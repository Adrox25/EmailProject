<html>
<head>
<title>PhpDumper.php</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #a9b7c6;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #629755; font-weight: bold; font-style: italic;}
.s6 { color: #77b767; font-style: italic;}
.s7 { color: #6a8759;}
.s8 { color: #9876aa;}
.s9 { color: #6897bb;}
.ls0 { height: 1px; border-width: 0; color: #4d4d4d; background-color:#4d4d4d}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PhpDumper.php</font>
</center></td></tr></table>
<pre><span class="s0">&lt;?php</span>

<span class="s2">/* 
 * This file is part of the Symfony package. 
 * 
 * (c) Fabien Potencier &lt;fabien@symfony.com&gt; 
 * 
 * For the full copyright and license information, please view the LICENSE 
 * file that was distributed with this source code. 
 */</span>
<hr class="ls0"><span class="s0">namespace </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Dumper</span><span class="s0">;</span>

<span class="s0">use </span><span class="s3">Composer</span><span class="s1">\</span><span class="s3">Autoload</span><span class="s1">\</span><span class="s3">ClassLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Debug</span><span class="s1">\</span><span class="s3">DebugClassLoader </span><span class="s0">as </span><span class="s3">LegacyDebugClassLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Argument</span><span class="s1">\</span><span class="s3">ArgumentInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Argument</span><span class="s1">\</span><span class="s3">IteratorArgument</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Argument</span><span class="s1">\</span><span class="s3">ServiceClosureArgument</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Argument</span><span class="s1">\</span><span class="s3">ServiceLocator</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Argument</span><span class="s1">\</span><span class="s3">ServiceLocatorArgument</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Compiler</span><span class="s1">\</span><span class="s3">AnalyzeServiceReferencesPass</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Compiler</span><span class="s1">\</span><span class="s3">CheckCircularReferencesPass</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Compiler</span><span class="s1">\</span><span class="s3">ServiceReferenceGraphEdge</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Compiler</span><span class="s1">\</span><span class="s3">ServiceReferenceGraphNode</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Container</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ContainerBuilder</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ContainerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Definition</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">EnvParameterException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">InvalidArgumentException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">LogicException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">RuntimeException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">ServiceCircularReferenceException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ExpressionLanguage</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">LazyProxy</span><span class="s1">\</span><span class="s3">PhpDumper</span><span class="s1">\</span><span class="s3">DumperInterface </span><span class="s0">as </span><span class="s3">ProxyDumper</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">LazyProxy</span><span class="s1">\</span><span class="s3">PhpDumper</span><span class="s1">\</span><span class="s3">NullDumper</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Loader</span><span class="s1">\</span><span class="s3">FileLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Parameter</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Reference</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ServiceLocator </span><span class="s0">as </span><span class="s3">BaseServiceLocator</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">TypedReference</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Variable</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">ErrorHandler</span><span class="s1">\</span><span class="s3">DebugClassLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">ExpressionLanguage</span><span class="s1">\</span><span class="s3">Expression</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpKernel</span><span class="s1">\</span><span class="s3">Kernel</span><span class="s0">;</span>
<hr class="ls0"><span class="s4">/**</span>
 <span class="s4">* PhpDumper dumps a service container as a PHP class.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Fabien Potencier </span><span class="s6">&lt;fabien</span><span class="s4">@symfony.com&gt;</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Johannes M. Schmitt </span><span class="s6">&lt;schmittjoh</span><span class="s4">@gmail.com&gt;</span>
 <span class="s4">*/</span>
<span class="s0">class </span><span class="s3">PhpDumper </span><span class="s0">extends </span><span class="s3">Dumper</span>
<span class="s1">{</span>
    <span class="s4">/**</span>
     <span class="s4">* Characters that might appear in the generated variable name as first character.</span>
     <span class="s4">*/</span>
    <span class="s0">const </span><span class="s3">FIRST_CHARS </span><span class="s1">= </span><span class="s7">'abcdefghijklmnopqrstuvwxyz'</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Characters that might appear in the generated variable name as any but the first character.</span>
     <span class="s4">*/</span>
    <span class="s0">const </span><span class="s3">NON_FIRST_CHARS </span><span class="s1">= </span><span class="s7">'abcdefghijklmnopqrstuvwxyz0123456789_'</span><span class="s0">;</span>

    <span class="s0">private </span><span class="s8">$definitionVariables</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$referenceVariables</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$variableCount</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$inlinedDefinitions</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$serviceCalls</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$reservedVariables </span><span class="s1">= [</span><span class="s7">'instance'</span><span class="s0">, </span><span class="s7">'class'</span><span class="s0">, </span><span class="s7">'this'</span><span class="s1">]</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$expressionLanguage</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$targetDirRegex</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$targetDirMaxMatches</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$docStar</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$serviceIdToMethodNameMap</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$usedMethodNames</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$namespace</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$asFiles</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$hotPathTag</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$inlineFactories</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$inlineRequires</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$inlinedRequires </span><span class="s1">= []</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$circularReferences </span><span class="s1">= []</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$singleUsePrivateIds </span><span class="s1">= []</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$preload </span><span class="s1">= []</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$addThrow </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$addGetService </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$locatedIds </span><span class="s1">= []</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$serviceLocatorTag</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$exportedVariables </span><span class="s1">= []</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s8">$baseClass</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">ProxyDumper</span>
     <span class="s4">*/</span>
    <span class="s0">private </span><span class="s8">$proxyDumper</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* {</span><span class="s5">@inheritdoc</span><span class="s4">}</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">__construct</span><span class="s1">(</span><span class="s3">ContainerBuilder </span><span class="s8">$container</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$container</span><span class="s1">-&gt;</span><span class="s3">isCompiled</span><span class="s1">()) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s7">'Cannot dump an uncompiled container.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s3">parent</span><span class="s1">::</span><span class="s3">__construct</span><span class="s1">(</span><span class="s8">$container</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the dumper to be used when dumping proxies in the generated container.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">setProxyDumper</span><span class="s1">(</span><span class="s3">ProxyDumper </span><span class="s8">$proxyDumper</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">proxyDumper </span><span class="s1">= </span><span class="s8">$proxyDumper</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Dumps the service container as a PHP class.</span>
     <span class="s4">*</span>
     <span class="s4">* Available options:</span>
     <span class="s4">*</span>
     <span class="s4">*  * class:      The class name</span>
     <span class="s4">*  * base_class: The base class name</span>
     <span class="s4">*  * namespace:  The class namespace</span>
     <span class="s4">*  * as_files:   To split the container in several files</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|array A PHP class representing the service container or an array of PHP files if the &quot;as_files&quot; option is set</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">EnvParameterException When an env var exists but has not been dumped</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">dump</span><span class="s1">(</span><span class="s0">array </span><span class="s8">$options </span><span class="s1">= [])</span>
    <span class="s1">{</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">locatedIds </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedRequires </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportedVariables </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$options </span><span class="s1">= </span><span class="s3">array_merge</span><span class="s1">([</span>
            <span class="s7">'class' </span><span class="s1">=&gt; </span><span class="s7">'ProjectServiceContainer'</span><span class="s0">,</span>
            <span class="s7">'base_class' </span><span class="s1">=&gt; </span><span class="s7">'Container'</span><span class="s0">,</span>
            <span class="s7">'namespace' </span><span class="s1">=&gt; </span><span class="s7">''</span><span class="s0">,</span>
            <span class="s7">'as_files' </span><span class="s1">=&gt; </span><span class="s3">false</span><span class="s0">,</span>
            <span class="s7">'debug' </span><span class="s1">=&gt; </span><span class="s3">true</span><span class="s0">,</span>
            <span class="s7">'hot_path_tag' </span><span class="s1">=&gt; </span><span class="s7">'container.hot_path'</span><span class="s0">,</span>
            <span class="s7">'inline_factories_parameter' </span><span class="s1">=&gt; </span><span class="s7">'container.dumper.inline_factories'</span><span class="s0">,</span>
            <span class="s7">'inline_class_loader_parameter' </span><span class="s1">=&gt; </span><span class="s7">'container.dumper.inline_class_loader'</span><span class="s0">,</span>
            <span class="s7">'preload_classes' </span><span class="s1">=&gt; []</span><span class="s0">,</span>
            <span class="s7">'service_locator_tag' </span><span class="s1">=&gt; </span><span class="s7">'container.service_locator'</span><span class="s0">,</span>
            <span class="s7">'build_time' </span><span class="s1">=&gt; </span><span class="s3">time</span><span class="s1">()</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">, </span><span class="s8">$options</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addThrow </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addGetService </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">namespace </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'namespace'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'as_files'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">hotPathTag </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'hot_path_tag'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'inline_factories_parameter'</span><span class="s1">] &amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasParameter</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'inline_factories_parameter'</span><span class="s1">]) &amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'inline_factories_parameter'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineRequires </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'inline_class_loader_parameter'</span><span class="s1">] &amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasParameter</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'inline_class_loader_parameter'</span><span class="s1">]) &amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'inline_class_loader_parameter'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceLocatorTag </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'service_locator_tag'</span><span class="s1">]</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$baseClass </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'base_class'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">) &amp;&amp; </span><span class="s7">'Container' </span><span class="s1">!== </span><span class="s8">$baseClass</span><span class="s1">) {</span>
            <span class="s8">$baseClass </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s\%s'</span><span class="s0">, </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'namespace'</span><span class="s1">] ? </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">.</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'namespace'</span><span class="s1">] : </span><span class="s7">''</span><span class="s0">, </span><span class="s8">$baseClass</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">baseClass </span><span class="s1">= </span><span class="s8">$baseClass</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s7">'Container' </span><span class="s1">=== </span><span class="s8">$baseClass</span><span class="s1">) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">baseClass </span><span class="s1">= </span><span class="s3">Container</span><span class="s1">::</span><span class="s0">class;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">baseClass </span><span class="s1">= </span><span class="s8">$baseClass</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">initializeMethodNamesMap</span><span class="s1">(</span><span class="s7">'Container' </span><span class="s1">=== </span><span class="s8">$baseClass </span><span class="s1">? </span><span class="s3">Container</span><span class="s1">::</span><span class="s0">class </span><span class="s1">: </span><span class="s8">$baseClass</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">() </span><span class="s0">instanceof </span><span class="s3">NullDumper</span><span class="s1">) {</span>
            <span class="s1">(</span><span class="s0">new </span><span class="s3">AnalyzeServiceReferencesPass</span><span class="s1">(</span><span class="s3">true</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))-&gt;</span><span class="s3">process</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">try </span><span class="s1">{</span>
                <span class="s1">(</span><span class="s0">new </span><span class="s3">CheckCircularReferencesPass</span><span class="s1">())-&gt;</span><span class="s3">process</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">catch </span><span class="s1">(</span><span class="s3">ServiceCircularReferenceException </span><span class="s8">$e</span><span class="s1">) {</span>
                <span class="s8">$path </span><span class="s1">= </span><span class="s8">$e</span><span class="s1">-&gt;</span><span class="s3">getPath</span><span class="s1">()</span><span class="s0">;</span>
                <span class="s3">end</span><span class="s1">(</span><span class="s8">$path</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s8">$path</span><span class="s1">[</span><span class="s3">key</span><span class="s1">(</span><span class="s8">$path</span><span class="s1">)] .= </span><span class="s7">'&quot;. Try running &quot;composer require symfony/proxy-manager-bridge'</span><span class="s0">;</span>

                <span class="s0">throw new </span><span class="s3">ServiceCircularReferenceException</span><span class="s1">(</span><span class="s8">$e</span><span class="s1">-&gt;</span><span class="s3">getServiceId</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$path</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s1">(</span><span class="s0">new </span><span class="s3">AnalyzeServiceReferencesPass</span><span class="s1">(</span><span class="s3">false</span><span class="s0">, </span><span class="s1">!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">() </span><span class="s0">instanceof </span><span class="s3">NullDumper</span><span class="s1">))-&gt;</span><span class="s3">process</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$checkedNodes </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getCompiler</span><span class="s1">()-&gt;</span><span class="s3">getServiceReferenceGraph</span><span class="s1">()-&gt;</span><span class="s3">getNodes</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$node</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$node</span><span class="s1">-&gt;</span><span class="s3">getValue</span><span class="s1">() </span><span class="s0">instanceof </span><span class="s3">Definition</span><span class="s1">) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$checkedNodes</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">analyzeCircularReferences</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$node</span><span class="s1">-&gt;</span><span class="s3">getOutEdges</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$checkedNodes</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isSingleUsePrivateNode</span><span class="s1">(</span><span class="s8">$node</span><span class="s1">)) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s8">$id</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getCompiler</span><span class="s1">()-&gt;</span><span class="s3">getServiceReferenceGraph</span><span class="s1">()-&gt;</span><span class="s3">clear</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$checkedNodes </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds </span><span class="s1">= </span><span class="s3">array_diff_key</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">docStar </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'debug'</span><span class="s1">] ? </span><span class="s7">'*' </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s0">empty</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'file'</span><span class="s1">]) &amp;&amp; </span><span class="s3">is_dir</span><span class="s1">(</span><span class="s8">$dir </span><span class="s1">= \</span><span class="s3">dirname</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'file'</span><span class="s1">]))) {</span>
            <span class="s2">// Build a regexp where the first root dirs are mandatory,</span>
            <span class="s2">// but every other sub-dir is optional up to the full path in $dir</span>
            <span class="s2">// Mandate at least 1 root dir and not more than 5 optional dirs.</span>

            <span class="s8">$dir </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(\</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s0">, </span><span class="s3">realpath</span><span class="s1">(</span><span class="s8">$dir</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s8">$i </span><span class="s1">= \</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$dir</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s9">2 </span><span class="s1">+ (int) (</span><span class="s7">'</span><span class="s0">\\</span><span class="s7">' </span><span class="s1">=== \</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">) &lt;= </span><span class="s8">$i</span><span class="s1">) {</span>
                <span class="s8">$regex </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
                <span class="s8">$lastOptionalDir </span><span class="s1">= </span><span class="s8">$i </span><span class="s1">&gt; </span><span class="s9">8 </span><span class="s1">? </span><span class="s8">$i </span><span class="s1">- </span><span class="s9">5 </span><span class="s1">: (</span><span class="s9">2 </span><span class="s1">+ (int) (</span><span class="s7">'</span><span class="s0">\\</span><span class="s7">' </span><span class="s1">=== \</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirMaxMatches </span><span class="s1">= </span><span class="s8">$i </span><span class="s1">- </span><span class="s8">$lastOptionalDir</span><span class="s0">;</span>

                <span class="s0">while </span><span class="s1">(--</span><span class="s8">$i </span><span class="s1">&gt;= </span><span class="s8">$lastOptionalDir</span><span class="s1">) {</span>
                    <span class="s8">$regex </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'(%s%s)?'</span><span class="s0">, </span><span class="s3">preg_quote</span><span class="s1">(\</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">.</span><span class="s8">$dir</span><span class="s1">[</span><span class="s8">$i</span><span class="s1">]</span><span class="s0">, </span><span class="s7">'#'</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$regex</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">do </span><span class="s1">{</span>
                    <span class="s8">$regex </span><span class="s1">= </span><span class="s3">preg_quote</span><span class="s1">(\</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">.</span><span class="s8">$dir</span><span class="s1">[</span><span class="s8">$i</span><span class="s1">]</span><span class="s0">, </span><span class="s7">'#'</span><span class="s1">).</span><span class="s8">$regex</span><span class="s0">;</span>
                <span class="s1">} </span><span class="s0">while </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">&lt; --</span><span class="s8">$i</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex </span><span class="s1">= </span><span class="s7">'#'</span><span class="s1">.</span><span class="s3">preg_quote</span><span class="s1">(</span><span class="s8">$dir</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s7">'#'</span><span class="s1">).</span><span class="s8">$regex</span><span class="s1">.</span><span class="s7">'#'</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s8">$proxyClasses </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories </span><span class="s1">? </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateProxyClasses</span><span class="s1">() : </span><span class="s3">null</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'preload_classes'</span><span class="s1">]) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">preload </span><span class="s1">= </span><span class="s3">array_combine</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'preload_classes'</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'preload_classes'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$code </span><span class="s1">=</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">startClass</span><span class="s1">(</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$baseClass</span><span class="s1">).</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addServices</span><span class="s1">(</span><span class="s8">$services</span><span class="s1">).</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addDeprecatedAliases</span><span class="s1">().</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addDefaultParametersMethod</span><span class="s1">()</span>
        <span class="s0">;</span>

        <span class="s8">$proxyClasses </span><span class="s1">= </span><span class="s8">$proxyClasses </span><span class="s1">?? </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateProxyClasses</span><span class="s1">()</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addGetService</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">preg_replace</span><span class="s1">(</span>
                <span class="s7">&quot;/(</span><span class="s0">\r</span><span class="s7">?</span><span class="s0">\n\r</span><span class="s7">?</span><span class="s0">\n    </span><span class="s7">public function __construct.+?</span><span class="s0">\\</span><span class="s7">{</span><span class="s0">\r</span><span class="s7">?</span><span class="s0">\n</span><span class="s7">)/s&quot;</span><span class="s0">,</span>
                <span class="s7">&quot;</span><span class="s0">\n    </span><span class="s7">private </span><span class="s0">\$</span><span class="s7">getService;$1        </span><span class="s0">\$</span><span class="s7">this-&gt;getService = </span><span class="s0">\\</span><span class="s7">Closure::fromCallable([</span><span class="s0">\$</span><span class="s7">this, 'getService']);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">,</span>
                <span class="s8">$code</span><span class="s0">,</span>
                <span class="s9">1</span>
            <span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles</span><span class="s1">) {</span>
            <span class="s8">$fileStart </span><span class="s1">= </span><span class="s3">&lt;&lt;&lt;EOF 
</span><span class="s7">&lt;?php 
 
use Symfony\Component\DependencyInjection\Argument\RewindableGenerator; 
use Symfony\Component\DependencyInjection\Exception\RuntimeException; 
 
// This file has been auto-generated by the Symfony Dependency Injection Component for internal use. 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
            <span class="s8">$files </span><span class="s1">= []</span><span class="s0">;</span>

            <span class="s8">$ids </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getRemovedIds</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">()) {</span>
                    <span class="s8">$ids</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$ids </span><span class="s1">= </span><span class="s3">array_keys</span><span class="s1">(</span><span class="s8">$ids</span><span class="s1">)) {</span>
                <span class="s3">sort</span><span class="s1">(</span><span class="s8">$ids</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s8">$c </span><span class="s1">= </span><span class="s7">&quot;&lt;?php</span><span class="s0">\n\n</span><span class="s7">return [</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$ids </span><span class="s0">as </span><span class="s8">$id</span><span class="s1">) {</span>
                    <span class="s8">$c </span><span class="s1">.= </span><span class="s7">'    '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">).</span><span class="s7">&quot; =&gt; true,</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s8">$files</span><span class="s1">[</span><span class="s7">'removed-ids.php'</span><span class="s1">] = </span><span class="s8">$c</span><span class="s1">.</span><span class="s7">&quot;];</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories</span><span class="s1">) {</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateServiceFiles</span><span class="s1">(</span><span class="s8">$services</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$file </span><span class="s1">=&gt; </span><span class="s8">$c</span><span class="s1">) {</span>
                    <span class="s8">$files</span><span class="s1">[</span><span class="s8">$file</span><span class="s1">] = </span><span class="s8">$fileStart</span><span class="s1">.</span><span class="s8">$c</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$proxyClasses </span><span class="s0">as </span><span class="s8">$file </span><span class="s1">=&gt; </span><span class="s8">$c</span><span class="s1">) {</span>
                    <span class="s8">$files</span><span class="s1">[</span><span class="s8">$file</span><span class="s1">] = </span><span class="s7">&quot;&lt;?php</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s1">.</span><span class="s8">$c</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">endClass</span><span class="s1">()</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories</span><span class="s1">) {</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$proxyClasses </span><span class="s0">as </span><span class="s8">$c</span><span class="s1">) {</span>
                    <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$c</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s8">$files</span><span class="s1">[</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">].</span><span class="s7">'.php'</span><span class="s1">] = </span><span class="s8">$code</span><span class="s0">;</span>
            <span class="s8">$hash </span><span class="s1">= </span><span class="s3">ucfirst</span><span class="s1">(</span><span class="s3">strtr</span><span class="s1">(</span><span class="s3">ContainerBuilder</span><span class="s1">::</span><span class="s3">hash</span><span class="s1">(</span><span class="s8">$files</span><span class="s1">)</span><span class="s0">, </span><span class="s7">'._'</span><span class="s0">, </span><span class="s7">'xx'</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">= []</span><span class="s0">;</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$files </span><span class="s0">as </span><span class="s8">$file </span><span class="s1">=&gt; </span><span class="s8">$c</span><span class="s1">) {</span>
                <span class="s8">$code</span><span class="s1">[</span><span class="s7">&quot;Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">/</span><span class="s1">{</span><span class="s8">$file</span><span class="s1">}</span><span class="s7">&quot;</span><span class="s1">] = </span><span class="s8">$c</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s3">array_pop</span><span class="s1">(</span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$code</span><span class="s1">[</span><span class="s7">&quot;Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">/</span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">.php&quot;</span><span class="s1">] = </span><span class="s3">substr_replace</span><span class="s1">(</span><span class="s8">$files</span><span class="s1">[</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">].</span><span class="s7">'.php'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">&quot;&lt;?php</span><span class="s0">\n\n</span><span class="s7">namespace Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s9">6</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$namespaceLine </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">namespace </span><span class="s1">? </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">namespace </span><span class="s1">{</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">namespace</span><span class="s1">}</span><span class="s7">;</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>
            <span class="s8">$time </span><span class="s1">= </span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'build_time'</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s8">$id </span><span class="s1">= </span><span class="s3">hash</span><span class="s1">(</span><span class="s7">'crc32'</span><span class="s0">, </span><span class="s8">$hash</span><span class="s1">.</span><span class="s8">$time</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">preload </span><span class="s1">&amp;&amp; </span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$autoloadFile </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getAutoloadFile</span><span class="s1">()) {</span>
                <span class="s8">$autoloadFile </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$autoloadFile</span><span class="s1">)</span><span class="s0">, </span><span class="s9">2</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s8">$code</span><span class="s1">[</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">].</span><span class="s7">'.preload.php'</span><span class="s1">] = </span><span class="s3">&lt;&lt;&lt;EOF 
</span><span class="s7">&lt;?php 
 
// This file has been auto-generated by the Symfony Dependency Injection Component 
// You can reference it in the &quot;opcache.preload&quot; php.ini setting on PHP &gt;= 7.4 when preloading is desired 
 
use Symfony\Component\DependencyInjection\Dumper\Preloader; 
 
require </span><span class="s8">$autoloadFile</span><span class="s7">; 
require __DIR__.'/Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">/</span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">.php'; 
 
\$classes = []; 
</span>
<span class="s3">EOF</span><span class="s0">;</span>

                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">preload </span><span class="s0">as </span><span class="s8">$class</span><span class="s1">) {</span>
                    <span class="s0">if </span><span class="s1">(!</span><span class="s8">$class </span><span class="s1">|| </span><span class="s3">false </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'$'</span><span class="s1">)) {</span>
                        <span class="s0">continue;</span>
                    <span class="s1">}</span>
                    <span class="s0">if </span><span class="s1">(!(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s3">false</span><span class="s1">) || </span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s3">false</span><span class="s1">) || </span><span class="s3">trait_exists</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) || (</span><span class="s0">new </span><span class="s1">\</span><span class="s3">ReflectionClass</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">))-&gt;</span><span class="s3">isUserDefined</span><span class="s1">()) {</span>
                        <span class="s8">$code</span><span class="s1">[</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">].</span><span class="s7">'.preload.php'</span><span class="s1">] .= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\$</span><span class="s7">classes[] = '%s';</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$class</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>

                <span class="s8">$code</span><span class="s1">[</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">].</span><span class="s7">'.preload.php'</span><span class="s1">] .= </span><span class="s3">&lt;&lt;&lt;'EOF' 
</span>
<span class="s7">Preloader::preload($classes); 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$code</span><span class="s1">[</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">].</span><span class="s7">'.php'</span><span class="s1">] = </span><span class="s3">&lt;&lt;&lt;EOF 
</span><span class="s7">&lt;?php 
</span><span class="s1">{</span><span class="s8">$namespaceLine</span><span class="s1">}</span>
<span class="s7">// This file has been auto-generated by the Symfony Dependency Injection Component for internal use. 
 
if (\\class_exists(\\Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">\\</span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">::class, false)) { 
    // no-op 
} elseif (!include __DIR__.'/Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">/</span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">.php') { 
    touch(__DIR__.'/Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">.legacy'); 
 
    return; 
} 
 
if (!\\class_exists(</span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">::class, false)) { 
    \\class_alias(\\Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">\\</span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">::class, </span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">::class, false); 
} 
 
return new \\Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">\\</span><span class="s1">{</span><span class="s8">$options</span><span class="s1">[</span><span class="s7">'class'</span><span class="s1">]}</span><span class="s7">([ 
    'container.build_hash' =&gt; '</span><span class="s8">$hash</span><span class="s7">', 
    'container.build_id' =&gt; '</span><span class="s8">$id</span><span class="s7">', 
    'container.build_time' =&gt; </span><span class="s8">$time</span><span class="s7">, 
], __DIR__.\\DIRECTORY_SEPARATOR.'Container</span><span class="s1">{</span><span class="s8">$hash</span><span class="s1">}</span><span class="s7">'); 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">endClass</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$proxyClasses </span><span class="s0">as </span><span class="s8">$c</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$c</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedRequires </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">locatedIds </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportedVariables </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">preload </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s8">$unusedEnvs </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getEnvCounters</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$env </span><span class="s1">=&gt; </span><span class="s8">$use</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$use</span><span class="s1">) {</span>
                <span class="s8">$unusedEnvs</span><span class="s1">[] = </span><span class="s8">$env</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$unusedEnvs</span><span class="s1">) {</span>
            <span class="s0">throw new </span><span class="s3">EnvParameterException</span><span class="s1">(</span><span class="s8">$unusedEnvs</span><span class="s0">, </span><span class="s3">null</span><span class="s0">, </span><span class="s7">'Environment variables &quot;%s&quot; are never used. Please, check your container</span><span class="s0">\'</span><span class="s7">s configuration.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Retrieves the currently set proxy dumper or instantiates one.</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">getProxyDumper</span><span class="s1">(): </span><span class="s3">ProxyDumper</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">proxyDumper</span><span class="s1">) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">proxyDumper </span><span class="s1">= </span><span class="s0">new </span><span class="s3">NullDumper</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">proxyDumper</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">ServiceReferenceGraphEdge[] $edges</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">analyzeCircularReferences</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$sourceId</span><span class="s0">, array </span><span class="s8">$edges</span><span class="s0">, array </span><span class="s1">&amp;</span><span class="s8">$checkedNodes</span><span class="s0">, array </span><span class="s1">&amp;</span><span class="s8">$currentPath </span><span class="s1">= []</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$byConstructor </span><span class="s1">= </span><span class="s3">true</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s8">$checkedNodes</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
        <span class="s8">$currentPath</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">] = </span><span class="s8">$byConstructor</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$edges </span><span class="s0">as </span><span class="s8">$edge</span><span class="s1">) {</span>
            <span class="s8">$node </span><span class="s1">= </span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">getDestNode</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s8">$id </span><span class="s1">= </span><span class="s8">$node</span><span class="s1">-&gt;</span><span class="s3">getId</span><span class="s1">()</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$node</span><span class="s1">-&gt;</span><span class="s3">getValue</span><span class="s1">() </span><span class="s0">instanceof </span><span class="s3">Definition </span><span class="s1">|| </span><span class="s8">$sourceId </span><span class="s1">=== </span><span class="s8">$id </span><span class="s1">|| </span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">isLazy</span><span class="s1">() || </span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">isWeak</span><span class="s1">()) {</span>
                <span class="s2">// no-op</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$currentPath</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addCircularReferences</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$currentPath</span><span class="s0">, </span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">isReferencedByConstructor</span><span class="s1">())</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$checkedNodes</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">analyzeCircularReferences</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$node</span><span class="s1">-&gt;</span><span class="s3">getOutEdges</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$checkedNodes</span><span class="s0">, </span><span class="s8">$currentPath</span><span class="s0">, </span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">isReferencedByConstructor</span><span class="s1">())</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">connectCircularReferences</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$currentPath</span><span class="s0">, </span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">isReferencedByConstructor</span><span class="s1">())</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">unset</span><span class="s1">(</span><span class="s8">$currentPath</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">connectCircularReferences</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$sourceId</span><span class="s0">, array </span><span class="s1">&amp;</span><span class="s8">$currentPath</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$byConstructor</span><span class="s0">, array </span><span class="s1">&amp;</span><span class="s8">$subPath </span><span class="s1">= [])</span>
    <span class="s1">{</span>
        <span class="s8">$currentPath</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">] = </span><span class="s8">$subPath</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">] = </span><span class="s8">$byConstructor</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">] </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$byConstructor</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$currentPath</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addCircularReferences</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$currentPath</span><span class="s0">, </span><span class="s8">$byConstructor</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$subPath</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]) &amp;&amp; </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">connectCircularReferences</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$currentPath</span><span class="s0">, </span><span class="s8">$byConstructor</span><span class="s0">, </span><span class="s8">$subPath</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">unset</span><span class="s1">(</span><span class="s8">$currentPath</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$subPath</span><span class="s1">[</span><span class="s8">$sourceId</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addCircularReferences</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s0">, array </span><span class="s8">$currentPath</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$byConstructor</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s8">$currentPath</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s8">$byConstructor</span><span class="s0">;</span>
        <span class="s8">$circularRefs </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s3">array_reverse</span><span class="s1">(</span><span class="s8">$currentPath</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$parentId </span><span class="s1">=&gt; </span><span class="s8">$v</span><span class="s1">) {</span>
            <span class="s8">$byConstructor </span><span class="s1">= </span><span class="s8">$byConstructor </span><span class="s1">&amp;&amp; </span><span class="s8">$v</span><span class="s0">;</span>
            <span class="s8">$circularRefs</span><span class="s1">[] = </span><span class="s8">$parentId</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$parentId </span><span class="s1">=== </span><span class="s8">$id</span><span class="s1">) {</span>
                <span class="s0">break;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s8">$currentId </span><span class="s1">= </span><span class="s8">$id</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$circularRefs </span><span class="s0">as </span><span class="s8">$parentId</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">empty</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$parentId</span><span class="s1">][</span><span class="s8">$currentId</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$parentId</span><span class="s1">][</span><span class="s8">$currentId</span><span class="s1">] = </span><span class="s8">$byConstructor</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$currentId </span><span class="s1">= </span><span class="s8">$parentId</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$class</span><span class="s0">, array </span><span class="s1">&amp;</span><span class="s8">$lineage</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$lineage</span><span class="s1">[</span><span class="s8">$class</span><span class="s1">])) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$r </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getReflectionClass</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">is_a</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">baseClass</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>
        <span class="s8">$file </span><span class="s1">= </span><span class="s8">$r</span><span class="s1">-&gt;</span><span class="s3">getFileName</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$file </span><span class="s1">|| </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$file</span><span class="s1">) === </span><span class="s8">$exportedFile </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$file</span><span class="s1">)) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s8">$lineage</span><span class="s1">[</span><span class="s8">$class</span><span class="s1">] = </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$exportedFile</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$parent </span><span class="s1">= </span><span class="s8">$r</span><span class="s1">-&gt;</span><span class="s3">getParentClass</span><span class="s1">()) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s8">$parent</span><span class="s1">-&gt;</span><span class="s3">name</span><span class="s0">, </span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$r</span><span class="s1">-&gt;</span><span class="s3">getInterfaces</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$parent</span><span class="s1">) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s8">$parent</span><span class="s1">-&gt;</span><span class="s3">name</span><span class="s0">, </span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$r</span><span class="s1">-&gt;</span><span class="s3">getTraits</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$parent</span><span class="s1">) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s8">$parent</span><span class="s1">-&gt;</span><span class="s3">name</span><span class="s0">, </span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">unset</span><span class="s1">(</span><span class="s8">$lineage</span><span class="s1">[</span><span class="s8">$class</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s8">$lineage</span><span class="s1">[</span><span class="s8">$class</span><span class="s1">] = </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$exportedFile</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">generateProxyClasses</span><span class="s1">(): </span><span class="s0">array</span>
    <span class="s1">{</span>
        <span class="s8">$proxyClasses </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$alreadyGenerated </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$definitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$strip </span><span class="s1">= </span><span class="s7">'' </span><span class="s1">=== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">docStar </span><span class="s1">&amp;&amp; </span><span class="s3">method_exists</span><span class="s1">(</span><span class="s7">'Symfony\Component\HttpKernel\Kernel'</span><span class="s0">, </span><span class="s7">'stripComments'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$proxyDumper </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s8">$definitions</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definitions </span><span class="s0">as </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$proxyDumper</span><span class="s1">-&gt;</span><span class="s3">isProxyCandidate</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$alreadyGenerated</span><span class="s1">[</span><span class="s8">$class </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getClass</span><span class="s1">()])) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s8">$alreadyGenerated</span><span class="s1">[</span><span class="s8">$class</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
            <span class="s2">// register class' reflector for resource tracking</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getReflectionClass</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">=== </span><span class="s8">$proxyCode </span><span class="s1">= </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s1">.</span><span class="s8">$proxyDumper</span><span class="s1">-&gt;</span><span class="s3">getProxyCode</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineRequires</span><span class="s1">) {</span>
                <span class="s8">$lineage </span><span class="s1">= []</span><span class="s0">;</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s3">array_diff_key</span><span class="s1">(</span><span class="s3">array_flip</span><span class="s1">(</span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedRequires</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$file </span><span class="s1">=&gt; </span><span class="s8">$class</span><span class="s1">) {</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories</span><span class="s1">) {</span>
                        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedRequires</span><span class="s1">[</span><span class="s8">$file</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;include_once %s;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$file</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s8">$proxyCode </span><span class="s1">= </span><span class="s8">$code</span><span class="s1">.</span><span class="s8">$proxyCode</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$strip</span><span class="s1">) {</span>
                <span class="s8">$proxyCode </span><span class="s1">= </span><span class="s7">&quot;&lt;?php</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s1">.</span><span class="s8">$proxyCode</span><span class="s0">;</span>
                <span class="s8">$proxyCode </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s3">Kernel</span><span class="s1">::</span><span class="s3">stripComments</span><span class="s1">(</span><span class="s8">$proxyCode</span><span class="s1">)</span><span class="s0">, </span><span class="s9">5</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$proxyClasses</span><span class="s1">[</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s.php'</span><span class="s0">, </span><span class="s3">explode</span><span class="s1">(</span><span class="s7">' '</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineRequires </span><span class="s1">? </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$proxyCode</span><span class="s0">, </span><span class="s1">\</span><span class="s3">strlen</span><span class="s1">(</span><span class="s8">$code</span><span class="s1">)) : </span><span class="s8">$proxyCode</span><span class="s0">, </span><span class="s9">3</span><span class="s1">)[</span><span class="s9">1</span><span class="s1">])] = </span><span class="s8">$proxyCode</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$proxyClasses</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addServiceInclude</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$cId</span><span class="s0">, </span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineRequires </span><span class="s1">&amp;&amp; (!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isHotPath</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">) || </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()-&gt;</span><span class="s3">isProxyCandidate</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">))) {</span>
            <span class="s8">$lineage </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedDefinitions </span><span class="s0">as </span><span class="s8">$def</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s8">$def</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">()) {</span>
                    <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getClasses</span><span class="s1">(</span><span class="s8">$def</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$class</span><span class="s1">) {</span>
                        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceCalls </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s0">list</span><span class="s1">(</span><span class="s8">$callCount</span><span class="s0">, </span><span class="s8">$behavior</span><span class="s1">)) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s7">'service_container' </span><span class="s1">!== </span><span class="s8">$id </span><span class="s1">&amp;&amp; </span><span class="s8">$id </span><span class="s1">!== </span><span class="s8">$cId</span>
                    <span class="s1">&amp;&amp; </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">IGNORE_ON_UNINITIALIZED_REFERENCE </span><span class="s1">!== </span><span class="s8">$behavior</span>
                    <span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span>
                    <span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isTrivialInstance</span><span class="s1">(</span><span class="s8">$def </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span>
                <span class="s1">) {</span>
                    <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getClasses</span><span class="s1">(</span><span class="s8">$def</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$class</span><span class="s1">) {</span>
                        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s3">array_diff_key</span><span class="s1">(</span><span class="s3">array_flip</span><span class="s1">(</span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedRequires</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$file </span><span class="s1">=&gt; </span><span class="s8">$class</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        include_once %s;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$file</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedDefinitions </span><span class="s0">as </span><span class="s8">$def</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$file </span><span class="s1">= </span><span class="s8">$def</span><span class="s1">-&gt;</span><span class="s3">getFile</span><span class="s1">()) {</span>
                <span class="s8">$file </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$file</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s8">$file </span><span class="s1">= </span><span class="s7">'(' </span><span class="s1">=== </span><span class="s8">$file</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] ? </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$file</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">) : </span><span class="s8">$file</span><span class="s0">;</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        include_once %s;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$file</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">'' </span><span class="s1">!== </span><span class="s8">$code</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">InvalidArgumentException</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">RuntimeException</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">addServiceInstance</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s0">, </span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$isSimpleInstance</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$class </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getClass</span><span class="s1">())</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">&quot;'&quot;</span><span class="s1">) &amp;&amp; </span><span class="s3">false </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'$'</span><span class="s1">) &amp;&amp; !</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s7">'/^</span><span class="s0">\'</span><span class="s7">(?:</span><span class="s0">\\</span><span class="s7">\{2})?[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*(?:</span><span class="s0">\\</span><span class="s7">\{2}[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)*</span><span class="s0">\'</span><span class="s7">$/'</span><span class="s0">, </span><span class="s8">$class</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'&quot;%s&quot; is not a valid class name for the &quot;%s&quot; service.'</span><span class="s0">, </span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$isProxyCandidate </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()-&gt;</span><span class="s3">isProxyCandidate</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$instantiation </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s8">$lastWitherIndex </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getMethodCalls</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$call</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$call</span><span class="s1">[</span><span class="s9">2</span><span class="s1">] ?? </span><span class="s3">false</span><span class="s1">) {</span>
                <span class="s8">$lastWitherIndex </span><span class="s1">= </span><span class="s8">$k</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$isProxyCandidate </span><span class="s1">&amp;&amp; </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">() &amp;&amp; !</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]) &amp;&amp; </span><span class="s3">null </span><span class="s1">=== </span><span class="s8">$lastWitherIndex</span><span class="s1">) {</span>
            <span class="s8">$instantiation </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;%s[%s] = %s'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'services' </span><span class="s1">: </span><span class="s7">'privates'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$isSimpleInstance </span><span class="s1">? </span><span class="s7">'' </span><span class="s1">: </span><span class="s7">'$instance'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s8">$isSimpleInstance</span><span class="s1">) {</span>
            <span class="s8">$instantiation </span><span class="s1">= </span><span class="s7">'$instance'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$return </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$isSimpleInstance</span><span class="s1">) {</span>
            <span class="s8">$return </span><span class="s1">= </span><span class="s7">'return '</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$instantiation </span><span class="s1">.= </span><span class="s7">' = '</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addNewInstance</span><span class="s1">(</span><span class="s8">$definition</span><span class="s0">, </span><span class="s7">'        '</span><span class="s1">.</span><span class="s8">$return</span><span class="s1">.</span><span class="s8">$instantiation</span><span class="s0">, </span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">isTrivialInstance</span><span class="s1">(</span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s1">): </span><span class="s3">bool</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">hasErrors</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s3">true</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isSynthetic</span><span class="s1">() || </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getFile</span><span class="s1">() || </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getMethodCalls</span><span class="s1">() || </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getProperties</span><span class="s1">() || </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getConfigurator</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">() || </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isLazy</span><span class="s1">() || </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">() || </span><span class="s9">3 </span><span class="s1">&lt; \</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getArguments</span><span class="s1">())) {</span>
            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getArguments</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$arg</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$arg </span><span class="s1">|| </span><span class="s8">$arg </span><span class="s0">instanceof </span><span class="s3">Parameter</span><span class="s1">) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$arg</span><span class="s1">) &amp;&amp; </span><span class="s9">3 </span><span class="s1">&gt;= \</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$arg</span><span class="s1">)) {</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$arg </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$v</span><span class="s1">) {</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$k</span><span class="s1">) !== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$k</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s0">if </span><span class="s1">(!</span><span class="s8">$v </span><span class="s1">|| </span><span class="s8">$v </span><span class="s0">instanceof </span><span class="s3">Parameter</span><span class="s1">) {</span>
                        <span class="s0">continue;</span>
                    <span class="s1">}</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s8">$v </span><span class="s0">instanceof </span><span class="s3">Reference </span><span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$v</span><span class="s1">) &amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)-&gt;</span><span class="s3">isSynthetic</span><span class="s1">()) {</span>
                        <span class="s0">continue;</span>
                    <span class="s1">}</span>
                    <span class="s0">if </span><span class="s1">(!</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s8">$v</span><span class="s1">) || </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$v</span><span class="s1">) !== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$v</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$arg </span><span class="s0">instanceof </span><span class="s3">Reference </span><span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$arg</span><span class="s1">) &amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)-&gt;</span><span class="s3">isSynthetic</span><span class="s1">()) {</span>
                <span class="s0">continue;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s8">$arg</span><span class="s1">) || </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$arg</span><span class="s1">) !== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$arg</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">true</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addServiceMethodCalls</span><span class="s1">(</span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$variableName</span><span class="s0">, </span><span class="s1">?</span><span class="s3">string </span><span class="s8">$sharedNonLazyId</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$lastWitherIndex </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getMethodCalls</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$call</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$call</span><span class="s1">[</span><span class="s9">2</span><span class="s1">] ?? </span><span class="s3">false</span><span class="s1">) {</span>
                <span class="s8">$lastWitherIndex </span><span class="s1">= </span><span class="s8">$k</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s8">$calls </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getMethodCalls</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$call</span><span class="s1">) {</span>
            <span class="s8">$arguments </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$call</span><span class="s1">[</span><span class="s9">1</span><span class="s1">] </span><span class="s0">as </span><span class="s8">$value</span><span class="s1">) {</span>
                <span class="s8">$arguments</span><span class="s1">[] = </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$witherAssignation </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$call</span><span class="s1">[</span><span class="s9">2</span><span class="s1">] ?? </span><span class="s3">false</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$sharedNonLazyId </span><span class="s1">&amp;&amp; </span><span class="s8">$lastWitherIndex </span><span class="s1">=== </span><span class="s8">$k</span><span class="s1">) {</span>
                    <span class="s8">$witherAssignation </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;%s[</span><span class="s0">\'</span><span class="s7">%s</span><span class="s0">\'</span><span class="s7">] = '</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'services' </span><span class="s1">: </span><span class="s7">'privates'</span><span class="s0">, </span><span class="s8">$sharedNonLazyId</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s8">$witherAssignation </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$%s = '</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$calls </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">wrapServiceConditionals</span><span class="s1">(</span><span class="s8">$call</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        %s</span><span class="s0">\$</span><span class="s7">%s-&gt;%s(%s);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$witherAssignation</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s0">, </span><span class="s8">$call</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s1">)))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$calls</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addServiceProperties</span><span class="s1">(</span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$variableName </span><span class="s1">= </span><span class="s7">'instance'</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getProperties</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$name </span><span class="s1">=&gt; </span><span class="s8">$value</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">%s-&gt;%s = %s;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s0">, </span><span class="s8">$name</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addServiceConfigurator</span><span class="s1">(</span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$variableName </span><span class="s1">= </span><span class="s7">'instance'</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$callable </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getConfigurator</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">)) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">Reference</span>
                <span class="s1">|| (</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">Definition </span><span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">-&gt;</span><span class="s3">contains</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]))</span>
            <span class="s1">) {</span>
                <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        %s-&gt;%s(</span><span class="s0">\$</span><span class="s7">%s);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$class </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s2">// If the class is a string we can optimize away</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">&quot;'&quot;</span><span class="s1">) &amp;&amp; </span><span class="s3">false </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'$'</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        %s::%s(</span><span class="s0">\$</span><span class="s7">%s);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpLiteralClass</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'new '</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        (%s)-&gt;%s(</span><span class="s0">\$</span><span class="s7">%s);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        [%s, '%s'](</span><span class="s0">\$</span><span class="s7">%s);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        %s(</span><span class="s0">\$</span><span class="s7">%s);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$callable</span><span class="s0">, </span><span class="s8">$variableName</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addService</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s0">, </span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s1">): </span><span class="s0">array</span>
    <span class="s1">{</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables </span><span class="s1">= </span><span class="s0">new </span><span class="s1">\</span><span class="s3">SplObjectStorage</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">variableCount </span><span class="s1">= </span><span class="s9">0</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Variable</span><span class="s1">(</span><span class="s7">'instance'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s8">$return </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$class </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getClass</span><span class="s1">()) {</span>
            <span class="s8">$class </span><span class="s1">= </span><span class="s8">$class </span><span class="s0">instanceof </span><span class="s3">Parameter </span><span class="s1">? </span><span class="s7">'%'</span><span class="s1">.</span><span class="s8">$class</span><span class="s1">.</span><span class="s7">'%' </span><span class="s1">: </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$return</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'%'</span><span class="s1">) ? </span><span class="s7">'@return object A %1$s instance' </span><span class="s1">: </span><span class="s7">'@return \%s'</span><span class="s0">, </span><span class="s3">ltrim</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">()) {</span>
            <span class="s8">$factory </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">)) {</span>
                <span class="s8">$return</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'@return object An instance returned by %s()'</span><span class="s0">, </span><span class="s8">$factory</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">) &amp;&amp; (\</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]) || </span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">Definition </span><span class="s1">|| </span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">Reference</span><span class="s1">)) {</span>
                <span class="s8">$class </span><span class="s1">= </span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">Definition </span><span class="s1">? </span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]-&gt;</span><span class="s3">getClass</span><span class="s1">() : (string) </span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s8">$class </span><span class="s1">= </span><span class="s8">$class </span><span class="s0">instanceof </span><span class="s3">Parameter </span><span class="s1">? </span><span class="s7">'%'</span><span class="s1">.</span><span class="s8">$class</span><span class="s1">.</span><span class="s7">'%' </span><span class="s1">: </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s8">$return</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'@return object An instance returned by %s::%s()'</span><span class="s0">, </span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">()) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$return </span><span class="s1">&amp;&amp; </span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$return</span><span class="s1">[\</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$return</span><span class="s1">) - </span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s7">'@return'</span><span class="s1">)) {</span>
                <span class="s8">$return</span><span class="s1">[] = </span><span class="s7">''</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$return</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'@deprecated %s'</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getDeprecationMessage</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$return </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n     </span><span class="s7">* </span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s7">&quot;</span><span class="s0">\n     </span><span class="s7">*</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n     </span><span class="s7">* &quot;</span><span class="s0">, </span><span class="s8">$return</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s8">$return </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s8">$return</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s8">$shared </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">() ? </span><span class="s7">' shared' </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s8">$public </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'public' </span><span class="s1">: </span><span class="s7">'private'</span><span class="s0">;</span>
        <span class="s8">$autowired </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isAutowired</span><span class="s1">() ? </span><span class="s7">' autowired' </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isLazy</span><span class="s1">()) {</span>
            <span class="s8">$lazyInitialization </span><span class="s1">= </span><span class="s7">'$lazyLoad = true'</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$lazyInitialization </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$asFile </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isHotPath</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$methodName </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$asFile</span><span class="s1">) {</span>
            <span class="s8">$file </span><span class="s1">= </span><span class="s8">$methodName</span><span class="s1">.</span><span class="s7">'.php'</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s7">&quot;        // Returns the </span><span class="s8">$public </span><span class="s7">'</span><span class="s8">$id</span><span class="s7">'</span><span class="s8">$shared$autowired </span><span class="s7">service.</span><span class="s0">\n\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$file </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">&lt;&lt;&lt;EOF 
</span>
    <span class="s7">/*</span><span class="s1">{</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">docStar</span><span class="s1">}</span>
     <span class="s7">* Gets the </span><span class="s8">$public </span><span class="s7">'</span><span class="s8">$id</span><span class="s7">'</span><span class="s8">$shared$autowired </span><span class="s7">service. 
     * 
     * </span><span class="s8">$return</span>
<span class="s3">EOF</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s7">'*/'</span><span class="s0">, </span><span class="s7">' '</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">).</span><span class="s3">&lt;&lt;&lt;EOF 
</span>
     <span class="s7">*/ 
    protected function </span><span class="s1">{</span><span class="s8">$methodName</span><span class="s1">}</span><span class="s7">(</span><span class="s8">$lazyInitialization</span><span class="s7">) 
    { 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">hasErrors</span><span class="s1">() &amp;&amp; </span><span class="s8">$e </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getErrors</span><span class="s1">()) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addThrow </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>

            <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;throw(%s);</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s3">reset</span><span class="s1">(</span><span class="s8">$e</span><span class="s1">)))</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceCalls </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedDefinitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getDefinitionsFromArguments</span><span class="s1">([</span><span class="s8">$definition</span><span class="s1">]</span><span class="s0">, </span><span class="s3">null</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceCalls</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">()) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        @trigger_error(%s, E_USER_DEPRECATED);</span><span class="s0">\n\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getDeprecationMessage</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedDefinitions </span><span class="s0">as </span><span class="s8">$def</span><span class="s1">) {</span>
                    <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getClasses</span><span class="s1">(</span><span class="s8">$def</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$class</span><span class="s1">) {</span>
                        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">preload</span><span class="s1">[</span><span class="s8">$class</span><span class="s1">] = </span><span class="s8">$class</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()-&gt;</span><span class="s3">isProxyCandidate</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s8">$factoryCode </span><span class="s1">= </span><span class="s8">$asFile </span><span class="s1">? (</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">() ? </span><span class="s7">&quot;</span><span class="s0">\$</span><span class="s7">this-&gt;load('%s.php', false)&quot; </span><span class="s1">: </span><span class="s7">'$this-&gt;factories[%2$s](false)'</span><span class="s1">) : </span><span class="s7">'$this-&gt;%s(false)'</span><span class="s0">;</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()-&gt;</span><span class="s3">getProxyFactoryCode</span><span class="s1">(</span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$id</span><span class="s0">, </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">$factoryCode</span><span class="s0">, </span><span class="s8">$methodName</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)))</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addServiceInclude</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineService</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$asFile</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s3">array_map</span><span class="s1">(</span><span class="s0">function </span><span class="s1">(</span><span class="s8">$line</span><span class="s1">) { </span><span class="s0">return </span><span class="s8">$line </span><span class="s1">? </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$line</span><span class="s0">, </span><span class="s9">8</span><span class="s1">) : </span><span class="s8">$line</span><span class="s0">; </span><span class="s1">}</span><span class="s0">, </span><span class="s3">explode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)))</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;    }</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedDefinitions </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceCalls </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s1">[</span><span class="s8">$file</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">]</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addInlineVariables</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s0">, </span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, array </span><span class="s8">$arguments</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$forConstructor</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$arguments </span><span class="s0">as </span><span class="s8">$argument</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$argument</span><span class="s1">)) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineVariables</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$argument</span><span class="s0">, </span><span class="s8">$forConstructor</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$argument </span><span class="s0">instanceof </span><span class="s3">Reference</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineReference</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$argument</span><span class="s0">, </span><span class="s8">$forConstructor</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$argument </span><span class="s0">instanceof </span><span class="s3">Definition</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineService</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$argument</span><span class="s0">, </span><span class="s8">$forConstructor</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addInlineReference</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s0">, </span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$targetId</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$forConstructor</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">while </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasAlias</span><span class="s1">(</span><span class="s8">$targetId</span><span class="s1">)) {</span>
            <span class="s8">$targetId </span><span class="s1">= (string) </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAlias</span><span class="s1">(</span><span class="s8">$targetId</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">list</span><span class="s1">(</span><span class="s8">$callCount</span><span class="s0">, </span><span class="s8">$behavior</span><span class="s1">) = </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceCalls</span><span class="s1">[</span><span class="s8">$targetId</span><span class="s1">]</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$id </span><span class="s1">=== </span><span class="s8">$targetId</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineService</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">'service_container' </span><span class="s1">=== </span><span class="s8">$targetId </span><span class="s1">|| </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">[</span><span class="s8">$targetId</span><span class="s1">])) {</span>
            <span class="s0">return </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$hasSelfRef </span><span class="s1">= </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">][</span><span class="s8">$targetId</span><span class="s1">]) &amp;&amp; !</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">[</span><span class="s8">$definition</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$hasSelfRef </span><span class="s1">&amp;&amp; !</span><span class="s8">$forConstructor </span><span class="s1">&amp;&amp; !</span><span class="s8">$forConstructor </span><span class="s1">= !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">][</span><span class="s8">$targetId</span><span class="s1">]) {</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineService</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">[</span><span class="s8">$targetId</span><span class="s1">]) || (</span><span class="s9">2 </span><span class="s1">&gt; </span><span class="s8">$callCount </span><span class="s1">&amp;&amp; (!</span><span class="s8">$hasSelfRef </span><span class="s1">|| !</span><span class="s8">$forConstructor</span><span class="s1">))) {</span>
            <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$name </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getNextVariableName</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">[</span><span class="s8">$targetId</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Variable</span><span class="s1">(</span><span class="s8">$name</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s8">$reference </span><span class="s1">= </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">EXCEPTION_ON_INVALID_REFERENCE </span><span class="s1">&gt;= </span><span class="s8">$behavior </span><span class="s1">? </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">$targetId</span><span class="s0">, </span><span class="s8">$behavior</span><span class="s1">) : </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">%s = %s;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$name</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getServiceCall</span><span class="s1">(</span><span class="s8">$targetId</span><span class="s0">, </span><span class="s8">$reference</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$hasSelfRef </span><span class="s1">|| !</span><span class="s8">$forConstructor</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s3">&lt;&lt;&lt;'EOTXT' 
</span>
        <span class="s7">if (isset($this-&gt;%s[%s])) { 
            return $this-&gt;%1$s[%2$s]; 
        } 
</span>
<span class="s3">EOTXT</span>
            <span class="s0">,</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'services' </span><span class="s1">: </span><span class="s7">'privates'</span><span class="s0">,</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span>
        <span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addInlineService</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s0">, </span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, </span><span class="s3">Definition </span><span class="s8">$inlineDef </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$forConstructor </span><span class="s1">= </span><span class="s3">true</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$isSimpleInstance </span><span class="s1">= </span><span class="s8">$isRootInstance </span><span class="s1">= </span><span class="s3">null </span><span class="s1">=== </span><span class="s8">$inlineDef</span><span class="s1">) {</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceCalls </span><span class="s0">as </span><span class="s8">$targetId </span><span class="s1">=&gt; </span><span class="s0">list</span><span class="s1">(</span><span class="s8">$callCount</span><span class="s0">, </span><span class="s8">$behavior</span><span class="s0">, </span><span class="s8">$byConstructor</span><span class="s1">)) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s8">$byConstructor </span><span class="s1">&amp;&amp; </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">][</span><span class="s8">$targetId</span><span class="s1">]) &amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">circularReferences</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">][</span><span class="s8">$targetId</span><span class="s1">]) {</span>
                    <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineReference</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$targetId</span><span class="s0">, </span><span class="s8">$forConstructor</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">[</span><span class="s8">$inlineDef </span><span class="s1">= </span><span class="s8">$inlineDef </span><span class="s1">?: </span><span class="s8">$definition</span><span class="s1">])) {</span>
            <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$arguments </span><span class="s1">= [</span><span class="s8">$inlineDef</span><span class="s1">-&gt;</span><span class="s3">getArguments</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$inlineDef</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">()]</span><span class="s0">;</span>

        <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineVariables</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s0">, </span><span class="s8">$forConstructor</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$arguments </span><span class="s1">= </span><span class="s3">array_filter</span><span class="s1">([</span><span class="s8">$inlineDef</span><span class="s1">-&gt;</span><span class="s3">getProperties</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$inlineDef</span><span class="s1">-&gt;</span><span class="s3">getMethodCalls</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$inlineDef</span><span class="s1">-&gt;</span><span class="s3">getConfigurator</span><span class="s1">()])) {</span>
            <span class="s8">$isSimpleInstance </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$definition </span><span class="s1">!== </span><span class="s8">$inlineDef </span><span class="s1">&amp;&amp; </span><span class="s9">2 </span><span class="s1">&gt; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedDefinitions</span><span class="s1">[</span><span class="s8">$inlineDef</span><span class="s1">]) {</span>
            <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">[</span><span class="s8">$inlineDef</span><span class="s1">])) {</span>
            <span class="s8">$isSimpleInstance </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$name </span><span class="s1">= </span><span class="s8">$definition </span><span class="s1">=== </span><span class="s8">$inlineDef </span><span class="s1">? </span><span class="s7">'instance' </span><span class="s1">: </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getNextVariableName</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">[</span><span class="s8">$inlineDef</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Variable</span><span class="s1">(</span><span class="s8">$name</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">'' </span><span class="s1">!== </span><span class="s8">$code </span><span class="s1">? </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">'instance' </span><span class="s1">=== </span><span class="s8">$name</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addServiceInstance</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$isSimpleInstance</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addNewInstance</span><span class="s1">(</span><span class="s8">$inlineDef</span><span class="s0">, </span><span class="s7">'        $'</span><span class="s1">.</span><span class="s8">$name</span><span class="s1">.</span><span class="s7">' = '</span><span class="s0">, </span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">'' </span><span class="s1">!== </span><span class="s8">$inline </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineVariables</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s1">.</span><span class="s8">$inline</span><span class="s1">.</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$arguments </span><span class="s1">&amp;&amp; </span><span class="s7">'instance' </span><span class="s1">=== </span><span class="s8">$name</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addServiceProperties</span><span class="s1">(</span><span class="s8">$inlineDef</span><span class="s0">, </span><span class="s8">$name</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addServiceMethodCalls</span><span class="s1">(</span><span class="s8">$inlineDef</span><span class="s0">, </span><span class="s8">$name</span><span class="s0">, </span><span class="s1">!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()-&gt;</span><span class="s3">isProxyCandidate</span><span class="s1">(</span><span class="s8">$inlineDef</span><span class="s1">) &amp;&amp; </span><span class="s8">$inlineDef</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">() &amp;&amp; !</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]) ? </span><span class="s8">$id </span><span class="s1">: </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addServiceConfigurator</span><span class="s1">(</span><span class="s8">$inlineDef</span><span class="s0">, </span><span class="s8">$name</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$isRootInstance </span><span class="s1">&amp;&amp; !</span><span class="s8">$isSimpleInstance</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;</span><span class="s0">\n        </span><span class="s7">return </span><span class="s0">\$</span><span class="s7">instance;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addServices</span><span class="s1">(</span><span class="s0">array </span><span class="s1">&amp;</span><span class="s8">$services </span><span class="s1">= </span><span class="s3">null</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$publicServices </span><span class="s1">= </span><span class="s8">$privateServices </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s8">$definitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s8">$definitions</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definitions </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isSynthetic</span><span class="s1">()) {</span>
                <span class="s8">$services</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addService</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$services</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s3">null</span><span class="s0">;</span>

                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getClasses</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$class</span><span class="s1">) {</span>
                    <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">preload</span><span class="s1">[</span><span class="s8">$class</span><span class="s1">] = </span><span class="s8">$class</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definitions </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!(</span><span class="s0">list</span><span class="s1">(</span><span class="s8">$file</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">) = </span><span class="s8">$services</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]) || </span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$file</span><span class="s1">) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">()) {</span>
                <span class="s8">$publicServices </span><span class="s1">.= </span><span class="s8">$code</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isTrivialInstance</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">) || </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">locatedIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$privateServices </span><span class="s1">.= </span><span class="s8">$code</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$publicServices</span><span class="s1">.</span><span class="s8">$privateServices</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">generateServiceFiles</span><span class="s1">(</span><span class="s0">array </span><span class="s8">$services</span><span class="s1">): </span><span class="s3">iterable</span>
    <span class="s1">{</span>
        <span class="s8">$definitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s8">$definitions</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definitions </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">((</span><span class="s0">list</span><span class="s1">(</span><span class="s8">$file</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">) = </span><span class="s8">$services</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]) &amp;&amp; </span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$file </span><span class="s1">&amp;&amp; (</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() || !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isTrivialInstance</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">) || </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">locatedIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]))) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">()) {</span>
                    <span class="s8">$i </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$code</span><span class="s0">, </span><span class="s7">&quot;</span><span class="s0">\n\n</span><span class="s7">include_once &quot;</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s8">$i </span><span class="s1">&amp;&amp; </span><span class="s3">false </span><span class="s1">!== </span><span class="s8">$i </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$code</span><span class="s0">, </span><span class="s7">&quot;</span><span class="s0">\n\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s9">2 </span><span class="s1">+ </span><span class="s8">$i</span><span class="s1">)) {</span>
                        <span class="s8">$code </span><span class="s1">= [</span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$code</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s9">2 </span><span class="s1">+ </span><span class="s8">$i</span><span class="s1">)</span><span class="s0">, </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$code</span><span class="s0">, </span><span class="s9">2 </span><span class="s1">+ </span><span class="s8">$i</span><span class="s1">)]</span><span class="s0">;</span>
                    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                        <span class="s8">$code </span><span class="s1">= [</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">]</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s8">$code</span><span class="s1">[</span><span class="s9">1</span><span class="s1">] = </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s3">array_map</span><span class="s1">(</span><span class="s0">function </span><span class="s1">(</span><span class="s8">$line</span><span class="s1">) { </span><span class="s0">return </span><span class="s8">$line </span><span class="s1">? </span><span class="s7">'    '</span><span class="s1">.</span><span class="s8">$line </span><span class="s1">: </span><span class="s8">$line</span><span class="s0">; </span><span class="s1">}</span><span class="s0">, </span><span class="s3">explode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])))</span><span class="s0">;</span>
                    <span class="s8">$factory </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;factories%s[%s]'</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'' </span><span class="s1">: </span><span class="s7">&quot;['service_container']&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
                    <span class="s8">$lazyloadInitialization </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isLazy</span><span class="s1">() ? </span><span class="s7">'$lazyLoad = true' </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>

                    <span class="s8">$code</span><span class="s1">[</span><span class="s9">1</span><span class="s1">] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;%s = function (%s) {</span><span class="s0">\n</span><span class="s7">%s};</span><span class="s0">\n\n</span><span class="s7">return %1</span><span class="s0">\$</span><span class="s7">s();</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$factory</span><span class="s0">, </span><span class="s8">$lazyloadInitialization</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])</span><span class="s0">;</span>
                    <span class="s8">$code </span><span class="s1">= </span><span class="s8">$code</span><span class="s1">[</span><span class="s9">0</span><span class="s1">].</span><span class="s8">$code</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">yield </span><span class="s8">$file </span><span class="s1">=&gt; </span><span class="s8">$code</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addNewInstance</span><span class="s1">(</span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$return </span><span class="s1">= </span><span class="s7">''</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$id </span><span class="s1">= </span><span class="s3">null</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$tail </span><span class="s1">= </span><span class="s8">$return </span><span class="s1">? </span><span class="s7">&quot;;</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">BaseServiceLocator</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=== </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getClass</span><span class="s1">() &amp;&amp; </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">hasTag</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceLocatorTag</span><span class="s1">)) {</span>
            <span class="s8">$arguments </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$argument</span><span class="s1">) {</span>
                <span class="s8">$arguments</span><span class="s1">[</span><span class="s8">$k</span><span class="s1">] = </span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getValues</span><span class="s1">()[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s8">$return</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s0">new </span><span class="s3">ServiceLocatorArgument</span><span class="s1">(</span><span class="s8">$arguments</span><span class="s1">)).</span><span class="s8">$tail</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$arguments </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getArguments</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$value</span><span class="s1">) {</span>
            <span class="s8">$arguments</span><span class="s1">[] = </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">()) {</span>
            <span class="s8">$callable </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">()</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">)) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s7">'/^[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*$/'</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])) {</span>
                    <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'Cannot dump definition because of invalid factory method (%s).'</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">] ?: </span><span class="s7">'n/a'</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">Reference</span>
                    <span class="s1">|| (</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">Definition </span><span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">-&gt;</span><span class="s3">contains</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]))) {</span>
                    <span class="s0">return </span><span class="s8">$return</span><span class="s1">.</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s-&gt;%s(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$arguments </span><span class="s1">? </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s1">) : </span><span class="s7">''</span><span class="s1">).</span><span class="s8">$tail</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s8">$class </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s2">// If the class is a string we can optimize away</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">&quot;'&quot;</span><span class="s1">) &amp;&amp; </span><span class="s3">false </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'$'</span><span class="s1">)) {</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s7">&quot;''&quot; </span><span class="s1">=== </span><span class="s8">$class</span><span class="s1">) {</span>
                        <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'Cannot dump definition: %s service is defined to be created by a factory but is missing the service reference, did you forget to define the factory service id or class?'</span><span class="s0">, </span><span class="s8">$id </span><span class="s1">? </span><span class="s7">'The &quot;'</span><span class="s1">.</span><span class="s8">$id</span><span class="s1">.</span><span class="s7">'&quot;' </span><span class="s1">: </span><span class="s7">'inline'</span><span class="s1">))</span><span class="s0">;</span>
                    <span class="s1">}</span>

                    <span class="s0">return </span><span class="s8">$return</span><span class="s1">.</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s::%s(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpLiteralClass</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$arguments </span><span class="s1">? </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s1">) : </span><span class="s7">''</span><span class="s1">).</span><span class="s8">$tail</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'new '</span><span class="s1">)) {</span>
                    <span class="s0">return </span><span class="s8">$return</span><span class="s1">.</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'(%s)-&gt;%s(%s)'</span><span class="s0">, </span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$arguments </span><span class="s1">? </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s1">) : </span><span class="s7">''</span><span class="s1">).</span><span class="s8">$tail</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">return </span><span class="s8">$return</span><span class="s1">.</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;[%s, '%s'](%s)&quot;</span><span class="s0">, </span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$callable</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$arguments </span><span class="s1">? </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s1">) : </span><span class="s7">''</span><span class="s1">).</span><span class="s8">$tail</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s8">$return</span><span class="s1">.</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpLiteralClass</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$callable</span><span class="s1">))</span><span class="s0">, </span><span class="s8">$arguments </span><span class="s1">? </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s1">) : </span><span class="s7">''</span><span class="s1">).</span><span class="s8">$tail</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s8">$class </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getClass</span><span class="s1">()) {</span>
            <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s7">'Cannot dump definitions which have no class nor factory.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$return</span><span class="s1">.</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'new %s(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpLiteralClass</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">))</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$arguments</span><span class="s1">)).</span><span class="s8">$tail</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">startClass</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$class</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$baseClass</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$namespaceLine </span><span class="s1">= !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">namespace </span><span class="s1">? </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">namespace </span><span class="s1">{</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">namespace</span><span class="s1">}</span><span class="s7">;</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s8">$code </span><span class="s1">= </span><span class="s3">&lt;&lt;&lt;EOF 
</span><span class="s7">&lt;?php 
</span><span class="s8">$namespaceLine</span>
<span class="s7">use Symfony\Component\DependencyInjection\Argument\RewindableGenerator; 
use Symfony\Component\DependencyInjection\ContainerInterface; 
use Symfony\Component\DependencyInjection\Container; 
use Symfony\Component\DependencyInjection\Exception\InvalidArgumentException; 
use Symfony\Component\DependencyInjection\Exception\LogicException; 
use Symfony\Component\DependencyInjection\Exception\RuntimeException; 
use Symfony\Component\DependencyInjection\ParameterBag\FrozenParameterBag; 
use Symfony\Component\DependencyInjection\ParameterBag\ParameterBagInterface; 
 
/*</span><span class="s1">{</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">docStar</span><span class="s1">}</span>
 <span class="s7">* This class has been auto-generated 
 * by the Symfony Dependency Injection Component. 
 * 
 * @final 
 */ 
class </span><span class="s8">$class </span><span class="s7">extends </span><span class="s8">$baseClass</span>
<span class="s7">{ 
    private \$parameters = []; 
 
    public function __construct() 
    { 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s7">'$parameters'</span><span class="s0">, </span><span class="s7">&quot;</span><span class="s0">\$</span><span class="s7">buildParameters;</span><span class="s0">\n    </span><span class="s7">private </span><span class="s0">\$</span><span class="s7">containerDir;</span><span class="s0">\n    </span><span class="s7">private </span><span class="s0">\$</span><span class="s7">parameters&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s7">'__construct()'</span><span class="s0">, </span><span class="s7">'__construct(array $buildParameters = [], $containerDir = __DIR__)'</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;buildParameters = </span><span class="s0">\$</span><span class="s7">buildParameters;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;containerDir = </span><span class="s0">\$</span><span class="s7">containerDir;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s7">'$parameters'</span><span class="s0">, </span><span class="s7">&quot;</span><span class="s0">\$</span><span class="s7">targetDir;</span><span class="s0">\n    </span><span class="s7">private </span><span class="s0">\$</span><span class="s7">parameters&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">'        $this-&gt;targetDir = </span><span class="s0">\\</span><span class="s7">dirname($containerDir);'</span><span class="s1">.</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">Container</span><span class="s1">::</span><span class="s0">class </span><span class="s1">!== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">baseClass</span><span class="s1">) {</span>
            <span class="s8">$r </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getReflectionClass</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">baseClass</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$r</span>
                <span class="s1">&amp;&amp; (</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$constructor </span><span class="s1">= </span><span class="s8">$r</span><span class="s1">-&gt;</span><span class="s3">getConstructor</span><span class="s1">())</span>
                <span class="s1">&amp;&amp; </span><span class="s9">0 </span><span class="s1">=== </span><span class="s8">$constructor</span><span class="s1">-&gt;</span><span class="s3">getNumberOfRequiredParameters</span><span class="s1">()</span>
                <span class="s1">&amp;&amp; </span><span class="s3">Container</span><span class="s1">::</span><span class="s0">class </span><span class="s1">!== </span><span class="s8">$constructor</span><span class="s1">-&gt;</span><span class="s3">getDeclaringClass</span><span class="s1">()-&gt;</span><span class="s3">name</span>
            <span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;        parent::__construct();</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;parameterBag = null;</span><span class="s0">\n\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getParameterBag</span><span class="s1">()-&gt;</span><span class="s3">all</span><span class="s1">()) {</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;parameters = </span><span class="s0">\$</span><span class="s7">this-&gt;getDefaultParameters();</span><span class="s0">\n\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;services = </span><span class="s0">\$</span><span class="s7">this-&gt;privates = [];</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>

        <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addSyntheticIds</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addMethodMap</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories </span><span class="s1">? </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addFileMap</span><span class="s1">() : </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addAliases</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addInlineRequires</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s3">&lt;&lt;&lt;EOF 
    </span><span class="s7">} 
 
    public function compile(): void 
    { 
        throw new LogicException('You cannot compile a dumped container that was already compiled.'); 
    } 
 
    public function isCompiled(): bool 
    { 
        return true; 
    } 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s8">$code </span><span class="s1">.= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addRemovedIds</span><span class="s1">()</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s3">&lt;&lt;&lt;EOF 
</span>
    <span class="s7">protected function load(\$file, \$lazyLoad = true) 
    { 
        return require \$this-&gt;containerDir.\\DIRECTORY_SEPARATOR.\$file; 
    } 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$proxyDumper </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$proxyDumper</span><span class="s1">-&gt;</span><span class="s3">isProxyCandidate</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories</span><span class="s1">) {</span>
                <span class="s8">$proxyLoader </span><span class="s1">= </span><span class="s7">'$this-&gt;load(&quot;{$class}.php&quot;)'</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">namespace </span><span class="s1">|| </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories</span><span class="s1">) {</span>
                <span class="s8">$proxyLoader </span><span class="s1">= </span><span class="s7">'class_alias(__NAMESPACE__.&quot;</span><span class="s0">\\\\</span><span class="s7">$class&quot;, $class, false)'</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$proxyLoader </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$proxyLoader</span><span class="s1">) {</span>
                <span class="s8">$proxyLoader </span><span class="s1">= </span><span class="s7">&quot;class_exists(</span><span class="s0">\$</span><span class="s7">class, false) || </span><span class="s1">{</span><span class="s8">$proxyLoader</span><span class="s1">}</span><span class="s7">;</span><span class="s0">\n\n        </span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s3">&lt;&lt;&lt;EOF 
</span>
    <span class="s7">protected function createProxy(\$class, \Closure \$factory) 
    { 
        </span><span class="s1">{</span><span class="s8">$proxyLoader</span><span class="s1">}</span><span class="s7">return \$factory(); 
    } 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
            <span class="s0">break;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addSyntheticIds</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s8">$definitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s8">$definitions</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definitions </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isSynthetic</span><span class="s1">() &amp;&amp; </span><span class="s7">'service_container' </span><span class="s1">!== </span><span class="s8">$id</span><span class="s1">) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">'            '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">).</span><span class="s7">&quot; =&gt; true,</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code </span><span class="s1">? </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;syntheticIds = [</span><span class="s0">\n</span><span class="s1">{</span><span class="s8">$code</span><span class="s1">}        </span><span class="s7">];</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addRemovedIds</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$ids </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getRemovedIds</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">()) {</span>
                <span class="s8">$ids</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$ids</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s7">&quot;require </span><span class="s0">\$</span><span class="s7">this-&gt;containerDir.</span><span class="s0">\\</span><span class="s7">DIRECTORY_SEPARATOR.'removed-ids.php'&quot;</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
            <span class="s8">$ids </span><span class="s1">= </span><span class="s3">array_keys</span><span class="s1">(</span><span class="s8">$ids</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s3">sort</span><span class="s1">(</span><span class="s8">$ids</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$ids </span><span class="s0">as </span><span class="s8">$id</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s3">FileLoader</span><span class="s1">::</span><span class="s3">ANONYMOUS_ID_REGEXP</span><span class="s0">, </span><span class="s8">$id</span><span class="s1">)) {</span>
                    <span class="s0">continue;</span>
                <span class="s1">}</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">'            '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">).</span><span class="s7">&quot; =&gt; true,</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$code </span><span class="s1">= </span><span class="s7">&quot;[</span><span class="s0">\n</span><span class="s1">{</span><span class="s8">$code</span><span class="s1">}        </span><span class="s7">]&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">&lt;&lt;&lt;EOF 
</span>
    <span class="s7">public function getRemovedIds(): array 
    { 
        return </span><span class="s1">{</span><span class="s8">$code</span><span class="s1">}</span><span class="s7">; 
    } 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addMethodMap</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s8">$definitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s8">$definitions</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definitions </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isSynthetic</span><span class="s1">() &amp;&amp; </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() &amp;&amp; (!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">|| </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories </span><span class="s1">|| </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isHotPath</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">))) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s7">'            '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">).</span><span class="s7">' =&gt; '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)).</span><span class="s7">&quot;,</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s8">$aliases </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAliases</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$aliases </span><span class="s0">as </span><span class="s8">$alias </span><span class="s1">=&gt; </span><span class="s8">$id</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$id</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">()) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">'            '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$alias</span><span class="s1">).</span><span class="s7">' =&gt; '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$alias</span><span class="s1">)).</span><span class="s7">&quot;,</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code </span><span class="s1">? </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;methodMap = [</span><span class="s0">\n</span><span class="s1">{</span><span class="s8">$code</span><span class="s1">}        </span><span class="s7">];</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addFileMap</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s8">$definitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinitions</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s8">$definitions</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$definitions </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isSynthetic</span><span class="s1">() &amp;&amp; </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() &amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isHotPath</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;            %s =&gt; '%s.php',</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code </span><span class="s1">? </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;fileMap = [</span><span class="s0">\n</span><span class="s1">{</span><span class="s8">$code</span><span class="s1">}        </span><span class="s7">];</span><span class="s0">\n</span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addAliases</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$aliases </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAliases</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s7">&quot;</span><span class="s0">\n        \$</span><span class="s7">this-&gt;aliases = [];</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$code </span><span class="s1">= </span><span class="s7">&quot;        </span><span class="s0">\$</span><span class="s7">this-&gt;aliases = [</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s8">$aliases</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$aliases </span><span class="s0">as </span><span class="s8">$alias </span><span class="s1">=&gt; </span><span class="s8">$id</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$id</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">()) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$id</span><span class="s0">;</span>
            <span class="s0">while </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$aliases</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$aliases</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s7">'            '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$alias</span><span class="s1">).</span><span class="s7">' =&gt; '</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">).</span><span class="s7">&quot;,</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s1">.</span><span class="s7">&quot;        ];</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addDeprecatedAliases</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s8">$aliases </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAliases</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$aliases </span><span class="s0">as </span><span class="s8">$alias </span><span class="s1">=&gt; </span><span class="s8">$definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">()) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s8">$public </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'public' </span><span class="s1">: </span><span class="s7">'private'</span><span class="s0">;</span>
            <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$definition</span><span class="s0">;</span>
            <span class="s8">$methodNameAlias </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$alias</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$idExported </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$messageExported </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getDeprecationMessage</span><span class="s1">(</span><span class="s8">$alias</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s8">$code </span><span class="s1">.= </span><span class="s3">&lt;&lt;&lt;EOF 
</span>
    <span class="s7">/*</span><span class="s1">{</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">docStar</span><span class="s1">}</span>
     <span class="s7">* Gets the </span><span class="s8">$public </span><span class="s7">'</span><span class="s8">$alias</span><span class="s7">' alias. 
     * 
     * @return object The &quot;</span><span class="s8">$id</span><span class="s7">&quot; service. 
     */ 
    protected function </span><span class="s1">{</span><span class="s8">$methodNameAlias</span><span class="s1">}</span><span class="s7">() 
    { 
        @trigger_error(</span><span class="s8">$messageExported</span><span class="s7">, E_USER_DEPRECATED); 
 
        return \$this-&gt;get(</span><span class="s8">$idExported</span><span class="s7">); 
    } 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addInlineRequires</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">hotPathTag </span><span class="s1">|| !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineRequires</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$lineage </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">findTaggedServiceIds</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">hotPathTag</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$id </span><span class="s1">=&gt; </span><span class="s8">$tags</span><span class="s1">) {</span>
            <span class="s8">$definition </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getProxyDumper</span><span class="s1">()-&gt;</span><span class="s3">isProxyCandidate</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s8">$inlinedDefinitions </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getDefinitionsFromArguments</span><span class="s1">([</span><span class="s8">$definition</span><span class="s1">])</span><span class="s0">;</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$inlinedDefinitions </span><span class="s0">as </span><span class="s8">$def</span><span class="s1">) {</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getClasses</span><span class="s1">(</span><span class="s8">$def</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$class</span><span class="s1">) {</span>
                    <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">collectLineage</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s8">$lineage</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s8">$code </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$lineage </span><span class="s0">as </span><span class="s8">$file</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedRequires</span><span class="s1">[</span><span class="s8">$file</span><span class="s1">])) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlinedRequires</span><span class="s1">[</span><span class="s8">$file</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
                <span class="s8">$code </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n            </span><span class="s7">include_once %s;&quot;</span><span class="s0">, </span><span class="s8">$file</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$code </span><span class="s1">? </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n        \$</span><span class="s7">this-&gt;privates['service_container'] = function () {%s</span><span class="s0">\n        </span><span class="s7">};</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">) : </span><span class="s7">''</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">addDefaultParametersMethod</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getParameterBag</span><span class="s1">()-&gt;</span><span class="s3">all</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$php </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$dynamicPhp </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getParameterBag</span><span class="s1">()-&gt;</span><span class="s3">all</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$key </span><span class="s1">=&gt; </span><span class="s8">$value</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$key </span><span class="s1">!== </span><span class="s8">$resolvedKey </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s8">$key</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'Parameter name cannot use env parameters: &quot;%s&quot;.'</span><span class="s0">, </span><span class="s8">$resolvedKey</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s8">$export </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportParameters</span><span class="s1">([</span><span class="s8">$value</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s8">$export </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(</span><span class="s7">'0 =&gt; '</span><span class="s0">, </span><span class="s3">substr</span><span class="s1">(</span><span class="s3">rtrim</span><span class="s1">(</span><span class="s8">$export</span><span class="s0">, </span><span class="s7">&quot; ]</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s9">2</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">)</span><span class="s0">, </span><span class="s9">2</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s7">&quot;/</span><span class="s0">\\\$</span><span class="s7">this-&gt;(?:getEnv\('(?:\w++:)*+\w++'\)|targetDir\.'')/&quot;</span><span class="s0">, </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])) {</span>
                <span class="s8">$dynamicPhp</span><span class="s1">[</span><span class="s8">$key</span><span class="s1">] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%scase %s: $value = %s; break;'</span><span class="s0">, </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$key</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$php</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s%s =&gt; %s,'</span><span class="s0">, </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$key</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s8">$parameters </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;[</span><span class="s0">\n</span><span class="s7">%s</span><span class="s0">\n</span><span class="s7">%s]&quot;</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$php</span><span class="s1">)</span><span class="s0">, </span><span class="s3">str_repeat</span><span class="s1">(</span><span class="s7">' '</span><span class="s0">, </span><span class="s9">8</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s8">$code </span><span class="s1">= </span><span class="s3">&lt;&lt;&lt;'EOF' 
</span>
    <span class="s7">public function getParameter(string $name) 
    { 
        if (isset($this-&gt;buildParameters[$name])) { 
            return $this-&gt;buildParameters[$name]; 
        } 
 
        if (!(isset($this-&gt;parameters[$name]) || isset($this-&gt;loadedDynamicParameters[$name]) || array_key_exists($name, $this-&gt;parameters))) { 
            throw new InvalidArgumentException(sprintf('The parameter &quot;%s&quot; must be defined.', $name)); 
        } 
        if (isset($this-&gt;loadedDynamicParameters[$name])) { 
            return $this-&gt;loadedDynamicParameters[$name] ? $this-&gt;dynamicParameters[$name] : $this-&gt;getDynamicParameter($name); 
        } 
 
        return $this-&gt;parameters[$name]; 
    } 
 
    public function hasParameter(string $name): bool 
    { 
        if (isset($this-&gt;buildParameters[$name])) { 
            return true; 
        } 
 
        return isset($this-&gt;parameters[$name]) || isset($this-&gt;loadedDynamicParameters[$name]) || array_key_exists($name, $this-&gt;parameters); 
    } 
 
    public function setParameter(string $name, $value): void 
    { 
        throw new LogicException('Impossible to call set() on a frozen ParameterBag.'); 
    } 
 
    public function getParameterBag(): ParameterBagInterface 
    { 
        if (null === $this-&gt;parameterBag) { 
            $parameters = $this-&gt;parameters; 
            foreach ($this-&gt;loadedDynamicParameters as $name =&gt; $loaded) { 
                $parameters[$name] = $loaded ? $this-&gt;dynamicParameters[$name] : $this-&gt;getDynamicParameter($name); 
            } 
            foreach ($this-&gt;buildParameters as $name =&gt; $value) { 
                $parameters[$name] = $value; 
            } 
            $this-&gt;parameterBag = new FrozenParameterBag($parameters); 
        } 
 
        return $this-&gt;parameterBag; 
    } 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles</span><span class="s1">) {</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">preg_replace</span><span class="s1">(</span><span class="s7">'/^.*buildParameters.*\n.*\n.*\n\n?/m'</span><span class="s0">, </span><span class="s7">''</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$dynamicPhp</span><span class="s1">) {</span>
            <span class="s8">$loadedDynamicParameters </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportParameters</span><span class="s1">(</span><span class="s3">array_combine</span><span class="s1">(</span><span class="s3">array_keys</span><span class="s1">(</span><span class="s8">$dynamicPhp</span><span class="s1">)</span><span class="s0">, </span><span class="s3">array_fill</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s1">\</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$dynamicPhp</span><span class="s1">)</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">, </span><span class="s7">''</span><span class="s0">, </span><span class="s9">8</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$getDynamicParameter </span><span class="s1">= </span><span class="s3">&lt;&lt;&lt;'EOF' 
        </span><span class="s7">switch ($name) { 
%s 
            default: throw new InvalidArgumentException(sprintf('The dynamic parameter &quot;%%s&quot; must be defined.', $name)); 
        } 
        $this-&gt;loadedDynamicParameters[$name] = true; 
 
        return $this-&gt;dynamicParameters[$name] = $value;</span>
<span class="s3">EOF</span><span class="s0">;</span>
            <span class="s8">$getDynamicParameter </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">$getDynamicParameter</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$dynamicPhp</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$loadedDynamicParameters </span><span class="s1">= </span><span class="s7">'[]'</span><span class="s0">;</span>
            <span class="s8">$getDynamicParameter </span><span class="s1">= </span><span class="s3">str_repeat</span><span class="s1">(</span><span class="s7">' '</span><span class="s0">, </span><span class="s9">8</span><span class="s1">).</span><span class="s7">'throw new InvalidArgumentException(sprintf(</span><span class="s0">\'</span><span class="s7">The dynamic parameter &quot;%s&quot; must be defined.</span><span class="s0">\'</span><span class="s7">, $name));'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$code </span><span class="s1">.= </span><span class="s3">&lt;&lt;&lt;EOF 
</span>
    <span class="s7">private \$loadedDynamicParameters = </span><span class="s1">{</span><span class="s8">$loadedDynamicParameters</span><span class="s1">}</span><span class="s7">; 
    private \$dynamicParameters = []; 
 
    private function getDynamicParameter(string \$name) 
    { 
</span><span class="s1">{</span><span class="s8">$getDynamicParameter</span><span class="s1">}</span>
    <span class="s7">} 
 
    protected function getDefaultParameters(): array 
    { 
        return </span><span class="s8">$parameters</span><span class="s7">; 
    } 
</span>
<span class="s3">EOF</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">InvalidArgumentException</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">exportParameters</span><span class="s1">(</span><span class="s0">array </span><span class="s8">$parameters</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$path </span><span class="s1">= </span><span class="s7">''</span><span class="s0">, </span><span class="s3">int </span><span class="s8">$indent </span><span class="s1">= </span><span class="s9">12</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$php </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$parameters </span><span class="s0">as </span><span class="s8">$key </span><span class="s1">=&gt; </span><span class="s8">$value</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)) {</span>
                <span class="s8">$value </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportParameters</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$path</span><span class="s1">.</span><span class="s7">'/'</span><span class="s1">.</span><span class="s8">$key</span><span class="s0">, </span><span class="s8">$indent </span><span class="s1">+ </span><span class="s9">4</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">ArgumentInterface</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'You cannot dump a container with parameters that contain special arguments. &quot;%s&quot; found in &quot;%s&quot;.'</span><span class="s0">, </span><span class="s1">\</span><span class="s3">get_class</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$path</span><span class="s1">.</span><span class="s7">'/'</span><span class="s1">.</span><span class="s8">$key</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Variable</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'You cannot dump a container with parameters that contain variable references. Variable &quot;%s&quot; found in &quot;%s&quot;.'</span><span class="s0">, </span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$path</span><span class="s1">.</span><span class="s7">'/'</span><span class="s1">.</span><span class="s8">$key</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Definition</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'You cannot dump a container with parameters that contain service definitions. Definition for &quot;%s&quot; found in &quot;%s&quot;.'</span><span class="s0">, </span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getClass</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$path</span><span class="s1">.</span><span class="s7">'/'</span><span class="s1">.</span><span class="s8">$key</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Reference</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'You cannot dump a container with parameters that contain references to other services (reference to service &quot;%s&quot; found in &quot;%s&quot;).'</span><span class="s0">, </span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$path</span><span class="s1">.</span><span class="s7">'/'</span><span class="s1">.</span><span class="s8">$key</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Expression</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'You cannot dump a container with parameters that contain expressions. Expression &quot;%s&quot; found in &quot;%s&quot;.'</span><span class="s0">, </span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$path</span><span class="s1">.</span><span class="s7">'/'</span><span class="s1">.</span><span class="s8">$key</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$value </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$php</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s%s =&gt; %s,'</span><span class="s0">, </span><span class="s3">str_repeat</span><span class="s1">(</span><span class="s7">' '</span><span class="s0">, </span><span class="s8">$indent</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$key</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;[</span><span class="s0">\n</span><span class="s7">%s</span><span class="s0">\n</span><span class="s7">%s]&quot;</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$php</span><span class="s1">)</span><span class="s0">, </span><span class="s3">str_repeat</span><span class="s1">(</span><span class="s7">' '</span><span class="s0">, </span><span class="s8">$indent </span><span class="s1">- </span><span class="s9">4</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">endClass</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addThrow</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">&lt;&lt;&lt;'EOF' 
</span>
    <span class="s7">protected function throw($message) 
    { 
        throw new RuntimeException($message); 
    } 
} 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">&lt;&lt;&lt;'EOF' 
</span><span class="s7">} 
</span>
<span class="s3">EOF</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">wrapServiceConditionals</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s3">string </span><span class="s8">$code</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$condition </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getServiceConditionals</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s2">// re-indent the wrapped code</span>
        <span class="s8">$code </span><span class="s1">= </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s3">array_map</span><span class="s1">(</span><span class="s0">function </span><span class="s1">(</span><span class="s8">$line</span><span class="s1">) { </span><span class="s0">return </span><span class="s8">$line </span><span class="s1">? </span><span class="s7">'    '</span><span class="s1">.</span><span class="s8">$line </span><span class="s1">: </span><span class="s8">$line</span><span class="s0">; </span><span class="s1">}</span><span class="s0">, </span><span class="s3">explode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)))</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        if (%s) {</span><span class="s0">\n</span><span class="s7">%s        }</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$condition</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getServiceConditionals</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$conditions </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s3">ContainerBuilder</span><span class="s1">::</span><span class="s3">getInitializedConditionals</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$service</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">$service</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s7">'false'</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s8">$conditions</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'isset($this-&gt;%s[%s])'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">$service</span><span class="s1">)-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'services' </span><span class="s1">: </span><span class="s7">'privates'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$service</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s3">ContainerBuilder</span><span class="s1">::</span><span class="s3">getServiceConditionals</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$service</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">$service</span><span class="s1">) &amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">$service</span><span class="s1">)-&gt;</span><span class="s3">isPublic</span><span class="s1">()) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s8">$conditions</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;has(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$service</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$conditions</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">' &amp;&amp; '</span><span class="s0">, </span><span class="s8">$conditions</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getDefinitionsFromArguments</span><span class="s1">(</span><span class="s0">array </span><span class="s8">$arguments</span><span class="s0">, </span><span class="s1">\</span><span class="s3">SplObjectStorage </span><span class="s8">$definitions </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, array </span><span class="s1">&amp;</span><span class="s8">$calls </span><span class="s1">= []</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$byConstructor </span><span class="s1">= </span><span class="s3">null</span><span class="s1">): \</span><span class="s3">SplObjectStorage</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s8">$definitions</span><span class="s1">) {</span>
            <span class="s8">$definitions </span><span class="s1">= </span><span class="s0">new </span><span class="s1">\</span><span class="s3">SplObjectStorage</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$arguments </span><span class="s0">as </span><span class="s8">$argument</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$argument</span><span class="s1">)) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getDefinitionsFromArguments</span><span class="s1">(</span><span class="s8">$argument</span><span class="s0">, </span><span class="s8">$definitions</span><span class="s0">, </span><span class="s8">$calls</span><span class="s0">, </span><span class="s8">$byConstructor</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$argument </span><span class="s0">instanceof </span><span class="s3">Reference</span><span class="s1">) {</span>
                <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$argument</span><span class="s0">;</span>

                <span class="s0">while </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)) {</span>
                    <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$calls</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                    <span class="s8">$calls</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = [</span><span class="s9">0</span><span class="s0">, </span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$byConstructor</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                    <span class="s8">$calls</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">][</span><span class="s9">1</span><span class="s1">] = </span><span class="s3">min</span><span class="s1">(</span><span class="s8">$calls</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">][</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">())</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s1">++</span><span class="s8">$calls</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">][</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s8">$argument </span><span class="s0">instanceof </span><span class="s3">Definition</span><span class="s1">) {</span>
                <span class="s2">// no-op</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$definitions</span><span class="s1">[</span><span class="s8">$argument</span><span class="s1">])) {</span>
                <span class="s8">$definitions</span><span class="s1">[</span><span class="s8">$argument</span><span class="s1">] = </span><span class="s9">1 </span><span class="s1">+ </span><span class="s8">$definitions</span><span class="s1">[</span><span class="s8">$argument</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$definitions</span><span class="s1">[</span><span class="s8">$argument</span><span class="s1">] = </span><span class="s9">1</span><span class="s0">;</span>
                <span class="s8">$arguments </span><span class="s1">= [</span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getArguments</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">()]</span><span class="s0">;</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getDefinitionsFromArguments</span><span class="s1">(</span><span class="s8">$arguments</span><span class="s0">, </span><span class="s8">$definitions</span><span class="s0">, </span><span class="s8">$calls</span><span class="s0">, </span><span class="s3">null </span><span class="s1">=== </span><span class="s8">$byConstructor </span><span class="s1">|| </span><span class="s8">$byConstructor</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s8">$arguments </span><span class="s1">= [</span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getProperties</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getMethodCalls</span><span class="s1">()</span><span class="s0">, </span><span class="s8">$argument</span><span class="s1">-&gt;</span><span class="s3">getConfigurator</span><span class="s1">()]</span><span class="s0">;</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getDefinitionsFromArguments</span><span class="s1">(</span><span class="s8">$arguments</span><span class="s0">, </span><span class="s8">$definitions</span><span class="s0">, </span><span class="s8">$calls</span><span class="s0">, </span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$byConstructor </span><span class="s1">&amp;&amp; </span><span class="s8">$byConstructor</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$definitions</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">RuntimeException</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$interpolate </span><span class="s1">= </span><span class="s3">true</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$value </span><span class="s1">&amp;&amp; </span><span class="s8">$interpolate </span><span class="s1">&amp;&amp; </span><span class="s3">false </span><span class="s1">!== </span><span class="s8">$param </span><span class="s1">= </span><span class="s3">array_search</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getParameterBag</span><span class="s1">()-&gt;</span><span class="s3">all</span><span class="s1">()</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s7">&quot;%</span><span class="s8">$param</span><span class="s7">%&quot;</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s8">$code </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$v</span><span class="s1">) {</span>
                <span class="s8">$code</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'%s =&gt; %s'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$k</span><span class="s0">, </span><span class="s8">$interpolate</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$v</span><span class="s0">, </span><span class="s8">$interpolate</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'[%s]'</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">', '</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">ArgumentInterface</span><span class="s1">) {</span>
            <span class="s8">$scope </span><span class="s1">= [</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>

            <span class="s0">try </span><span class="s1">{</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">ServiceClosureArgument</span><span class="s1">) {</span>
                    <span class="s8">$value </span><span class="s1">= </span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getValues</span><span class="s1">()[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
                    <span class="s8">$code </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$interpolate</span><span class="s1">)</span><span class="s0">;</span>

                    <span class="s8">$returnedType </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">TypedReference</span><span class="s1">) {</span>
                        <span class="s8">$returnedType </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">': %s\%s'</span><span class="s0">, </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">EXCEPTION_ON_INVALID_REFERENCE </span><span class="s1">&gt;= </span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">() ? </span><span class="s7">'' </span><span class="s1">: </span><span class="s7">'?'</span><span class="s0">, </span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getType</span><span class="s1">())</span><span class="s0">;</span>
                    <span class="s1">}</span>

                    <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'return %s;'</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>

                    <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;function ()%s {</span><span class="s0">\n            </span><span class="s7">%s</span><span class="s0">\n        </span><span class="s7">}&quot;</span><span class="s0">, </span><span class="s8">$returnedType</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">IteratorArgument</span><span class="s1">) {</span>
                    <span class="s8">$operands </span><span class="s1">= [</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
                    <span class="s8">$code </span><span class="s1">= []</span><span class="s0">;</span>
                    <span class="s8">$code</span><span class="s1">[] = </span><span class="s7">'new RewindableGenerator(function () {'</span><span class="s0">;</span>

                    <span class="s0">if </span><span class="s1">(!</span><span class="s8">$values </span><span class="s1">= </span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getValues</span><span class="s1">()) {</span>
                        <span class="s8">$code</span><span class="s1">[] = </span><span class="s7">'            return new \EmptyIterator();'</span><span class="s0">;</span>
                    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                        <span class="s8">$countCode </span><span class="s1">= []</span><span class="s0">;</span>
                        <span class="s8">$countCode</span><span class="s1">[] = </span><span class="s7">'function () {'</span><span class="s0">;</span>

                        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$values </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$v</span><span class="s1">) {</span>
                            <span class="s1">(</span><span class="s8">$c </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getServiceConditionals</span><span class="s1">(</span><span class="s8">$v</span><span class="s1">)) ? </span><span class="s8">$operands</span><span class="s1">[] = </span><span class="s7">&quot;(int) (</span><span class="s8">$c</span><span class="s7">)&quot; </span><span class="s1">: ++</span><span class="s8">$operands</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
                            <span class="s8">$v </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">wrapServiceConditionals</span><span class="s1">(</span><span class="s8">$v</span><span class="s0">, </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;        yield %s =&gt; %s;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$k</span><span class="s0">, </span><span class="s8">$interpolate</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$v</span><span class="s0">, </span><span class="s8">$interpolate</span><span class="s1">)))</span><span class="s0">;</span>
                            <span class="s0">foreach </span><span class="s1">(</span><span class="s3">explode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$v</span><span class="s1">) </span><span class="s0">as </span><span class="s8">$v</span><span class="s1">) {</span>
                                <span class="s0">if </span><span class="s1">(</span><span class="s8">$v</span><span class="s1">) {</span>
                                    <span class="s8">$code</span><span class="s1">[] = </span><span class="s7">'    '</span><span class="s1">.</span><span class="s8">$v</span><span class="s0">;</span>
                                <span class="s1">}</span>
                            <span class="s1">}</span>
                        <span class="s1">}</span>

                        <span class="s8">$countCode</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'            return %s;'</span><span class="s0">, </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">' + '</span><span class="s0">, </span><span class="s8">$operands</span><span class="s1">))</span><span class="s0">;</span>
                        <span class="s8">$countCode</span><span class="s1">[] = </span><span class="s7">'        }'</span><span class="s0">;</span>
                    <span class="s1">}</span>

                    <span class="s8">$code</span><span class="s1">[] = </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'        }, %s)'</span><span class="s0">, </span><span class="s1">\</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$operands</span><span class="s1">) &gt; </span><span class="s9">1 </span><span class="s1">? </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$countCode</span><span class="s1">) : </span><span class="s8">$operands</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])</span><span class="s0">;</span>

                    <span class="s0">return </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">ServiceLocatorArgument</span><span class="s1">) {</span>
                    <span class="s8">$serviceMap </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
                    <span class="s8">$serviceTypes </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
                    <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getValues</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$k </span><span class="s1">=&gt; </span><span class="s8">$v</span><span class="s1">) {</span>
                        <span class="s0">if </span><span class="s1">(!</span><span class="s8">$v</span><span class="s1">) {</span>
                            <span class="s0">continue;</span>
                        <span class="s1">}</span>
                        <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$v</span><span class="s0">;</span>
                        <span class="s0">while </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)) {</span>
                            <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
                        <span class="s1">}</span>
                        <span class="s8">$definition </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
                        <span class="s8">$load </span><span class="s1">= !(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">hasErrors</span><span class="s1">() &amp;&amp; </span><span class="s8">$e </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getErrors</span><span class="s1">()) ? </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isHotPath</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">) : </span><span class="s3">reset</span><span class="s1">(</span><span class="s8">$e</span><span class="s1">)</span><span class="s0">;</span>
                        <span class="s8">$serviceMap </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n            </span><span class="s7">%s =&gt; [%s, %s, %s, %s],&quot;</span><span class="s0">,</span>
                            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$k</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">() ? (</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'services' </span><span class="s1">: </span><span class="s7">'privates'</span><span class="s1">) : </span><span class="s3">false</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">IGNORE_ON_UNINITIALIZED_REFERENCE </span><span class="s1">!== </span><span class="s8">$v</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">() &amp;&amp; !\</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$load</span><span class="s1">) ? </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">).(</span><span class="s8">$load </span><span class="s1">? </span><span class="s7">'.php' </span><span class="s1">: </span><span class="s7">''</span><span class="s1">) : </span><span class="s3">null</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$load</span><span class="s1">)</span>
                        <span class="s1">)</span><span class="s0">;</span>
                        <span class="s8">$serviceTypes </span><span class="s1">.= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n            </span><span class="s7">%s =&gt; %s,&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$k</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$v </span><span class="s0">instanceof </span><span class="s3">TypedReference </span><span class="s1">? </span><span class="s8">$v</span><span class="s1">-&gt;</span><span class="s3">getType</span><span class="s1">() : </span><span class="s7">'?'</span><span class="s1">))</span><span class="s0">;</span>
                        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">locatedIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addGetService </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>

                    <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'new \%s($this-&gt;getService, [%s%s], [%s%s])'</span><span class="s0">, </span><span class="s3">ServiceLocator</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">$serviceMap</span><span class="s0">, </span><span class="s8">$serviceMap </span><span class="s1">? </span><span class="s7">&quot;</span><span class="s0">\n        </span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s0">, </span><span class="s8">$serviceTypes</span><span class="s0">, </span><span class="s8">$serviceTypes </span><span class="s1">? </span><span class="s7">&quot;</span><span class="s0">\n        </span><span class="s7">&quot; </span><span class="s1">: </span><span class="s7">''</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">finally </span><span class="s1">{</span>
                <span class="s0">list</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">) = </span><span class="s8">$scope</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Definition</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">hasErrors</span><span class="s1">() &amp;&amp; </span><span class="s8">$e </span><span class="s1">= </span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getErrors</span><span class="s1">()) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addThrow </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>

                <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;throw(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s3">reset</span><span class="s1">(</span><span class="s8">$e</span><span class="s1">)))</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables </span><span class="s1">&amp;&amp; </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">-&gt;</span><span class="s3">contains</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">definitionVariables</span><span class="s1">[</span><span class="s8">$value</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$interpolate</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getMethodCalls</span><span class="s1">()) {</span>
                <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s7">'Cannot dump definitions which have method calls.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getProperties</span><span class="s1">()) {</span>
                <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s7">'Cannot dump definitions which have properties.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">getConfigurator</span><span class="s1">()) {</span>
                <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s7">'Cannot dump definitions which have a configurator.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addNewInstance</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Variable</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">'$'</span><span class="s1">.</span><span class="s8">$value</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Reference</span><span class="s1">) {</span>
            <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$value</span><span class="s0">;</span>

            <span class="s0">while </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)) {</span>
                <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables </span><span class="s1">&amp;&amp; </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">referenceVariables</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]</span><span class="s0">, </span><span class="s8">$interpolate</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getServiceCall</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Expression</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getExpressionLanguage</span><span class="s1">()-&gt;</span><span class="s3">compile</span><span class="s1">((string) </span><span class="s8">$value</span><span class="s0">, </span><span class="s1">[</span><span class="s7">'this' </span><span class="s1">=&gt; </span><span class="s7">'container'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Parameter</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpParameter</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s3">true </span><span class="s1">=== </span><span class="s8">$interpolate </span><span class="s1">&amp;&amp; \</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s7">'/^%([^%]+)%$/'</span><span class="s0">, </span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$match</span><span class="s1">)) {</span>
                <span class="s2">// we do this to deal with non string values (Boolean, integer, ...)</span>
                <span class="s2">// the preg_replace_callback converts them to strings</span>
                <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpParameter</span><span class="s1">(</span><span class="s8">$match</span><span class="s1">[</span><span class="s9">1</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$replaceParameters </span><span class="s1">= </span><span class="s0">function </span><span class="s1">(</span><span class="s8">$match</span><span class="s1">) {</span>
                    <span class="s0">return </span><span class="s7">&quot;'.&quot;</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpParameter</span><span class="s1">(</span><span class="s8">$match</span><span class="s1">[</span><span class="s9">2</span><span class="s1">]).</span><span class="s7">&quot;.'&quot;</span><span class="s0">;</span>
                <span class="s1">}</span><span class="s0">;</span>

                <span class="s8">$code </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s7">'%%'</span><span class="s0">, </span><span class="s7">'%'</span><span class="s0">, </span><span class="s3">preg_replace_callback</span><span class="s1">(</span><span class="s7">'/(?&lt;!%)(%)([^%]+)\1/'</span><span class="s0">, </span><span class="s8">$replaceParameters</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)))</span><span class="s0">;</span>

                <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(\</span><span class="s3">is_object</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">) || \</span><span class="s3">is_resource</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s7">'Unable to dump a service container if a parameter is an object or a resource.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Dumps a string to a literal (aka PHP Code) class value.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">RuntimeException</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">dumpLiteralClass</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$class</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'$'</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'${($_ = %s) &amp;&amp; false ?: &quot;_&quot;}'</span><span class="s0">, </span><span class="s8">$class</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">&quot;'&quot;</span><span class="s1">) || !</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s7">'/^</span><span class="s0">\'</span><span class="s7">(?:</span><span class="s0">\\</span><span class="s7">\{2})?[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*(?:</span><span class="s0">\\</span><span class="s7">\{2}[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*)*</span><span class="s0">\'</span><span class="s7">$/'</span><span class="s0">, </span><span class="s8">$class</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'Cannot dump definition because of invalid class name (%s).'</span><span class="s0">, </span><span class="s8">$class </span><span class="s1">?: </span><span class="s7">'n/a'</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$class </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s3">str_replace</span><span class="s1">(</span><span class="s7">'</span><span class="s0">\\\\</span><span class="s7">'</span><span class="s0">, </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s0">, </span><span class="s8">$class</span><span class="s1">)</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">) ? </span><span class="s8">$class </span><span class="s1">: </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">.</span><span class="s8">$class</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">dumpParameter</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$name</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasParameter</span><span class="s1">(</span><span class="s8">$name</span><span class="s1">)) {</span>
            <span class="s8">$value </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">$name</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$dumpedValue </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">dumpValue</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$value </span><span class="s1">|| !\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s8">$dumpedValue</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s7">&quot;/</span><span class="s0">\\\$</span><span class="s7">this-&gt;(?:getEnv\('(?:\w++:)*+\w++'\)|targetDir\.'')/&quot;</span><span class="s0">, </span><span class="s8">$dumpedValue</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;parameters[%s]'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$name</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;getParameter(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$name</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getServiceCall</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s0">, </span><span class="s3">Reference </span><span class="s8">$reference </span><span class="s1">= </span><span class="s3">null</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">while </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)) {</span>
            <span class="s8">$id </span><span class="s1">= (string) </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">'service_container' </span><span class="s1">=== </span><span class="s8">$id</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">'$this'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">) &amp;&amp; </span><span class="s8">$definition </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isSynthetic</span><span class="s1">()) {</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;get(%s%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">, </span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$reference </span><span class="s1">? </span><span class="s7">', '</span><span class="s1">.</span><span class="s8">$reference</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">() : </span><span class="s7">''</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$reference </span><span class="s1">&amp;&amp; </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">IGNORE_ON_UNINITIALIZED_REFERENCE </span><span class="s1">=== </span><span class="s8">$reference</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">()) {</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s7">'null'</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">()) {</span>
                    <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isTrivialInstance</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">hasErrors</span><span class="s1">() &amp;&amp; </span><span class="s8">$e </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getErrors</span><span class="s1">()) {</span>
                    <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addThrow </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>

                    <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;throw(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">export</span><span class="s1">(</span><span class="s3">reset</span><span class="s1">(</span><span class="s8">$e</span><span class="s1">)))</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">addNewInstance</span><span class="s1">(</span><span class="s8">$definition</span><span class="s0">, </span><span class="s7">''</span><span class="s0">, </span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">() &amp;&amp; !</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                    <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;%s[%s] = %s'</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'services' </span><span class="s1">: </span><span class="s7">'privates'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s7">&quot;(</span><span class="s8">$code</span><span class="s7">)&quot;</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">inlineFactories </span><span class="s1">&amp;&amp; !</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">isHotPath</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">)) {</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\$</span><span class="s7">this-&gt;load('%s.php')&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">()) {</span>
                    <span class="s8">$factory </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;factories%s[%s]'</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'' </span><span class="s1">: </span><span class="s7">&quot;['service_container']&quot;</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
                    <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'(isset(%s) ? %1$s() : %s)'</span><span class="s0">, </span><span class="s8">$factory</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;%s()'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">() &amp;&amp; !</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">singleUsePrivateIds</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
                <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'($this-&gt;%s[%s] ?? %s)'</span><span class="s0">, </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isPublic</span><span class="s1">() ? </span><span class="s7">'services' </span><span class="s1">: </span><span class="s7">'privates'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s8">$code</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$reference </span><span class="s1">&amp;&amp; </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">IGNORE_ON_UNINITIALIZED_REFERENCE </span><span class="s1">=== </span><span class="s8">$reference</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s7">'null'</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$reference </span><span class="s1">&amp;&amp; </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">EXCEPTION_ON_INVALID_REFERENCE </span><span class="s1">&lt; </span><span class="s8">$reference</span><span class="s1">-&gt;</span><span class="s3">getInvalidBehavior</span><span class="s1">()) {</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;get(%s, /* ContainerInterface::NULL_ON_INVALID_REFERENCE */ %d)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">, </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">NULL_ON_INVALID_REFERENCE</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$code </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;get(%s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'($this-&gt;services[%s] ?? %s)'</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">, </span><span class="s8">$code</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Initializes the method names map to avoid conflicts with the Container methods.</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">initializeMethodNamesMap</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$class</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceIdToMethodNameMap </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">usedMethodNames </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$reflectionClass </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getReflectionClass</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">)) {</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$reflectionClass</span><span class="s1">-&gt;</span><span class="s3">getMethods</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$method</span><span class="s1">) {</span>
                <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">usedMethodNames</span><span class="s1">[</span><span class="s3">strtolower</span><span class="s1">(</span><span class="s8">$method</span><span class="s1">-&gt;</span><span class="s3">getName</span><span class="s1">())] = </span><span class="s3">true</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">InvalidArgumentException</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">generateMethodName</span><span class="s1">(</span><span class="s3">string </span><span class="s8">$id</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceIdToMethodNameMap</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">])) {</span>
            <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceIdToMethodNameMap</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$i </span><span class="s1">= </span><span class="s3">strrpos</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$name </span><span class="s1">= </span><span class="s3">Container</span><span class="s1">::</span><span class="s3">camelize</span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s8">$i </span><span class="s1">&amp;&amp; </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">[</span><span class="s9">1 </span><span class="s1">+ </span><span class="s8">$i</span><span class="s1">]) ? </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$id</span><span class="s0">, </span><span class="s9">1 </span><span class="s1">+ </span><span class="s8">$i</span><span class="s1">) : </span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$name </span><span class="s1">= </span><span class="s3">preg_replace</span><span class="s1">(</span><span class="s7">'/[^a-zA-Z0-9_\x7f-\xff]/'</span><span class="s0">, </span><span class="s7">''</span><span class="s0">, </span><span class="s8">$name</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$methodName </span><span class="s1">= </span><span class="s7">'get'</span><span class="s1">.</span><span class="s8">$name</span><span class="s1">.</span><span class="s7">'Service'</span><span class="s0">;</span>
        <span class="s8">$suffix </span><span class="s1">= </span><span class="s9">1</span><span class="s0">;</span>

        <span class="s0">while </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">usedMethodNames</span><span class="s1">[</span><span class="s3">strtolower</span><span class="s1">(</span><span class="s8">$methodName</span><span class="s1">)])) {</span>
            <span class="s1">++</span><span class="s8">$suffix</span><span class="s0">;</span>
            <span class="s8">$methodName </span><span class="s1">= </span><span class="s7">'get'</span><span class="s1">.</span><span class="s8">$name</span><span class="s1">.</span><span class="s8">$suffix</span><span class="s1">.</span><span class="s7">'Service'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">serviceIdToMethodNameMap</span><span class="s1">[</span><span class="s8">$id</span><span class="s1">] = </span><span class="s8">$methodName</span><span class="s0">;</span>
        <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">usedMethodNames</span><span class="s1">[</span><span class="s3">strtolower</span><span class="s1">(</span><span class="s8">$methodName</span><span class="s1">)] = </span><span class="s3">true</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s8">$methodName</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getNextVariableName</span><span class="s1">(): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s8">$firstChars </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">FIRST_CHARS</span><span class="s0">;</span>
        <span class="s8">$firstCharsLength </span><span class="s1">= \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s8">$firstChars</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s8">$nonFirstChars </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">NON_FIRST_CHARS</span><span class="s0">;</span>
        <span class="s8">$nonFirstCharsLength </span><span class="s1">= \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s8">$nonFirstChars</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">while </span><span class="s1">(</span><span class="s3">true</span><span class="s1">) {</span>
            <span class="s8">$name </span><span class="s1">= </span><span class="s7">''</span><span class="s0">;</span>
            <span class="s8">$i </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">variableCount</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">'' </span><span class="s1">=== </span><span class="s8">$name</span><span class="s1">) {</span>
                <span class="s8">$name </span><span class="s1">.= </span><span class="s8">$firstChars</span><span class="s1">[</span><span class="s8">$i </span><span class="s1">% </span><span class="s8">$firstCharsLength</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s8">$i </span><span class="s1">= (int) (</span><span class="s8">$i </span><span class="s1">/ </span><span class="s8">$firstCharsLength</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">while </span><span class="s1">(</span><span class="s8">$i </span><span class="s1">&gt; </span><span class="s9">0</span><span class="s1">) {</span>
                <span class="s1">--</span><span class="s8">$i</span><span class="s0">;</span>
                <span class="s8">$name </span><span class="s1">.= </span><span class="s8">$nonFirstChars</span><span class="s1">[</span><span class="s8">$i </span><span class="s1">% </span><span class="s8">$nonFirstCharsLength</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s8">$i </span><span class="s1">= (int) (</span><span class="s8">$i </span><span class="s1">/ </span><span class="s8">$nonFirstCharsLength</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s1">++</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">variableCount</span><span class="s0">;</span>

            <span class="s2">// check that the name is not reserved</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s8">$name</span><span class="s0">, </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">reservedVariables</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s8">$name</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getExpressionLanguage</span><span class="s1">(): </span><span class="s3">ExpressionLanguage</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">expressionLanguage</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s7">'Symfony\Component\ExpressionLanguage\ExpressionLanguage'</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s7">'Unable to use expressions as the Symfony ExpressionLanguage component is not installed.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s8">$providers </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">getExpressionLanguageProviders</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">expressionLanguage </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ExpressionLanguage</span><span class="s1">(</span><span class="s3">null</span><span class="s0">, </span><span class="s8">$providers</span><span class="s0">, function </span><span class="s1">(</span><span class="s8">$arg</span><span class="s1">) {</span>
                <span class="s8">$id </span><span class="s1">= </span><span class="s7">'&quot;&quot;' </span><span class="s1">=== </span><span class="s3">substr_replace</span><span class="s1">(</span><span class="s8">$arg</span><span class="s0">, </span><span class="s7">''</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">) ? </span><span class="s3">stripcslashes</span><span class="s1">(</span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$arg</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s1">)) : </span><span class="s3">null</span><span class="s0">;</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$id </span><span class="s1">&amp;&amp; (</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasAlias</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">) || </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">))) {</span>
                    <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">getServiceCall</span><span class="s1">(</span><span class="s8">$id</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'$this-&gt;get(%s)'</span><span class="s0">, </span><span class="s8">$arg</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">})</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">isTrackingResources</span><span class="s1">()) {</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$providers </span><span class="s0">as </span><span class="s8">$provider</span><span class="s1">) {</span>
                    <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">addObjectResource</span><span class="s1">(</span><span class="s8">$provider</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">expressionLanguage</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">isHotPath</span><span class="s1">(</span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s1">): </span><span class="s3">bool</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">hotPathTag </span><span class="s1">&amp;&amp; </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">hasTag</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">hotPathTag</span><span class="s1">) &amp;&amp; !</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">isDeprecated</span><span class="s1">()</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">isSingleUsePrivateNode</span><span class="s1">(</span><span class="s3">ServiceReferenceGraphNode </span><span class="s8">$node</span><span class="s1">): </span><span class="s3">bool</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$node</span><span class="s1">-&gt;</span><span class="s3">getValue</span><span class="s1">()-&gt;</span><span class="s3">isPublic</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s8">$ids </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s8">$node</span><span class="s1">-&gt;</span><span class="s3">getInEdges</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$edge</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s8">$value </span><span class="s1">= </span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">getSourceNode</span><span class="s1">()-&gt;</span><span class="s3">getValue</span><span class="s1">()) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">isLazy</span><span class="s1">() || !</span><span class="s8">$value </span><span class="s0">instanceof </span><span class="s3">Definition </span><span class="s1">|| !</span><span class="s8">$value</span><span class="s1">-&gt;</span><span class="s3">isShared</span><span class="s1">()) {</span>
                <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s8">$ids</span><span class="s1">[</span><span class="s8">$edge</span><span class="s1">-&gt;</span><span class="s3">getSourceNode</span><span class="s1">()-&gt;</span><span class="s3">getId</span><span class="s1">()] = </span><span class="s3">true</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">1 </span><span class="s1">=== \</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$ids</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">mixed</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">export</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex </span><span class="s1">&amp;&amp; \</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">) &amp;&amp; </span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex</span><span class="s0">, </span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$matches</span><span class="s0">, </span><span class="s3">PREG_OFFSET_CAPTURE</span><span class="s1">)) {</span>
            <span class="s8">$prefix </span><span class="s1">= </span><span class="s8">$matches</span><span class="s1">[</span><span class="s9">0</span><span class="s1">][</span><span class="s9">1</span><span class="s1">] ? </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s8">$matches</span><span class="s1">[</span><span class="s9">0</span><span class="s1">][</span><span class="s9">1</span><span class="s1">])</span><span class="s0">, </span><span class="s3">true</span><span class="s1">).</span><span class="s7">'.' </span><span class="s1">: </span><span class="s7">''</span><span class="s0">;</span>
            <span class="s8">$suffix </span><span class="s1">= </span><span class="s8">$matches</span><span class="s1">[</span><span class="s9">0</span><span class="s1">][</span><span class="s9">1</span><span class="s1">] + \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s8">$matches</span><span class="s1">[</span><span class="s9">0</span><span class="s1">][</span><span class="s9">0</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s8">$suffix </span><span class="s1">= </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">[</span><span class="s8">$suffix</span><span class="s1">]) ? </span><span class="s7">'.'</span><span class="s1">.</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s8">$suffix</span><span class="s1">)</span><span class="s0">, </span><span class="s3">true</span><span class="s1">) : </span><span class="s7">''</span><span class="s0">;</span>
            <span class="s8">$dirname </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles </span><span class="s1">? </span><span class="s7">'$this-&gt;containerDir' </span><span class="s1">: </span><span class="s7">'__DIR__'</span><span class="s0">;</span>
            <span class="s8">$offset </span><span class="s1">= </span><span class="s9">1 </span><span class="s1">+ </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirMaxMatches </span><span class="s1">- \</span><span class="s3">count</span><span class="s1">(</span><span class="s8">$matches</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">&lt; </span><span class="s8">$offset</span><span class="s1">) {</span>
                <span class="s8">$dirname </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'\dirname(__DIR__, %d)'</span><span class="s0">, </span><span class="s8">$offset </span><span class="s1">+ (int) </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">asFiles</span><span class="s1">) {</span>
                <span class="s8">$dirname </span><span class="s1">= </span><span class="s7">&quot;</span><span class="s0">\$</span><span class="s7">this-&gt;targetDir.''&quot;</span><span class="s0">; </span><span class="s2">// empty string concatenation on purpose</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$prefix </span><span class="s1">|| </span><span class="s8">$suffix</span><span class="s1">) {</span>
                <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s7">'(%s%s%s)'</span><span class="s0">, </span><span class="s8">$prefix</span><span class="s0">, </span><span class="s8">$dirname</span><span class="s0">, </span><span class="s8">$suffix</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s8">$dirname</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">mixed</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">doExport</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s3">bool </span><span class="s8">$resolveEnv </span><span class="s1">= </span><span class="s3">false</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s8">$shouldCacheValue </span><span class="s1">= </span><span class="s8">$resolveEnv </span><span class="s1">&amp;&amp; \</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">$shouldCacheValue </span><span class="s1">&amp;&amp; </span><span class="s0">isset</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportedVariables</span><span class="s1">[</span><span class="s8">$value</span><span class="s1">])) {</span>
            <span class="s0">return </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportedVariables</span><span class="s1">[</span><span class="s8">$value</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$value</span><span class="s1">) &amp;&amp; </span><span class="s3">false </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s1">)) {</span>
            <span class="s8">$cleanParts </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(</span><span class="s7">&quot;</span><span class="s0">\n</span><span class="s7">&quot;</span><span class="s0">, </span><span class="s8">$value</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$cleanParts </span><span class="s1">= </span><span class="s3">array_map</span><span class="s1">(</span><span class="s0">function </span><span class="s1">(</span><span class="s8">$part</span><span class="s1">) { </span><span class="s0">return </span><span class="s3">var_export</span><span class="s1">(</span><span class="s8">$part</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)</span><span class="s0">; </span><span class="s1">}</span><span class="s0">, </span><span class="s8">$cleanParts</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$export </span><span class="s1">= </span><span class="s3">implode</span><span class="s1">(</span><span class="s7">'.&quot;\n&quot;.'</span><span class="s0">, </span><span class="s8">$cleanParts</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s8">$export </span><span class="s1">= </span><span class="s3">var_export</span><span class="s1">(</span><span class="s8">$value</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$resolveEnv </span><span class="s1">&amp;&amp; </span><span class="s7">&quot;'&quot; </span><span class="s1">=== </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] &amp;&amp; </span><span class="s8">$export </span><span class="s1">!== </span><span class="s8">$resolvedExport </span><span class="s1">= </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s8">$export</span><span class="s0">, </span><span class="s7">&quot;'.</span><span class="s0">\$</span><span class="s7">this-&gt;getEnv('string:%s').'&quot;</span><span class="s1">)) {</span>
            <span class="s8">$export </span><span class="s1">= </span><span class="s8">$resolvedExport</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">&quot;.''&quot; </span><span class="s1">=== </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$export</span><span class="s0">, </span><span class="s1">-</span><span class="s9">3</span><span class="s1">)) {</span>
                <span class="s8">$export </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$export</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s1">-</span><span class="s9">3</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s7">&quot;'&quot; </span><span class="s1">=== </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]) {</span>
                    <span class="s8">$export </span><span class="s1">= </span><span class="s3">substr_replace</span><span class="s1">(</span><span class="s8">$export</span><span class="s0">, </span><span class="s7">''</span><span class="s0">, </span><span class="s9">18</span><span class="s0">, </span><span class="s9">7</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">&quot;'&quot; </span><span class="s1">=== </span><span class="s8">$export</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]) {</span>
                <span class="s8">$export </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$export</span><span class="s0">, </span><span class="s9">3</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">$shouldCacheValue</span><span class="s1">) {</span>
            <span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">exportedVariables</span><span class="s1">[</span><span class="s8">$value</span><span class="s1">] = </span><span class="s8">$export</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">$export</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getAutoloadFile</span><span class="s1">(): ?</span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s3">spl_autoload_functions</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$autoloader</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$autoloader</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">$autoloader</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">DebugClassLoader </span><span class="s1">|| </span><span class="s8">$autoloader</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">LegacyDebugClassLoader</span><span class="s1">) {</span>
                <span class="s8">$autoloader </span><span class="s1">= </span><span class="s8">$autoloader</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]-&gt;</span><span class="s3">getClassLoader</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$autoloader</span><span class="s1">) || !</span><span class="s8">$autoloader</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] </span><span class="s0">instanceof </span><span class="s3">ClassLoader </span><span class="s1">|| !</span><span class="s8">$autoloader</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]-&gt;</span><span class="s3">findFile</span><span class="s1">(</span><span class="s3">__CLASS__</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s3">get_declared_classes</span><span class="s1">() </span><span class="s0">as </span><span class="s8">$class</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s8">$class</span><span class="s0">, </span><span class="s7">'ComposerAutoloaderInit'</span><span class="s1">) &amp;&amp; </span><span class="s8">$class</span><span class="s1">::</span><span class="s3">getLoader</span><span class="s1">() === </span><span class="s8">$autoloader</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]) {</span>
                    <span class="s8">$file </span><span class="s1">= \</span><span class="s3">dirname</span><span class="s1">((</span><span class="s0">new </span><span class="s1">\</span><span class="s3">ReflectionClass</span><span class="s1">(</span><span class="s8">$class</span><span class="s1">))-&gt;</span><span class="s3">getFileName</span><span class="s1">()</span><span class="s0">, </span><span class="s9">2</span><span class="s1">).</span><span class="s7">'/autoload.php'</span><span class="s0">;</span>

                    <span class="s0">if </span><span class="s1">(</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">$this</span><span class="s1">-&gt;</span><span class="s3">targetDirRegex</span><span class="s1">.</span><span class="s7">'A'</span><span class="s0">, </span><span class="s8">$file</span><span class="s1">)) {</span>
                        <span class="s0">return </span><span class="s8">$file</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getClasses</span><span class="s1">(</span><span class="s3">Definition </span><span class="s8">$definition</span><span class="s1">): </span><span class="s0">array</span>
    <span class="s1">{</span>
        <span class="s8">$classes </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">while </span><span class="s1">(</span><span class="s8">$definition </span><span class="s0">instanceof </span><span class="s3">Definition</span><span class="s1">) {</span>
            <span class="s8">$classes</span><span class="s1">[] = </span><span class="s3">trim</span><span class="s1">(</span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getClass</span><span class="s1">()</span><span class="s0">, </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s8">$factory </span><span class="s1">= </span><span class="s8">$definition</span><span class="s1">-&gt;</span><span class="s3">getFactory</span><span class="s1">()</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">)) {</span>
                <span class="s8">$factory </span><span class="s1">= [</span><span class="s8">$factory</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_string</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">])) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s8">$i </span><span class="s1">= </span><span class="s3">strrpos</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s7">'::'</span><span class="s1">)) {</span>
                    <span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">] = </span><span class="s3">substr</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s8">$i</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s8">$classes</span><span class="s1">[] = </span><span class="s3">trim</span><span class="s1">(</span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s7">'</span><span class="s0">\\</span><span class="s7">'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s8">$definition </span><span class="s1">= </span><span class="s8">$factory</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">array_filter</span><span class="s1">(</span><span class="s8">$classes</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>