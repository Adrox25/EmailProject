<html>
<head>
<title>Mbstring.php</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #a9b7c6;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #629755; font-weight: bold; font-style: italic;}
.s6 { color: #77b767; font-style: italic;}
.s7 { color: #9876aa;}
.s8 { color: #6a8759;}
.s9 { color: #6897bb;}
.ls0 { height: 1px; border-width: 0; color: #4d4d4d; background-color:#4d4d4d}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Mbstring.php</font>
</center></td></tr></table>
<pre><span class="s0">&lt;?php</span>

<span class="s2">/* 
 * This file is part of the Symfony package. 
 * 
 * (c) Fabien Potencier &lt;fabien@symfony.com&gt; 
 * 
 * For the full copyright and license information, please view the LICENSE 
 * file that was distributed with this source code. 
 */</span>
<hr class="ls0"><span class="s0">namespace </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Polyfill</span><span class="s1">\</span><span class="s3">Mbstring</span><span class="s0">;</span>
<hr class="ls0"><span class="s4">/**</span>
 <span class="s4">* Partial mbstring implementation in PHP, iconv based, UTF-8 centric.</span>
 <span class="s4">*</span>
 <span class="s4">* Implemented:</span>
 <span class="s4">* - mb_chr                  - Returns a specific character from its Unicode code point</span>
 <span class="s4">* - mb_convert_encoding     - Convert character encoding</span>
 <span class="s4">* - mb_convert_variables    - Convert character code in variable(s)</span>
 <span class="s4">* - mb_decode_mimeheader    - Decode string in MIME header field</span>
 <span class="s4">* - mb_encode_mimeheader    - Encode string for MIME header XXX NATIVE IMPLEMENTATION IS REALLY BUGGED</span>
 <span class="s4">* - mb_decode_numericentity - Decode HTML numeric string reference to character</span>
 <span class="s4">* - mb_encode_numericentity - Encode character to HTML numeric string reference</span>
 <span class="s4">* - mb_convert_case         - Perform case folding on a string</span>
 <span class="s4">* - mb_detect_encoding      - Detect character encoding</span>
 <span class="s4">* - mb_get_info             - Get internal settings of mbstring</span>
 <span class="s4">* - mb_http_input           - Detect HTTP input character encoding</span>
 <span class="s4">* - mb_http_output          - Set/Get HTTP output character encoding</span>
 <span class="s4">* - mb_internal_encoding    - Set/Get internal character encoding</span>
 <span class="s4">* - mb_list_encodings       - Returns an array of all supported encodings</span>
 <span class="s4">* - mb_ord                  - Returns the Unicode code point of a character</span>
 <span class="s4">* - mb_output_handler       - Callback function converts character encoding in output buffer</span>
 <span class="s4">* - mb_scrub                - Replaces ill-formed byte sequences with substitute characters</span>
 <span class="s4">* - mb_strlen               - Get string length</span>
 <span class="s4">* - mb_strpos               - Find position of first occurrence of string in a string</span>
 <span class="s4">* - mb_strrpos              - Find position of last occurrence of a string in a string</span>
 <span class="s4">* - mb_str_split            - Convert a string to an array</span>
 <span class="s4">* - mb_strtolower           - Make a string lowercase</span>
 <span class="s4">* - mb_strtoupper           - Make a string uppercase</span>
 <span class="s4">* - mb_substitute_character - Set/Get substitution character</span>
 <span class="s4">* - mb_substr               - Get part of string</span>
 <span class="s4">* - mb_stripos              - Finds position of first occurrence of a string within another, case insensitive</span>
 <span class="s4">* - mb_stristr              - Finds first occurrence of a string within another, case insensitive</span>
 <span class="s4">* - mb_strrchr              - Finds the last occurrence of a character in a string within another</span>
 <span class="s4">* - mb_strrichr             - Finds the last occurrence of a character in a string within another, case insensitive</span>
 <span class="s4">* - mb_strripos             - Finds position of last occurrence of a string within another, case insensitive</span>
 <span class="s4">* - mb_strstr               - Finds first occurrence of a string within another</span>
 <span class="s4">* - mb_strwidth             - Return width of string</span>
 <span class="s4">* - mb_substr_count         - Count the number of substring occurrences</span>
 <span class="s4">*</span>
 <span class="s4">* Not implemented:</span>
 <span class="s4">* - mb_convert_kana         - Convert &quot;kana&quot; one from another (&quot;zen-kaku&quot;, &quot;han-kaku&quot; and more)</span>
 <span class="s4">* - mb_ereg_*               - Regular expression with multibyte support</span>
 <span class="s4">* - mb_parse_str            - Parse GET/POST/COOKIE data and set global variable</span>
 <span class="s4">* - mb_preferred_mime_name  - Get MIME charset string</span>
 <span class="s4">* - mb_regex_encoding       - Returns current encoding for multibyte regex as string</span>
 <span class="s4">* - mb_regex_set_options    - Set/Get the default options for mbregex functions</span>
 <span class="s4">* - mb_send_mail            - Send encoded mail</span>
 <span class="s4">* - mb_split                - Split multibyte string using regular expression</span>
 <span class="s4">* - mb_strcut               - Get part of string</span>
 <span class="s4">* - mb_strimwidth           - Get truncated string with specified width</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Nicolas Grekas </span><span class="s6">&lt;p</span><span class="s4">@tchwork.com&gt;</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@internal</span>
 <span class="s4">*/</span>
<span class="s0">final class </span><span class="s3">Mbstring</span>
<span class="s1">{</span>
    <span class="s0">const </span><span class="s3">MB_CASE_FOLD </span><span class="s1">= </span><span class="s3">PHP_INT_MAX</span><span class="s0">;</span>

    <span class="s0">private static </span><span class="s7">$encodingList </span><span class="s1">= </span><span class="s0">array</span><span class="s1">(</span><span class="s8">'ASCII'</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s0">private static </span><span class="s7">$language </span><span class="s1">= </span><span class="s8">'neutral'</span><span class="s0">;</span>
    <span class="s0">private static </span><span class="s7">$internalEncoding </span><span class="s1">= </span><span class="s8">'UTF-8'</span><span class="s0">;</span>
    <span class="s0">private static </span><span class="s7">$caseFold </span><span class="s1">= </span><span class="s0">array</span><span class="s1">(</span>
        <span class="s0">array</span><span class="s1">(</span><span class="s8">'µ'</span><span class="s0">, </span><span class="s8">'ſ'</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCD\x85</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">'ς'</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCF\x90</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCF\x91</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCF\x95</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCF\x96</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCF\xB0</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCF\xB1</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xCF\xB5</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xE1\xBA\x9B</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xE1\xBE\xBE</span><span class="s8">&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">array</span><span class="s1">(</span><span class="s8">'μ'</span><span class="s0">, </span><span class="s8">'s'</span><span class="s0">, </span><span class="s8">'ι'</span><span class="s0">,        </span><span class="s8">'σ'</span><span class="s0">, </span><span class="s8">'β'</span><span class="s0">,        </span><span class="s8">'θ'</span><span class="s0">,        </span><span class="s8">'φ'</span><span class="s0">,        </span><span class="s8">'π'</span><span class="s0">,        </span><span class="s8">'κ'</span><span class="s0">,        </span><span class="s8">'ρ'</span><span class="s0">,        </span><span class="s8">'ε'</span><span class="s0">,        </span><span class="s8">&quot;</span><span class="s0">\xE1\xB9\xA1</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">'ι'</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">;</span>

    <span class="s0">public static function </span><span class="s3">mb_convert_encoding</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$toEncoding</span><span class="s0">, </span><span class="s7">$fromEncoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s7">$fromEncoding</span><span class="s1">) || </span><span class="s3">false </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s7">$fromEncoding</span><span class="s0">, </span><span class="s8">','</span><span class="s1">)) {</span>
            <span class="s7">$fromEncoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_detect_encoding</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$fromEncoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$fromEncoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$fromEncoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$toEncoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$toEncoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'BASE64' </span><span class="s1">=== </span><span class="s7">$fromEncoding</span><span class="s1">) {</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">base64_decode</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$fromEncoding </span><span class="s1">= </span><span class="s7">$toEncoding</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'BASE64' </span><span class="s1">=== </span><span class="s7">$toEncoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">base64_encode</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'HTML-ENTITIES' </span><span class="s1">=== </span><span class="s7">$toEncoding </span><span class="s1">|| </span><span class="s8">'HTML' </span><span class="s1">=== </span><span class="s7">$toEncoding</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'HTML-ENTITIES' </span><span class="s1">=== </span><span class="s7">$fromEncoding </span><span class="s1">|| </span><span class="s8">'HTML' </span><span class="s1">=== </span><span class="s7">$fromEncoding</span><span class="s1">) {</span>
                <span class="s7">$fromEncoding </span><span class="s1">= </span><span class="s8">'Windows-1252'</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">!== </span><span class="s7">$fromEncoding</span><span class="s1">) {</span>
                <span class="s7">$s </span><span class="s1">= </span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$fromEncoding</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s3">preg_replace_callback</span><span class="s1">(</span><span class="s8">'/[\x80-\xFF]+/'</span><span class="s0">, array</span><span class="s1">(</span><span class="s3">__CLASS__</span><span class="s0">, </span><span class="s8">'html_encoding_callback'</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'HTML-ENTITIES' </span><span class="s1">=== </span><span class="s7">$fromEncoding</span><span class="s1">) {</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">html_entity_decode</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s3">ENT_COMPAT</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$fromEncoding </span><span class="s1">= </span><span class="s8">'UTF-8'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$fromEncoding</span><span class="s0">, </span><span class="s7">$toEncoding</span><span class="s1">.</span><span class="s8">'//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_convert_variables</span><span class="s1">(</span><span class="s7">$toEncoding</span><span class="s0">, </span><span class="s7">$fromEncoding</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$a </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$b </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$c </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$d </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$e </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$f </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$vars </span><span class="s1">= </span><span class="s0">array</span><span class="s1">(&amp;</span><span class="s7">$a</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$b</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$c</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$d</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$e</span><span class="s0">, </span><span class="s1">&amp;</span><span class="s7">$f</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$ok </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>
        <span class="s3">array_walk_recursive</span><span class="s1">(</span><span class="s7">$vars</span><span class="s0">, function </span><span class="s1">(&amp;</span><span class="s7">$v</span><span class="s1">) </span><span class="s0">use </span><span class="s1">(&amp;</span><span class="s7">$ok</span><span class="s0">, </span><span class="s7">$toEncoding</span><span class="s0">, </span><span class="s7">$fromEncoding</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">=== </span><span class="s7">$v </span><span class="s1">= </span><span class="s3">Mbstring</span><span class="s1">::</span><span class="s3">mb_convert_encoding</span><span class="s1">(</span><span class="s7">$v</span><span class="s0">, </span><span class="s7">$toEncoding</span><span class="s0">, </span><span class="s7">$fromEncoding</span><span class="s1">)) {</span>
                <span class="s7">$ok </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">})</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s7">$ok </span><span class="s1">? </span><span class="s7">$fromEncoding </span><span class="s1">: </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_decode_mimeheader</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">iconv_mime_decode</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s9">2</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$internalEncoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_encode_mimeheader</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$charset </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$transferEncoding </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$linefeed </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$indent </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'mb_encode_mimeheader() is bugged. Please use iconv_mime_encode() instead'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_decode_numericentity</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$convmap</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$s </span><span class="s1">&amp;&amp; !\</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">) &amp;&amp; !(\</span><span class="s3">is_object</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">) &amp;&amp; \</span><span class="s3">method_exists</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s8">'__toString'</span><span class="s1">))) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'mb_decode_numericentity() expects parameter 1 to be string, '</span><span class="s1">.\</span><span class="s3">gettype</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">).</span><span class="s8">' given'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s7">$convmap</span><span class="s1">) || !</span><span class="s7">$convmap</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$encoding </span><span class="s1">&amp;&amp; !\</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'mb_decode_numericentity() expects parameter 3 to be string, '</span><span class="s1">.\</span><span class="s3">gettype</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">).</span><span class="s8">' given'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s8">''</span><span class="s0">;  </span><span class="s2">// Instead of null (cf. mb_encode_numericentity).</span>
        <span class="s1">}</span>

        <span class="s7">$s </span><span class="s1">= (string) </span><span class="s7">$s</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">=== </span><span class="s7">$s</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'//u'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)) {</span>
                <span class="s7">$s </span><span class="s1">= @</span><span class="s3">iconv</span><span class="s1">(</span><span class="s8">'UTF-8'</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$cnt </span><span class="s1">= </span><span class="s3">floor</span><span class="s1">(\</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$convmap</span><span class="s1">) / </span><span class="s9">4</span><span class="s1">) * </span><span class="s9">4</span><span class="s0">;</span>

        <span class="s0">for </span><span class="s1">(</span><span class="s7">$i </span><span class="s1">= </span><span class="s9">0</span><span class="s0">; </span><span class="s7">$i </span><span class="s1">&lt; </span><span class="s7">$cnt</span><span class="s0">; </span><span class="s7">$i </span><span class="s1">+= </span><span class="s9">4</span><span class="s1">) {</span>
            <span class="s2">// collector_decode_htmlnumericentity ignores $convmap[$i + 3]</span>
            <span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">] += </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$i </span><span class="s1">+ </span><span class="s9">2</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$i </span><span class="s1">+ </span><span class="s9">1</span><span class="s1">] += </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$i </span><span class="s1">+ </span><span class="s9">2</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$s </span><span class="s1">= </span><span class="s3">preg_replace_callback</span><span class="s1">(</span><span class="s8">'/&amp;#(?:0*([0-9]+)|x0*([0-9a-fA-F]+))(?!&amp;);?/'</span><span class="s0">, function </span><span class="s1">(</span><span class="s0">array </span><span class="s7">$m</span><span class="s1">) </span><span class="s0">use </span><span class="s1">(</span><span class="s7">$cnt</span><span class="s0">, </span><span class="s7">$convmap</span><span class="s1">) {</span>
            <span class="s7">$c </span><span class="s1">= </span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$m</span><span class="s1">[</span><span class="s9">2</span><span class="s1">]) ? (int) </span><span class="s3">hexdec</span><span class="s1">(</span><span class="s7">$m</span><span class="s1">[</span><span class="s9">2</span><span class="s1">]) : </span><span class="s7">$m</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s0">for </span><span class="s1">(</span><span class="s7">$i </span><span class="s1">= </span><span class="s9">0</span><span class="s0">; </span><span class="s7">$i </span><span class="s1">&lt; </span><span class="s7">$cnt</span><span class="s0">; </span><span class="s7">$i </span><span class="s1">+= </span><span class="s9">4</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s7">$c </span><span class="s1">&gt;= </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">] &amp;&amp; </span><span class="s7">$c </span><span class="s1">&lt;= </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$i </span><span class="s1">+ </span><span class="s9">1</span><span class="s1">]) {</span>
                    <span class="s0">return </span><span class="s3">Mbstring</span><span class="s1">::</span><span class="s3">mb_chr</span><span class="s1">(</span><span class="s7">$c </span><span class="s1">- </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$i </span><span class="s1">+ </span><span class="s9">2</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s7">$m</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">$s</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">iconv</span><span class="s1">(</span><span class="s8">'UTF-8'</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">.</span><span class="s8">'//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_encode_numericentity</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$convmap</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$is_hex </span><span class="s1">= </span><span class="s3">false</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$s </span><span class="s1">&amp;&amp; !\</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">) &amp;&amp; !(\</span><span class="s3">is_object</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">) &amp;&amp; \</span><span class="s3">method_exists</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s8">'__toString'</span><span class="s1">))) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'mb_encode_numericentity() expects parameter 1 to be string, '</span><span class="s1">.\</span><span class="s3">gettype</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">).</span><span class="s8">' given'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s7">$convmap</span><span class="s1">) || !</span><span class="s7">$convmap</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$encoding </span><span class="s1">&amp;&amp; !\</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'mb_encode_numericentity() expects parameter 3 to be string, '</span><span class="s1">.\</span><span class="s3">gettype</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">).</span><span class="s8">' given'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">null</span><span class="s0">;  </span><span class="s2">// Instead of '' (cf. mb_decode_numericentity).</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$is_hex </span><span class="s1">&amp;&amp; !\</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s7">$is_hex</span><span class="s1">)) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'mb_encode_numericentity() expects parameter 4 to be boolean, '</span><span class="s1">.\</span><span class="s3">gettype</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">).</span><span class="s8">' given'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$s </span><span class="s1">= (string) </span><span class="s7">$s</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">=== </span><span class="s7">$s</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'//u'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)) {</span>
                <span class="s7">$s </span><span class="s1">= @</span><span class="s3">iconv</span><span class="s1">(</span><span class="s8">'UTF-8'</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">static </span><span class="s7">$ulenMask </span><span class="s1">= </span><span class="s0">array</span><span class="s1">(</span><span class="s8">&quot;</span><span class="s0">\xC0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">2</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xD0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">2</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xE0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">3</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xF0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">4</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$cnt </span><span class="s1">= </span><span class="s3">floor</span><span class="s1">(\</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$convmap</span><span class="s1">) / </span><span class="s9">4</span><span class="s1">) * </span><span class="s9">4</span><span class="s0">;</span>
        <span class="s7">$i </span><span class="s1">= </span><span class="s9">0</span><span class="s0">;</span>
        <span class="s7">$len </span><span class="s1">= \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$result </span><span class="s1">= </span><span class="s8">''</span><span class="s0">;</span>

        <span class="s0">while </span><span class="s1">(</span><span class="s7">$i </span><span class="s1">&lt; </span><span class="s7">$len</span><span class="s1">) {</span>
            <span class="s7">$ulen </span><span class="s1">= </span><span class="s7">$s</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">] &lt; </span><span class="s8">&quot;</span><span class="s0">\x80</span><span class="s8">&quot; </span><span class="s1">? </span><span class="s9">1 </span><span class="s1">: </span><span class="s7">$ulenMask</span><span class="s1">[</span><span class="s7">$s</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">] &amp; </span><span class="s8">&quot;</span><span class="s0">\xF0</span><span class="s8">&quot;</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s7">$uchr </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$i</span><span class="s0">, </span><span class="s7">$ulen</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$i </span><span class="s1">+= </span><span class="s7">$ulen</span><span class="s0">;</span>
            <span class="s7">$c </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_ord</span><span class="s1">(</span><span class="s7">$uchr</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">for </span><span class="s1">(</span><span class="s7">$j </span><span class="s1">= </span><span class="s9">0</span><span class="s0">; </span><span class="s7">$j </span><span class="s1">&lt; </span><span class="s7">$cnt</span><span class="s0">; </span><span class="s7">$j </span><span class="s1">+= </span><span class="s9">4</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s7">$c </span><span class="s1">&gt;= </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$j</span><span class="s1">] &amp;&amp; </span><span class="s7">$c </span><span class="s1">&lt;= </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$j </span><span class="s1">+ </span><span class="s9">1</span><span class="s1">]) {</span>
                    <span class="s7">$cOffset </span><span class="s1">= (</span><span class="s7">$c </span><span class="s1">+ </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$j </span><span class="s1">+ </span><span class="s9">2</span><span class="s1">]) &amp; </span><span class="s7">$convmap</span><span class="s1">[</span><span class="s7">$j </span><span class="s1">+ </span><span class="s9">3</span><span class="s1">]</span><span class="s0">;</span>
                    <span class="s7">$result </span><span class="s1">.= </span><span class="s7">$is_hex </span><span class="s1">? </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'&amp;#x%X;'</span><span class="s0">, </span><span class="s7">$cOffset</span><span class="s1">) : </span><span class="s8">'&amp;#'</span><span class="s1">.</span><span class="s7">$cOffset</span><span class="s1">.</span><span class="s8">';'</span><span class="s0">;</span>
                    <span class="s0">continue </span><span class="s9">2</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s7">$result </span><span class="s1">.= </span><span class="s7">$uchr</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">$result</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">iconv</span><span class="s1">(</span><span class="s8">'UTF-8'</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">.</span><span class="s8">'//IGNORE'</span><span class="s0">, </span><span class="s7">$result</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$mode</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$s </span><span class="s1">= (string) </span><span class="s7">$s</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">=== </span><span class="s7">$s</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'//u'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)) {</span>
                <span class="s7">$s </span><span class="s1">= @</span><span class="s3">iconv</span><span class="s1">(</span><span class="s8">'UTF-8'</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">MB_CASE_TITLE </span><span class="s1">== </span><span class="s7">$mode</span><span class="s1">) {</span>
            <span class="s0">static </span><span class="s7">$titleRegexp </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$titleRegexp</span><span class="s1">) {</span>
                <span class="s7">$titleRegexp </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getData</span><span class="s1">(</span><span class="s8">'titleCaseRegexp'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">preg_replace_callback</span><span class="s1">(</span><span class="s7">$titleRegexp</span><span class="s0">, array</span><span class="s1">(</span><span class="s3">__CLASS__</span><span class="s0">, </span><span class="s8">'title_case'</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">MB_CASE_UPPER </span><span class="s1">== </span><span class="s7">$mode</span><span class="s1">) {</span>
                <span class="s0">static </span><span class="s7">$upper </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$upper</span><span class="s1">) {</span>
                    <span class="s7">$upper </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getData</span><span class="s1">(</span><span class="s8">'upperCase'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s7">$map </span><span class="s1">= </span><span class="s7">$upper</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s3">MB_CASE_FOLD </span><span class="s1">=== </span><span class="s7">$mode</span><span class="s1">) {</span>
                    <span class="s7">$s </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s7">$caseFold</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$caseFold</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">static </span><span class="s7">$lower </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$lower</span><span class="s1">) {</span>
                    <span class="s7">$lower </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getData</span><span class="s1">(</span><span class="s8">'lowerCase'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s7">$map </span><span class="s1">= </span><span class="s7">$lower</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">static </span><span class="s7">$ulenMask </span><span class="s1">= </span><span class="s0">array</span><span class="s1">(</span><span class="s8">&quot;</span><span class="s0">\xC0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">2</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xD0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">2</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xE0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">3</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\xF0</span><span class="s8">&quot; </span><span class="s1">=&gt; </span><span class="s9">4</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$i </span><span class="s1">= </span><span class="s9">0</span><span class="s0">;</span>
            <span class="s7">$len </span><span class="s1">= \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">while </span><span class="s1">(</span><span class="s7">$i </span><span class="s1">&lt; </span><span class="s7">$len</span><span class="s1">) {</span>
                <span class="s7">$ulen </span><span class="s1">= </span><span class="s7">$s</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">] &lt; </span><span class="s8">&quot;</span><span class="s0">\x80</span><span class="s8">&quot; </span><span class="s1">? </span><span class="s9">1 </span><span class="s1">: </span><span class="s7">$ulenMask</span><span class="s1">[</span><span class="s7">$s</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">] &amp; </span><span class="s8">&quot;</span><span class="s0">\xF0</span><span class="s8">&quot;</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s7">$uchr </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$i</span><span class="s0">, </span><span class="s7">$ulen</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$i </span><span class="s1">+= </span><span class="s7">$ulen</span><span class="s0">;</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$map</span><span class="s1">[</span><span class="s7">$uchr</span><span class="s1">])) {</span>
                    <span class="s7">$uchr </span><span class="s1">= </span><span class="s7">$map</span><span class="s1">[</span><span class="s7">$uchr</span><span class="s1">]</span><span class="s0">;</span>
                    <span class="s7">$nlen </span><span class="s1">= \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s7">$uchr</span><span class="s1">)</span><span class="s0">;</span>

                    <span class="s0">if </span><span class="s1">(</span><span class="s7">$nlen </span><span class="s1">== </span><span class="s7">$ulen</span><span class="s1">) {</span>
                        <span class="s7">$nlen </span><span class="s1">= </span><span class="s7">$i</span><span class="s0">;</span>
                        <span class="s0">do </span><span class="s1">{</span>
                            <span class="s7">$s</span><span class="s1">[--</span><span class="s7">$nlen</span><span class="s1">] = </span><span class="s7">$uchr</span><span class="s1">[--</span><span class="s7">$ulen</span><span class="s1">]</span><span class="s0">;</span>
                        <span class="s1">} </span><span class="s0">while </span><span class="s1">(</span><span class="s7">$ulen</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                        <span class="s7">$s </span><span class="s1">= </span><span class="s3">substr_replace</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$uchr</span><span class="s0">, </span><span class="s7">$i </span><span class="s1">- </span><span class="s7">$ulen</span><span class="s0">, </span><span class="s7">$ulen</span><span class="s1">)</span><span class="s0">;</span>
                        <span class="s7">$len </span><span class="s1">+= </span><span class="s7">$nlen </span><span class="s1">- </span><span class="s7">$ulen</span><span class="s0">;</span>
                        <span class="s7">$i </span><span class="s1">+= </span><span class="s7">$nlen </span><span class="s1">- </span><span class="s7">$ulen</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">$s</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">iconv</span><span class="s1">(</span><span class="s8">'UTF-8'</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">.</span><span class="s8">'//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_internal_encoding</span><span class="s1">(</span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$internalEncoding</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">|| </span><span class="s3">false </span><span class="s1">!== @</span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s0">, </span><span class="s8">' '</span><span class="s1">)) {</span>
            <span class="s3">self</span><span class="s1">::</span><span class="s7">$internalEncoding </span><span class="s1">= </span><span class="s7">$encoding</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">true</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_language</span><span class="s1">(</span><span class="s7">$lang </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$lang</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$language</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">switch </span><span class="s1">(</span><span class="s7">$lang </span><span class="s1">= </span><span class="s3">strtolower</span><span class="s1">(</span><span class="s7">$lang</span><span class="s1">)) {</span>
            <span class="s0">case </span><span class="s8">'uni'</span><span class="s1">:</span>
            <span class="s0">case </span><span class="s8">'neutral'</span><span class="s1">:</span>
                <span class="s3">self</span><span class="s1">::</span><span class="s7">$language </span><span class="s1">= </span><span class="s7">$lang</span><span class="s0">;</span>

                <span class="s0">return </span><span class="s3">true</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_list_encodings</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return array</span><span class="s1">(</span><span class="s8">'UTF-8'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_encoding_aliases</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">switch </span><span class="s1">(</span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)) {</span>
            <span class="s0">case </span><span class="s8">'UTF8'</span><span class="s1">:</span>
            <span class="s0">case </span><span class="s8">'UTF-8'</span><span class="s1">:</span>
                <span class="s0">return array</span><span class="s1">(</span><span class="s8">'utf8'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_check_encoding</span><span class="s1">(</span><span class="s7">$var </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$var</span><span class="s1">) {</span>
                <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$internalEncoding</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_detect_encoding</span><span class="s1">(</span><span class="s7">$var</span><span class="s0">, array</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)) || </span><span class="s3">false </span><span class="s1">!== @</span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s0">, </span><span class="s7">$var</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_detect_encoding</span><span class="s1">(</span><span class="s7">$str</span><span class="s0">, </span><span class="s7">$encodingList </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$strict </span><span class="s1">= </span><span class="s3">false</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encodingList</span><span class="s1">) {</span>
            <span class="s7">$encodingList </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$encodingList</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s7">$encodingList</span><span class="s1">)) {</span>
                <span class="s7">$encodingList </span><span class="s1">= </span><span class="s3">array_map</span><span class="s1">(</span><span class="s8">'trim'</span><span class="s0">, </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">','</span><span class="s0">, </span><span class="s7">$encodingList</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s7">$encodingList </span><span class="s1">= </span><span class="s3">array_map</span><span class="s1">(</span><span class="s8">'strtoupper'</span><span class="s0">, </span><span class="s7">$encodingList</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$encodingList </span><span class="s0">as </span><span class="s7">$enc</span><span class="s1">) {</span>
            <span class="s0">switch </span><span class="s1">(</span><span class="s7">$enc</span><span class="s1">) {</span>
                <span class="s0">case </span><span class="s8">'ASCII'</span><span class="s1">:</span>
                    <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'/[\x80-\xFF]/'</span><span class="s0">, </span><span class="s7">$str</span><span class="s1">)) {</span>
                        <span class="s0">return </span><span class="s7">$enc</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s0">break;</span>

                <span class="s0">case </span><span class="s8">'UTF8'</span><span class="s1">:</span>
                <span class="s0">case </span><span class="s8">'UTF-8'</span><span class="s1">:</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'//u'</span><span class="s0">, </span><span class="s7">$str</span><span class="s1">)) {</span>
                        <span class="s0">return </span><span class="s8">'UTF-8'</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s0">break;</span>

                <span class="s0">default</span><span class="s1">:</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strncmp</span><span class="s1">(</span><span class="s7">$enc</span><span class="s0">, </span><span class="s8">'ISO-8859-'</span><span class="s0">, </span><span class="s9">9</span><span class="s1">)) {</span>
                        <span class="s0">return </span><span class="s7">$enc</span><span class="s0">;</span>
                    <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_detect_order</span><span class="s1">(</span><span class="s7">$encodingList </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encodingList</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$encodingList</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_array</span><span class="s1">(</span><span class="s7">$encodingList</span><span class="s1">)) {</span>
            <span class="s7">$encodingList </span><span class="s1">= </span><span class="s3">array_map</span><span class="s1">(</span><span class="s8">'trim'</span><span class="s0">, </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">','</span><span class="s0">, </span><span class="s7">$encodingList</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s7">$encodingList </span><span class="s1">= </span><span class="s3">array_map</span><span class="s1">(</span><span class="s8">'strtoupper'</span><span class="s0">, </span><span class="s7">$encodingList</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$encodingList </span><span class="s0">as </span><span class="s7">$enc</span><span class="s1">) {</span>
            <span class="s0">switch </span><span class="s1">(</span><span class="s7">$enc</span><span class="s1">) {</span>
                <span class="s0">default</span><span class="s1">:</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s3">strncmp</span><span class="s1">(</span><span class="s7">$enc</span><span class="s0">, </span><span class="s8">'ISO-8859-'</span><span class="s0">, </span><span class="s9">9</span><span class="s1">)) {</span>
                        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s2">// no break</span>
                <span class="s0">case </span><span class="s8">'ASCII'</span><span class="s1">:</span>
                <span class="s0">case </span><span class="s8">'UTF8'</span><span class="s1">:</span>
                <span class="s0">case </span><span class="s8">'UTF-8'</span><span class="s1">:</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">self</span><span class="s1">::</span><span class="s7">$encodingList </span><span class="s1">= </span><span class="s7">$encodingList</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">true</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'CP850' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">|| </span><span class="s8">'ASCII' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s1">\</span><span class="s3">strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s1">@</span><span class="s3">iconv_strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset </span><span class="s1">= </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'CP850' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">|| </span><span class="s8">'ASCII' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">strpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$needle </span><span class="s1">= (string) </span><span class="s7">$needle</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">=== </span><span class="s7">$needle</span><span class="s1">) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s3">__METHOD__</span><span class="s1">.</span><span class="s8">': Empty delimiter'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">iconv_strpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strrpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset </span><span class="s1">= </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'CP850' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">|| </span><span class="s8">'ASCII' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">strrpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$offset </span><span class="s1">!= (int) </span><span class="s7">$offset</span><span class="s1">) {</span>
            <span class="s7">$offset </span><span class="s1">= </span><span class="s9">0</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s7">$offset </span><span class="s1">= (int) </span><span class="s7">$offset</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$offset </span><span class="s1">&lt; </span><span class="s9">0</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">&gt; </span><span class="s7">$offset </span><span class="s1">+= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_strlen</span><span class="s1">(</span><span class="s7">$needle</span><span class="s1">)) {</span>
                    <span class="s7">$haystack </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$offset</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s7">$offset </span><span class="s1">= </span><span class="s9">0</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$haystack </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$offset</span><span class="s0">, </span><span class="s9">2147483647</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s7">$pos </span><span class="s1">= </span><span class="s3">iconv_strrpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">false </span><span class="s1">!== </span><span class="s7">$pos </span><span class="s1">? </span><span class="s7">$offset </span><span class="s1">+ </span><span class="s7">$pos </span><span class="s1">: </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_str_split</span><span class="s1">(</span><span class="s7">$string</span><span class="s0">, </span><span class="s7">$split_length </span><span class="s1">= </span><span class="s9">1</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$string </span><span class="s1">&amp;&amp; !\</span><span class="s3">is_scalar</span><span class="s1">(</span><span class="s7">$string</span><span class="s1">) &amp;&amp; !(\</span><span class="s3">is_object</span><span class="s1">(</span><span class="s7">$string</span><span class="s1">) &amp;&amp; \</span><span class="s3">method_exists</span><span class="s1">(</span><span class="s7">$string</span><span class="s0">, </span><span class="s8">'__toString'</span><span class="s1">))) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'mb_str_split() expects parameter 1 to be string, '</span><span class="s1">.\</span><span class="s3">gettype</span><span class="s1">(</span><span class="s7">$string</span><span class="s1">).</span><span class="s8">' given'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">1 </span><span class="s1">&gt; </span><span class="s7">$split_length </span><span class="s1">= (int) </span><span class="s7">$split_length</span><span class="s1">) {</span>
            <span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'The length of each segment must be greater than zero'</span><span class="s0">, </span><span class="s3">E_USER_WARNING</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">mb_internal_encoding</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)) {</span>
            <span class="s7">$rx </span><span class="s1">= </span><span class="s8">'/('</span><span class="s0">;</span>
            <span class="s0">while </span><span class="s1">(</span><span class="s9">65535 </span><span class="s1">&lt; </span><span class="s7">$split_length</span><span class="s1">) {</span>
                <span class="s7">$rx </span><span class="s1">.= </span><span class="s8">'.{65535}'</span><span class="s0">;</span>
                <span class="s7">$split_length </span><span class="s1">-= </span><span class="s9">65535</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s7">$rx </span><span class="s1">.= </span><span class="s8">'.{'</span><span class="s1">.</span><span class="s7">$split_length</span><span class="s1">.</span><span class="s8">'})/us'</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">preg_split</span><span class="s1">(</span><span class="s7">$rx</span><span class="s0">, </span><span class="s7">$string</span><span class="s0">, </span><span class="s3">null</span><span class="s0">, </span><span class="s3">PREG_SPLIT_DELIM_CAPTURE </span><span class="s1">| </span><span class="s3">PREG_SPLIT_NO_EMPTY</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$result </span><span class="s1">= </span><span class="s0">array</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s7">$length </span><span class="s1">= </span><span class="s3">mb_strlen</span><span class="s1">(</span><span class="s7">$string</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">for </span><span class="s1">(</span><span class="s7">$i </span><span class="s1">= </span><span class="s9">0</span><span class="s0">; </span><span class="s7">$i </span><span class="s1">&lt; </span><span class="s7">$length</span><span class="s0">; </span><span class="s7">$i </span><span class="s1">+= </span><span class="s7">$split_length</span><span class="s1">) {</span>
            <span class="s7">$result</span><span class="s1">[] = </span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$string</span><span class="s0">, </span><span class="s7">$i</span><span class="s0">, </span><span class="s7">$split_length</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s7">$result</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strtolower</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s3">MB_CASE_LOWER</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strtoupper</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s3">MB_CASE_UPPER</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_substitute_character</span><span class="s1">(</span><span class="s7">$c </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strcasecmp</span><span class="s1">(</span><span class="s7">$c</span><span class="s0">, </span><span class="s8">'none'</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s3">true</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$c </span><span class="s1">? </span><span class="s3">false </span><span class="s1">: </span><span class="s8">'none'</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$start</span><span class="s0">, </span><span class="s7">$length </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'CP850' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">|| </span><span class="s8">'ASCII' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s1">(string) </span><span class="s3">substr</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$start</span><span class="s0">, </span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$length </span><span class="s1">? </span><span class="s9">2147483647 </span><span class="s1">: </span><span class="s7">$length</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$start </span><span class="s1">&lt; </span><span class="s9">0</span><span class="s1">) {</span>
            <span class="s7">$start </span><span class="s1">= </span><span class="s3">iconv_strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">) + </span><span class="s7">$start</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$start </span><span class="s1">&lt; </span><span class="s9">0</span><span class="s1">) {</span>
                <span class="s7">$start </span><span class="s1">= </span><span class="s9">0</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$length</span><span class="s1">) {</span>
            <span class="s7">$length </span><span class="s1">= </span><span class="s9">2147483647</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s7">$length </span><span class="s1">&lt; </span><span class="s9">0</span><span class="s1">) {</span>
            <span class="s7">$length </span><span class="s1">= </span><span class="s3">iconv_strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">) + </span><span class="s7">$length </span><span class="s1">- </span><span class="s7">$start</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$length </span><span class="s1">&lt; </span><span class="s9">0</span><span class="s1">) {</span>
                <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s1">(string) </span><span class="s3">iconv_substr</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$start</span><span class="s0">, </span><span class="s7">$length</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_stripos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset </span><span class="s1">= </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$haystack </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s3">MB_CASE_FOLD</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$needle </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$needle</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s3">MB_CASE_FOLD</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_strpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_stristr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$part </span><span class="s1">= </span><span class="s3">false</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$pos </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_stripos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getSubpart</span><span class="s1">(</span><span class="s7">$pos</span><span class="s0">, </span><span class="s7">$part</span><span class="s0">, </span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strrchr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$part </span><span class="s1">= </span><span class="s3">false</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'CP850' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">|| </span><span class="s8">'ASCII' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">strrchr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$part</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s7">$needle </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$needle</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$pos </span><span class="s1">= </span><span class="s3">iconv_strrpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getSubpart</span><span class="s1">(</span><span class="s7">$pos</span><span class="s0">, </span><span class="s7">$part</span><span class="s0">, </span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strrichr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$part </span><span class="s1">= </span><span class="s3">false</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$needle </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$needle</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s9">1</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$pos </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_strripos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getSubpart</span><span class="s1">(</span><span class="s7">$pos</span><span class="s0">, </span><span class="s7">$part</span><span class="s0">, </span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strripos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset </span><span class="s1">= </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$haystack </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s3">MB_CASE_FOLD</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$needle </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$needle</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s3">MB_CASE_FOLD</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_strrpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$offset</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strstr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$part </span><span class="s1">= </span><span class="s3">false</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">=== </span><span class="s7">$pos</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$part</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">substr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$pos</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">substr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$pos</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_get_info</span><span class="s1">(</span><span class="s7">$type </span><span class="s1">= </span><span class="s8">'all'</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$info </span><span class="s1">= </span><span class="s0">array</span><span class="s1">(</span>
            <span class="s8">'internal_encoding' </span><span class="s1">=&gt; </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$internalEncoding</span><span class="s0">,</span>
            <span class="s8">'http_output' </span><span class="s1">=&gt; </span><span class="s8">'pass'</span><span class="s0">,</span>
            <span class="s8">'http_output_conv_mimetypes' </span><span class="s1">=&gt; </span><span class="s8">'^(text/|application/xhtml\+xml)'</span><span class="s0">,</span>
            <span class="s8">'func_overload' </span><span class="s1">=&gt; </span><span class="s9">0</span><span class="s0">,</span>
            <span class="s8">'func_overload_list' </span><span class="s1">=&gt; </span><span class="s8">'no overload'</span><span class="s0">,</span>
            <span class="s8">'mail_charset' </span><span class="s1">=&gt; </span><span class="s8">'UTF-8'</span><span class="s0">,</span>
            <span class="s8">'mail_header_encoding' </span><span class="s1">=&gt; </span><span class="s8">'BASE64'</span><span class="s0">,</span>
            <span class="s8">'mail_body_encoding' </span><span class="s1">=&gt; </span><span class="s8">'BASE64'</span><span class="s0">,</span>
            <span class="s8">'illegal_chars' </span><span class="s1">=&gt; </span><span class="s9">0</span><span class="s0">,</span>
            <span class="s8">'encoding_translation' </span><span class="s1">=&gt; </span><span class="s8">'Off'</span><span class="s0">,</span>
            <span class="s8">'language' </span><span class="s1">=&gt; </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$language</span><span class="s0">,</span>
            <span class="s8">'detect_order' </span><span class="s1">=&gt; </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$encodingList</span><span class="s0">,</span>
            <span class="s8">'substitute_character' </span><span class="s1">=&gt; </span><span class="s8">'none'</span><span class="s0">,</span>
            <span class="s8">'strict_detection' </span><span class="s1">=&gt; </span><span class="s8">'Off'</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'all' </span><span class="s1">=== </span><span class="s7">$type</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s7">$info</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$info</span><span class="s1">[</span><span class="s7">$type</span><span class="s1">])) {</span>
            <span class="s0">return </span><span class="s7">$info</span><span class="s1">[</span><span class="s7">$type</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_http_input</span><span class="s1">(</span><span class="s7">$type </span><span class="s1">= </span><span class="s8">''</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_http_output</span><span class="s1">(</span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$encoding </span><span class="s1">? </span><span class="s8">'pass' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">: </span><span class="s8">'pass'</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_strwidth</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">!== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">iconv</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s0">, </span><span class="s8">'UTF-8//IGNORE'</span><span class="s0">, </span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$s </span><span class="s1">= </span><span class="s3">preg_replace</span><span class="s1">(</span><span class="s8">'/[\x{1100}-\x{115F}\x{2329}\x{232A}\x{2E80}-\x{303E}\x{3040}-\x{A4CF}\x{AC00}-\x{D7A3}\x{F900}-\x{FAFF}\x{FE10}-\x{FE19}\x{FE30}-\x{FE6F}\x{FF00}-\x{FF60}\x{FFE0}-\x{FFE6}\x{20000}-\x{2FFFD}\x{30000}-\x{3FFFD}]/u'</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s7">$s</span><span class="s0">, </span><span class="s1">-</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$wide</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s1">(</span><span class="s7">$wide </span><span class="s1">&lt;&lt; </span><span class="s9">1</span><span class="s1">) + </span><span class="s3">iconv_strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_substr_count</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">substr_count</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$needle</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_output_handler</span><span class="s1">(</span><span class="s7">$contents</span><span class="s0">, </span><span class="s7">$status</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s7">$contents</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_chr</span><span class="s1">(</span><span class="s7">$code</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">&gt; </span><span class="s7">$code </span><span class="s1">%= </span><span class="s9">0x200000</span><span class="s1">) {</span>
            <span class="s7">$s </span><span class="s1">= \</span><span class="s3">chr</span><span class="s1">(</span><span class="s7">$code</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s9">0x800 </span><span class="s1">&gt; </span><span class="s7">$code</span><span class="s1">) {</span>
            <span class="s7">$s </span><span class="s1">= \</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0xC0 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&gt;&gt; </span><span class="s9">6</span><span class="s1">).\</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&amp; </span><span class="s9">0x3F</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s9">0x10000 </span><span class="s1">&gt; </span><span class="s7">$code</span><span class="s1">) {</span>
            <span class="s7">$s </span><span class="s1">= \</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0xE0 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&gt;&gt; </span><span class="s9">12</span><span class="s1">).\</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&gt;&gt; </span><span class="s9">6 </span><span class="s1">&amp; </span><span class="s9">0x3F</span><span class="s1">).\</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&amp; </span><span class="s9">0x3F</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$s </span><span class="s1">= \</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0xF0 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&gt;&gt; </span><span class="s9">18</span><span class="s1">).\</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&gt;&gt; </span><span class="s9">12 </span><span class="s1">&amp; </span><span class="s9">0x3F</span><span class="s1">).\</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&gt;&gt; </span><span class="s9">6 </span><span class="s1">&amp; </span><span class="s9">0x3F</span><span class="s1">).\</span><span class="s3">chr</span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">| </span><span class="s7">$code </span><span class="s1">&amp; </span><span class="s9">0x3F</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">!== </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)) {</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">mb_convert_encoding</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s7">$s</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public static function </span><span class="s3">mb_ord</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">!== </span><span class="s7">$encoding </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)) {</span>
            <span class="s7">$s </span><span class="s1">= </span><span class="s3">mb_convert_encoding</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">1 </span><span class="s1">=== \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s1">\</span><span class="s3">ord</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$code </span><span class="s1">= (</span><span class="s7">$s </span><span class="s1">= </span><span class="s3">unpack</span><span class="s1">(</span><span class="s8">'C*'</span><span class="s0">, </span><span class="s3">substr</span><span class="s1">(</span><span class="s7">$s</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s9">4</span><span class="s1">))) ? </span><span class="s7">$s</span><span class="s1">[</span><span class="s9">1</span><span class="s1">] : </span><span class="s9">0</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">0xF0 </span><span class="s1">&lt;= </span><span class="s7">$code</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s1">((</span><span class="s7">$code </span><span class="s1">- </span><span class="s9">0xF0</span><span class="s1">) &lt;&lt; </span><span class="s9">18</span><span class="s1">) + ((</span><span class="s7">$s</span><span class="s1">[</span><span class="s9">2</span><span class="s1">] - </span><span class="s9">0x80</span><span class="s1">) &lt;&lt; </span><span class="s9">12</span><span class="s1">) + ((</span><span class="s7">$s</span><span class="s1">[</span><span class="s9">3</span><span class="s1">] - </span><span class="s9">0x80</span><span class="s1">) &lt;&lt; </span><span class="s9">6</span><span class="s1">) + </span><span class="s7">$s</span><span class="s1">[</span><span class="s9">4</span><span class="s1">] - </span><span class="s9">0x80</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">0xE0 </span><span class="s1">&lt;= </span><span class="s7">$code</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s1">((</span><span class="s7">$code </span><span class="s1">- </span><span class="s9">0xE0</span><span class="s1">) &lt;&lt; </span><span class="s9">12</span><span class="s1">) + ((</span><span class="s7">$s</span><span class="s1">[</span><span class="s9">2</span><span class="s1">] - </span><span class="s9">0x80</span><span class="s1">) &lt;&lt; </span><span class="s9">6</span><span class="s1">) + </span><span class="s7">$s</span><span class="s1">[</span><span class="s9">3</span><span class="s1">] - </span><span class="s9">0x80</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">0xC0 </span><span class="s1">&lt;= </span><span class="s7">$code</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s1">((</span><span class="s7">$code </span><span class="s1">- </span><span class="s9">0xC0</span><span class="s1">) &lt;&lt; </span><span class="s9">6</span><span class="s1">) + </span><span class="s7">$s</span><span class="s1">[</span><span class="s9">2</span><span class="s1">] - </span><span class="s9">0x80</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s7">$code</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private static function </span><span class="s3">getSubpart</span><span class="s1">(</span><span class="s7">$pos</span><span class="s0">, </span><span class="s7">$part</span><span class="s0">, </span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">=== </span><span class="s7">$pos</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$part</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$pos</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_substr</span><span class="s1">(</span><span class="s7">$haystack</span><span class="s0">, </span><span class="s7">$pos</span><span class="s0">, </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private static function </span><span class="s3">html_encoding_callback</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$m</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$i </span><span class="s1">= </span><span class="s9">1</span><span class="s0">;</span>
        <span class="s7">$entities </span><span class="s1">= </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s7">$m </span><span class="s1">= </span><span class="s3">unpack</span><span class="s1">(</span><span class="s8">'C*'</span><span class="s0">, </span><span class="s3">htmlentities</span><span class="s1">(</span><span class="s7">$m</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">ENT_COMPAT</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s0">while </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s9">0x80 </span><span class="s1">&gt; </span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">]) {</span>
                <span class="s7">$entities </span><span class="s1">.= \</span><span class="s3">chr</span><span class="s1">(</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++])</span><span class="s0">;</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s9">0xF0 </span><span class="s1">&lt;= </span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">]) {</span>
                <span class="s7">$c </span><span class="s1">= ((</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0xF0</span><span class="s1">) &lt;&lt; </span><span class="s9">18</span><span class="s1">) + ((</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0x80</span><span class="s1">) &lt;&lt; </span><span class="s9">12</span><span class="s1">) + ((</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0x80</span><span class="s1">) &lt;&lt; </span><span class="s9">6</span><span class="s1">) + </span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0x80</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s9">0xE0 </span><span class="s1">&lt;= </span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">]) {</span>
                <span class="s7">$c </span><span class="s1">= ((</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0xE0</span><span class="s1">) &lt;&lt; </span><span class="s9">12</span><span class="s1">) + ((</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0x80</span><span class="s1">) &lt;&lt; </span><span class="s9">6</span><span class="s1">) + </span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0x80</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$c </span><span class="s1">= ((</span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0xC0</span><span class="s1">) &lt;&lt; </span><span class="s9">6</span><span class="s1">) + </span><span class="s7">$m</span><span class="s1">[</span><span class="s7">$i</span><span class="s1">++] - </span><span class="s9">0x80</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$entities </span><span class="s1">.= </span><span class="s8">'&amp;#'</span><span class="s1">.</span><span class="s7">$c</span><span class="s1">.</span><span class="s8">';'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s7">$entities</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private static function </span><span class="s3">title_case</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$s</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">MB_CASE_UPPER</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s1">).</span><span class="s3">self</span><span class="s1">::</span><span class="s3">mb_convert_case</span><span class="s1">(</span><span class="s7">$s</span><span class="s1">[</span><span class="s9">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">MB_CASE_LOWER</span><span class="s0">, </span><span class="s8">'UTF-8'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private static function </span><span class="s3">getData</span><span class="s1">(</span><span class="s7">$file</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">file_exists</span><span class="s1">(</span><span class="s7">$file </span><span class="s1">= </span><span class="s3">__DIR__</span><span class="s1">.</span><span class="s8">'/Resources/unidata/'</span><span class="s1">.</span><span class="s7">$file</span><span class="s1">.</span><span class="s8">'.php'</span><span class="s1">)) {</span>
            <span class="s0">return require </span><span class="s7">$file</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private static function </span><span class="s3">getEncoding</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s7">$internalEncoding</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF-8' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">'UTF-8'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$encoding </span><span class="s1">= </span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s7">$encoding</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'8BIT' </span><span class="s1">=== </span><span class="s7">$encoding </span><span class="s1">|| </span><span class="s8">'BINARY' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">'CP850'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'UTF8' </span><span class="s1">=== </span><span class="s7">$encoding</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s8">'UTF-8'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s7">$encoding</span><span class="s0">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>