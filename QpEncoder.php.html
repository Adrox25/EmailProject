<html>
<head>
<title>QpEncoder.php</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #a9b7c6;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #629755; font-weight: bold; font-style: italic;}
.s6 { color: #9876aa;}
.s7 { color: #6897bb;}
.s8 { color: #6a8759;}
.ls0 { height: 1px; border-width: 0; color: #4d4d4d; background-color:#4d4d4d}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
QpEncoder.php</font>
</center></td></tr></table>
<pre><span class="s0">&lt;?php</span>

<span class="s2">/* 
 * This file is part of the Symfony package. 
 * 
 * (c) Fabien Potencier &lt;fabien@symfony.com&gt; 
 * 
 * For the full copyright and license information, please view the LICENSE 
 * file that was distributed with this source code. 
 */</span>
<hr class="ls0"><span class="s0">namespace </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mime</span><span class="s1">\</span><span class="s3">Encoder</span><span class="s0">;</span>

<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mime</span><span class="s1">\</span><span class="s3">CharacterStream</span><span class="s0">;</span>
<hr class="ls0"><span class="s4">/**</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Chris Corbyn</span>
 <span class="s4">*/</span>
<span class="s0">class </span><span class="s3">QpEncoder </span><span class="s0">implements </span><span class="s3">EncoderInterface</span>
<span class="s1">{</span>
    <span class="s4">/**</span>
     <span class="s4">* Pre-computed QP for HUGE optimization.</span>
     <span class="s4">*/</span>
    <span class="s0">private static </span><span class="s6">$qpMap </span><span class="s1">= [</span>
        <span class="s7">0 </span><span class="s1">=&gt; </span><span class="s8">'=00'</span><span class="s0">, </span><span class="s7">1 </span><span class="s1">=&gt; </span><span class="s8">'=01'</span><span class="s0">, </span><span class="s7">2 </span><span class="s1">=&gt; </span><span class="s8">'=02'</span><span class="s0">, </span><span class="s7">3 </span><span class="s1">=&gt; </span><span class="s8">'=03'</span><span class="s0">, </span><span class="s7">4 </span><span class="s1">=&gt; </span><span class="s8">'=04'</span><span class="s0">,</span>
        <span class="s7">5 </span><span class="s1">=&gt; </span><span class="s8">'=05'</span><span class="s0">, </span><span class="s7">6 </span><span class="s1">=&gt; </span><span class="s8">'=06'</span><span class="s0">, </span><span class="s7">7 </span><span class="s1">=&gt; </span><span class="s8">'=07'</span><span class="s0">, </span><span class="s7">8 </span><span class="s1">=&gt; </span><span class="s8">'=08'</span><span class="s0">, </span><span class="s7">9 </span><span class="s1">=&gt; </span><span class="s8">'=09'</span><span class="s0">,</span>
        <span class="s7">10 </span><span class="s1">=&gt; </span><span class="s8">'=0A'</span><span class="s0">, </span><span class="s7">11 </span><span class="s1">=&gt; </span><span class="s8">'=0B'</span><span class="s0">, </span><span class="s7">12 </span><span class="s1">=&gt; </span><span class="s8">'=0C'</span><span class="s0">, </span><span class="s7">13 </span><span class="s1">=&gt; </span><span class="s8">'=0D'</span><span class="s0">, </span><span class="s7">14 </span><span class="s1">=&gt; </span><span class="s8">'=0E'</span><span class="s0">,</span>
        <span class="s7">15 </span><span class="s1">=&gt; </span><span class="s8">'=0F'</span><span class="s0">, </span><span class="s7">16 </span><span class="s1">=&gt; </span><span class="s8">'=10'</span><span class="s0">, </span><span class="s7">17 </span><span class="s1">=&gt; </span><span class="s8">'=11'</span><span class="s0">, </span><span class="s7">18 </span><span class="s1">=&gt; </span><span class="s8">'=12'</span><span class="s0">, </span><span class="s7">19 </span><span class="s1">=&gt; </span><span class="s8">'=13'</span><span class="s0">,</span>
        <span class="s7">20 </span><span class="s1">=&gt; </span><span class="s8">'=14'</span><span class="s0">, </span><span class="s7">21 </span><span class="s1">=&gt; </span><span class="s8">'=15'</span><span class="s0">, </span><span class="s7">22 </span><span class="s1">=&gt; </span><span class="s8">'=16'</span><span class="s0">, </span><span class="s7">23 </span><span class="s1">=&gt; </span><span class="s8">'=17'</span><span class="s0">, </span><span class="s7">24 </span><span class="s1">=&gt; </span><span class="s8">'=18'</span><span class="s0">,</span>
        <span class="s7">25 </span><span class="s1">=&gt; </span><span class="s8">'=19'</span><span class="s0">, </span><span class="s7">26 </span><span class="s1">=&gt; </span><span class="s8">'=1A'</span><span class="s0">, </span><span class="s7">27 </span><span class="s1">=&gt; </span><span class="s8">'=1B'</span><span class="s0">, </span><span class="s7">28 </span><span class="s1">=&gt; </span><span class="s8">'=1C'</span><span class="s0">, </span><span class="s7">29 </span><span class="s1">=&gt; </span><span class="s8">'=1D'</span><span class="s0">,</span>
        <span class="s7">30 </span><span class="s1">=&gt; </span><span class="s8">'=1E'</span><span class="s0">, </span><span class="s7">31 </span><span class="s1">=&gt; </span><span class="s8">'=1F'</span><span class="s0">, </span><span class="s7">32 </span><span class="s1">=&gt; </span><span class="s8">'=20'</span><span class="s0">, </span><span class="s7">33 </span><span class="s1">=&gt; </span><span class="s8">'=21'</span><span class="s0">, </span><span class="s7">34 </span><span class="s1">=&gt; </span><span class="s8">'=22'</span><span class="s0">,</span>
        <span class="s7">35 </span><span class="s1">=&gt; </span><span class="s8">'=23'</span><span class="s0">, </span><span class="s7">36 </span><span class="s1">=&gt; </span><span class="s8">'=24'</span><span class="s0">, </span><span class="s7">37 </span><span class="s1">=&gt; </span><span class="s8">'=25'</span><span class="s0">, </span><span class="s7">38 </span><span class="s1">=&gt; </span><span class="s8">'=26'</span><span class="s0">, </span><span class="s7">39 </span><span class="s1">=&gt; </span><span class="s8">'=27'</span><span class="s0">,</span>
        <span class="s7">40 </span><span class="s1">=&gt; </span><span class="s8">'=28'</span><span class="s0">, </span><span class="s7">41 </span><span class="s1">=&gt; </span><span class="s8">'=29'</span><span class="s0">, </span><span class="s7">42 </span><span class="s1">=&gt; </span><span class="s8">'=2A'</span><span class="s0">, </span><span class="s7">43 </span><span class="s1">=&gt; </span><span class="s8">'=2B'</span><span class="s0">, </span><span class="s7">44 </span><span class="s1">=&gt; </span><span class="s8">'=2C'</span><span class="s0">,</span>
        <span class="s7">45 </span><span class="s1">=&gt; </span><span class="s8">'=2D'</span><span class="s0">, </span><span class="s7">46 </span><span class="s1">=&gt; </span><span class="s8">'=2E'</span><span class="s0">, </span><span class="s7">47 </span><span class="s1">=&gt; </span><span class="s8">'=2F'</span><span class="s0">, </span><span class="s7">48 </span><span class="s1">=&gt; </span><span class="s8">'=30'</span><span class="s0">, </span><span class="s7">49 </span><span class="s1">=&gt; </span><span class="s8">'=31'</span><span class="s0">,</span>
        <span class="s7">50 </span><span class="s1">=&gt; </span><span class="s8">'=32'</span><span class="s0">, </span><span class="s7">51 </span><span class="s1">=&gt; </span><span class="s8">'=33'</span><span class="s0">, </span><span class="s7">52 </span><span class="s1">=&gt; </span><span class="s8">'=34'</span><span class="s0">, </span><span class="s7">53 </span><span class="s1">=&gt; </span><span class="s8">'=35'</span><span class="s0">, </span><span class="s7">54 </span><span class="s1">=&gt; </span><span class="s8">'=36'</span><span class="s0">,</span>
        <span class="s7">55 </span><span class="s1">=&gt; </span><span class="s8">'=37'</span><span class="s0">, </span><span class="s7">56 </span><span class="s1">=&gt; </span><span class="s8">'=38'</span><span class="s0">, </span><span class="s7">57 </span><span class="s1">=&gt; </span><span class="s8">'=39'</span><span class="s0">, </span><span class="s7">58 </span><span class="s1">=&gt; </span><span class="s8">'=3A'</span><span class="s0">, </span><span class="s7">59 </span><span class="s1">=&gt; </span><span class="s8">'=3B'</span><span class="s0">,</span>
        <span class="s7">60 </span><span class="s1">=&gt; </span><span class="s8">'=3C'</span><span class="s0">, </span><span class="s7">61 </span><span class="s1">=&gt; </span><span class="s8">'=3D'</span><span class="s0">, </span><span class="s7">62 </span><span class="s1">=&gt; </span><span class="s8">'=3E'</span><span class="s0">, </span><span class="s7">63 </span><span class="s1">=&gt; </span><span class="s8">'=3F'</span><span class="s0">, </span><span class="s7">64 </span><span class="s1">=&gt; </span><span class="s8">'=40'</span><span class="s0">,</span>
        <span class="s7">65 </span><span class="s1">=&gt; </span><span class="s8">'=41'</span><span class="s0">, </span><span class="s7">66 </span><span class="s1">=&gt; </span><span class="s8">'=42'</span><span class="s0">, </span><span class="s7">67 </span><span class="s1">=&gt; </span><span class="s8">'=43'</span><span class="s0">, </span><span class="s7">68 </span><span class="s1">=&gt; </span><span class="s8">'=44'</span><span class="s0">, </span><span class="s7">69 </span><span class="s1">=&gt; </span><span class="s8">'=45'</span><span class="s0">,</span>
        <span class="s7">70 </span><span class="s1">=&gt; </span><span class="s8">'=46'</span><span class="s0">, </span><span class="s7">71 </span><span class="s1">=&gt; </span><span class="s8">'=47'</span><span class="s0">, </span><span class="s7">72 </span><span class="s1">=&gt; </span><span class="s8">'=48'</span><span class="s0">, </span><span class="s7">73 </span><span class="s1">=&gt; </span><span class="s8">'=49'</span><span class="s0">, </span><span class="s7">74 </span><span class="s1">=&gt; </span><span class="s8">'=4A'</span><span class="s0">,</span>
        <span class="s7">75 </span><span class="s1">=&gt; </span><span class="s8">'=4B'</span><span class="s0">, </span><span class="s7">76 </span><span class="s1">=&gt; </span><span class="s8">'=4C'</span><span class="s0">, </span><span class="s7">77 </span><span class="s1">=&gt; </span><span class="s8">'=4D'</span><span class="s0">, </span><span class="s7">78 </span><span class="s1">=&gt; </span><span class="s8">'=4E'</span><span class="s0">, </span><span class="s7">79 </span><span class="s1">=&gt; </span><span class="s8">'=4F'</span><span class="s0">,</span>
        <span class="s7">80 </span><span class="s1">=&gt; </span><span class="s8">'=50'</span><span class="s0">, </span><span class="s7">81 </span><span class="s1">=&gt; </span><span class="s8">'=51'</span><span class="s0">, </span><span class="s7">82 </span><span class="s1">=&gt; </span><span class="s8">'=52'</span><span class="s0">, </span><span class="s7">83 </span><span class="s1">=&gt; </span><span class="s8">'=53'</span><span class="s0">, </span><span class="s7">84 </span><span class="s1">=&gt; </span><span class="s8">'=54'</span><span class="s0">,</span>
        <span class="s7">85 </span><span class="s1">=&gt; </span><span class="s8">'=55'</span><span class="s0">, </span><span class="s7">86 </span><span class="s1">=&gt; </span><span class="s8">'=56'</span><span class="s0">, </span><span class="s7">87 </span><span class="s1">=&gt; </span><span class="s8">'=57'</span><span class="s0">, </span><span class="s7">88 </span><span class="s1">=&gt; </span><span class="s8">'=58'</span><span class="s0">, </span><span class="s7">89 </span><span class="s1">=&gt; </span><span class="s8">'=59'</span><span class="s0">,</span>
        <span class="s7">90 </span><span class="s1">=&gt; </span><span class="s8">'=5A'</span><span class="s0">, </span><span class="s7">91 </span><span class="s1">=&gt; </span><span class="s8">'=5B'</span><span class="s0">, </span><span class="s7">92 </span><span class="s1">=&gt; </span><span class="s8">'=5C'</span><span class="s0">, </span><span class="s7">93 </span><span class="s1">=&gt; </span><span class="s8">'=5D'</span><span class="s0">, </span><span class="s7">94 </span><span class="s1">=&gt; </span><span class="s8">'=5E'</span><span class="s0">,</span>
        <span class="s7">95 </span><span class="s1">=&gt; </span><span class="s8">'=5F'</span><span class="s0">, </span><span class="s7">96 </span><span class="s1">=&gt; </span><span class="s8">'=60'</span><span class="s0">, </span><span class="s7">97 </span><span class="s1">=&gt; </span><span class="s8">'=61'</span><span class="s0">, </span><span class="s7">98 </span><span class="s1">=&gt; </span><span class="s8">'=62'</span><span class="s0">, </span><span class="s7">99 </span><span class="s1">=&gt; </span><span class="s8">'=63'</span><span class="s0">,</span>
        <span class="s7">100 </span><span class="s1">=&gt; </span><span class="s8">'=64'</span><span class="s0">, </span><span class="s7">101 </span><span class="s1">=&gt; </span><span class="s8">'=65'</span><span class="s0">, </span><span class="s7">102 </span><span class="s1">=&gt; </span><span class="s8">'=66'</span><span class="s0">, </span><span class="s7">103 </span><span class="s1">=&gt; </span><span class="s8">'=67'</span><span class="s0">, </span><span class="s7">104 </span><span class="s1">=&gt; </span><span class="s8">'=68'</span><span class="s0">,</span>
        <span class="s7">105 </span><span class="s1">=&gt; </span><span class="s8">'=69'</span><span class="s0">, </span><span class="s7">106 </span><span class="s1">=&gt; </span><span class="s8">'=6A'</span><span class="s0">, </span><span class="s7">107 </span><span class="s1">=&gt; </span><span class="s8">'=6B'</span><span class="s0">, </span><span class="s7">108 </span><span class="s1">=&gt; </span><span class="s8">'=6C'</span><span class="s0">, </span><span class="s7">109 </span><span class="s1">=&gt; </span><span class="s8">'=6D'</span><span class="s0">,</span>
        <span class="s7">110 </span><span class="s1">=&gt; </span><span class="s8">'=6E'</span><span class="s0">, </span><span class="s7">111 </span><span class="s1">=&gt; </span><span class="s8">'=6F'</span><span class="s0">, </span><span class="s7">112 </span><span class="s1">=&gt; </span><span class="s8">'=70'</span><span class="s0">, </span><span class="s7">113 </span><span class="s1">=&gt; </span><span class="s8">'=71'</span><span class="s0">, </span><span class="s7">114 </span><span class="s1">=&gt; </span><span class="s8">'=72'</span><span class="s0">,</span>
        <span class="s7">115 </span><span class="s1">=&gt; </span><span class="s8">'=73'</span><span class="s0">, </span><span class="s7">116 </span><span class="s1">=&gt; </span><span class="s8">'=74'</span><span class="s0">, </span><span class="s7">117 </span><span class="s1">=&gt; </span><span class="s8">'=75'</span><span class="s0">, </span><span class="s7">118 </span><span class="s1">=&gt; </span><span class="s8">'=76'</span><span class="s0">, </span><span class="s7">119 </span><span class="s1">=&gt; </span><span class="s8">'=77'</span><span class="s0">,</span>
        <span class="s7">120 </span><span class="s1">=&gt; </span><span class="s8">'=78'</span><span class="s0">, </span><span class="s7">121 </span><span class="s1">=&gt; </span><span class="s8">'=79'</span><span class="s0">, </span><span class="s7">122 </span><span class="s1">=&gt; </span><span class="s8">'=7A'</span><span class="s0">, </span><span class="s7">123 </span><span class="s1">=&gt; </span><span class="s8">'=7B'</span><span class="s0">, </span><span class="s7">124 </span><span class="s1">=&gt; </span><span class="s8">'=7C'</span><span class="s0">,</span>
        <span class="s7">125 </span><span class="s1">=&gt; </span><span class="s8">'=7D'</span><span class="s0">, </span><span class="s7">126 </span><span class="s1">=&gt; </span><span class="s8">'=7E'</span><span class="s0">, </span><span class="s7">127 </span><span class="s1">=&gt; </span><span class="s8">'=7F'</span><span class="s0">, </span><span class="s7">128 </span><span class="s1">=&gt; </span><span class="s8">'=80'</span><span class="s0">, </span><span class="s7">129 </span><span class="s1">=&gt; </span><span class="s8">'=81'</span><span class="s0">,</span>
        <span class="s7">130 </span><span class="s1">=&gt; </span><span class="s8">'=82'</span><span class="s0">, </span><span class="s7">131 </span><span class="s1">=&gt; </span><span class="s8">'=83'</span><span class="s0">, </span><span class="s7">132 </span><span class="s1">=&gt; </span><span class="s8">'=84'</span><span class="s0">, </span><span class="s7">133 </span><span class="s1">=&gt; </span><span class="s8">'=85'</span><span class="s0">, </span><span class="s7">134 </span><span class="s1">=&gt; </span><span class="s8">'=86'</span><span class="s0">,</span>
        <span class="s7">135 </span><span class="s1">=&gt; </span><span class="s8">'=87'</span><span class="s0">, </span><span class="s7">136 </span><span class="s1">=&gt; </span><span class="s8">'=88'</span><span class="s0">, </span><span class="s7">137 </span><span class="s1">=&gt; </span><span class="s8">'=89'</span><span class="s0">, </span><span class="s7">138 </span><span class="s1">=&gt; </span><span class="s8">'=8A'</span><span class="s0">, </span><span class="s7">139 </span><span class="s1">=&gt; </span><span class="s8">'=8B'</span><span class="s0">,</span>
        <span class="s7">140 </span><span class="s1">=&gt; </span><span class="s8">'=8C'</span><span class="s0">, </span><span class="s7">141 </span><span class="s1">=&gt; </span><span class="s8">'=8D'</span><span class="s0">, </span><span class="s7">142 </span><span class="s1">=&gt; </span><span class="s8">'=8E'</span><span class="s0">, </span><span class="s7">143 </span><span class="s1">=&gt; </span><span class="s8">'=8F'</span><span class="s0">, </span><span class="s7">144 </span><span class="s1">=&gt; </span><span class="s8">'=90'</span><span class="s0">,</span>
        <span class="s7">145 </span><span class="s1">=&gt; </span><span class="s8">'=91'</span><span class="s0">, </span><span class="s7">146 </span><span class="s1">=&gt; </span><span class="s8">'=92'</span><span class="s0">, </span><span class="s7">147 </span><span class="s1">=&gt; </span><span class="s8">'=93'</span><span class="s0">, </span><span class="s7">148 </span><span class="s1">=&gt; </span><span class="s8">'=94'</span><span class="s0">, </span><span class="s7">149 </span><span class="s1">=&gt; </span><span class="s8">'=95'</span><span class="s0">,</span>
        <span class="s7">150 </span><span class="s1">=&gt; </span><span class="s8">'=96'</span><span class="s0">, </span><span class="s7">151 </span><span class="s1">=&gt; </span><span class="s8">'=97'</span><span class="s0">, </span><span class="s7">152 </span><span class="s1">=&gt; </span><span class="s8">'=98'</span><span class="s0">, </span><span class="s7">153 </span><span class="s1">=&gt; </span><span class="s8">'=99'</span><span class="s0">, </span><span class="s7">154 </span><span class="s1">=&gt; </span><span class="s8">'=9A'</span><span class="s0">,</span>
        <span class="s7">155 </span><span class="s1">=&gt; </span><span class="s8">'=9B'</span><span class="s0">, </span><span class="s7">156 </span><span class="s1">=&gt; </span><span class="s8">'=9C'</span><span class="s0">, </span><span class="s7">157 </span><span class="s1">=&gt; </span><span class="s8">'=9D'</span><span class="s0">, </span><span class="s7">158 </span><span class="s1">=&gt; </span><span class="s8">'=9E'</span><span class="s0">, </span><span class="s7">159 </span><span class="s1">=&gt; </span><span class="s8">'=9F'</span><span class="s0">,</span>
        <span class="s7">160 </span><span class="s1">=&gt; </span><span class="s8">'=A0'</span><span class="s0">, </span><span class="s7">161 </span><span class="s1">=&gt; </span><span class="s8">'=A1'</span><span class="s0">, </span><span class="s7">162 </span><span class="s1">=&gt; </span><span class="s8">'=A2'</span><span class="s0">, </span><span class="s7">163 </span><span class="s1">=&gt; </span><span class="s8">'=A3'</span><span class="s0">, </span><span class="s7">164 </span><span class="s1">=&gt; </span><span class="s8">'=A4'</span><span class="s0">,</span>
        <span class="s7">165 </span><span class="s1">=&gt; </span><span class="s8">'=A5'</span><span class="s0">, </span><span class="s7">166 </span><span class="s1">=&gt; </span><span class="s8">'=A6'</span><span class="s0">, </span><span class="s7">167 </span><span class="s1">=&gt; </span><span class="s8">'=A7'</span><span class="s0">, </span><span class="s7">168 </span><span class="s1">=&gt; </span><span class="s8">'=A8'</span><span class="s0">, </span><span class="s7">169 </span><span class="s1">=&gt; </span><span class="s8">'=A9'</span><span class="s0">,</span>
        <span class="s7">170 </span><span class="s1">=&gt; </span><span class="s8">'=AA'</span><span class="s0">, </span><span class="s7">171 </span><span class="s1">=&gt; </span><span class="s8">'=AB'</span><span class="s0">, </span><span class="s7">172 </span><span class="s1">=&gt; </span><span class="s8">'=AC'</span><span class="s0">, </span><span class="s7">173 </span><span class="s1">=&gt; </span><span class="s8">'=AD'</span><span class="s0">, </span><span class="s7">174 </span><span class="s1">=&gt; </span><span class="s8">'=AE'</span><span class="s0">,</span>
        <span class="s7">175 </span><span class="s1">=&gt; </span><span class="s8">'=AF'</span><span class="s0">, </span><span class="s7">176 </span><span class="s1">=&gt; </span><span class="s8">'=B0'</span><span class="s0">, </span><span class="s7">177 </span><span class="s1">=&gt; </span><span class="s8">'=B1'</span><span class="s0">, </span><span class="s7">178 </span><span class="s1">=&gt; </span><span class="s8">'=B2'</span><span class="s0">, </span><span class="s7">179 </span><span class="s1">=&gt; </span><span class="s8">'=B3'</span><span class="s0">,</span>
        <span class="s7">180 </span><span class="s1">=&gt; </span><span class="s8">'=B4'</span><span class="s0">, </span><span class="s7">181 </span><span class="s1">=&gt; </span><span class="s8">'=B5'</span><span class="s0">, </span><span class="s7">182 </span><span class="s1">=&gt; </span><span class="s8">'=B6'</span><span class="s0">, </span><span class="s7">183 </span><span class="s1">=&gt; </span><span class="s8">'=B7'</span><span class="s0">, </span><span class="s7">184 </span><span class="s1">=&gt; </span><span class="s8">'=B8'</span><span class="s0">,</span>
        <span class="s7">185 </span><span class="s1">=&gt; </span><span class="s8">'=B9'</span><span class="s0">, </span><span class="s7">186 </span><span class="s1">=&gt; </span><span class="s8">'=BA'</span><span class="s0">, </span><span class="s7">187 </span><span class="s1">=&gt; </span><span class="s8">'=BB'</span><span class="s0">, </span><span class="s7">188 </span><span class="s1">=&gt; </span><span class="s8">'=BC'</span><span class="s0">, </span><span class="s7">189 </span><span class="s1">=&gt; </span><span class="s8">'=BD'</span><span class="s0">,</span>
        <span class="s7">190 </span><span class="s1">=&gt; </span><span class="s8">'=BE'</span><span class="s0">, </span><span class="s7">191 </span><span class="s1">=&gt; </span><span class="s8">'=BF'</span><span class="s0">, </span><span class="s7">192 </span><span class="s1">=&gt; </span><span class="s8">'=C0'</span><span class="s0">, </span><span class="s7">193 </span><span class="s1">=&gt; </span><span class="s8">'=C1'</span><span class="s0">, </span><span class="s7">194 </span><span class="s1">=&gt; </span><span class="s8">'=C2'</span><span class="s0">,</span>
        <span class="s7">195 </span><span class="s1">=&gt; </span><span class="s8">'=C3'</span><span class="s0">, </span><span class="s7">196 </span><span class="s1">=&gt; </span><span class="s8">'=C4'</span><span class="s0">, </span><span class="s7">197 </span><span class="s1">=&gt; </span><span class="s8">'=C5'</span><span class="s0">, </span><span class="s7">198 </span><span class="s1">=&gt; </span><span class="s8">'=C6'</span><span class="s0">, </span><span class="s7">199 </span><span class="s1">=&gt; </span><span class="s8">'=C7'</span><span class="s0">,</span>
        <span class="s7">200 </span><span class="s1">=&gt; </span><span class="s8">'=C8'</span><span class="s0">, </span><span class="s7">201 </span><span class="s1">=&gt; </span><span class="s8">'=C9'</span><span class="s0">, </span><span class="s7">202 </span><span class="s1">=&gt; </span><span class="s8">'=CA'</span><span class="s0">, </span><span class="s7">203 </span><span class="s1">=&gt; </span><span class="s8">'=CB'</span><span class="s0">, </span><span class="s7">204 </span><span class="s1">=&gt; </span><span class="s8">'=CC'</span><span class="s0">,</span>
        <span class="s7">205 </span><span class="s1">=&gt; </span><span class="s8">'=CD'</span><span class="s0">, </span><span class="s7">206 </span><span class="s1">=&gt; </span><span class="s8">'=CE'</span><span class="s0">, </span><span class="s7">207 </span><span class="s1">=&gt; </span><span class="s8">'=CF'</span><span class="s0">, </span><span class="s7">208 </span><span class="s1">=&gt; </span><span class="s8">'=D0'</span><span class="s0">, </span><span class="s7">209 </span><span class="s1">=&gt; </span><span class="s8">'=D1'</span><span class="s0">,</span>
        <span class="s7">210 </span><span class="s1">=&gt; </span><span class="s8">'=D2'</span><span class="s0">, </span><span class="s7">211 </span><span class="s1">=&gt; </span><span class="s8">'=D3'</span><span class="s0">, </span><span class="s7">212 </span><span class="s1">=&gt; </span><span class="s8">'=D4'</span><span class="s0">, </span><span class="s7">213 </span><span class="s1">=&gt; </span><span class="s8">'=D5'</span><span class="s0">, </span><span class="s7">214 </span><span class="s1">=&gt; </span><span class="s8">'=D6'</span><span class="s0">,</span>
        <span class="s7">215 </span><span class="s1">=&gt; </span><span class="s8">'=D7'</span><span class="s0">, </span><span class="s7">216 </span><span class="s1">=&gt; </span><span class="s8">'=D8'</span><span class="s0">, </span><span class="s7">217 </span><span class="s1">=&gt; </span><span class="s8">'=D9'</span><span class="s0">, </span><span class="s7">218 </span><span class="s1">=&gt; </span><span class="s8">'=DA'</span><span class="s0">, </span><span class="s7">219 </span><span class="s1">=&gt; </span><span class="s8">'=DB'</span><span class="s0">,</span>
        <span class="s7">220 </span><span class="s1">=&gt; </span><span class="s8">'=DC'</span><span class="s0">, </span><span class="s7">221 </span><span class="s1">=&gt; </span><span class="s8">'=DD'</span><span class="s0">, </span><span class="s7">222 </span><span class="s1">=&gt; </span><span class="s8">'=DE'</span><span class="s0">, </span><span class="s7">223 </span><span class="s1">=&gt; </span><span class="s8">'=DF'</span><span class="s0">, </span><span class="s7">224 </span><span class="s1">=&gt; </span><span class="s8">'=E0'</span><span class="s0">,</span>
        <span class="s7">225 </span><span class="s1">=&gt; </span><span class="s8">'=E1'</span><span class="s0">, </span><span class="s7">226 </span><span class="s1">=&gt; </span><span class="s8">'=E2'</span><span class="s0">, </span><span class="s7">227 </span><span class="s1">=&gt; </span><span class="s8">'=E3'</span><span class="s0">, </span><span class="s7">228 </span><span class="s1">=&gt; </span><span class="s8">'=E4'</span><span class="s0">, </span><span class="s7">229 </span><span class="s1">=&gt; </span><span class="s8">'=E5'</span><span class="s0">,</span>
        <span class="s7">230 </span><span class="s1">=&gt; </span><span class="s8">'=E6'</span><span class="s0">, </span><span class="s7">231 </span><span class="s1">=&gt; </span><span class="s8">'=E7'</span><span class="s0">, </span><span class="s7">232 </span><span class="s1">=&gt; </span><span class="s8">'=E8'</span><span class="s0">, </span><span class="s7">233 </span><span class="s1">=&gt; </span><span class="s8">'=E9'</span><span class="s0">, </span><span class="s7">234 </span><span class="s1">=&gt; </span><span class="s8">'=EA'</span><span class="s0">,</span>
        <span class="s7">235 </span><span class="s1">=&gt; </span><span class="s8">'=EB'</span><span class="s0">, </span><span class="s7">236 </span><span class="s1">=&gt; </span><span class="s8">'=EC'</span><span class="s0">, </span><span class="s7">237 </span><span class="s1">=&gt; </span><span class="s8">'=ED'</span><span class="s0">, </span><span class="s7">238 </span><span class="s1">=&gt; </span><span class="s8">'=EE'</span><span class="s0">, </span><span class="s7">239 </span><span class="s1">=&gt; </span><span class="s8">'=EF'</span><span class="s0">,</span>
        <span class="s7">240 </span><span class="s1">=&gt; </span><span class="s8">'=F0'</span><span class="s0">, </span><span class="s7">241 </span><span class="s1">=&gt; </span><span class="s8">'=F1'</span><span class="s0">, </span><span class="s7">242 </span><span class="s1">=&gt; </span><span class="s8">'=F2'</span><span class="s0">, </span><span class="s7">243 </span><span class="s1">=&gt; </span><span class="s8">'=F3'</span><span class="s0">, </span><span class="s7">244 </span><span class="s1">=&gt; </span><span class="s8">'=F4'</span><span class="s0">,</span>
        <span class="s7">245 </span><span class="s1">=&gt; </span><span class="s8">'=F5'</span><span class="s0">, </span><span class="s7">246 </span><span class="s1">=&gt; </span><span class="s8">'=F6'</span><span class="s0">, </span><span class="s7">247 </span><span class="s1">=&gt; </span><span class="s8">'=F7'</span><span class="s0">, </span><span class="s7">248 </span><span class="s1">=&gt; </span><span class="s8">'=F8'</span><span class="s0">, </span><span class="s7">249 </span><span class="s1">=&gt; </span><span class="s8">'=F9'</span><span class="s0">,</span>
        <span class="s7">250 </span><span class="s1">=&gt; </span><span class="s8">'=FA'</span><span class="s0">, </span><span class="s7">251 </span><span class="s1">=&gt; </span><span class="s8">'=FB'</span><span class="s0">, </span><span class="s7">252 </span><span class="s1">=&gt; </span><span class="s8">'=FC'</span><span class="s0">, </span><span class="s7">253 </span><span class="s1">=&gt; </span><span class="s8">'=FD'</span><span class="s0">, </span><span class="s7">254 </span><span class="s1">=&gt; </span><span class="s8">'=FE'</span><span class="s0">,</span>
        <span class="s7">255 </span><span class="s1">=&gt; </span><span class="s8">'=FF'</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">;</span>

    <span class="s0">private static </span><span class="s6">$safeMapShare </span><span class="s1">= []</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* A map of non-encoded ascii characters.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string[]</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@internal</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s6">$safeMap </span><span class="s1">= []</span><span class="s0">;</span>

    <span class="s0">public function </span><span class="s3">__construct</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s6">$id </span><span class="s1">= </span><span class="s0">static</span><span class="s1">::</span><span class="s0">class;</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s6">$safeMapShare</span><span class="s1">[</span><span class="s6">$id</span><span class="s1">])) {</span>
            <span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">initSafeMap</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s3">self</span><span class="s1">::</span><span class="s6">$safeMapShare</span><span class="s1">[</span><span class="s6">$id</span><span class="s1">] = </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">safeMap</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">safeMap </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s6">$safeMapShare</span><span class="s1">[</span><span class="s6">$id</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">protected function </span><span class="s3">initSafeMap</span><span class="s1">(): </span><span class="s3">void</span>
    <span class="s1">{</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s3">array_merge</span><span class="s1">([</span><span class="s7">0x09</span><span class="s0">, </span><span class="s7">0x20</span><span class="s1">]</span><span class="s0">, </span><span class="s3">range</span><span class="s1">(</span><span class="s7">0x21</span><span class="s0">, </span><span class="s7">0x3C</span><span class="s1">)</span><span class="s0">, </span><span class="s3">range</span><span class="s1">(</span><span class="s7">0x3E</span><span class="s0">, </span><span class="s7">0x7E</span><span class="s1">)) </span><span class="s0">as </span><span class="s6">$byte</span><span class="s1">) {</span>
            <span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">safeMap</span><span class="s1">[</span><span class="s6">$byte</span><span class="s1">] = \</span><span class="s3">chr</span><span class="s1">(</span><span class="s6">$byte</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* {</span><span class="s5">@inheritdoc</span><span class="s4">}</span>
     <span class="s4">*</span>
     <span class="s4">* Takes an unencoded string and produces a QP encoded string from it.</span>
     <span class="s4">*</span>
     <span class="s4">* QP encoded strings have a maximum line length of 76 characters.</span>
     <span class="s4">* If the first line needs to be shorter, indicate the difference with</span>
     <span class="s4">* $firstLineOffset.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">encodeString</span><span class="s1">(</span><span class="s3">string </span><span class="s6">$string</span><span class="s0">, </span><span class="s1">?</span><span class="s3">string </span><span class="s6">$charset </span><span class="s1">= </span><span class="s8">'utf-8'</span><span class="s0">, </span><span class="s3">int </span><span class="s6">$firstLineOffset </span><span class="s1">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">int </span><span class="s6">$maxLineLength </span><span class="s1">= </span><span class="s7">0</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s6">$maxLineLength </span><span class="s1">&gt; </span><span class="s7">76 </span><span class="s1">|| </span><span class="s6">$maxLineLength </span><span class="s1">&lt;= </span><span class="s7">0</span><span class="s1">) {</span>
            <span class="s6">$maxLineLength </span><span class="s1">= </span><span class="s7">76</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s6">$thisLineLength </span><span class="s1">= </span><span class="s6">$maxLineLength </span><span class="s1">- </span><span class="s6">$firstLineOffset</span><span class="s0">;</span>

        <span class="s6">$lines </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s6">$lNo </span><span class="s1">= </span><span class="s7">0</span><span class="s0">;</span>
        <span class="s6">$lines</span><span class="s1">[</span><span class="s6">$lNo</span><span class="s1">] = </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s6">$currentLine </span><span class="s1">= &amp;</span><span class="s6">$lines</span><span class="s1">[</span><span class="s6">$lNo</span><span class="s1">++]</span><span class="s0">;</span>
        <span class="s6">$size </span><span class="s1">= </span><span class="s6">$lineLen </span><span class="s1">= </span><span class="s7">0</span><span class="s0">;</span>
        <span class="s6">$charStream </span><span class="s1">= </span><span class="s0">new </span><span class="s3">CharacterStream</span><span class="s1">(</span><span class="s6">$string</span><span class="s0">, </span><span class="s6">$charset</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s2">// Fetching more than 4 chars at one is slower, as is fetching fewer bytes</span>
        <span class="s2">// Conveniently 4 chars is the UTF-8 safe number since UTF-8 has up to 6</span>
        <span class="s2">// bytes per char and (6 * 4 * 3 = 72 chars per line) * =NN is 3 bytes</span>
        <span class="s0">while </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s6">$bytes </span><span class="s1">= </span><span class="s6">$charStream</span><span class="s1">-&gt;</span><span class="s3">readBytes</span><span class="s1">(</span><span class="s7">4</span><span class="s1">)) {</span>
            <span class="s6">$enc </span><span class="s1">= </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">encodeByteSequence</span><span class="s1">(</span><span class="s6">$bytes</span><span class="s0">, </span><span class="s6">$size</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s6">$i </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s6">$enc</span><span class="s0">, </span><span class="s8">'=0D=0A'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s6">$newLineLength </span><span class="s1">= </span><span class="s6">$lineLen </span><span class="s1">+ (</span><span class="s3">false </span><span class="s1">=== </span><span class="s6">$i </span><span class="s1">? </span><span class="s6">$size </span><span class="s1">: </span><span class="s6">$i</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s6">$currentLine </span><span class="s1">&amp;&amp; </span><span class="s6">$newLineLength </span><span class="s1">&gt;= </span><span class="s6">$thisLineLength</span><span class="s1">) {</span>
                <span class="s6">$lines</span><span class="s1">[</span><span class="s6">$lNo</span><span class="s1">] = </span><span class="s8">''</span><span class="s0">;</span>
                <span class="s6">$currentLine </span><span class="s1">= &amp;</span><span class="s6">$lines</span><span class="s1">[</span><span class="s6">$lNo</span><span class="s1">++]</span><span class="s0">;</span>
                <span class="s6">$thisLineLength </span><span class="s1">= </span><span class="s6">$maxLineLength</span><span class="s0">;</span>
                <span class="s6">$lineLen </span><span class="s1">= </span><span class="s7">0</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s6">$currentLine </span><span class="s1">.= </span><span class="s6">$enc</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">=== </span><span class="s6">$i</span><span class="s1">) {</span>
                <span class="s6">$lineLen </span><span class="s1">+= </span><span class="s6">$size</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s2">// 6 is the length of '=0D=0A'.</span>
                <span class="s6">$lineLen </span><span class="s1">= </span><span class="s6">$size </span><span class="s1">- </span><span class="s3">strrpos</span><span class="s1">(</span><span class="s6">$enc</span><span class="s0">, </span><span class="s8">'=0D=0A'</span><span class="s1">) - </span><span class="s7">6</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">standardize</span><span class="s1">(</span><span class="s3">implode</span><span class="s1">(</span><span class="s8">&quot;=</span><span class="s0">\r\n</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s6">$lines</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Encode the given byte array into a verbatim QP form.</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">encodeByteSequence</span><span class="s1">(</span><span class="s0">array </span><span class="s6">$bytes</span><span class="s0">, </span><span class="s3">int </span><span class="s1">&amp;</span><span class="s6">$size</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s6">$ret </span><span class="s1">= </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s6">$size </span><span class="s1">= </span><span class="s7">0</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s6">$bytes </span><span class="s0">as </span><span class="s6">$b</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">safeMap</span><span class="s1">[</span><span class="s6">$b</span><span class="s1">])) {</span>
                <span class="s6">$ret </span><span class="s1">.= </span><span class="s6">$this</span><span class="s1">-&gt;</span><span class="s3">safeMap</span><span class="s1">[</span><span class="s6">$b</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s1">++</span><span class="s6">$size</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s6">$ret </span><span class="s1">.= </span><span class="s3">self</span><span class="s1">::</span><span class="s6">$qpMap</span><span class="s1">[</span><span class="s6">$b</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s6">$size </span><span class="s1">+= </span><span class="s7">3</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s6">$ret</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Make sure CRLF is correct and HT/SPACE are in valid places.</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">standardize</span><span class="s1">(</span><span class="s3">string </span><span class="s6">$string</span><span class="s1">): </span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s6">$string </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">([</span><span class="s8">&quot;</span><span class="s0">\t</span><span class="s8">=0D=0A&quot;</span><span class="s0">, </span><span class="s8">' =0D=0A'</span><span class="s0">, </span><span class="s8">'=0D=0A'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s8">&quot;=09</span><span class="s0">\r\n</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;=20</span><span class="s0">\r\n</span><span class="s8">&quot;</span><span class="s0">, </span><span class="s8">&quot;</span><span class="s0">\r\n</span><span class="s8">&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s6">$string</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">switch </span><span class="s1">(</span><span class="s6">$end </span><span class="s1">= \</span><span class="s3">ord</span><span class="s1">(</span><span class="s3">substr</span><span class="s1">(</span><span class="s6">$string</span><span class="s0">, </span><span class="s1">-</span><span class="s7">1</span><span class="s1">))) {</span>
            <span class="s0">case </span><span class="s7">0x09</span><span class="s1">:</span>
            <span class="s0">case </span><span class="s7">0x20</span><span class="s1">:</span>
                <span class="s6">$string </span><span class="s1">= </span><span class="s3">substr_replace</span><span class="s1">(</span><span class="s6">$string</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s6">$qpMap</span><span class="s1">[</span><span class="s6">$end</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s7">1</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s6">$string</span><span class="s0">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>