<html>
<head>
<title>Request.php</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #a9b7c6;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #629755; font-weight: bold; font-style: italic;}
.s6 { color: #77b767; font-style: italic;}
.s7 { color: #6897bb;}
.s8 { color: #6a8759;}
.s9 { color: #9876aa;}
.ls0 { height: 1px; border-width: 0; color: #4d4d4d; background-color:#4d4d4d}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Request.php</font>
</center></td></tr></table>
<pre><span class="s0">&lt;?php</span>

<span class="s2">/* 
 * This file is part of the Symfony package. 
 * 
 * (c) Fabien Potencier &lt;fabien@symfony.com&gt; 
 * 
 * For the full copyright and license information, please view the LICENSE 
 * file that was distributed with this source code. 
 */</span>
<hr class="ls0"><span class="s0">namespace </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpFoundation</span><span class="s0">;</span>

<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpFoundation</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">ConflictingHeadersException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpFoundation</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">SuspiciousOperationException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpFoundation</span><span class="s1">\</span><span class="s3">Session</span><span class="s1">\</span><span class="s3">SessionInterface</span><span class="s0">;</span>

<span class="s2">// Help opcache.preload discover always-needed symbols</span>
<span class="s3">class_exists</span><span class="s1">(</span><span class="s3">AcceptHeader</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
<span class="s3">class_exists</span><span class="s1">(</span><span class="s3">FileBag</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
<span class="s3">class_exists</span><span class="s1">(</span><span class="s3">HeaderBag</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
<span class="s3">class_exists</span><span class="s1">(</span><span class="s3">HeaderUtils</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
<span class="s3">class_exists</span><span class="s1">(</span><span class="s3">ParameterBag</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
<span class="s3">class_exists</span><span class="s1">(</span><span class="s3">ServerBag</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
<hr class="ls0"><span class="s4">/**</span>
 <span class="s4">* Request represents an HTTP request.</span>
 <span class="s4">*</span>
 <span class="s4">* The methods dealing with URL accept / return a raw path (% encoded):</span>
 <span class="s4">*   * getBasePath</span>
 <span class="s4">*   * getBaseUrl</span>
 <span class="s4">*   * getPathInfo</span>
 <span class="s4">*   * getRequestUri</span>
 <span class="s4">*   * getUri</span>
 <span class="s4">*   * getUriForPath</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Fabien Potencier </span><span class="s6">&lt;fabien</span><span class="s4">@symfony.com&gt;</span>
 <span class="s4">*/</span>
<span class="s0">class </span><span class="s3">Request</span>
<span class="s1">{</span>
    <span class="s0">const </span><span class="s3">HEADER_FORWARDED </span><span class="s1">= </span><span class="s7">0b00001</span><span class="s0">; </span><span class="s2">// When using RFC 7239</span>
    <span class="s0">const </span><span class="s3">HEADER_X_FORWARDED_FOR </span><span class="s1">= </span><span class="s7">0b00010</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">HEADER_X_FORWARDED_HOST </span><span class="s1">= </span><span class="s7">0b00100</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">HEADER_X_FORWARDED_PROTO </span><span class="s1">= </span><span class="s7">0b01000</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">HEADER_X_FORWARDED_PORT </span><span class="s1">= </span><span class="s7">0b10000</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">HEADER_X_FORWARDED_ALL </span><span class="s1">= </span><span class="s7">0b11110</span><span class="s0">; </span><span class="s2">// All &quot;X-Forwarded-*&quot; headers</span>
    <span class="s0">const </span><span class="s3">HEADER_X_FORWARDED_AWS_ELB </span><span class="s1">= </span><span class="s7">0b11010</span><span class="s0">; </span><span class="s2">// AWS ELB doesn't send X-Forwarded-Host</span>

    <span class="s0">const </span><span class="s3">METHOD_HEAD </span><span class="s1">= </span><span class="s8">'HEAD'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_GET </span><span class="s1">= </span><span class="s8">'GET'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_POST </span><span class="s1">= </span><span class="s8">'POST'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_PUT </span><span class="s1">= </span><span class="s8">'PUT'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_PATCH </span><span class="s1">= </span><span class="s8">'PATCH'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_DELETE </span><span class="s1">= </span><span class="s8">'DELETE'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_PURGE </span><span class="s1">= </span><span class="s8">'PURGE'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_OPTIONS </span><span class="s1">= </span><span class="s8">'OPTIONS'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_TRACE </span><span class="s1">= </span><span class="s8">'TRACE'</span><span class="s0">;</span>
    <span class="s0">const </span><span class="s3">METHOD_CONNECT </span><span class="s1">= </span><span class="s8">'CONNECT'</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string[]</span>
     <span class="s4">*/</span>
    <span class="s0">protected static </span><span class="s9">$trustedProxies </span><span class="s1">= []</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string[]</span>
     <span class="s4">*/</span>
    <span class="s0">protected static </span><span class="s9">$trustedHostPatterns </span><span class="s1">= []</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string[]</span>
     <span class="s4">*/</span>
    <span class="s0">protected static </span><span class="s9">$trustedHosts </span><span class="s1">= []</span><span class="s0">;</span>

    <span class="s0">protected static </span><span class="s9">$httpMethodParameterOverride </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Custom parameters.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">ParameterBag</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s9">$attributes</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Request body parameters ($_POST).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">ParameterBag</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s9">$request</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Query string parameters ($_GET).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">ParameterBag</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s9">$query</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Server and execution environment parameters ($_SERVER).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">ServerBag</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s9">$server</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Uploaded files ($_FILES).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">FileBag</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s9">$files</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Cookies ($_COOKIE).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">ParameterBag</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s9">$cookies</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Headers (taken from the $_SERVER).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">HeaderBag</span>
     <span class="s4">*/</span>
    <span class="s0">public </span><span class="s9">$headers</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string|resource|false|null</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$content</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">array</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$languages</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">array</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$charsets</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">array</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$encodings</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">array</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$acceptableContentTypes</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$pathInfo</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$requestUri</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$baseUrl</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$basePath</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$method</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$format</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">SessionInterface</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$session</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$locale</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected </span><span class="s9">$defaultLocale </span><span class="s1">= </span><span class="s8">'en'</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">array</span>
     <span class="s4">*/</span>
    <span class="s0">protected static </span><span class="s9">$formats</span><span class="s0">;</span>

    <span class="s0">protected static </span><span class="s9">$requestFactory</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@var </span><span class="s4">string|null</span>
     <span class="s4">*/</span>
    <span class="s0">private </span><span class="s9">$preferredFormat</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s9">$isHostValid </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s9">$isForwardedValid </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>

    <span class="s0">private static </span><span class="s9">$trustedHeaderSet </span><span class="s1">= -</span><span class="s7">1</span><span class="s0">;</span>

    <span class="s0">private static </span><span class="s9">$forwardedParams </span><span class="s1">= [</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_FOR </span><span class="s1">=&gt; </span><span class="s8">'for'</span><span class="s0">,</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_HOST </span><span class="s1">=&gt; </span><span class="s8">'host'</span><span class="s0">,</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PROTO </span><span class="s1">=&gt; </span><span class="s8">'proto'</span><span class="s0">,</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PORT </span><span class="s1">=&gt; </span><span class="s8">'host'</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Names for headers that can be trusted when</span>
     <span class="s4">* using trusted proxies.</span>
     <span class="s4">*</span>
     <span class="s4">* The FORWARDED header is the standard as of rfc7239.</span>
     <span class="s4">*</span>
     <span class="s4">* The other headers are non-standard, but widely used</span>
     <span class="s4">* by popular reverse proxies (like Apache mod_proxy or Amazon EC2).</span>
     <span class="s4">*/</span>
    <span class="s0">private static </span><span class="s9">$trustedHeaders </span><span class="s1">= [</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_FORWARDED </span><span class="s1">=&gt; </span><span class="s8">'FORWARDED'</span><span class="s0">,</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_FOR </span><span class="s1">=&gt; </span><span class="s8">'X_FORWARDED_FOR'</span><span class="s0">,</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_HOST </span><span class="s1">=&gt; </span><span class="s8">'X_FORWARDED_HOST'</span><span class="s0">,</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PROTO </span><span class="s1">=&gt; </span><span class="s8">'X_FORWARDED_PROTO'</span><span class="s0">,</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PORT </span><span class="s1">=&gt; </span><span class="s8">'X_FORWARDED_PORT'</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $query      The GET parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $request    The POST parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $attributes The request attributes (parameters parsed from the PATH_INFO, ...)</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $cookies    The COOKIE parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $files      The FILES parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $server     The SERVER parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string|resource|null $content    The raw body data</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">__construct</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$query </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$request </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$attributes </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$cookies </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$files </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$server </span><span class="s1">= []</span><span class="s0">, </span><span class="s9">$content </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">initialize</span><span class="s1">(</span><span class="s9">$query</span><span class="s0">, </span><span class="s9">$request</span><span class="s0">, </span><span class="s9">$attributes</span><span class="s0">, </span><span class="s9">$cookies</span><span class="s0">, </span><span class="s9">$files</span><span class="s0">, </span><span class="s9">$server</span><span class="s0">, </span><span class="s9">$content</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the parameters for this request.</span>
     <span class="s4">*</span>
     <span class="s4">* This method also re-initializes all properties.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $query      The GET parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $request    The POST parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $attributes The request attributes (parameters parsed from the PATH_INFO, ...)</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $cookies    The COOKIE parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $files      The FILES parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $server     The SERVER parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string|resource|null $content    The raw body data</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">initialize</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$query </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$request </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$attributes </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$cookies </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$files </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$server </span><span class="s1">= []</span><span class="s0">, </span><span class="s9">$content </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">request </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$request</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">query </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$query</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">attributes </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$attributes</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">cookies </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$cookies</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">files </span><span class="s1">= </span><span class="s0">new </span><span class="s3">FileBag</span><span class="s1">(</span><span class="s9">$files</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ServerBag</span><span class="s1">(</span><span class="s9">$server</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers </span><span class="s1">= </span><span class="s0">new </span><span class="s3">HeaderBag</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">getHeaders</span><span class="s1">())</span><span class="s0">;</span>

        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content </span><span class="s1">= </span><span class="s9">$content</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">languages </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">charsets </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">encodings </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">acceptableContentTypes </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">pathInfo </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">requestUri </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">baseUrl </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">basePath </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">format </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Creates a new request with values from PHP's super globals.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">static</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">createFromGlobals</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$request </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s3">createRequestFromFactory</span><span class="s1">(</span><span class="s9">$_GET</span><span class="s0">, </span><span class="s9">$_POST</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s9">$_COOKIE</span><span class="s0">, </span><span class="s9">$_FILES</span><span class="s0">, </span><span class="s9">$_SERVER</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$request</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'CONTENT_TYPE'</span><span class="s1">)</span><span class="s0">, </span><span class="s8">'application/x-www-form-urlencoded'</span><span class="s1">)</span>
            <span class="s1">&amp;&amp; \</span><span class="s3">in_array</span><span class="s1">(</span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$request</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'REQUEST_METHOD'</span><span class="s0">, </span><span class="s8">'GET'</span><span class="s1">))</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'PUT'</span><span class="s0">, </span><span class="s8">'DELETE'</span><span class="s0">, </span><span class="s8">'PATCH'</span><span class="s1">])</span>
        <span class="s1">) {</span>
            <span class="s3">parse_str</span><span class="s1">(</span><span class="s9">$request</span><span class="s1">-&gt;</span><span class="s3">getContent</span><span class="s1">()</span><span class="s0">, </span><span class="s9">$data</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$request</span><span class="s1">-&gt;</span><span class="s3">request </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$data</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$request</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Creates a Request based on a given URI and configuration.</span>
     <span class="s4">*</span>
     <span class="s4">* The information contained in the URI always take precedence</span>
     <span class="s4">* over the other information (server and parameters).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string               $uri        The URI</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string               $method     The HTTP method</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $parameters The query (GET) or request (POST) parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $cookies    The request cookies ($_COOKIE)</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $files      The request files ($_FILES)</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array                $server     The server parameters ($_SERVER)</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string|resource|null $content    The raw body data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">static</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">create</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$uri</span><span class="s0">, </span><span class="s3">string </span><span class="s9">$method </span><span class="s1">= </span><span class="s8">'GET'</span><span class="s0">, array </span><span class="s9">$parameters </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$cookies </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$files </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$server </span><span class="s1">= []</span><span class="s0">, </span><span class="s9">$content </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$server </span><span class="s1">= </span><span class="s3">array_replace</span><span class="s1">([</span>
            <span class="s8">'SERVER_NAME' </span><span class="s1">=&gt; </span><span class="s8">'localhost'</span><span class="s0">,</span>
            <span class="s8">'SERVER_PORT' </span><span class="s1">=&gt; </span><span class="s7">80</span><span class="s0">,</span>
            <span class="s8">'HTTP_HOST' </span><span class="s1">=&gt; </span><span class="s8">'localhost'</span><span class="s0">,</span>
            <span class="s8">'HTTP_USER_AGENT' </span><span class="s1">=&gt; </span><span class="s8">'Symfony'</span><span class="s0">,</span>
            <span class="s8">'HTTP_ACCEPT' </span><span class="s1">=&gt; </span><span class="s8">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span><span class="s0">,</span>
            <span class="s8">'HTTP_ACCEPT_LANGUAGE' </span><span class="s1">=&gt; </span><span class="s8">'en-us,en;q=0.5'</span><span class="s0">,</span>
            <span class="s8">'HTTP_ACCEPT_CHARSET' </span><span class="s1">=&gt; </span><span class="s8">'ISO-8859-1,utf-8;q=0.7,*;q=0.7'</span><span class="s0">,</span>
            <span class="s8">'REMOTE_ADDR' </span><span class="s1">=&gt; </span><span class="s8">'127.0.0.1'</span><span class="s0">,</span>
            <span class="s8">'SCRIPT_NAME' </span><span class="s1">=&gt; </span><span class="s8">''</span><span class="s0">,</span>
            <span class="s8">'SCRIPT_FILENAME' </span><span class="s1">=&gt; </span><span class="s8">''</span><span class="s0">,</span>
            <span class="s8">'SERVER_PROTOCOL' </span><span class="s1">=&gt; </span><span class="s8">'HTTP/1.1'</span><span class="s0">,</span>
            <span class="s8">'REQUEST_TIME' </span><span class="s1">=&gt; </span><span class="s3">time</span><span class="s1">()</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">, </span><span class="s9">$server</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s9">$server</span><span class="s1">[</span><span class="s8">'PATH_INFO'</span><span class="s1">] = </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s9">$server</span><span class="s1">[</span><span class="s8">'REQUEST_METHOD'</span><span class="s1">] = </span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$method</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s9">$components </span><span class="s1">= </span><span class="s3">parse_url</span><span class="s1">(</span><span class="s9">$uri</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'host'</span><span class="s1">])) {</span>
            <span class="s9">$server</span><span class="s1">[</span><span class="s8">'SERVER_NAME'</span><span class="s1">] = </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'host'</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s9">$server</span><span class="s1">[</span><span class="s8">'HTTP_HOST'</span><span class="s1">] = </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'host'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'scheme'</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'https' </span><span class="s1">=== </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'scheme'</span><span class="s1">]) {</span>
                <span class="s9">$server</span><span class="s1">[</span><span class="s8">'HTTPS'</span><span class="s1">] = </span><span class="s8">'on'</span><span class="s0">;</span>
                <span class="s9">$server</span><span class="s1">[</span><span class="s8">'SERVER_PORT'</span><span class="s1">] = </span><span class="s7">443</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s0">unset</span><span class="s1">(</span><span class="s9">$server</span><span class="s1">[</span><span class="s8">'HTTPS'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s9">$server</span><span class="s1">[</span><span class="s8">'SERVER_PORT'</span><span class="s1">] = </span><span class="s7">80</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'port'</span><span class="s1">])) {</span>
            <span class="s9">$server</span><span class="s1">[</span><span class="s8">'SERVER_PORT'</span><span class="s1">] = </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'port'</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s9">$server</span><span class="s1">[</span><span class="s8">'HTTP_HOST'</span><span class="s1">] .= </span><span class="s8">':'</span><span class="s1">.</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'port'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'user'</span><span class="s1">])) {</span>
            <span class="s9">$server</span><span class="s1">[</span><span class="s8">'PHP_AUTH_USER'</span><span class="s1">] = </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'user'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'pass'</span><span class="s1">])) {</span>
            <span class="s9">$server</span><span class="s1">[</span><span class="s8">'PHP_AUTH_PW'</span><span class="s1">] = </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'pass'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">])) {</span>
            <span class="s9">$components</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">] = </span><span class="s8">'/'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">switch </span><span class="s1">(</span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$method</span><span class="s1">)) {</span>
            <span class="s0">case </span><span class="s8">'POST'</span><span class="s1">:</span>
            <span class="s0">case </span><span class="s8">'PUT'</span><span class="s1">:</span>
            <span class="s0">case </span><span class="s8">'DELETE'</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$server</span><span class="s1">[</span><span class="s8">'CONTENT_TYPE'</span><span class="s1">])) {</span>
                    <span class="s9">$server</span><span class="s1">[</span><span class="s8">'CONTENT_TYPE'</span><span class="s1">] = </span><span class="s8">'application/x-www-form-urlencoded'</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s2">// no break</span>
            <span class="s0">case </span><span class="s8">'PATCH'</span><span class="s1">:</span>
                <span class="s9">$request </span><span class="s1">= </span><span class="s9">$parameters</span><span class="s0">;</span>
                <span class="s9">$query </span><span class="s1">= []</span><span class="s0">;</span>
                <span class="s0">break;</span>
            <span class="s0">default</span><span class="s1">:</span>
                <span class="s9">$request </span><span class="s1">= []</span><span class="s0">;</span>
                <span class="s9">$query </span><span class="s1">= </span><span class="s9">$parameters</span><span class="s0">;</span>
                <span class="s0">break;</span>
        <span class="s1">}</span>

        <span class="s9">$queryString </span><span class="s1">= </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'query'</span><span class="s1">])) {</span>
            <span class="s3">parse_str</span><span class="s1">(</span><span class="s3">html_entity_decode</span><span class="s1">(</span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'query'</span><span class="s1">])</span><span class="s0">, </span><span class="s9">$qs</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s9">$query</span><span class="s1">) {</span>
                <span class="s9">$query </span><span class="s1">= </span><span class="s3">array_replace</span><span class="s1">(</span><span class="s9">$qs</span><span class="s0">, </span><span class="s9">$query</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s9">$queryString </span><span class="s1">= </span><span class="s3">http_build_query</span><span class="s1">(</span><span class="s9">$query</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s8">'&amp;'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s9">$query </span><span class="s1">= </span><span class="s9">$qs</span><span class="s0">;</span>
                <span class="s9">$queryString </span><span class="s1">= </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'query'</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s9">$query</span><span class="s1">) {</span>
            <span class="s9">$queryString </span><span class="s1">= </span><span class="s3">http_build_query</span><span class="s1">(</span><span class="s9">$query</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s8">'&amp;'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$server</span><span class="s1">[</span><span class="s8">'REQUEST_URI'</span><span class="s1">] = </span><span class="s9">$components</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].(</span><span class="s8">'' </span><span class="s1">!== </span><span class="s9">$queryString </span><span class="s1">? </span><span class="s8">'?'</span><span class="s1">.</span><span class="s9">$queryString </span><span class="s1">: </span><span class="s8">''</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$server</span><span class="s1">[</span><span class="s8">'QUERY_STRING'</span><span class="s1">] = </span><span class="s9">$queryString</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s3">createRequestFromFactory</span><span class="s1">(</span><span class="s9">$query</span><span class="s0">, </span><span class="s9">$request</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s9">$cookies</span><span class="s0">, </span><span class="s9">$files</span><span class="s0">, </span><span class="s9">$server</span><span class="s0">, </span><span class="s9">$content</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets a callable able to create a Request instance.</span>
     <span class="s4">*</span>
     <span class="s4">* This is mainly useful when you need to override the Request class</span>
     <span class="s4">* to keep BC with an existing system. It should not be used for any</span>
     <span class="s4">* other purpose.</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">setFactory</span><span class="s1">(?</span><span class="s0">callable </span><span class="s9">$callable</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s9">$requestFactory </span><span class="s1">= </span><span class="s9">$callable</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Clones a request and overrides some of its parameters.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $query      The GET parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $request    The POST parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $attributes The request attributes (parameters parsed from the PATH_INFO, ...)</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $cookies    The COOKIE parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $files      The FILES parameters</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $server     The SERVER parameters</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">static</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">duplicate</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$query </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, array </span><span class="s9">$request </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, array </span><span class="s9">$attributes </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, array </span><span class="s9">$cookies </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, array </span><span class="s9">$files </span><span class="s1">= </span><span class="s3">null</span><span class="s0">, array </span><span class="s9">$server </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$dup </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$query</span><span class="s1">) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">query </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$query</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$request</span><span class="s1">) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">request </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$request</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$attributes</span><span class="s1">) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">attributes </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$attributes</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$cookies</span><span class="s1">) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">cookies </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ParameterBag</span><span class="s1">(</span><span class="s9">$cookies</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$files</span><span class="s1">) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">files </span><span class="s1">= </span><span class="s0">new </span><span class="s3">FileBag</span><span class="s1">(</span><span class="s9">$files</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$server</span><span class="s1">) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">server </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ServerBag</span><span class="s1">(</span><span class="s9">$server</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">headers </span><span class="s1">= </span><span class="s0">new </span><span class="s3">HeaderBag</span><span class="s1">(</span><span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">getHeaders</span><span class="s1">())</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">languages </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">charsets </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">encodings </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">acceptableContentTypes </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">pathInfo </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">requestUri </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">baseUrl </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">basePath </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">method </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">format </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'_format'</span><span class="s1">) &amp;&amp; </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'_format'</span><span class="s1">)) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">attributes</span><span class="s1">-&gt;</span><span class="s3">set</span><span class="s1">(</span><span class="s8">'_format'</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'_format'</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">getRequestFormat</span><span class="s1">(</span><span class="s3">null</span><span class="s1">)) {</span>
            <span class="s9">$dup</span><span class="s1">-&gt;</span><span class="s3">setRequestFormat</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getRequestFormat</span><span class="s1">(</span><span class="s3">null</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$dup</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Clones the current request.</span>
     <span class="s4">*</span>
     <span class="s4">* Note that the session is not cloned as duplicated requests</span>
     <span class="s4">* are most of the time sub-requests of the main one.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">__clone</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">query </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">query</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">request </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">request</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">attributes </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">attributes</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">cookies </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">cookies</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">files </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">files</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers </span><span class="s1">= </span><span class="s0">clone </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the request as a string.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The request</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">__toString</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">try </span><span class="s1">{</span>
            <span class="s9">$content </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getContent</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">catch </span><span class="s1">(\</span><span class="s3">LogicException </span><span class="s9">$e</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">PHP_VERSION_ID </span><span class="s1">&gt;= </span><span class="s7">70400</span><span class="s1">) {</span>
                <span class="s0">throw </span><span class="s9">$e</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s3">trigger_error</span><span class="s1">(</span><span class="s9">$e</span><span class="s0">, </span><span class="s3">E_USER_ERROR</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$cookieHeader </span><span class="s1">= </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s9">$cookies </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">cookies </span><span class="s0">as </span><span class="s9">$k </span><span class="s1">=&gt; </span><span class="s9">$v</span><span class="s1">) {</span>
            <span class="s9">$cookies</span><span class="s1">[] = </span><span class="s9">$k</span><span class="s1">.</span><span class="s8">'='</span><span class="s1">.</span><span class="s9">$v</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s0">empty</span><span class="s1">(</span><span class="s9">$cookies</span><span class="s1">)) {</span>
            <span class="s9">$cookieHeader </span><span class="s1">= </span><span class="s8">'Cookie: '</span><span class="s1">.</span><span class="s3">implode</span><span class="s1">(</span><span class="s8">'; '</span><span class="s0">, </span><span class="s9">$cookies</span><span class="s1">).</span><span class="s8">&quot;</span><span class="s0">\r\n</span><span class="s8">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return</span>
            <span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s %s %s'</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getMethod</span><span class="s1">()</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getRequestUri</span><span class="s1">()</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SERVER_PROTOCOL'</span><span class="s1">)).</span><span class="s8">&quot;</span><span class="s0">\r\n</span><span class="s8">&quot;</span><span class="s1">.</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">.</span>
            <span class="s9">$cookieHeader</span><span class="s1">.</span><span class="s8">&quot;</span><span class="s0">\r\n</span><span class="s8">&quot;</span><span class="s1">.</span>
            <span class="s9">$content</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Overrides the PHP global variables according to this request instance.</span>
     <span class="s4">*</span>
     <span class="s4">* It overrides $_GET, $_POST, $_REQUEST, $_SERVER, $_COOKIE.</span>
     <span class="s4">* $_FILES is never overridden, see rfc1867</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">overrideGlobals</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">set</span><span class="s1">(</span><span class="s8">'QUERY_STRING'</span><span class="s0">, static</span><span class="s1">::</span><span class="s3">normalizeQueryString</span><span class="s1">(</span><span class="s3">http_build_query</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">query</span><span class="s1">-&gt;</span><span class="s3">all</span><span class="s1">()</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s8">'&amp;'</span><span class="s1">)))</span><span class="s0">;</span>

        <span class="s9">$_GET </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">query</span><span class="s1">-&gt;</span><span class="s3">all</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s9">$_POST </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">request</span><span class="s1">-&gt;</span><span class="s3">all</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s9">$_SERVER </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">all</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s9">$_COOKIE </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">cookies</span><span class="s1">-&gt;</span><span class="s3">all</span><span class="s1">()</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">all</span><span class="s1">() </span><span class="s0">as </span><span class="s9">$key </span><span class="s1">=&gt; </span><span class="s9">$value</span><span class="s1">) {</span>
            <span class="s9">$key </span><span class="s1">= </span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s3">str_replace</span><span class="s1">(</span><span class="s8">'-'</span><span class="s0">, </span><span class="s8">'_'</span><span class="s0">, </span><span class="s9">$key</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$key</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'CONTENT_TYPE'</span><span class="s0">, </span><span class="s8">'CONTENT_LENGTH'</span><span class="s0">, </span><span class="s8">'CONTENT_MD5'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
                <span class="s9">$_SERVER</span><span class="s1">[</span><span class="s9">$key</span><span class="s1">] = </span><span class="s3">implode</span><span class="s1">(</span><span class="s8">', '</span><span class="s0">, </span><span class="s9">$value</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s9">$_SERVER</span><span class="s1">[</span><span class="s8">'HTTP_'</span><span class="s1">.</span><span class="s9">$key</span><span class="s1">] = </span><span class="s3">implode</span><span class="s1">(</span><span class="s8">', '</span><span class="s0">, </span><span class="s9">$value</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s9">$request </span><span class="s1">= [</span><span class="s8">'g' </span><span class="s1">=&gt; </span><span class="s9">$_GET</span><span class="s0">, </span><span class="s8">'p' </span><span class="s1">=&gt; </span><span class="s9">$_POST</span><span class="s0">, </span><span class="s8">'c' </span><span class="s1">=&gt; </span><span class="s9">$_COOKIE</span><span class="s1">]</span><span class="s0">;</span>

        <span class="s9">$requestOrder </span><span class="s1">= </span><span class="s3">ini_get</span><span class="s1">(</span><span class="s8">'request_order'</span><span class="s1">) ?: </span><span class="s3">ini_get</span><span class="s1">(</span><span class="s8">'variables_order'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$requestOrder </span><span class="s1">= </span><span class="s3">preg_replace</span><span class="s1">(</span><span class="s8">'#[^cgp]#'</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s3">strtolower</span><span class="s1">(</span><span class="s9">$requestOrder</span><span class="s1">)) ?: </span><span class="s8">'gp'</span><span class="s0">;</span>

        <span class="s9">$_REQUEST </span><span class="s1">= [[]]</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s3">str_split</span><span class="s1">(</span><span class="s9">$requestOrder</span><span class="s1">) </span><span class="s0">as </span><span class="s9">$order</span><span class="s1">) {</span>
            <span class="s9">$_REQUEST</span><span class="s1">[] = </span><span class="s9">$request</span><span class="s1">[</span><span class="s9">$order</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$_REQUEST </span><span class="s1">= </span><span class="s3">array_merge</span><span class="s1">(...</span><span class="s9">$_REQUEST</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets a list of trusted proxies.</span>
     <span class="s4">*</span>
     <span class="s4">* You should only list the reverse proxies that you manage directly.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $proxies          A list of trusted proxies, the string 'REMOTE_ADDR' will be replaced with $_SERVER['REMOTE_ADDR']</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">int   $trustedHeaderSet A bit field of Request::HEADER_*, to set which headers to trust from your proxies</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">\InvalidArgumentException When $trustedHeaderSet is invalid</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">setTrustedProxies</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$proxies</span><span class="s0">, </span><span class="s3">int </span><span class="s9">$trustedHeaderSet</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedProxies </span><span class="s1">= </span><span class="s3">array_reduce</span><span class="s1">(</span><span class="s9">$proxies</span><span class="s0">, function </span><span class="s1">(</span><span class="s9">$proxies</span><span class="s0">, </span><span class="s9">$proxy</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'REMOTE_ADDR' </span><span class="s1">!== </span><span class="s9">$proxy</span><span class="s1">) {</span>
                <span class="s9">$proxies</span><span class="s1">[] = </span><span class="s9">$proxy</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$_SERVER</span><span class="s1">[</span><span class="s8">'REMOTE_ADDR'</span><span class="s1">])) {</span>
                <span class="s9">$proxies</span><span class="s1">[] = </span><span class="s9">$_SERVER</span><span class="s1">[</span><span class="s8">'REMOTE_ADDR'</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s9">$proxies</span><span class="s0">;</span>
        <span class="s1">}</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">;</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaderSet </span><span class="s1">= </span><span class="s9">$trustedHeaderSet</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the list of trusted proxies.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array An array of trusted proxies</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">getTrustedProxies</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedProxies</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the set of trusted headers from trusted proxies.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">int A bit field of Request::HEADER_* that defines which headers are trusted from your proxies</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">getTrustedHeaderSet</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaderSet</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets a list of trusted host patterns.</span>
     <span class="s4">*</span>
     <span class="s4">* You should only list the hosts you manage using regexs.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">array $hostPatterns A list of trusted host patterns</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">setTrustedHosts</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$hostPatterns</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHostPatterns </span><span class="s1">= </span><span class="s3">array_map</span><span class="s1">(</span><span class="s0">function </span><span class="s1">(</span><span class="s9">$hostPattern</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'{%s}i'</span><span class="s0">, </span><span class="s9">$hostPattern</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span><span class="s0">, </span><span class="s9">$hostPatterns</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s2">// we need to reset trusted hosts on trusted host patterns change</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHosts </span><span class="s1">= []</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the list of trusted host patterns.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array An array of trusted host patterns</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">getTrustedHosts</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHostPatterns</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Normalizes a query string.</span>
     <span class="s4">*</span>
     <span class="s4">* It builds a normalized query string, where keys/value pairs are alphabetized,</span>
     <span class="s4">* have consistent escaping and unneeded delimiters are removed.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string A normalized query string for the Request</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">normalizeQueryString</span><span class="s1">(?</span><span class="s3">string </span><span class="s9">$qs</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">=== (</span><span class="s9">$qs </span><span class="s1">?? </span><span class="s8">''</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s3">parse_str</span><span class="s1">(</span><span class="s9">$qs</span><span class="s0">, </span><span class="s9">$qs</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s3">ksort</span><span class="s1">(</span><span class="s9">$qs</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s3">http_build_query</span><span class="s1">(</span><span class="s9">$qs</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s8">'&amp;'</span><span class="s0">, </span><span class="s3">PHP_QUERY_RFC3986</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Enables support for the _method request parameter to determine the intended HTTP method.</span>
     <span class="s4">*</span>
     <span class="s4">* Be warned that enabling this feature might lead to CSRF issues in your code.</span>
     <span class="s4">* Check that you are using CSRF tokens when required.</span>
     <span class="s4">* If the HTTP method parameter override is enabled, an html-form with method &quot;POST&quot; can be altered</span>
     <span class="s4">* and used to send a &quot;PUT&quot; or &quot;DELETE&quot; request via the _method request parameter.</span>
     <span class="s4">* If these methods are not protected against CSRF, this presents a possible vulnerability.</span>
     <span class="s4">*</span>
     <span class="s4">* The HTTP method can only be overridden when the real HTTP method is POST.</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">enableHttpMethodParameterOverride</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s3">self</span><span class="s1">::</span><span class="s9">$httpMethodParameterOverride </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Checks whether support for the _method request parameter is enabled.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool True when the _method request parameter is enabled, false otherwise</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">getHttpMethodParameterOverride</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$httpMethodParameterOverride</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets a &quot;parameter&quot; value from any bag.</span>
     <span class="s4">*</span>
     <span class="s4">* This method is mainly useful for libraries that want to provide some flexibility. If you don't need the</span>
     <span class="s4">* flexibility in controllers, it is better to explicitly get request parameters from the appropriate</span>
     <span class="s4">* public property instead (attributes, query, request).</span>
     <span class="s4">*</span>
     <span class="s4">* Order of precedence: PATH (routing placeholders or custom attributes), GET, BODY</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">mixed $default The default value if the parameter key does not exist</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">mixed</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">get</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$key</span><span class="s0">, </span><span class="s9">$default </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">$this </span><span class="s1">!== </span><span class="s9">$result </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">attributes</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s9">$key</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$result</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">$this </span><span class="s1">!== </span><span class="s9">$result </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">query</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s9">$key</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$result</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">$this </span><span class="s1">!== </span><span class="s9">$result </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">request</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s9">$key</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$result</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$default</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the Session.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">SessionInterface The session</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getSession</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$session </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">session</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$session </span><span class="s0">instanceof </span><span class="s3">SessionInterface </span><span class="s1">&amp;&amp; </span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$session</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">setSession</span><span class="s1">(</span><span class="s9">$session </span><span class="s1">= </span><span class="s9">$session</span><span class="s1">())</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$session</span><span class="s1">) {</span>
            <span class="s0">throw new </span><span class="s1">\</span><span class="s3">BadMethodCallException</span><span class="s1">(</span><span class="s8">'Session has not been set.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$session</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Whether the request contains a Session which was started in one of the</span>
     <span class="s4">* previous requests.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">hasPreviousSession</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s2">// the check for $this-&gt;session avoids malicious users trying to fake a session cookie with proper name</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">hasSession</span><span class="s1">() &amp;&amp; </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">cookies</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getSession</span><span class="s1">()-&gt;</span><span class="s3">getName</span><span class="s1">())</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Whether the request contains a Session object.</span>
     <span class="s4">*</span>
     <span class="s4">* This method does not give any information about the state of the session object,</span>
     <span class="s4">* like whether the session is started or not. It is just a way to check if this Request</span>
     <span class="s4">* is associated with a Session instance.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool true when the Request contains a Session object, false otherwise</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">hasSession</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">session</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public function </span><span class="s3">setSession</span><span class="s1">(</span><span class="s3">SessionInterface </span><span class="s9">$session</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">session </span><span class="s1">= </span><span class="s9">$session</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@internal</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">setSessionFactory</span><span class="s1">(</span><span class="s0">callable </span><span class="s9">$factory</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">session </span><span class="s1">= </span><span class="s9">$factory</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the client IP addresses.</span>
     <span class="s4">*</span>
     <span class="s4">* In the returned array the most trusted IP address is first, and the</span>
     <span class="s4">* least trusted one last. The &quot;real&quot; client IP address is the last one,</span>
     <span class="s4">* but this is also the least trusted one. Trusted proxies are stripped.</span>
     <span class="s4">*</span>
     <span class="s4">* Use this method carefully; you should use getClientIp() instead.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array The client IP addresses</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">getClientIp()</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getClientIps</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$ip </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'REMOTE_ADDR'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isFromTrustedProxy</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s1">[</span><span class="s9">$ip</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getTrustedValues</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_FOR</span><span class="s0">, </span><span class="s9">$ip</span><span class="s1">) ?: [</span><span class="s9">$ip</span><span class="s1">]</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the client IP address.</span>
     <span class="s4">*</span>
     <span class="s4">* This method can read the client IP address from the &quot;X-Forwarded-For&quot; header</span>
     <span class="s4">* when trusted proxies were set via &quot;setTrustedProxies()&quot;. The &quot;X-Forwarded-For&quot;</span>
     <span class="s4">* header value is a comma+space separated list of IP addresses, the left-most</span>
     <span class="s4">* being the original client, and each successive proxy that passed the request</span>
     <span class="s4">* adding the IP address where it received the request from.</span>
     <span class="s4">*</span>
     <span class="s4">* If your reverse proxy uses a different header name than &quot;X-Forwarded-For&quot;,</span>
     <span class="s4">* (&quot;Client-Ip&quot; for instance), configure it via the $trustedHeaderSet</span>
     <span class="s4">* argument of the Request::setTrustedProxies() method instead.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null The client IP address</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">getClientIps()</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">https://wikipedia.org/wiki/X-Forwarded-For</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getClientIp</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$ipAddresses </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getClientIps</span><span class="s1">()</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s9">$ipAddresses</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns current script name.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getScriptName</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SCRIPT_NAME'</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'ORIG_SCRIPT_NAME'</span><span class="s0">, </span><span class="s8">''</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the path being requested relative to the executed script.</span>
     <span class="s4">*</span>
     <span class="s4">* The path info always starts with a /.</span>
     <span class="s4">*</span>
     <span class="s4">* Suppose this request is instantiated from /mysite on localhost:</span>
     <span class="s4">*</span>
     <span class="s4">*  * http://localhost/mysite              returns an empty string</span>
     <span class="s4">*  * http://localhost/mysite/about        returns '/about'</span>
     <span class="s4">*  * http://localhost/mysite/enco%20ded   returns '/enco%20ded'</span>
     <span class="s4">*  * http://localhost/mysite/about?var=1  returns '/about'</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The raw path (i.e. not urldecoded)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getPathInfo</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">pathInfo</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">pathInfo </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">preparePathInfo</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">pathInfo</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the root path from which this request is executed.</span>
     <span class="s4">*</span>
     <span class="s4">* Suppose that an index.php file instantiates this request object:</span>
     <span class="s4">*</span>
     <span class="s4">*  * http://localhost/index.php         returns an empty string</span>
     <span class="s4">*  * http://localhost/index.php/page    returns an empty string</span>
     <span class="s4">*  * http://localhost/web/index.php     returns '/web'</span>
     <span class="s4">*  * http://localhost/we%20b/index.php  returns '/we%20b'</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The raw path (i.e. not urldecoded)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getBasePath</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">basePath</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">basePath </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">prepareBasePath</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">basePath</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the root URL from which this request is executed.</span>
     <span class="s4">*</span>
     <span class="s4">* The base URL never ends with a /.</span>
     <span class="s4">*</span>
     <span class="s4">* This is similar to getBasePath(), except that it also includes the</span>
     <span class="s4">* script filename (e.g. index.php) if one exists.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The raw URL (i.e. not urldecoded)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getBaseUrl</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">baseUrl</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">baseUrl </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">prepareBaseUrl</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">baseUrl</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the request's scheme.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getScheme</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isSecure</span><span class="s1">() ? </span><span class="s8">'https' </span><span class="s1">: </span><span class="s8">'http'</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the port on which the request is made.</span>
     <span class="s4">*</span>
     <span class="s4">* This method can read the client port from the &quot;X-Forwarded-Port&quot; header</span>
     <span class="s4">* when trusted proxies were set via &quot;setTrustedProxies()&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* The &quot;X-Forwarded-Port&quot; header must contain the client port.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">int|string can be a string if fetched from the server bag</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getPort</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isFromTrustedProxy</span><span class="s1">() &amp;&amp; </span><span class="s9">$host </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getTrustedValues</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PORT</span><span class="s1">)) {</span>
            <span class="s9">$host </span><span class="s1">= </span><span class="s9">$host</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isFromTrustedProxy</span><span class="s1">() &amp;&amp; </span><span class="s9">$host </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getTrustedValues</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_HOST</span><span class="s1">)) {</span>
            <span class="s9">$host </span><span class="s1">= </span><span class="s9">$host</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s9">$host </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'HOST'</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SERVER_PORT'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'[' </span><span class="s1">=== </span><span class="s9">$host</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
            <span class="s9">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$host</span><span class="s0">, </span><span class="s8">':'</span><span class="s0">, </span><span class="s3">strrpos</span><span class="s1">(</span><span class="s9">$host</span><span class="s0">, </span><span class="s8">']'</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s9">$pos </span><span class="s1">= </span><span class="s3">strrpos</span><span class="s1">(</span><span class="s9">$host</span><span class="s0">, </span><span class="s8">':'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$pos </span><span class="s1">&amp;&amp; </span><span class="s9">$port </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$host</span><span class="s0">, </span><span class="s9">$pos </span><span class="s1">+ </span><span class="s7">1</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s1">(int) </span><span class="s9">$port</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s8">'https' </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getScheme</span><span class="s1">() ? </span><span class="s7">443 </span><span class="s1">: </span><span class="s7">80</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the user.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getUser</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'PHP_AUTH_USER'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the password.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getPassword</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'PHP_AUTH_PW'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the user info.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string A user name and, optionally, scheme-specific information about how to gain authorization to access the server</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getUserInfo</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$userinfo </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getUser</span><span class="s1">()</span><span class="s0">;</span>

        <span class="s9">$pass </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getPassword</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">!= </span><span class="s9">$pass</span><span class="s1">) {</span>
            <span class="s9">$userinfo </span><span class="s1">.= </span><span class="s8">&quot;:</span><span class="s9">$pass</span><span class="s8">&quot;</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$userinfo</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the HTTP host being requested.</span>
     <span class="s4">*</span>
     <span class="s4">* The port name will be appended to the host if it's non-standard.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getHttpHost</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$scheme </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getScheme</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s9">$port </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getPort</span><span class="s1">()</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">((</span><span class="s8">'http' </span><span class="s1">== </span><span class="s9">$scheme </span><span class="s1">&amp;&amp; </span><span class="s7">80 </span><span class="s1">== </span><span class="s9">$port</span><span class="s1">) || (</span><span class="s8">'https' </span><span class="s1">== </span><span class="s9">$scheme </span><span class="s1">&amp;&amp; </span><span class="s7">443 </span><span class="s1">== </span><span class="s9">$port</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getHost</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getHost</span><span class="s1">().</span><span class="s8">':'</span><span class="s1">.</span><span class="s9">$port</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the requested URI (path and query string).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The raw URI (i.e. not URI decoded)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getRequestUri</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">requestUri</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">requestUri </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">prepareRequestUri</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">requestUri</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the scheme and HTTP host.</span>
     <span class="s4">*</span>
     <span class="s4">* If the URL was called with basic authentication, the user</span>
     <span class="s4">* and the password are not added to the generated string.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The scheme and HTTP host</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getSchemeAndHttpHost</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getScheme</span><span class="s1">().</span><span class="s8">'://'</span><span class="s1">.</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getHttpHost</span><span class="s1">()</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Generates a normalized URI (URL) for the Request.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string A normalized URI (URL) for the Request</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">getQueryString()</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getUri</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$qs </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getQueryString</span><span class="s1">()) {</span>
            <span class="s9">$qs </span><span class="s1">= </span><span class="s8">'?'</span><span class="s1">.</span><span class="s9">$qs</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getSchemeAndHttpHost</span><span class="s1">().</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getBaseUrl</span><span class="s1">().</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getPathInfo</span><span class="s1">().</span><span class="s9">$qs</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Generates a normalized URI for the given path.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string $path A path to use instead of the current one</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The normalized URI for the path</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getUriForPath</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$path</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getSchemeAndHttpHost</span><span class="s1">().</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getBaseUrl</span><span class="s1">().</span><span class="s9">$path</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the path as relative reference from the current Request path.</span>
     <span class="s4">*</span>
     <span class="s4">* Only the URIs path component (no schema, host etc.) is relevant and must be given.</span>
     <span class="s4">* Both paths must be absolute and not contain relative parts.</span>
     <span class="s4">* Relative URLs from one resource to another are useful when generating self-contained downloadable document archives.</span>
     <span class="s4">* Furthermore, they can be used to reduce the link size in documents.</span>
     <span class="s4">*</span>
     <span class="s4">* Example target paths, given a base path of &quot;/a/b/c/d&quot;:</span>
     <span class="s4">* - &quot;/a/b/c/d&quot;     -&gt; &quot;&quot;</span>
     <span class="s4">* - &quot;/a/b/c/&quot;      -&gt; &quot;./&quot;</span>
     <span class="s4">* - &quot;/a/b/&quot;        -&gt; &quot;../&quot;</span>
     <span class="s4">* - &quot;/a/b/c/other&quot; -&gt; &quot;other&quot;</span>
     <span class="s4">* - &quot;/a/x/y&quot;       -&gt; &quot;../../x/y&quot;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The relative target path</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getRelativeUriForPath</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$path</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s2">// be sure that we are dealing with an absolute path</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$path</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) || </span><span class="s8">'/' </span><span class="s1">!== </span><span class="s9">$path</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
            <span class="s0">return </span><span class="s9">$path</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">$path </span><span class="s1">=== </span><span class="s9">$basePath </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getPathInfo</span><span class="s1">()) {</span>
            <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$sourceDirs </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">'/'</span><span class="s0">, isset</span><span class="s1">(</span><span class="s9">$basePath</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) &amp;&amp; </span><span class="s8">'/' </span><span class="s1">=== </span><span class="s9">$basePath</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] ? </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$basePath</span><span class="s0">, </span><span class="s7">1</span><span class="s1">) : </span><span class="s9">$basePath</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$targetDirs </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">'/'</span><span class="s0">, </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$path</span><span class="s0">, </span><span class="s7">1</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s3">array_pop</span><span class="s1">(</span><span class="s9">$sourceDirs</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s9">$targetFile </span><span class="s1">= </span><span class="s3">array_pop</span><span class="s1">(</span><span class="s9">$targetDirs</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$sourceDirs </span><span class="s0">as </span><span class="s9">$i </span><span class="s1">=&gt; </span><span class="s9">$dir</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$targetDirs</span><span class="s1">[</span><span class="s9">$i</span><span class="s1">]) &amp;&amp; </span><span class="s9">$dir </span><span class="s1">=== </span><span class="s9">$targetDirs</span><span class="s1">[</span><span class="s9">$i</span><span class="s1">]) {</span>
                <span class="s0">unset</span><span class="s1">(</span><span class="s9">$sourceDirs</span><span class="s1">[</span><span class="s9">$i</span><span class="s1">]</span><span class="s0">, </span><span class="s9">$targetDirs</span><span class="s1">[</span><span class="s9">$i</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s0">break;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s9">$targetDirs</span><span class="s1">[] = </span><span class="s9">$targetFile</span><span class="s0">;</span>
        <span class="s9">$path </span><span class="s1">= </span><span class="s3">str_repeat</span><span class="s1">(</span><span class="s8">'../'</span><span class="s0">, </span><span class="s1">\</span><span class="s3">count</span><span class="s1">(</span><span class="s9">$sourceDirs</span><span class="s1">)).</span><span class="s3">implode</span><span class="s1">(</span><span class="s8">'/'</span><span class="s0">, </span><span class="s9">$targetDirs</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s2">// A reference to the same base directory or an empty subdirectory must be prefixed with &quot;./&quot;.</span>
        <span class="s2">// This also applies to a segment with a colon character (e.g., &quot;file:colon&quot;) that cannot be used</span>
        <span class="s2">// as the first segment of a relative-path reference, as it would be mistaken for a scheme name</span>
        <span class="s2">// (see https://tools.ietf.org/html/rfc3986#section-4.2).</span>
        <span class="s0">return </span><span class="s1">!</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$path</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) || </span><span class="s8">'/' </span><span class="s1">=== </span><span class="s9">$path</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span>
            <span class="s1">|| </span><span class="s3">false </span><span class="s1">!== (</span><span class="s9">$colonPos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$path</span><span class="s0">, </span><span class="s8">':'</span><span class="s1">)) &amp;&amp; (</span><span class="s9">$colonPos </span><span class="s1">&lt; (</span><span class="s9">$slashPos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$path</span><span class="s0">, </span><span class="s8">'/'</span><span class="s1">)) || </span><span class="s3">false </span><span class="s1">=== </span><span class="s9">$slashPos</span><span class="s1">)</span>
            <span class="s1">? </span><span class="s8">&quot;./</span><span class="s9">$path</span><span class="s8">&quot; </span><span class="s1">: </span><span class="s9">$path</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Generates the normalized query string for the Request.</span>
     <span class="s4">*</span>
     <span class="s4">* It builds a normalized query string, where keys/value pairs are alphabetized</span>
     <span class="s4">* and have consistent escaping.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null A normalized query string for the Request</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getQueryString</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$qs </span><span class="s1">= </span><span class="s0">static</span><span class="s1">::</span><span class="s3">normalizeQueryString</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'QUERY_STRING'</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s8">'' </span><span class="s1">=== </span><span class="s9">$qs </span><span class="s1">? </span><span class="s3">null </span><span class="s1">: </span><span class="s9">$qs</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Checks whether the request is secure or not.</span>
     <span class="s4">*</span>
     <span class="s4">* This method can read the client protocol from the &quot;X-Forwarded-Proto&quot; header</span>
     <span class="s4">* when trusted proxies were set via &quot;setTrustedProxies()&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* The &quot;X-Forwarded-Proto&quot; header must contain the protocol: &quot;https&quot; or &quot;http&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isSecure</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isFromTrustedProxy</span><span class="s1">() &amp;&amp; </span><span class="s9">$proto </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getTrustedValues</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PROTO</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s1">\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s3">strtolower</span><span class="s1">(</span><span class="s9">$proto</span><span class="s1">[</span><span class="s7">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'https'</span><span class="s0">, </span><span class="s8">'on'</span><span class="s0">, </span><span class="s8">'ssl'</span><span class="s0">, </span><span class="s8">'1'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$https </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'HTTPS'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s1">!</span><span class="s0">empty</span><span class="s1">(</span><span class="s9">$https</span><span class="s1">) &amp;&amp; </span><span class="s8">'off' </span><span class="s1">!== </span><span class="s3">strtolower</span><span class="s1">(</span><span class="s9">$https</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the host name.</span>
     <span class="s4">*</span>
     <span class="s4">* This method can read the client host name from the &quot;X-Forwarded-Host&quot; header</span>
     <span class="s4">* when trusted proxies were set via &quot;setTrustedProxies()&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* The &quot;X-Forwarded-Host&quot; header must contain the client host name.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">SuspiciousOperationException when the host name is invalid or not trusted</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getHost</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isFromTrustedProxy</span><span class="s1">() &amp;&amp; </span><span class="s9">$host </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getTrustedValues</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_HOST</span><span class="s1">)) {</span>
            <span class="s9">$host </span><span class="s1">= </span><span class="s9">$host</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!</span><span class="s9">$host </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'HOST'</span><span class="s1">)) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s9">$host </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SERVER_NAME'</span><span class="s1">)) {</span>
                <span class="s9">$host </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SERVER_ADDR'</span><span class="s0">, </span><span class="s8">''</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">// trim and remove port number from host</span>
        <span class="s2">// host is lowercase as per RFC 952/2181</span>
        <span class="s9">$host </span><span class="s1">= </span><span class="s3">strtolower</span><span class="s1">(</span><span class="s3">preg_replace</span><span class="s1">(</span><span class="s8">'/:\d+$/'</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s3">trim</span><span class="s1">(</span><span class="s9">$host</span><span class="s1">)))</span><span class="s0">;</span>

        <span class="s2">// as the host can come from the user (HTTP_HOST and depending on the configuration, SERVER_NAME too can come from the user)</span>
        <span class="s2">// check that it does not contain forbidden characters (see RFC 952 and RFC 2181)</span>
        <span class="s2">// use preg_replace() instead of preg_match() to prevent DoS attacks with long host names</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">$host </span><span class="s1">&amp;&amp; </span><span class="s8">'' </span><span class="s1">!== </span><span class="s3">preg_replace</span><span class="s1">(</span><span class="s8">'/(?:^\[)?[a-zA-Z0-9-:\]_]+\.?/'</span><span class="s0">, </span><span class="s8">''</span><span class="s0">, </span><span class="s9">$host</span><span class="s1">)) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isHostValid</span><span class="s1">) {</span>
                <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isHostValid </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>

            <span class="s0">throw new </span><span class="s3">SuspiciousOperationException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Invalid Host &quot;%s&quot;.'</span><span class="s0">, </span><span class="s9">$host</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(\</span><span class="s3">count</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHostPatterns</span><span class="s1">) &gt; </span><span class="s7">0</span><span class="s1">) {</span>
            <span class="s2">// to avoid host header injection attacks, you should provide a list of trusted host patterns</span>

            <span class="s0">if </span><span class="s1">(\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$host</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHosts</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s9">$host</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHostPatterns </span><span class="s0">as </span><span class="s9">$pattern</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s9">$pattern</span><span class="s0">, </span><span class="s9">$host</span><span class="s1">)) {</span>
                    <span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHosts</span><span class="s1">[] = </span><span class="s9">$host</span><span class="s0">;</span>

                    <span class="s0">return </span><span class="s9">$host</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isHostValid</span><span class="s1">) {</span>
                <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isHostValid </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>

            <span class="s0">throw new </span><span class="s3">SuspiciousOperationException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Untrusted Host &quot;%s&quot;.'</span><span class="s0">, </span><span class="s9">$host</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$host</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the request method.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">setMethod</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$method</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">set</span><span class="s1">(</span><span class="s8">'REQUEST_METHOD'</span><span class="s0">, </span><span class="s9">$method</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the request &quot;intended&quot; method.</span>
     <span class="s4">*</span>
     <span class="s4">* If the X-HTTP-Method-Override header is set, and if the method is a POST,</span>
     <span class="s4">* then it is used to determine the &quot;real&quot; intended HTTP method.</span>
     <span class="s4">*</span>
     <span class="s4">* The _method request parameter can also be used to determine the HTTP method,</span>
     <span class="s4">* but only if enableHttpMethodParameterOverride() has been called.</span>
     <span class="s4">*</span>
     <span class="s4">* The method is always an uppercased string.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The request method</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">getRealMethod()</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getMethod</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method </span><span class="s1">= </span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'REQUEST_METHOD'</span><span class="s0">, </span><span class="s8">'GET'</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'POST' </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$method </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'X-HTTP-METHOD-OVERRIDE'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$method </span><span class="s1">&amp;&amp; </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$httpMethodParameterOverride</span><span class="s1">) {</span>
            <span class="s9">$method </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">request</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'_method'</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">query</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'_method'</span><span class="s0">, </span><span class="s8">'POST'</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!\</span><span class="s3">is_string</span><span class="s1">(</span><span class="s9">$method</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$method </span><span class="s1">= </span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$method</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$method</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'GET'</span><span class="s0">, </span><span class="s8">'HEAD'</span><span class="s0">, </span><span class="s8">'POST'</span><span class="s0">, </span><span class="s8">'PUT'</span><span class="s0">, </span><span class="s8">'DELETE'</span><span class="s0">, </span><span class="s8">'CONNECT'</span><span class="s0">, </span><span class="s8">'OPTIONS'</span><span class="s0">, </span><span class="s8">'PATCH'</span><span class="s0">, </span><span class="s8">'PURGE'</span><span class="s0">, </span><span class="s8">'TRACE'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method </span><span class="s1">= </span><span class="s9">$method</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'/^[A-Z]++$/D'</span><span class="s0">, </span><span class="s9">$method</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">SuspiciousOperationException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Invalid method override &quot;%s&quot;.'</span><span class="s0">, </span><span class="s9">$method</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">method </span><span class="s1">= </span><span class="s9">$method</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the &quot;real&quot; request method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string The request method</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">getMethod()</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getRealMethod</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'REQUEST_METHOD'</span><span class="s0">, </span><span class="s8">'GET'</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the mime type associated with the format.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null The associated mime type (null if not found)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getMimeType</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$format</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">) {</span>
            <span class="s0">static</span><span class="s1">::</span><span class="s3">initializeFormats</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return isset</span><span class="s1">(</span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">[</span><span class="s9">$format</span><span class="s1">]) ? </span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">[</span><span class="s9">$format</span><span class="s1">][</span><span class="s7">0</span><span class="s1">] : </span><span class="s3">null</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the mime types associated with the format.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array The associated mime types</span>
     <span class="s4">*/</span>
    <span class="s0">public static function </span><span class="s3">getMimeTypes</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$format</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">) {</span>
            <span class="s0">static</span><span class="s1">::</span><span class="s3">initializeFormats</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return isset</span><span class="s1">(</span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">[</span><span class="s9">$format</span><span class="s1">]) ? </span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">[</span><span class="s9">$format</span><span class="s1">] : []</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the format associated with the mime type.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null The format (null if not found)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getFormat</span><span class="s1">(?</span><span class="s3">string </span><span class="s9">$mimeType</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$canonicalMimeType </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$mimeType</span><span class="s0">, </span><span class="s8">';'</span><span class="s1">)) {</span>
            <span class="s9">$canonicalMimeType </span><span class="s1">= </span><span class="s3">trim</span><span class="s1">(</span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$mimeType</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$pos</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">) {</span>
            <span class="s0">static</span><span class="s1">::</span><span class="s3">initializeFormats</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats </span><span class="s0">as </span><span class="s9">$format </span><span class="s1">=&gt; </span><span class="s9">$mimeTypes</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$mimeType</span><span class="s0">, </span><span class="s1">(array) </span><span class="s9">$mimeTypes</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s9">$format</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$canonicalMimeType </span><span class="s1">&amp;&amp; \</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$canonicalMimeType</span><span class="s0">, </span><span class="s1">(array) </span><span class="s9">$mimeTypes</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s9">$format</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Associates a format with mime types.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string|array $mimeTypes The associated mime types (the preferred one must be the first as it will be used as the content type)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">setFormat</span><span class="s1">(?</span><span class="s3">string </span><span class="s9">$format</span><span class="s0">, </span><span class="s9">$mimeTypes</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">) {</span>
            <span class="s0">static</span><span class="s1">::</span><span class="s3">initializeFormats</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">static</span><span class="s1">::</span><span class="s9">$formats</span><span class="s1">[</span><span class="s9">$format</span><span class="s1">] = \</span><span class="s3">is_array</span><span class="s1">(</span><span class="s9">$mimeTypes</span><span class="s1">) ? </span><span class="s9">$mimeTypes </span><span class="s1">: [</span><span class="s9">$mimeTypes</span><span class="s1">]</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the request format.</span>
     <span class="s4">*</span>
     <span class="s4">* Here is the process to determine the format:</span>
     <span class="s4">*</span>
     <span class="s4">*  * format defined by the user (with setRequestFormat())</span>
     <span class="s4">*  * _format request attribute</span>
     <span class="s4">*  * $default</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">getPreferredFormat</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null The request format</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getRequestFormat</span><span class="s1">(?</span><span class="s3">string </span><span class="s9">$default </span><span class="s1">= </span><span class="s8">'html'</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">format</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">format </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">attributes</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'_format'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">format </span><span class="s1">? </span><span class="s9">$default </span><span class="s1">: </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">format</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the request format.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">setRequestFormat</span><span class="s1">(?</span><span class="s3">string </span><span class="s9">$format</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">format </span><span class="s1">= </span><span class="s9">$format</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the format associated with the request.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null The format (null if no content type is present)</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getContentType</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getFormat</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'CONTENT_TYPE'</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the default locale.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">setDefaultLocale</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$locale</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">defaultLocale </span><span class="s1">= </span><span class="s9">$locale</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">locale</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">setPhpDefaultLocale</span><span class="s1">(</span><span class="s9">$locale</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Get the default locale.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getDefaultLocale</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">defaultLocale</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the locale.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">setLocale</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$locale</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">setPhpDefaultLocale</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">locale </span><span class="s1">= </span><span class="s9">$locale</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Get the locale.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getLocale</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">locale </span><span class="s1">? </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">defaultLocale </span><span class="s1">: </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">locale</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Checks if the request method is of specified type.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string $method Uppercase request method (GET, POST etc)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isMethod</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$method</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getMethod</span><span class="s1">() === </span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$method</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Checks whether or not the method is safe.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">https://tools.ietf.org/html/rfc7231#section-4.2.1</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isMethodSafe</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s1">\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getMethod</span><span class="s1">()</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'GET'</span><span class="s0">, </span><span class="s8">'HEAD'</span><span class="s0">, </span><span class="s8">'OPTIONS'</span><span class="s0">, </span><span class="s8">'TRACE'</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Checks whether or not the method is idempotent.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isMethodIdempotent</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s1">\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getMethod</span><span class="s1">()</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'HEAD'</span><span class="s0">, </span><span class="s8">'GET'</span><span class="s0">, </span><span class="s8">'PUT'</span><span class="s0">, </span><span class="s8">'DELETE'</span><span class="s0">, </span><span class="s8">'TRACE'</span><span class="s0">, </span><span class="s8">'OPTIONS'</span><span class="s0">, </span><span class="s8">'PURGE'</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Checks whether the method is cacheable or not.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">https://tools.ietf.org/html/rfc7231#section-4.2.3</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool True for GET and HEAD, false otherwise</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isMethodCacheable</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s1">\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getMethod</span><span class="s1">()</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'GET'</span><span class="s0">, </span><span class="s8">'HEAD'</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the protocol version.</span>
     <span class="s4">*</span>
     <span class="s4">* If the application is behind a proxy, the protocol version used in the</span>
     <span class="s4">* requests between the client and the proxy and between the proxy and the</span>
     <span class="s4">* server might be different. This returns the former (from the &quot;Via&quot; header)</span>
     <span class="s4">* if the proxy is trusted (see &quot;setTrustedProxies()&quot;), otherwise it returns</span>
     <span class="s4">* the latter (from the &quot;SERVER_PROTOCOL&quot; server parameter).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getProtocolVersion</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isFromTrustedProxy</span><span class="s1">()) {</span>
            <span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'~^(HTTP/)?([1-9]\.[0-9]) ~'</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'Via'</span><span class="s1">)</span><span class="s0">, </span><span class="s9">$matches</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s9">$matches</span><span class="s1">) {</span>
                <span class="s0">return </span><span class="s8">'HTTP/'</span><span class="s1">.</span><span class="s9">$matches</span><span class="s1">[</span><span class="s7">2</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SERVER_PROTOCOL'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the request body content.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">bool $asResource If true, a resource will be returned</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|resource The request body content or a resource to read the body stream</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">\LogicException</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getContent</span><span class="s1">(</span><span class="s3">bool </span><span class="s9">$asResource </span><span class="s1">= </span><span class="s3">false</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$currentContentIsResource </span><span class="s1">= \</span><span class="s3">is_resource</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">true </span><span class="s1">=== </span><span class="s9">$asResource</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s9">$currentContentIsResource</span><span class="s1">) {</span>
                <span class="s3">rewind</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// Content passed in parameter (test)</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">is_string</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s1">)) {</span>
                <span class="s9">$resource </span><span class="s1">= </span><span class="s3">fopen</span><span class="s1">(</span><span class="s8">'php://temp'</span><span class="s0">, </span><span class="s8">'r+'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s3">fwrite</span><span class="s1">(</span><span class="s9">$resource</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s3">rewind</span><span class="s1">(</span><span class="s9">$resource</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s0">return </span><span class="s9">$resource</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">fopen</span><span class="s1">(</span><span class="s8">'php://input'</span><span class="s0">, </span><span class="s8">'rb'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">$currentContentIsResource</span><span class="s1">) {</span>
            <span class="s3">rewind</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return </span><span class="s3">stream_get_contents</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content </span><span class="s1">|| </span><span class="s3">false </span><span class="s1">=== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s1">) {</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content </span><span class="s1">= </span><span class="s3">file_get_contents</span><span class="s1">(</span><span class="s8">'php://input'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">content</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the Etags.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array The entity tags</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getETags</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">preg_split</span><span class="s1">(</span><span class="s8">'/\s*,\s*/'</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'if_none_match'</span><span class="s1">)</span><span class="s0">, </span><span class="s3">null</span><span class="s0">, </span><span class="s3">PREG_SPLIT_NO_EMPTY</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isNoCache</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">hasCacheControlDirective</span><span class="s1">(</span><span class="s8">'no-cache'</span><span class="s1">) || </span><span class="s8">'no-cache' </span><span class="s1">== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'Pragma'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets the preferred format for the response by inspecting, in the following order:</span>
     <span class="s4">*   * the request format set using setRequestFormat</span>
     <span class="s4">*   * the values of the Accept HTTP header</span>
     <span class="s4">*</span>
     <span class="s4">* Note that if you use this method, you should send the &quot;Vary: Accept&quot; header</span>
     <span class="s4">* in the response to prevent any issues with intermediary HTTP caches.</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getPreferredFormat</span><span class="s1">(?</span><span class="s3">string </span><span class="s9">$default </span><span class="s1">= </span><span class="s8">'html'</span><span class="s1">): ?</span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">preferredFormat </span><span class="s1">|| </span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">preferredFormat </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getRequestFormat</span><span class="s1">(</span><span class="s3">null</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">preferredFormat</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getAcceptableContentTypes</span><span class="s1">() </span><span class="s0">as </span><span class="s9">$mimeType</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">preferredFormat </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getFormat</span><span class="s1">(</span><span class="s9">$mimeType</span><span class="s1">)) {</span>
                <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">preferredFormat</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$default</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the preferred language.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">string[] $locales An array of ordered available locales</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string|null The preferred locale</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getPreferredLanguage</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$locales </span><span class="s1">= </span><span class="s3">null</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s9">$preferredLanguages </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getLanguages</span><span class="s1">()</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">empty</span><span class="s1">(</span><span class="s9">$locales</span><span class="s1">)) {</span>
            <span class="s0">return isset</span><span class="s1">(</span><span class="s9">$preferredLanguages</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) ? </span><span class="s9">$preferredLanguages</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] : </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$preferredLanguages</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$locales</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$extendedPreferredLanguages </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$preferredLanguages </span><span class="s0">as </span><span class="s9">$language</span><span class="s1">) {</span>
            <span class="s9">$extendedPreferredLanguages</span><span class="s1">[] = </span><span class="s9">$language</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$position </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$language</span><span class="s0">, </span><span class="s8">'_'</span><span class="s1">)) {</span>
                <span class="s9">$superLanguage </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$language</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$position</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(!\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s9">$superLanguage</span><span class="s0">, </span><span class="s9">$preferredLanguages</span><span class="s1">)) {</span>
                    <span class="s9">$extendedPreferredLanguages</span><span class="s1">[] = </span><span class="s9">$superLanguage</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s9">$preferredLanguages </span><span class="s1">= </span><span class="s3">array_values</span><span class="s1">(</span><span class="s3">array_intersect</span><span class="s1">(</span><span class="s9">$extendedPreferredLanguages</span><span class="s0">, </span><span class="s9">$locales</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s0">return isset</span><span class="s1">(</span><span class="s9">$preferredLanguages</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) ? </span><span class="s9">$preferredLanguages</span><span class="s1">[</span><span class="s7">0</span><span class="s1">] : </span><span class="s9">$locales</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets a list of languages acceptable by the client browser.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array Languages ordered in the user browser preferences</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getLanguages</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">languages</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">languages</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$languages </span><span class="s1">= </span><span class="s3">AcceptHeader</span><span class="s1">::</span><span class="s3">fromString</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'Accept-Language'</span><span class="s1">))-&gt;</span><span class="s3">all</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">languages </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$languages </span><span class="s0">as </span><span class="s9">$lang </span><span class="s1">=&gt; </span><span class="s9">$acceptHeaderItem</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$lang</span><span class="s0">, </span><span class="s8">'-'</span><span class="s1">)) {</span>
                <span class="s9">$codes </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">'-'</span><span class="s0">, </span><span class="s9">$lang</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s8">'i' </span><span class="s1">=== </span><span class="s9">$codes</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
                    <span class="s2">// Language not listed in ISO 639 that are not variants</span>
                    <span class="s2">// of any listed language, which can be registered with the</span>
                    <span class="s2">// i-prefix, such as i-cherokee</span>
                    <span class="s0">if </span><span class="s1">(\</span><span class="s3">count</span><span class="s1">(</span><span class="s9">$codes</span><span class="s1">) &gt; </span><span class="s7">1</span><span class="s1">) {</span>
                        <span class="s9">$lang </span><span class="s1">= </span><span class="s9">$codes</span><span class="s1">[</span><span class="s7">1</span><span class="s1">]</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                    <span class="s0">for </span><span class="s1">(</span><span class="s9">$i </span><span class="s1">= </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$max </span><span class="s1">= \</span><span class="s3">count</span><span class="s1">(</span><span class="s9">$codes</span><span class="s1">)</span><span class="s0">; </span><span class="s9">$i </span><span class="s1">&lt; </span><span class="s9">$max</span><span class="s0">; </span><span class="s1">++</span><span class="s9">$i</span><span class="s1">) {</span>
                        <span class="s0">if </span><span class="s1">(</span><span class="s7">0 </span><span class="s1">=== </span><span class="s9">$i</span><span class="s1">) {</span>
                            <span class="s9">$lang </span><span class="s1">= </span><span class="s3">strtolower</span><span class="s1">(</span><span class="s9">$codes</span><span class="s1">[</span><span class="s7">0</span><span class="s1">])</span><span class="s0">;</span>
                        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                            <span class="s9">$lang </span><span class="s1">.= </span><span class="s8">'_'</span><span class="s1">.</span><span class="s3">strtoupper</span><span class="s1">(</span><span class="s9">$codes</span><span class="s1">[</span><span class="s9">$i</span><span class="s1">])</span><span class="s0">;</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">languages</span><span class="s1">[] = </span><span class="s9">$lang</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">languages</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets a list of charsets acceptable by the client browser.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array List of charsets in preferable order</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getCharsets</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">charsets</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">charsets</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">charsets </span><span class="s1">= </span><span class="s3">array_keys</span><span class="s1">(</span><span class="s3">AcceptHeader</span><span class="s1">::</span><span class="s3">fromString</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'Accept-Charset'</span><span class="s1">))-&gt;</span><span class="s3">all</span><span class="s1">())</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets a list of encodings acceptable by the client browser.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array List of encodings in preferable order</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getEncodings</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">encodings</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">encodings</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">encodings </span><span class="s1">= </span><span class="s3">array_keys</span><span class="s1">(</span><span class="s3">AcceptHeader</span><span class="s1">::</span><span class="s3">fromString</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'Accept-Encoding'</span><span class="s1">))-&gt;</span><span class="s3">all</span><span class="s1">())</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Gets a list of content types acceptable by the client browser.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">array List of content types in preferable order</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getAcceptableContentTypes</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">acceptableContentTypes</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">acceptableContentTypes</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">acceptableContentTypes </span><span class="s1">= </span><span class="s3">array_keys</span><span class="s1">(</span><span class="s3">AcceptHeader</span><span class="s1">::</span><span class="s3">fromString</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'Accept'</span><span class="s1">))-&gt;</span><span class="s3">all</span><span class="s1">())</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns true if the request is a XMLHttpRequest.</span>
     <span class="s4">*</span>
     <span class="s4">* It works if your JavaScript library sets an X-Requested-With HTTP header.</span>
     <span class="s4">* It is known to work with common JavaScript frameworks:</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">https://wikipedia.org/wiki/List_of_Ajax_frameworks#JavaScript</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool true if the request is an XMLHttpRequest, false otherwise</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isXmlHttpRequest</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s8">'XMLHttpRequest' </span><span class="s1">== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'X-Requested-With'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s2">/* 
     * The following methods are derived from code of the Zend Framework (1.10dev - 2010-01-24) 
     * 
     * Code subject to the new BSD license (https://framework.zend.com/license). 
     * 
     * Copyright (c) 2005-2010 Zend Technologies USA Inc. (https://www.zend.com/) 
     */</span>

    <span class="s0">protected function </span><span class="s3">prepareRequestUri</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$requestUri </span><span class="s1">= </span><span class="s8">''</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'1' </span><span class="s1">== </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'IIS_WasUrlRewritten'</span><span class="s1">) &amp;&amp; </span><span class="s8">'' </span><span class="s1">!= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'UNENCODED_URL'</span><span class="s1">)) {</span>
            <span class="s2">// IIS7 with URL Rewrite: make sure we get the unencoded URL (double slash problem)</span>
            <span class="s9">$requestUri </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'UNENCODED_URL'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">remove</span><span class="s1">(</span><span class="s8">'UNENCODED_URL'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">remove</span><span class="s1">(</span><span class="s8">'IIS_WasUrlRewritten'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s8">'REQUEST_URI'</span><span class="s1">)) {</span>
            <span class="s9">$requestUri </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'REQUEST_URI'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">!== </span><span class="s9">$requestUri </span><span class="s1">&amp;&amp; </span><span class="s8">'/' </span><span class="s1">=== </span><span class="s9">$requestUri</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
                <span class="s2">// To only use path and query remove the fragment.</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s8">'#'</span><span class="s1">)) {</span>
                    <span class="s9">$requestUri </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$pos</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s2">// HTTP proxy reqs setup request URI with scheme and host [and port] + the URL path,</span>
                <span class="s2">// only use URL path.</span>
                <span class="s9">$uriComponents </span><span class="s1">= </span><span class="s3">parse_url</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$uriComponents</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">])) {</span>
                    <span class="s9">$requestUri </span><span class="s1">= </span><span class="s9">$uriComponents</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s9">$uriComponents</span><span class="s1">[</span><span class="s8">'query'</span><span class="s1">])) {</span>
                    <span class="s9">$requestUri </span><span class="s1">.= </span><span class="s8">'?'</span><span class="s1">.</span><span class="s9">$uriComponents</span><span class="s1">[</span><span class="s8">'query'</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s8">'ORIG_PATH_INFO'</span><span class="s1">)) {</span>
            <span class="s2">// IIS 5.0, PHP as CGI</span>
            <span class="s9">$requestUri </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'ORIG_PATH_INFO'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">!= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'QUERY_STRING'</span><span class="s1">)) {</span>
                <span class="s9">$requestUri </span><span class="s1">.= </span><span class="s8">'?'</span><span class="s1">.</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'QUERY_STRING'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">remove</span><span class="s1">(</span><span class="s8">'ORIG_PATH_INFO'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s2">// normalize the request URI to ease creating sub-requests from this request</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">set</span><span class="s1">(</span><span class="s8">'REQUEST_URI'</span><span class="s0">, </span><span class="s9">$requestUri</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">return </span><span class="s9">$requestUri</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Prepares the base URL.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string</span>
     <span class="s4">*/</span>
    <span class="s0">protected function </span><span class="s3">prepareBaseUrl</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$filename </span><span class="s1">= </span><span class="s3">basename</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SCRIPT_FILENAME'</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">basename</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SCRIPT_NAME'</span><span class="s1">)) === </span><span class="s9">$filename</span><span class="s1">) {</span>
            <span class="s9">$baseUrl </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SCRIPT_NAME'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s3">basename</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'PHP_SELF'</span><span class="s1">)) === </span><span class="s9">$filename</span><span class="s1">) {</span>
            <span class="s9">$baseUrl </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'PHP_SELF'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s3">basename</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'ORIG_SCRIPT_NAME'</span><span class="s1">)) === </span><span class="s9">$filename</span><span class="s1">) {</span>
            <span class="s9">$baseUrl </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'ORIG_SCRIPT_NAME'</span><span class="s1">)</span><span class="s0">; </span><span class="s2">// 1and1 shared hosting compatibility</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s2">// Backtrack up the script_filename to find the portion matching</span>
            <span class="s2">// php_self</span>
            <span class="s9">$path </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'PHP_SELF'</span><span class="s0">, </span><span class="s8">''</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$file </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SCRIPT_FILENAME'</span><span class="s0">, </span><span class="s8">''</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$segs </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">'/'</span><span class="s0">, </span><span class="s3">trim</span><span class="s1">(</span><span class="s9">$file</span><span class="s0">, </span><span class="s8">'/'</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s9">$segs </span><span class="s1">= </span><span class="s3">array_reverse</span><span class="s1">(</span><span class="s9">$segs</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$index </span><span class="s1">= </span><span class="s7">0</span><span class="s0">;</span>
            <span class="s9">$last </span><span class="s1">= \</span><span class="s3">count</span><span class="s1">(</span><span class="s9">$segs</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$baseUrl </span><span class="s1">= </span><span class="s8">''</span><span class="s0">;</span>
            <span class="s0">do </span><span class="s1">{</span>
                <span class="s9">$seg </span><span class="s1">= </span><span class="s9">$segs</span><span class="s1">[</span><span class="s9">$index</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s9">$baseUrl </span><span class="s1">= </span><span class="s8">'/'</span><span class="s1">.</span><span class="s9">$seg</span><span class="s1">.</span><span class="s9">$baseUrl</span><span class="s0">;</span>
                <span class="s1">++</span><span class="s9">$index</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">while </span><span class="s1">(</span><span class="s9">$last </span><span class="s1">&gt; </span><span class="s9">$index </span><span class="s1">&amp;&amp; (</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$path</span><span class="s0">, </span><span class="s9">$baseUrl</span><span class="s1">)) &amp;&amp; </span><span class="s7">0 </span><span class="s1">!= </span><span class="s9">$pos</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s2">// Does the baseUrl have anything in common with the request_uri?</span>
        <span class="s9">$requestUri </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getRequestUri</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">!== </span><span class="s9">$requestUri </span><span class="s1">&amp;&amp; </span><span class="s8">'/' </span><span class="s1">!== </span><span class="s9">$requestUri</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
            <span class="s9">$requestUri </span><span class="s1">= </span><span class="s8">'/'</span><span class="s1">.</span><span class="s9">$requestUri</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">$baseUrl </span><span class="s1">&amp;&amp; </span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$prefix </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getUrlencodedPrefix</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s9">$baseUrl</span><span class="s1">)) {</span>
            <span class="s2">// full $baseUrl matches</span>
            <span class="s0">return </span><span class="s9">$prefix</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">$baseUrl </span><span class="s1">&amp;&amp; </span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$prefix </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getUrlencodedPrefix</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s3">rtrim</span><span class="s1">(\</span><span class="s3">dirname</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">)</span><span class="s0">, </span><span class="s8">'/'</span><span class="s1">.\</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">).</span><span class="s8">'/'</span><span class="s1">)) {</span>
            <span class="s2">// directory portion of $baseUrl matches</span>
            <span class="s0">return </span><span class="s3">rtrim</span><span class="s1">(</span><span class="s9">$prefix</span><span class="s0">, </span><span class="s8">'/'</span><span class="s1">.\</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$truncatedRequestUri </span><span class="s1">= </span><span class="s9">$requestUri</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s8">'?'</span><span class="s1">)) {</span>
            <span class="s9">$truncatedRequestUri </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$pos</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$basename </span><span class="s1">= </span><span class="s3">basename</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">empty</span><span class="s1">(</span><span class="s9">$basename</span><span class="s1">) || !</span><span class="s3">strpos</span><span class="s1">(</span><span class="s3">rawurldecode</span><span class="s1">(</span><span class="s9">$truncatedRequestUri</span><span class="s1">)</span><span class="s0">, </span><span class="s9">$basename</span><span class="s1">)) {</span>
            <span class="s2">// no match whatsoever; set it blank</span>
            <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s2">// If using mod_rewrite or ISAPI_Rewrite strip the script filename</span>
        <span class="s2">// out of baseUrl. $pos !== 0 makes sure it is not matching a value</span>
        <span class="s2">// from PATH_INFO or QUERY_STRING</span>
        <span class="s0">if </span><span class="s1">(\</span><span class="s3">strlen</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s1">) &gt;= \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">) &amp;&amp; (</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s9">$baseUrl</span><span class="s1">)) &amp;&amp; </span><span class="s7">0 </span><span class="s1">!== </span><span class="s9">$pos</span><span class="s1">) {</span>
            <span class="s9">$baseUrl </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$pos </span><span class="s1">+ \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">rtrim</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s0">, </span><span class="s8">'/'</span><span class="s1">.\</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Prepares the base path.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string base path</span>
     <span class="s4">*/</span>
    <span class="s0">protected function </span><span class="s3">prepareBasePath</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s9">$baseUrl </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getBaseUrl</span><span class="s1">()</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">empty</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s8">''</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$filename </span><span class="s1">= </span><span class="s3">basename</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'SCRIPT_FILENAME'</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">basename</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">) === </span><span class="s9">$filename</span><span class="s1">) {</span>
            <span class="s9">$basePath </span><span class="s1">= \</span><span class="s3">dirname</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s9">$basePath </span><span class="s1">= </span><span class="s9">$baseUrl</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'</span><span class="s0">\\</span><span class="s8">' </span><span class="s1">=== \</span><span class="s3">DIRECTORY_SEPARATOR</span><span class="s1">) {</span>
            <span class="s9">$basePath </span><span class="s1">= </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s8">'</span><span class="s0">\\</span><span class="s8">'</span><span class="s0">, </span><span class="s8">'/'</span><span class="s0">, </span><span class="s9">$basePath</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">rtrim</span><span class="s1">(</span><span class="s9">$basePath</span><span class="s0">, </span><span class="s8">'/'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Prepares the path info.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">string path info</span>
     <span class="s4">*/</span>
    <span class="s0">protected function </span><span class="s3">preparePathInfo</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== (</span><span class="s9">$requestUri </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getRequestUri</span><span class="s1">())) {</span>
            <span class="s0">return </span><span class="s8">'/'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s2">// Remove the query string from REQUEST_URI</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">!== </span><span class="s9">$pos </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s8">'?'</span><span class="s1">)) {</span>
            <span class="s9">$requestUri </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$pos</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'' </span><span class="s1">!== </span><span class="s9">$requestUri </span><span class="s1">&amp;&amp; </span><span class="s8">'/' </span><span class="s1">!== </span><span class="s9">$requestUri</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]) {</span>
            <span class="s9">$requestUri </span><span class="s1">= </span><span class="s8">'/'</span><span class="s1">.</span><span class="s9">$requestUri</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== (</span><span class="s9">$baseUrl </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">getBaseUrl</span><span class="s1">())) {</span>
            <span class="s0">return </span><span class="s9">$requestUri</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$pathInfo </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$requestUri</span><span class="s0">, </span><span class="s1">\</span><span class="s3">strlen</span><span class="s1">(</span><span class="s9">$baseUrl</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">=== </span><span class="s9">$pathInfo </span><span class="s1">|| </span><span class="s8">'' </span><span class="s1">=== </span><span class="s9">$pathInfo</span><span class="s1">) {</span>
            <span class="s2">// If substr() returns false then PATH_INFO is set to an empty string</span>
            <span class="s0">return </span><span class="s8">'/'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s1">(string) </span><span class="s9">$pathInfo</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Initializes HTTP request formats.</span>
     <span class="s4">*/</span>
    <span class="s0">protected static function </span><span class="s3">initializeFormats</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">static</span><span class="s1">::</span><span class="s9">$formats </span><span class="s1">= [</span>
            <span class="s8">'html' </span><span class="s1">=&gt; [</span><span class="s8">'text/html'</span><span class="s0">, </span><span class="s8">'application/xhtml+xml'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'txt' </span><span class="s1">=&gt; [</span><span class="s8">'text/plain'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'js' </span><span class="s1">=&gt; [</span><span class="s8">'application/javascript'</span><span class="s0">, </span><span class="s8">'application/x-javascript'</span><span class="s0">, </span><span class="s8">'text/javascript'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'css' </span><span class="s1">=&gt; [</span><span class="s8">'text/css'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'json' </span><span class="s1">=&gt; [</span><span class="s8">'application/json'</span><span class="s0">, </span><span class="s8">'application/x-json'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'jsonld' </span><span class="s1">=&gt; [</span><span class="s8">'application/ld+json'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'xml' </span><span class="s1">=&gt; [</span><span class="s8">'text/xml'</span><span class="s0">, </span><span class="s8">'application/xml'</span><span class="s0">, </span><span class="s8">'application/x-xml'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'rdf' </span><span class="s1">=&gt; [</span><span class="s8">'application/rdf+xml'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'atom' </span><span class="s1">=&gt; [</span><span class="s8">'application/atom+xml'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'rss' </span><span class="s1">=&gt; [</span><span class="s8">'application/rss+xml'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'form' </span><span class="s1">=&gt; [</span><span class="s8">'application/x-www-form-urlencoded'</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">setPhpDefaultLocale</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$locale</span><span class="s1">): </span><span class="s3">void</span>
    <span class="s1">{</span>
        <span class="s2">// if either the class Locale doesn't exist, or an exception is thrown when</span>
        <span class="s2">// setting the default locale, the intl module is not installed, and</span>
        <span class="s2">// the call can be ignored:</span>
        <span class="s0">try </span><span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Locale'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                <span class="s1">\</span><span class="s3">Locale</span><span class="s1">::</span><span class="s3">setDefault</span><span class="s1">(</span><span class="s9">$locale</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">catch </span><span class="s1">(\</span><span class="s3">Exception </span><span class="s9">$e</span><span class="s1">) {</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the prefix as encoded in the string when the string starts with</span>
     <span class="s4">* the given prefix, null otherwise.</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">getUrlencodedPrefix</span><span class="s1">(</span><span class="s3">string </span><span class="s9">$string</span><span class="s0">, </span><span class="s3">string </span><span class="s9">$prefix</span><span class="s1">): ?</span><span class="s3">string</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">0 </span><span class="s1">!== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s3">rawurldecode</span><span class="s1">(</span><span class="s9">$string</span><span class="s1">)</span><span class="s0">, </span><span class="s9">$prefix</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s9">$len </span><span class="s1">= \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s9">$prefix</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'#^(%%[[:xdigit:]]{2}|.){%d}#'</span><span class="s0">, </span><span class="s9">$len</span><span class="s1">)</span><span class="s0">, </span><span class="s9">$string</span><span class="s0">, </span><span class="s9">$match</span><span class="s1">)) {</span>
            <span class="s0">return </span><span class="s9">$match</span><span class="s1">[</span><span class="s7">0</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return </span><span class="s3">null</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private static function </span><span class="s3">createRequestFromFactory</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$query </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$request </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$attributes </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$cookies </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$files </span><span class="s1">= []</span><span class="s0">, array </span><span class="s9">$server </span><span class="s1">= []</span><span class="s0">, </span><span class="s9">$content </span><span class="s1">= </span><span class="s3">null</span><span class="s1">): </span><span class="s3">self</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$requestFactory</span><span class="s1">) {</span>
            <span class="s9">$request </span><span class="s1">= (</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$requestFactory</span><span class="s1">)(</span><span class="s9">$query</span><span class="s0">, </span><span class="s9">$request</span><span class="s0">, </span><span class="s9">$attributes</span><span class="s0">, </span><span class="s9">$cookies</span><span class="s0">, </span><span class="s9">$files</span><span class="s0">, </span><span class="s9">$server</span><span class="s0">, </span><span class="s9">$content</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s9">$request </span><span class="s0">instanceof </span><span class="s3">self</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s1">\</span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'The Request factory must return an instance of Symfony\Component\HttpFoundation\Request.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">return </span><span class="s9">$request</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return new static</span><span class="s1">(</span><span class="s9">$query</span><span class="s0">, </span><span class="s9">$request</span><span class="s0">, </span><span class="s9">$attributes</span><span class="s0">, </span><span class="s9">$cookies</span><span class="s0">, </span><span class="s9">$files</span><span class="s0">, </span><span class="s9">$server</span><span class="s0">, </span><span class="s9">$content</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Indicates whether this request originated from a trusted proxy.</span>
     <span class="s4">*</span>
     <span class="s4">* This can be useful to determine whether or not to trust the</span>
     <span class="s4">* contents of a proxy-specific header.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">bool true if the request came from a trusted proxy, false otherwise</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">isFromTrustedProxy</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedProxies </span><span class="s1">&amp;&amp; </span><span class="s3">IpUtils</span><span class="s1">::</span><span class="s3">checkIp</span><span class="s1">(</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">server</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s8">'REMOTE_ADDR'</span><span class="s1">)</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedProxies</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">getTrustedValues</span><span class="s1">(</span><span class="s3">int </span><span class="s9">$type</span><span class="s0">, </span><span class="s3">string </span><span class="s9">$ip </span><span class="s1">= </span><span class="s3">null</span><span class="s1">): </span><span class="s0">array</span>
    <span class="s1">{</span>
        <span class="s9">$clientValues </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s9">$forwardedValues </span><span class="s1">= []</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">((</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaderSet </span><span class="s1">&amp; </span><span class="s9">$type</span><span class="s1">) &amp;&amp; </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaders</span><span class="s1">[</span><span class="s9">$type</span><span class="s1">])) {</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s3">explode</span><span class="s1">(</span><span class="s8">','</span><span class="s0">, </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaders</span><span class="s1">[</span><span class="s9">$type</span><span class="s1">])) </span><span class="s0">as </span><span class="s9">$v</span><span class="s1">) {</span>
                <span class="s9">$clientValues</span><span class="s1">[] = (</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PORT </span><span class="s1">=== </span><span class="s9">$type </span><span class="s1">? </span><span class="s8">'0.0.0.0:' </span><span class="s1">: </span><span class="s8">''</span><span class="s1">).</span><span class="s3">trim</span><span class="s1">(</span><span class="s9">$v</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">((</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaderSet </span><span class="s1">&amp; </span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_FORWARDED</span><span class="s1">) &amp;&amp; </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">has</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaders</span><span class="s1">[</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_FORWARDED</span><span class="s1">])) {</span>
            <span class="s9">$forwarded </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">headers</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaders</span><span class="s1">[</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_FORWARDED</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s9">$parts </span><span class="s1">= </span><span class="s3">HeaderUtils</span><span class="s1">::</span><span class="s3">split</span><span class="s1">(</span><span class="s9">$forwarded</span><span class="s0">, </span><span class="s8">',;='</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$forwardedValues </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s9">$param </span><span class="s1">= </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$forwardedParams</span><span class="s1">[</span><span class="s9">$type</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$parts </span><span class="s0">as </span><span class="s9">$subParts</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$v </span><span class="s1">= </span><span class="s3">HeaderUtils</span><span class="s1">::</span><span class="s3">combine</span><span class="s1">(</span><span class="s9">$subParts</span><span class="s1">)[</span><span class="s9">$param</span><span class="s1">] ?? </span><span class="s3">null</span><span class="s1">) {</span>
                    <span class="s0">continue;</span>
                <span class="s1">}</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_X_FORWARDED_PORT </span><span class="s1">=== </span><span class="s9">$type</span><span class="s1">) {</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s8">']' </span><span class="s1">=== </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$v</span><span class="s0">, </span><span class="s1">-</span><span class="s7">1</span><span class="s1">) || </span><span class="s3">false </span><span class="s1">=== </span><span class="s9">$v </span><span class="s1">= </span><span class="s3">strrchr</span><span class="s1">(</span><span class="s9">$v</span><span class="s0">, </span><span class="s8">':'</span><span class="s1">)) {</span>
                        <span class="s9">$v </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isSecure</span><span class="s1">() ? </span><span class="s8">':443' </span><span class="s1">: </span><span class="s8">':80'</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s9">$v </span><span class="s1">= </span><span class="s8">'0.0.0.0'</span><span class="s1">.</span><span class="s9">$v</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s9">$forwardedValues</span><span class="s1">[] = </span><span class="s9">$v</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$ip</span><span class="s1">) {</span>
            <span class="s9">$clientValues </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">normalizeAndFilterClientIps</span><span class="s1">(</span><span class="s9">$clientValues</span><span class="s0">, </span><span class="s9">$ip</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s9">$forwardedValues </span><span class="s1">= </span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">normalizeAndFilterClientIps</span><span class="s1">(</span><span class="s9">$forwardedValues</span><span class="s0">, </span><span class="s9">$ip</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s9">$forwardedValues </span><span class="s1">=== </span><span class="s9">$clientValues </span><span class="s1">|| !</span><span class="s9">$clientValues</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$forwardedValues</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$forwardedValues</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s9">$clientValues</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isForwardedValid</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s3">null </span><span class="s1">!== </span><span class="s9">$ip </span><span class="s1">? [</span><span class="s8">'0.0.0.0'</span><span class="s0">, </span><span class="s9">$ip</span><span class="s1">] : []</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s9">$this</span><span class="s1">-&gt;</span><span class="s3">isForwardedValid </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>

        <span class="s0">throw new </span><span class="s3">ConflictingHeadersException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'The request has both a trusted &quot;%s&quot; header and a trusted &quot;%s&quot; header, conflicting with each other. You should either configure your proxy to remove one of them, or configure your project to distrust the offending one.'</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaders</span><span class="s1">[</span><span class="s3">self</span><span class="s1">::</span><span class="s3">HEADER_FORWARDED</span><span class="s1">]</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedHeaders</span><span class="s1">[</span><span class="s9">$type</span><span class="s1">]))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">normalizeAndFilterClientIps</span><span class="s1">(</span><span class="s0">array </span><span class="s9">$clientIps</span><span class="s0">, </span><span class="s3">string </span><span class="s9">$ip</span><span class="s1">): </span><span class="s0">array</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s9">$clientIps</span><span class="s1">) {</span>
            <span class="s0">return </span><span class="s1">[]</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s9">$clientIps</span><span class="s1">[] = </span><span class="s9">$ip</span><span class="s0">; </span><span class="s2">// Complete the IP chain with the IP the request actually came from</span>
        <span class="s9">$firstTrustedIp </span><span class="s1">= </span><span class="s3">null</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s9">$clientIps </span><span class="s0">as </span><span class="s9">$key </span><span class="s1">=&gt; </span><span class="s9">$clientIp</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s8">'.'</span><span class="s1">)) {</span>
                <span class="s2">// Strip :port from IPv4 addresses. This is allowed in Forwarded</span>
                <span class="s2">// and may occur in X-Forwarded-For.</span>
                <span class="s9">$i </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s8">':'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s9">$i</span><span class="s1">) {</span>
                    <span class="s9">$clientIps</span><span class="s1">[</span><span class="s9">$key</span><span class="s1">] = </span><span class="s9">$clientIp </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s9">$i</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s7">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s8">'['</span><span class="s1">)) {</span>
                <span class="s2">// Strip brackets and :port from IPv6 addresses.</span>
                <span class="s9">$i </span><span class="s1">= </span><span class="s3">strpos</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s8">']'</span><span class="s0">, </span><span class="s7">1</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s9">$clientIps</span><span class="s1">[</span><span class="s9">$key</span><span class="s1">] = </span><span class="s9">$clientIp </span><span class="s1">= </span><span class="s3">substr</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s7">1</span><span class="s0">, </span><span class="s9">$i </span><span class="s1">- </span><span class="s7">1</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s3">filter_var</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s3">FILTER_VALIDATE_IP</span><span class="s1">)) {</span>
                <span class="s0">unset</span><span class="s1">(</span><span class="s9">$clientIps</span><span class="s1">[</span><span class="s9">$key</span><span class="s1">])</span><span class="s0">;</span>

                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">IpUtils</span><span class="s1">::</span><span class="s3">checkIp</span><span class="s1">(</span><span class="s9">$clientIp</span><span class="s0">, </span><span class="s3">self</span><span class="s1">::</span><span class="s9">$trustedProxies</span><span class="s1">)) {</span>
                <span class="s0">unset</span><span class="s1">(</span><span class="s9">$clientIps</span><span class="s1">[</span><span class="s9">$key</span><span class="s1">])</span><span class="s0">;</span>

                <span class="s2">// Fallback to this when the client IP falls into the range of trusted proxies</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s9">$firstTrustedIp</span><span class="s1">) {</span>
                    <span class="s9">$firstTrustedIp </span><span class="s1">= </span><span class="s9">$clientIp</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">// Now the IP chain contains only untrusted proxies and the client IP</span>
        <span class="s0">return </span><span class="s9">$clientIps </span><span class="s1">? </span><span class="s3">array_reverse</span><span class="s1">(</span><span class="s9">$clientIps</span><span class="s1">) : [</span><span class="s9">$firstTrustedIp</span><span class="s1">]</span><span class="s0">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>