<html>
<head>
<title>FrameworkExtension.php</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #a9b7c6;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #629755; font-weight: bold; font-style: italic;}
.s6 { color: #77b767; font-style: italic;}
.s7 { color: #9876aa;}
.s8 { color: #6a8759;}
.s9 { color: #6897bb;}
.ls0 { height: 1px; border-width: 0; color: #4d4d4d; background-color:#4d4d4d}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
FrameworkExtension.php</font>
</center></td></tr></table>
<pre><span class="s0">&lt;?php</span>

<span class="s2">/* 
 * This file is part of the Symfony package. 
 * 
 * (c) Fabien Potencier &lt;fabien@symfony.com&gt; 
 * 
 * For the full copyright and license information, please view the LICENSE 
 * file that was distributed with this source code. 
 */</span>
<hr class="ls0"><span class="s0">namespace </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Bundle</span><span class="s1">\</span><span class="s3">FrameworkBundle</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s0">;</span>

<span class="s0">use </span><span class="s3">Doctrine</span><span class="s1">\</span><span class="s3">Common</span><span class="s1">\</span><span class="s3">Annotations</span><span class="s1">\</span><span class="s3">AnnotationRegistry</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Doctrine</span><span class="s1">\</span><span class="s3">Common</span><span class="s1">\</span><span class="s3">Annotations</span><span class="s1">\</span><span class="s3">Reader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Http</span><span class="s1">\</span><span class="s3">Client</span><span class="s1">\</span><span class="s3">HttpClient</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Psr</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">CacheItemPoolInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Psr</span><span class="s1">\</span><span class="s3">Container</span><span class="s1">\</span><span class="s3">ContainerInterface </span><span class="s0">as </span><span class="s3">PsrContainerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Psr</span><span class="s1">\</span><span class="s3">EventDispatcher</span><span class="s1">\</span><span class="s3">EventDispatcherInterface </span><span class="s0">as </span><span class="s3">PsrEventDispatcherInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Psr</span><span class="s1">\</span><span class="s3">Http</span><span class="s1">\</span><span class="s3">Client</span><span class="s1">\</span><span class="s3">ClientInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Psr</span><span class="s1">\</span><span class="s3">Log</span><span class="s1">\</span><span class="s3">LoggerAwareInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Monolog</span><span class="s1">\</span><span class="s3">Processor</span><span class="s1">\</span><span class="s3">DebugProcessor</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Twig</span><span class="s1">\</span><span class="s3">Extension</span><span class="s1">\</span><span class="s3">CsrfExtension</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Bundle</span><span class="s1">\</span><span class="s3">FrameworkBundle</span><span class="s1">\</span><span class="s3">Controller</span><span class="s1">\</span><span class="s3">AbstractController</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Bundle</span><span class="s1">\</span><span class="s3">FrameworkBundle</span><span class="s1">\</span><span class="s3">Routing</span><span class="s1">\</span><span class="s3">AnnotatedRouteControllerLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Bundle</span><span class="s1">\</span><span class="s3">FrameworkBundle</span><span class="s1">\</span><span class="s3">Routing</span><span class="s1">\</span><span class="s3">RouteLoaderInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Bundle</span><span class="s1">\</span><span class="s3">FullStack</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Asset</span><span class="s1">\</span><span class="s3">PackageInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">BrowserKit</span><span class="s1">\</span><span class="s3">AbstractBrowser</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">Adapter</span><span class="s1">\</span><span class="s3">AdapterInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">Adapter</span><span class="s1">\</span><span class="s3">ArrayAdapter</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">Adapter</span><span class="s1">\</span><span class="s3">ChainAdapter</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">Adapter</span><span class="s1">\</span><span class="s3">TagAwareAdapter</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">CachePoolPass</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">Marshaller</span><span class="s1">\</span><span class="s3">DefaultMarshaller</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">Marshaller</span><span class="s1">\</span><span class="s3">MarshallerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">ResettableInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Config</span><span class="s1">\</span><span class="s3">FileLocator</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Config</span><span class="s1">\</span><span class="s3">Loader</span><span class="s1">\</span><span class="s3">LoaderInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Config</span><span class="s1">\</span><span class="s3">Resource</span><span class="s1">\</span><span class="s3">DirectoryResource</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Config</span><span class="s1">\</span><span class="s3">ResourceCheckerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Console</span><span class="s1">\</span><span class="s3">Application</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Console</span><span class="s1">\</span><span class="s3">Command</span><span class="s1">\</span><span class="s3">Command</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Alias</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Argument</span><span class="s1">\</span><span class="s3">ServiceClosureArgument</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ChildDefinition</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Compiler</span><span class="s1">\</span><span class="s3">ServiceLocatorTagPass</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ContainerBuilder</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ContainerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Definition</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">EnvVarLoaderInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">EnvVarProcessorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">InvalidArgumentException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Exception</span><span class="s1">\</span><span class="s3">LogicException</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Loader</span><span class="s1">\</span><span class="s3">XmlFileLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Parameter</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Reference</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">ServiceLocator</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">EventDispatcher</span><span class="s1">\</span><span class="s3">EventSubscriberInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">ExpressionLanguage</span><span class="s1">\</span><span class="s3">ExpressionLanguage</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Finder</span><span class="s1">\</span><span class="s3">Finder</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Form</span><span class="s1">\</span><span class="s3">ChoiceList</span><span class="s1">\</span><span class="s3">Factory</span><span class="s1">\</span><span class="s3">CachingFactoryDecorator</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Form</span><span class="s1">\</span><span class="s3">FormTypeExtensionInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Form</span><span class="s1">\</span><span class="s3">FormTypeGuesserInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Form</span><span class="s1">\</span><span class="s3">FormTypeInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpClient</span><span class="s1">\</span><span class="s3">ScopingHttpClient</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpKernel</span><span class="s1">\</span><span class="s3">CacheClearer</span><span class="s1">\</span><span class="s3">CacheClearerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpKernel</span><span class="s1">\</span><span class="s3">CacheWarmer</span><span class="s1">\</span><span class="s3">CacheWarmerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpKernel</span><span class="s1">\</span><span class="s3">Controller</span><span class="s1">\</span><span class="s3">ArgumentValueResolverInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpKernel</span><span class="s1">\</span><span class="s3">DataCollector</span><span class="s1">\</span><span class="s3">DataCollectorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">HttpKernel</span><span class="s1">\</span><span class="s3">DependencyInjection</span><span class="s1">\</span><span class="s3">Extension</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Lock</span><span class="s1">\</span><span class="s3">Lock</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Lock</span><span class="s1">\</span><span class="s3">LockFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Lock</span><span class="s1">\</span><span class="s3">LockInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Lock</span><span class="s1">\</span><span class="s3">PersistingStoreInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Lock</span><span class="s1">\</span><span class="s3">Store</span><span class="s1">\</span><span class="s3">StoreFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Amazon</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">SesTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Google</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">GmailTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Mailchimp</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">MandrillTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Mailgun</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">MailgunTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Postmark</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">PostmarkTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Sendgrid</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">SendgridTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s1">\</span><span class="s3">Mailer</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Messenger</span><span class="s1">\</span><span class="s3">Handler</span><span class="s1">\</span><span class="s3">MessageHandlerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Messenger</span><span class="s1">\</span><span class="s3">MessageBus</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Messenger</span><span class="s1">\</span><span class="s3">MessageBusInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Messenger</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">AmqpExt</span><span class="s1">\</span><span class="s3">AmqpTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Messenger</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">RedisExt</span><span class="s1">\</span><span class="s3">RedisTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Messenger</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">TransportFactoryInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Messenger</span><span class="s1">\</span><span class="s3">Transport</span><span class="s1">\</span><span class="s3">TransportInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mime</span><span class="s1">\</span><span class="s3">MimeTypeGuesserInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Mime</span><span class="s1">\</span><span class="s3">MimeTypes</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Notifier</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Nexmo</span><span class="s1">\</span><span class="s3">NexmoTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Notifier</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Slack</span><span class="s1">\</span><span class="s3">SlackTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Notifier</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Telegram</span><span class="s1">\</span><span class="s3">TelegramTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Notifier</span><span class="s1">\</span><span class="s3">Bridge</span><span class="s1">\</span><span class="s3">Twilio</span><span class="s1">\</span><span class="s3">TwilioTransportFactory</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Notifier</span><span class="s1">\</span><span class="s3">Notifier</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Notifier</span><span class="s1">\</span><span class="s3">Recipient</span><span class="s1">\</span><span class="s3">AdminRecipient</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">PropertyAccess</span><span class="s1">\</span><span class="s3">PropertyAccessor</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">PropertyInfo</span><span class="s1">\</span><span class="s3">PropertyAccessExtractorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">PropertyInfo</span><span class="s1">\</span><span class="s3">PropertyDescriptionExtractorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">PropertyInfo</span><span class="s1">\</span><span class="s3">PropertyInfoExtractorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">PropertyInfo</span><span class="s1">\</span><span class="s3">PropertyInitializableExtractorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">PropertyInfo</span><span class="s1">\</span><span class="s3">PropertyListExtractorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">PropertyInfo</span><span class="s1">\</span><span class="s3">PropertyTypeExtractorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Routing</span><span class="s1">\</span><span class="s3">Loader</span><span class="s1">\</span><span class="s3">AnnotationDirectoryLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Routing</span><span class="s1">\</span><span class="s3">Loader</span><span class="s1">\</span><span class="s3">AnnotationFileLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Security</span><span class="s1">\</span><span class="s3">Core</span><span class="s1">\</span><span class="s3">Security</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Security</span><span class="s1">\</span><span class="s3">Csrf</span><span class="s1">\</span><span class="s3">CsrfTokenManagerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Serializer</span><span class="s1">\</span><span class="s3">Encoder</span><span class="s1">\</span><span class="s3">DecoderInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Serializer</span><span class="s1">\</span><span class="s3">Encoder</span><span class="s1">\</span><span class="s3">EncoderInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Serializer</span><span class="s1">\</span><span class="s3">Normalizer</span><span class="s1">\</span><span class="s3">DenormalizerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Serializer</span><span class="s1">\</span><span class="s3">Normalizer</span><span class="s1">\</span><span class="s3">NormalizerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Stopwatch</span><span class="s1">\</span><span class="s3">Stopwatch</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">String</span><span class="s1">\</span><span class="s3">Slugger</span><span class="s1">\</span><span class="s3">SluggerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Translation</span><span class="s1">\</span><span class="s3">Command</span><span class="s1">\</span><span class="s3">XliffLintCommand </span><span class="s0">as </span><span class="s3">BaseXliffLintCommand</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Translation</span><span class="s1">\</span><span class="s3">Translator</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Validator</span><span class="s1">\</span><span class="s3">ConstraintValidatorInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Validator</span><span class="s1">\</span><span class="s3">Mapping</span><span class="s1">\</span><span class="s3">Loader</span><span class="s1">\</span><span class="s3">PropertyInfoLoader</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Validator</span><span class="s1">\</span><span class="s3">ObjectInitializerInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">WebLink</span><span class="s1">\</span><span class="s3">HttpHeaderSerializer</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Workflow</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">WorkflowInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Yaml</span><span class="s1">\</span><span class="s3">Command</span><span class="s1">\</span><span class="s3">LintCommand </span><span class="s0">as </span><span class="s3">BaseYamlLintCommand</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Component</span><span class="s1">\</span><span class="s3">Yaml</span><span class="s1">\</span><span class="s3">Yaml</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Contracts</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">CacheInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Contracts</span><span class="s1">\</span><span class="s3">Cache</span><span class="s1">\</span><span class="s3">TagAwareCacheInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Contracts</span><span class="s1">\</span><span class="s3">HttpClient</span><span class="s1">\</span><span class="s3">HttpClientInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Contracts</span><span class="s1">\</span><span class="s3">Service</span><span class="s1">\</span><span class="s3">ResetInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Contracts</span><span class="s1">\</span><span class="s3">Service</span><span class="s1">\</span><span class="s3">ServiceSubscriberInterface</span><span class="s0">;</span>
<span class="s0">use </span><span class="s3">Symfony</span><span class="s1">\</span><span class="s3">Contracts</span><span class="s1">\</span><span class="s3">Translation</span><span class="s1">\</span><span class="s3">LocaleAwareInterface</span><span class="s0">;</span>
<hr class="ls0"><span class="s4">/**</span>
 <span class="s4">* FrameworkExtension.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Fabien Potencier </span><span class="s6">&lt;fabien</span><span class="s4">@symfony.com&gt;</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Jeremy Mikola </span><span class="s6">&lt;jmikola</span><span class="s4">@gmail.com&gt;</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Kévin Dunglas </span><span class="s6">&lt;dunglas</span><span class="s4">@gmail.com&gt;</span>
 <span class="s4">* </span><span class="s5">@author </span><span class="s4">Grégoire Pineau </span><span class="s6">&lt;lyrixx</span><span class="s4">@lyrixx.info&gt;</span>
 <span class="s4">*/</span>
<span class="s0">class </span><span class="s3">FrameworkExtension </span><span class="s0">extends </span><span class="s3">Extension</span>
<span class="s1">{</span>
    <span class="s0">private </span><span class="s7">$formConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s7">$translationConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s7">$sessionConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s7">$annotationsConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s7">$validatorConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s7">$messengerConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s7">$mailerConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>
    <span class="s0">private </span><span class="s7">$httpClientConfigEnabled </span><span class="s1">= </span><span class="s3">false</span><span class="s0">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Responds to the app.config configuration parameter.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">LogicException</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">load</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$configs</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader </span><span class="s1">= </span><span class="s0">new </span><span class="s3">XmlFileLoader</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, new </span><span class="s3">FileLocator</span><span class="s1">(\</span><span class="s3">dirname</span><span class="s1">(</span><span class="s3">__DIR__</span><span class="s1">).</span><span class="s8">'/Resources/config'</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'web.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'services.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'fragment_renderer.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'error_renderer.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">PsrEventDispatcherInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s3">PsrEventDispatcherInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">'event_dispatcher'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s8">'parameter_bag'</span><span class="s0">, </span><span class="s3">PsrContainerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Application</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'console.xml'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">BaseXliffLintCommand</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.xliff_lint'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">BaseYamlLintCommand</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.yaml_lint'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">// Load Cache configuration first as it is used by other components</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'cache.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$configuration </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">getConfiguration</span><span class="s1">(</span><span class="s7">$configs</span><span class="s0">, </span><span class="s7">$container</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$config </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">processConfiguration</span><span class="s1">(</span><span class="s7">$configuration</span><span class="s0">, </span><span class="s7">$configs</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">annotationsConfigEnabled </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'annotations'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">translationConfigEnabled </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'translator'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s2">// A translator must always be registered (as support is included by</span>
        <span class="s2">// default in the Form and Validator component). If disabled, an identity</span>
        <span class="s2">// translator will be used and everything will still work as expected.</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'translator'</span><span class="s1">]) || </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'form'</span><span class="s1">]) || </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'validation'</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Translation\Translator'</span><span class="s1">) &amp;&amp; </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'translator'</span><span class="s1">])) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Translation support cannot be enabled as the Translation component is not installed. Try running &quot;composer require symfony/translation&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Translator</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'identity_translator.xml'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">// If the slugger is used but the String component is not available, we should throw an error</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">SluggerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'slugger'</span><span class="s0">, </span><span class="s8">'stdClass'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">addError</span><span class="s1">(</span><span class="s8">'You cannot use the &quot;slugger&quot; service since the String component is not installed. Try running &quot;composer require symfony/string&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">LocaleAwareInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'slugger'</span><span class="s0">, </span><span class="s8">'stdClass'</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">addError</span><span class="s1">(</span><span class="s8">'You cannot use the &quot;slugger&quot; service since the Translation contracts are not installed. Try running &quot;composer require symfony/translation&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(!\</span><span class="s3">extension_loaded</span><span class="s1">(</span><span class="s8">'intl'</span><span class="s1">) &amp;&amp; !\</span><span class="s3">defined</span><span class="s1">(</span><span class="s8">'PHPUNIT_COMPOSER_INSTALL'</span><span class="s1">)) {</span>
                <span class="s1">@</span><span class="s3">trigger_error</span><span class="s1">(</span><span class="s8">'Please install the &quot;intl&quot; PHP extension for best performance.'</span><span class="s0">, </span><span class="s3">E_USER_DEPRECATED</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'secret'</span><span class="s1">])) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'kernel.secret'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'secret'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'kernel.http_method_override'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'http_method_override'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'kernel.trusted_hosts'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'trusted_hosts'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'kernel.default_locale'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_locale'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'kernel.error_controller'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'error_controller'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasParameter</span><span class="s1">(</span><span class="s8">'debug.file_link_format'</span><span class="s1">)) {</span>
            <span class="s7">$links </span><span class="s1">= [</span>
                <span class="s8">'textmate' </span><span class="s1">=&gt; </span><span class="s8">'txmt://open?url=file://%%f&amp;line=%%l'</span><span class="s0">,</span>
                <span class="s8">'macvim' </span><span class="s1">=&gt; </span><span class="s8">'mvim://open?url=file://%%f&amp;line=%%l'</span><span class="s0">,</span>
                <span class="s8">'emacs' </span><span class="s1">=&gt; </span><span class="s8">'emacs://open?url=file://%%f&amp;line=%%l'</span><span class="s0">,</span>
                <span class="s8">'sublime' </span><span class="s1">=&gt; </span><span class="s8">'subl://open?url=file://%%f&amp;line=%%l'</span><span class="s0">,</span>
                <span class="s8">'phpstorm' </span><span class="s1">=&gt; </span><span class="s8">'phpstorm://open?file=%%f&amp;line=%%l'</span><span class="s0">,</span>
                <span class="s8">'atom' </span><span class="s1">=&gt; </span><span class="s8">'atom://core/open/file?filename=%%f&amp;line=%%l'</span><span class="s0">,</span>
                <span class="s8">'vscode' </span><span class="s1">=&gt; </span><span class="s8">'vscode://file/%%f:%%l'</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">;</span>
            <span class="s7">$ide </span><span class="s1">= </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'ide'</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s2">// mark any env vars found in the ide setting as used</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s7">$ide</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'debug.file_link_format'</span><span class="s0">, </span><span class="s3">str_replace</span><span class="s1">(</span><span class="s8">'%'</span><span class="s0">, </span><span class="s8">'%%'</span><span class="s0">, </span><span class="s3">ini_get</span><span class="s1">(</span><span class="s8">'xdebug.file_link_format'</span><span class="s1">) ?: </span><span class="s3">get_cfg_var</span><span class="s1">(</span><span class="s8">'xdebug.file_link_format'</span><span class="s1">)) ?: (</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$links</span><span class="s1">[</span><span class="s7">$ide</span><span class="s1">]) ? </span><span class="s7">$links</span><span class="s1">[</span><span class="s7">$ide</span><span class="s1">] : </span><span class="s7">$ide</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s0">empty</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'test'</span><span class="s1">])) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'test.xml'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">AbstractBrowser</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'test.client'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">// register cache before session so both can share the connection services</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerCacheConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'cache'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'session'</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(!\</span><span class="s3">extension_loaded</span><span class="s1">(</span><span class="s8">'session'</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Session support cannot be enabled as the session extension is not installed. See https://php.net/session.installation for instructions.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">sessionConfigEnabled </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerSessionConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'session'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s0">empty</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'test'</span><span class="s1">])) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'test.session.listener'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s8">'%session.storage.options%'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'request'</span><span class="s1">])) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerRequestConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'request'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'csrf_protection'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">]) {</span>
            <span class="s7">$config</span><span class="s1">[</span><span class="s8">'csrf_protection'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">] = </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">sessionConfigEnabled </span><span class="s1">&amp;&amp; !</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">FullStack</span><span class="s1">::</span><span class="s0">class</span><span class="s1">) &amp;&amp; </span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">CsrfTokenManagerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerSecurityCsrfConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'csrf_protection'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'form'</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Form\Form'</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Form support cannot be enabled as the Form component is not installed. Try running &quot;composer require symfony/form&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">formConfigEnabled </span><span class="s1">= </span><span class="s3">true</span><span class="s0">;</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerFormConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Validator\Validation'</span><span class="s1">)) {</span>
                <span class="s7">$config</span><span class="s1">[</span><span class="s8">'validation'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">] = </span><span class="s3">true</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'validator.translation_domain'</span><span class="s0">, </span><span class="s8">'validators'</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'form.type_extension.form.validator'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'form.type_guesser.validator'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.form_debug'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'assets'</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Asset\Package'</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Asset support cannot be enabled as the Asset component is not installed. Try running &quot;composer require symfony/asset&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerAssetsConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'assets'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">messengerConfigEnabled </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'messenger'</span><span class="s1">])) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMessengerConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'messenger'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'validation'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_consume_messages'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_debug'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_stop_workers'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_setup_transports'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_retry'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_show'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_remove'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'cache.messenger.restart_workers_signal'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.amqp.factory'</span><span class="s1">) &amp;&amp; </span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">AmqpTransportFactory</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.amqp.factory'</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.transport_factory'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.redis.factory'</span><span class="s1">) &amp;&amp; </span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">RedisTransportFactory</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.redis.factory'</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.transport_factory'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">httpClientConfigEnabled </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'http_client'</span><span class="s1">])) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerHttpClientConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'http_client'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'profiler'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">mailerConfigEnabled </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'mailer'</span><span class="s1">])) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMailerConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'mailer'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'notifier'</span><span class="s1">])) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerNotifierConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'notifier'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$propertyInfoEnabled </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'property_info'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerValidationConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'validation'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s0">, </span><span class="s7">$propertyInfoEnabled</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerEsiConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'esi'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerSsiConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'ssi'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerFragmentsConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'fragments'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerTranslatorConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'translator'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_locale'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerProfilerConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'profiler'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerWorkflowConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'workflows'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerDebugConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'php_errors'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerRouterConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'router'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerAnnotationsConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'annotations'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerPropertyAccessConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'property_access'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerSecretsConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'secrets'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'serializer'</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Serializer\Serializer'</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Serializer support cannot be enabled as the Serializer component is not installed. Try running &quot;composer require symfony/serializer-pack&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerSerializerConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'serializer'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$propertyInfoEnabled</span><span class="s1">) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerPropertyInfoConfiguration</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'lock'</span><span class="s1">])) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerLockConfiguration</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'lock'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$loader</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'web_link'</span><span class="s1">])) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">HttpHeaderSerializer</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'WebLink support cannot be enabled as the WebLink component is not installed. Try running &quot;composer require symfony/weblink&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'web_link.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">addAnnotatedClassesToCompile</span><span class="s1">([</span>
            <span class="s8">'**</span><span class="s0">\\</span><span class="s8">Controller</span><span class="s0">\\</span><span class="s8">'</span><span class="s0">,</span>
            <span class="s8">'**</span><span class="s0">\\</span><span class="s8">Entity</span><span class="s0">\\</span><span class="s8">'</span><span class="s0">,</span>

            <span class="s2">// Added explicitly so that we don't rely on the class map being dumped to make it work</span>
            <span class="s8">'Symfony</span><span class="s0">\\</span><span class="s8">Bundle</span><span class="s0">\\</span><span class="s8">FrameworkBundle</span><span class="s0">\\</span><span class="s8">Controller</span><span class="s0">\\</span><span class="s8">AbstractController'</span><span class="s0">,</span>
        <span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">MimeTypes</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'mime_type.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">Command</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'console.command'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ResourceCheckerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'config_cache.resource_checker'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">EnvVarLoaderInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'container.env_var_loader'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">EnvVarProcessorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'container.env_var_processor'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ServiceLocator</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'container.service_locator'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ServiceSubscriberInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'container.service_subscriber'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ArgumentValueResolverInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'controller.argument_value_resolver'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">AbstractController</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'controller.service_arguments'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">DataCollectorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'data_collector'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">FormTypeInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'form.type'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">FormTypeGuesserInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'form.type_guesser'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">FormTypeExtensionInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'form.type_extension'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">CacheClearerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.cache_clearer'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">CacheWarmerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.cache_warmer'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">EventSubscriberInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.event_subscriber'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">LocaleAwareInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.locale_aware'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ResetInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.reset'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'reset'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">MarshallerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ResettableInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.reset'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'reset'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">PropertyListExtractorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'property_info.list_extractor'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">PropertyTypeExtractorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'property_info.type_extractor'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">PropertyDescriptionExtractorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'property_info.description_extractor'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">PropertyAccessExtractorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'property_info.access_extractor'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">PropertyInitializableExtractorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'property_info.initializable_extractor'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">EncoderInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'serializer.encoder'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">DecoderInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'serializer.encoder'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">NormalizerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'serializer.normalizer'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">DenormalizerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'serializer.normalizer'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ConstraintValidatorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'validator.constraint_validator'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">ObjectInitializerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'validator.initializer'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">MessageHandlerInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.message_handler'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">TransportFactoryInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.transport_factory'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">MimeTypeGuesserInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'mime.mime_type_guesser'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">LoggerAwareInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'setLogger'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'logger'</span><span class="s1">)])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">)) {</span>
            <span class="s2">// remove tagged iterator argument for resource checkers</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'config_cache_factory'</span><span class="s1">)-&gt;</span><span class="s3">setArguments</span><span class="s1">([])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'disallow_search_engine_index'</span><span class="s1">] ?? </span><span class="s3">false</span><span class="s1">) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'disallow_search_engine_index_response_listener'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerForAutoconfiguration</span><span class="s1">(</span><span class="s3">RouteLoaderInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'routing.route_loader'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* {</span><span class="s5">@inheritdoc</span><span class="s4">}</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">return new </span><span class="s3">Configuration</span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">))</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerFormConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'form.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'form'</span><span class="s1">][</span><span class="s8">'csrf_protection'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">]) {</span>
            <span class="s7">$config</span><span class="s1">[</span><span class="s8">'form'</span><span class="s1">][</span><span class="s8">'csrf_protection'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">] = </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'csrf_protection'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'form'</span><span class="s1">][</span><span class="s8">'csrf_protection'</span><span class="s1">])) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'form_csrf.xml'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'form.type_extension.csrf.enabled'</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'form.type_extension.csrf.field_name'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'form'</span><span class="s1">][</span><span class="s8">'csrf_protection'</span><span class="s1">][</span><span class="s8">'field_name'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'form.type_extension.csrf.enabled'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Translator</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'form.type_extension.upload.validator'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">method_exists</span><span class="s1">(</span><span class="s3">CachingFactoryDecorator</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">'reset'</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'form.choice_list_factory.cached'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">clearTag</span><span class="s1">(</span><span class="s8">'kernel.reset'</span><span class="s1">)</span>
            <span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerEsiConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'fragment.renderer.esi'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'esi.xml'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerSsiConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'fragment.renderer.ssi'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'ssi.xml'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerFragmentsConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'fragment.renderer.hinclude'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'fragment.renderer.hinclude.global_template'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'hinclude_default_template'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'fragment_listener.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'fragment.path'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerProfilerConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s2">// this is needed for the WebProfiler to work even if the profiler is disabled</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'data_collector.templates'</span><span class="s0">, </span><span class="s1">[])</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'profiling.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'collectors.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'cache_debug.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">formConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'form_debug.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">validatorConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'validator_debug.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">translationConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'translation_debug.xml'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'translator.data_collector'</span><span class="s1">)-&gt;</span><span class="s3">setDecoratedService</span><span class="s1">(</span><span class="s8">'translator'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">messengerConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'messenger_debug.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">mailerConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'mailer_debug.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">httpClientConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'http_client_debug.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'profiler_listener.only_exceptions'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'only_exceptions'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'profiler_listener.only_master_requests'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'only_master_requests'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s2">// Choose storage class based on the DSN</span>
        <span class="s0">list</span><span class="s1">(</span><span class="s7">$class</span><span class="s1">) = </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">':'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'dsn'</span><span class="s1">]</span><span class="s0">, </span><span class="s9">2</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s8">'file' </span><span class="s1">!== </span><span class="s7">$class</span><span class="s1">) {</span>
            <span class="s0">throw new </span><span class="s1">\</span><span class="s3">LogicException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Driver &quot;%s&quot; is not supported for the profiler.'</span><span class="s0">, </span><span class="s7">$class</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'profiler.storage.dsn'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'dsn'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'profiler'</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'collect'</span><span class="s1">])</span>
            <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.reset'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'reset'</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerWorkflowConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'enabled'</span><span class="s1">]) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.workflow_dump'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Workflow</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Workflow support cannot be enabled as the Workflow component is not installed. Try running &quot;composer require symfony/workflow&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'workflow.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$registryDefinition </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'workflow.registry'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'workflows'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$name </span><span class="s1">=&gt; </span><span class="s7">$workflow</span><span class="s1">) {</span>
            <span class="s7">$type </span><span class="s1">= </span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'type'</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s7">$workflowId </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.%s'</span><span class="s0">, </span><span class="s7">$type</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s2">// Process Metadata (workflow + places (transition is done in the &quot;create transition&quot; block))</span>
            <span class="s7">$metadataStoreDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Metadata</span><span class="s1">\</span><span class="s3">InMemoryMetadataStore</span><span class="s1">::</span><span class="s0">class, </span><span class="s1">[[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s3">null</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">]) {</span>
                <span class="s7">$metadataStoreDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s7">$placesMetadata </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'places'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$place</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s7">$place</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">]) {</span>
                    <span class="s7">$placesMetadata</span><span class="s1">[</span><span class="s7">$place</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">]] = </span><span class="s7">$place</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$placesMetadata</span><span class="s1">) {</span>
                <span class="s7">$metadataStoreDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$placesMetadata</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// Create transitions</span>
            <span class="s7">$transitions </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s7">$guardsConfiguration </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s7">$transitionsMetadataDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(\</span><span class="s3">SplObjectStorage</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s2">// Global transition counter per workflow</span>
            <span class="s7">$transitionCounter </span><span class="s1">= </span><span class="s9">0</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'transitions'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$transition</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s8">'workflow' </span><span class="s1">=== </span><span class="s7">$type</span><span class="s1">) {</span>
                    <span class="s7">$transitionDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Transition</span><span class="s1">::</span><span class="s0">class, </span><span class="s1">[</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'from'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'to'</span><span class="s1">]])</span><span class="s0">;</span>
                    <span class="s7">$transitionDefinition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s7">$transitionId </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.transition.%s'</span><span class="s0">, </span><span class="s7">$workflowId</span><span class="s0">, </span><span class="s7">$transitionCounter</span><span class="s1">++)</span><span class="s0">;</span>
                    <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s0">, </span><span class="s7">$transitionDefinition</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s7">$transitions</span><span class="s1">[] = </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'guard'</span><span class="s1">])) {</span>
                        <span class="s7">$configuration </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">EventListener</span><span class="s1">\</span><span class="s3">GuardExpression</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                        <span class="s7">$configuration</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s1">))</span><span class="s0">;</span>
                        <span class="s7">$configuration</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'guard'</span><span class="s1">])</span><span class="s0">;</span>
                        <span class="s7">$configuration</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
                        <span class="s7">$eventName </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'workflow.%s.guard.%s'</span><span class="s0">, </span><span class="s7">$name</span><span class="s0">, </span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">])</span><span class="s0">;</span>
                        <span class="s7">$guardsConfiguration</span><span class="s1">[</span><span class="s7">$eventName</span><span class="s1">][] = </span><span class="s7">$configuration</span><span class="s0">;</span>
                    <span class="s1">}</span>
                    <span class="s0">if </span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">]) {</span>
                        <span class="s7">$transitionsMetadataDefinition</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'attach'</span><span class="s0">, </span><span class="s1">[</span>
                            <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s1">)</span><span class="s0">,</span>
                            <span class="s7">$transition</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">])</span><span class="s0">;</span>
                    <span class="s1">}</span>
                <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">'state_machine' </span><span class="s1">=== </span><span class="s7">$type</span><span class="s1">) {</span>
                    <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'from'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$from</span><span class="s1">) {</span>
                        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'to'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$to</span><span class="s1">) {</span>
                            <span class="s7">$transitionDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Transition</span><span class="s1">::</span><span class="s0">class, </span><span class="s1">[</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$from</span><span class="s0">, </span><span class="s7">$to</span><span class="s1">])</span><span class="s0">;</span>
                            <span class="s7">$transitionDefinition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
                            <span class="s7">$transitionId </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.transition.%s'</span><span class="s0">, </span><span class="s7">$workflowId</span><span class="s0">, </span><span class="s7">$transitionCounter</span><span class="s1">++)</span><span class="s0">;</span>
                            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s0">, </span><span class="s7">$transitionDefinition</span><span class="s1">)</span><span class="s0">;</span>
                            <span class="s7">$transitions</span><span class="s1">[] = </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s1">)</span><span class="s0">;</span>
                            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'guard'</span><span class="s1">])) {</span>
                                <span class="s7">$configuration </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">EventListener</span><span class="s1">\</span><span class="s3">GuardExpression</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                                <span class="s7">$configuration</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s1">))</span><span class="s0">;</span>
                                <span class="s7">$configuration</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'guard'</span><span class="s1">])</span><span class="s0">;</span>
                                <span class="s7">$configuration</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
                                <span class="s7">$eventName </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'workflow.%s.guard.%s'</span><span class="s0">, </span><span class="s7">$name</span><span class="s0">, </span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">])</span><span class="s0">;</span>
                                <span class="s7">$guardsConfiguration</span><span class="s1">[</span><span class="s7">$eventName</span><span class="s1">][] = </span><span class="s7">$configuration</span><span class="s0">;</span>
                            <span class="s1">}</span>
                            <span class="s0">if </span><span class="s1">(</span><span class="s7">$transition</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">]) {</span>
                                <span class="s7">$transitionsMetadataDefinition</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'attach'</span><span class="s0">, </span><span class="s1">[</span>
                                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$transitionId</span><span class="s1">)</span><span class="s0">,</span>
                                    <span class="s7">$transition</span><span class="s1">[</span><span class="s8">'metadata'</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">])</span><span class="s0">;</span>
                            <span class="s1">}</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s7">$metadataStoreDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$transitionsMetadataDefinition</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s2">// Create places</span>
            <span class="s7">$places </span><span class="s1">= </span><span class="s3">array_column</span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'places'</span><span class="s1">]</span><span class="s0">, </span><span class="s8">'name'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$initialMarking </span><span class="s1">= </span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'initial_marking'</span><span class="s1">] ?? []</span><span class="s0">;</span>

            <span class="s2">// Create a Definition</span>
            <span class="s7">$definitionDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Definition</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definitionDefinition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definitionDefinition</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s7">$places</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definitionDefinition</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s7">$transitions</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definitionDefinition</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s7">$initialMarking</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definitionDefinition</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s7">$metadataStoreDefinition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definitionDefinition</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'workflow.definition'</span><span class="s0">, </span><span class="s1">[</span>
                <span class="s8">'name' </span><span class="s1">=&gt; </span><span class="s7">$name</span><span class="s0">,</span>
                <span class="s8">'type' </span><span class="s1">=&gt; </span><span class="s7">$type</span><span class="s0">,</span>
            <span class="s1">])</span><span class="s0">;</span>

            <span class="s2">// Create MarkingStore</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'marking_store'</span><span class="s1">][</span><span class="s8">'type'</span><span class="s1">])) {</span>
                <span class="s7">$markingStoreDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s8">'workflow.marking_store.method'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$markingStoreDefinition</span><span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span>
                    <span class="s8">'state_machine' </span><span class="s1">=== </span><span class="s7">$type</span><span class="s0">, </span><span class="s2">//single state</span>
                    <span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'marking_store'</span><span class="s1">][</span><span class="s8">'property'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">])</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'marking_store'</span><span class="s1">][</span><span class="s8">'service'</span><span class="s1">])) {</span>
                <span class="s7">$markingStoreDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'marking_store'</span><span class="s1">][</span><span class="s8">'service'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// Create Workflow</span>
            <span class="s7">$workflowDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.abstract'</span><span class="s0">, </span><span class="s7">$type</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s7">$workflowDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.definition'</span><span class="s0">, </span><span class="s7">$workflowId</span><span class="s1">)))</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$markingStoreDefinition</span><span class="s1">)) {</span>
                <span class="s7">$workflowDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$markingStoreDefinition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s7">$workflowDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">3</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s2">// Store to container</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$workflowId</span><span class="s0">, </span><span class="s7">$workflowDefinition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.definition'</span><span class="s0">, </span><span class="s7">$workflowId</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$definitionDefinition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$workflowId</span><span class="s0">, </span><span class="s3">WorkflowInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$name</span><span class="s1">.</span><span class="s8">'.'</span><span class="s1">.</span><span class="s7">$type</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s2">// Validate Workflow</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'state_machine' </span><span class="s1">=== </span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'type'</span><span class="s1">]) {</span>
                <span class="s7">$validator </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Validator</span><span class="s1">\</span><span class="s3">StateMachineValidator</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$validator </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Validator</span><span class="s1">\</span><span class="s3">WorkflowValidator</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$trs </span><span class="s1">= </span><span class="s3">array_map</span><span class="s1">(</span><span class="s0">function </span><span class="s1">(</span><span class="s3">Reference </span><span class="s7">$ref</span><span class="s1">) </span><span class="s0">use </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">): </span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Transition </span><span class="s1">{</span>
                <span class="s0">return </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">get</span><span class="s1">((string) </span><span class="s7">$ref</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span><span class="s0">, </span><span class="s7">$transitions</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$realDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">Definition</span><span class="s1">(</span><span class="s7">$places</span><span class="s0">, </span><span class="s7">$trs</span><span class="s0">, </span><span class="s7">$initialMarking</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$validator</span><span class="s1">-&gt;</span><span class="s3">validate</span><span class="s1">(</span><span class="s7">$realDefinition</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s2">// Add workflow to Registry</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'supports'</span><span class="s1">]) {</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'supports'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$supportedClassName</span><span class="s1">) {</span>
                    <span class="s7">$strategyDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">SupportStrategy</span><span class="s1">\</span><span class="s3">InstanceOfSupportStrategy</span><span class="s1">::</span><span class="s0">class, </span><span class="s1">[</span><span class="s7">$supportedClassName</span><span class="s1">])</span><span class="s0">;</span>
                    <span class="s7">$strategyDefinition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s7">$registryDefinition</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'addWorkflow'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$workflowId</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$strategyDefinition</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'support_strategy'</span><span class="s1">])) {</span>
                <span class="s7">$registryDefinition</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'addWorkflow'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$workflowId</span><span class="s1">)</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'support_strategy'</span><span class="s1">])])</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// Enable the AuditTrail</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$workflow</span><span class="s1">[</span><span class="s8">'audit_trail'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">]) {</span>
                <span class="s7">$listener </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">EventListener</span><span class="s1">\</span><span class="s3">AuditTrailListener</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$listener</span><span class="s1">-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$listener</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'monolog.logger'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'channel' </span><span class="s1">=&gt; </span><span class="s8">'workflow'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$listener</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.event_listener'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'event' </span><span class="s1">=&gt; </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'workflow.%s.leave'</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">, </span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'onLeave'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$listener</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.event_listener'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'event' </span><span class="s1">=&gt; </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'workflow.%s.transition'</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">, </span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'onTransition'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$listener</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.event_listener'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'event' </span><span class="s1">=&gt; </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'workflow.%s.enter'</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">, </span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'onEnter'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$listener</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'logger'</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.listener.audit_trail'</span><span class="s0">, </span><span class="s7">$workflowId</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$listener</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// Add Guard Listener</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$guardsConfiguration</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">ExpressionLanguage</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                    <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Cannot guard workflows as the ExpressionLanguage component is not installed. Try running &quot;composer require symfony/expression-language&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Security</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                    <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Cannot guard workflows as the Security component is not installed. Try running &quot;composer require symfony/security-core&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s7">$guard </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Workflow</span><span class="s1">\</span><span class="s3">EventListener</span><span class="s1">\</span><span class="s3">GuardListener</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$guard</span><span class="s1">-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s7">$guard</span><span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span>
                    <span class="s7">$guardsConfiguration</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'workflow.security.expression_language'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'security.token_storage'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'security.authorization_checker'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'security.authentication.trust_resolver'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'security.role_hierarchy'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'validator'</span><span class="s0">, </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">NULL_ON_INVALID_REFERENCE</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">])</span><span class="s0">;</span>
                <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$guardsConfiguration </span><span class="s0">as </span><span class="s7">$eventName </span><span class="s1">=&gt; </span><span class="s7">$config</span><span class="s1">) {</span>
                    <span class="s7">$guard</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.event_listener'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'event' </span><span class="s1">=&gt; </span><span class="s7">$eventName</span><span class="s0">, </span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'onTransition'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'%s.listener.guard'</span><span class="s0">, </span><span class="s7">$workflowId</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$guard</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'workflow.has_guard_listeners'</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerDebugConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'debug_prod.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Stopwatch</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'debug.stopwatch'</span><span class="s0">, </span><span class="s3">Stopwatch</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.reset'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'method' </span><span class="s1">=&gt; </span><span class="s8">'reset'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s3">Stopwatch</span><span class="s1">::</span><span class="s0">class, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'debug.stopwatch'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$debug </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$debug</span><span class="s1">) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'debug.container.dump'</span><span class="s0">, </span><span class="s8">'%kernel.cache_dir%/%kernel.container_class%.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$debug </span><span class="s1">&amp;&amp; </span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Stopwatch</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'debug.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$definition </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">'debug.debug_handlers_listener'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">false </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'log'</span><span class="s1">]) {</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s3">true </span><span class="s1">!== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'log'</span><span class="s1">]) {</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'log'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'throw'</span><span class="s1">]) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'debug.error_handler.throw_at'</span><span class="s0">, </span><span class="s9">0</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$debug </span><span class="s1">&amp;&amp; </span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">DebugProcessor</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$definition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">DebugProcessor</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'request_stack'</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'debug.log_processor'</span><span class="s0">, </span><span class="s7">$definition</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerRouterConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.router_debug'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.router_match'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'routing.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'utf8'</span><span class="s1">]) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'routing.loader'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'utf8' </span><span class="s1">=&gt; </span><span class="s3">true</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'router.resource'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'resource'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$router </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">'router.default'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$argument </span><span class="s1">= </span><span class="s7">$router</span><span class="s1">-&gt;</span><span class="s3">getArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$argument</span><span class="s1">[</span><span class="s8">'strict_requirements'</span><span class="s1">] = </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'strict_requirements'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'type'</span><span class="s1">])) {</span>
            <span class="s7">$argument</span><span class="s1">[</span><span class="s8">'resource_type'</span><span class="s1">] = </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'type'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s7">$router</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$argument</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'request_listener.http_port'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'http_port'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'request_listener.https_port'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'https_port'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">annotationsConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'routing.loader.annotation'</span><span class="s0">, </span><span class="s3">AnnotatedRouteControllerLoader</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'routing.loader'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'priority' </span><span class="s1">=&gt; -</span><span class="s9">10</span><span class="s1">])</span>
                <span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'annotation_reader'</span><span class="s1">))</span><span class="s0">;</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'routing.loader.annotation.directory'</span><span class="s0">, </span><span class="s3">AnnotationDirectoryLoader</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'routing.loader'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'priority' </span><span class="s1">=&gt; -</span><span class="s9">10</span><span class="s1">])</span>
                <span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'file_locator'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'routing.loader.annotation'</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">])</span><span class="s0">;</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'routing.loader.annotation.file'</span><span class="s0">, </span><span class="s3">AnnotationFileLoader</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'routing.loader'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'priority' </span><span class="s1">=&gt; -</span><span class="s9">10</span><span class="s1">])</span>
                <span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'file_locator'</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'routing.loader.annotation'</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerSessionConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'session.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s2">// session storage</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'session.storage'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'storage_id'</span><span class="s1">])-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$options </span><span class="s1">= [</span><span class="s8">'cache_limiter' </span><span class="s1">=&gt; </span><span class="s8">'0'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">([</span><span class="s8">'name'</span><span class="s0">, </span><span class="s8">'cookie_lifetime'</span><span class="s0">, </span><span class="s8">'cookie_path'</span><span class="s0">, </span><span class="s8">'cookie_domain'</span><span class="s0">, </span><span class="s8">'cookie_secure'</span><span class="s0">, </span><span class="s8">'cookie_httponly'</span><span class="s0">, </span><span class="s8">'cookie_samesite'</span><span class="s0">, </span><span class="s8">'use_cookies'</span><span class="s0">, </span><span class="s8">'gc_maxlifetime'</span><span class="s0">, </span><span class="s8">'gc_probability'</span><span class="s0">, </span><span class="s8">'gc_divisor'</span><span class="s0">, </span><span class="s8">'sid_length'</span><span class="s0">, </span><span class="s8">'sid_bits_per_character'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$key</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s7">$key</span><span class="s1">])) {</span>
                <span class="s7">$options</span><span class="s1">[</span><span class="s7">$key</span><span class="s1">] = </span><span class="s7">$config</span><span class="s1">[</span><span class="s7">$key</span><span class="s1">]</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'auto' </span><span class="s1">=== (</span><span class="s7">$options</span><span class="s1">[</span><span class="s8">'cookie_secure'</span><span class="s1">] ?? </span><span class="s3">null</span><span class="s1">)) {</span>
            <span class="s7">$locator </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'session_listener'</span><span class="s1">)-&gt;</span><span class="s3">getArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$locator</span><span class="s1">-&gt;</span><span class="s3">setValues</span><span class="s1">(</span><span class="s7">$locator</span><span class="s1">-&gt;</span><span class="s3">getValues</span><span class="s1">() + [</span>
                <span class="s8">'session_storage' </span><span class="s1">=&gt; </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'session.storage'</span><span class="s0">, </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">IGNORE_ON_INVALID_REFERENCE</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s8">'request_stack' </span><span class="s1">=&gt; </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'request_stack'</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'session.storage.options'</span><span class="s0">, </span><span class="s7">$options</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s2">// session handler (the internal callback registered with PHP session management)</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'handler_id'</span><span class="s1">]) {</span>
            <span class="s2">// Set the handler class to be null</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'session.storage.native'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'session.storage.php_bridge'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'handler_id'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$usedEnvs</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$usedEnvs </span><span class="s1">|| </span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'#^[a-z]++://#'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'handler_id'</span><span class="s1">])) {</span>
                <span class="s7">$id </span><span class="s1">= </span><span class="s8">'.cache_connection.'</span><span class="s1">.</span><span class="s3">ContainerBuilder</span><span class="s1">::</span><span class="s3">hash</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'handler_id'</span><span class="s1">])</span><span class="s0">;</span>

                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'session.abstract_handler'</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s7">$id</span><span class="s1">) ? </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$id</span><span class="s1">) : </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'handler_id'</span><span class="s1">])</span><span class="s0">;</span>

                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'session.handler'</span><span class="s0">, </span><span class="s8">'session.abstract_handler'</span><span class="s1">)-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'session.handler'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'handler_id'</span><span class="s1">])-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'session.save_path'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'save_path'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'session.metadata.update_threshold'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'metadata_update_threshold'</span><span class="s1">])</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerRequestConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'formats'</span><span class="s1">]) {</span>
            <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'request.xml'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$listener </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'request.add_request_formats_listener'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$listener</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'formats'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerAssetsConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'assets.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'version_strategy'</span><span class="s1">]) {</span>
            <span class="s7">$defaultVersion </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'version_strategy'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$defaultVersion </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">createVersion</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'version'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'version_format'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'json_manifest_path'</span><span class="s1">]</span><span class="s0">, </span><span class="s8">'_default'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$defaultPackage </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">createPackageDefinition</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'base_path'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'base_urls'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$defaultVersion</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'assets._default_package'</span><span class="s0">, </span><span class="s7">$defaultPackage</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$namedPackages </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'packages'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$name </span><span class="s1">=&gt; </span><span class="s7">$package</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'version_strategy'</span><span class="s1">]) {</span>
                <span class="s7">$version </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'version_strategy'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!\</span><span class="s3">array_key_exists</span><span class="s1">(</span><span class="s8">'version'</span><span class="s0">, </span><span class="s7">$package</span><span class="s1">) &amp;&amp; </span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'json_manifest_path'</span><span class="s1">]) {</span>
                <span class="s2">// if neither version nor json_manifest_path are specified, use the default</span>
                <span class="s7">$version </span><span class="s1">= </span><span class="s7">$defaultVersion</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s2">// let format fallback to main version_format</span>
                <span class="s7">$format </span><span class="s1">= </span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'version_format'</span><span class="s1">] ?: </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'version_format'</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s7">$version </span><span class="s1">= </span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'version'</span><span class="s1">]) ? </span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'version'</span><span class="s1">] : </span><span class="s3">null</span><span class="s0">;</span>
                <span class="s7">$version </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">createVersion</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$version</span><span class="s0">, </span><span class="s7">$format</span><span class="s0">, </span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'json_manifest_path'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'assets._package_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">createPackageDefinition</span><span class="s1">(</span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'base_path'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$package</span><span class="s1">[</span><span class="s8">'base_urls'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$version</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s8">'assets._package_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">PackageInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$name</span><span class="s1">.</span><span class="s8">'.package'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$namedPackages</span><span class="s1">[</span><span class="s7">$name</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'assets._package_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'assets.packages'</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'assets._default_package'</span><span class="s1">))</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$namedPackages</span><span class="s1">)</span>
        <span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns a definition for an asset package.</span>
     <span class="s4">*/</span>
    <span class="s0">private function </span><span class="s3">createPackageDefinition</span><span class="s1">(?</span><span class="s3">string </span><span class="s7">$basePath</span><span class="s0">, array </span><span class="s7">$baseUrls</span><span class="s0">, </span><span class="s3">Reference </span><span class="s7">$version</span><span class="s1">): </span><span class="s3">Definition</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$basePath </span><span class="s1">&amp;&amp; </span><span class="s7">$baseUrls</span><span class="s1">) {</span>
            <span class="s0">throw new </span><span class="s1">\</span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'An asset package cannot have base URLs and base paths.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$package </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s7">$baseUrls </span><span class="s1">? </span><span class="s8">'assets.url_package' </span><span class="s1">: </span><span class="s8">'assets.path_package'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$package</span>
            <span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$baseUrls </span><span class="s1">?: </span><span class="s7">$basePath</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$version</span><span class="s1">)</span>
        <span class="s0">;</span>

        <span class="s0">return </span><span class="s7">$package</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">createVersion</span><span class="s1">(</span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s1">?</span><span class="s3">string </span><span class="s7">$version</span><span class="s0">, </span><span class="s1">?</span><span class="s3">string </span><span class="s7">$format</span><span class="s0">, </span><span class="s1">?</span><span class="s3">string </span><span class="s7">$jsonManifestPath</span><span class="s0">, </span><span class="s3">string </span><span class="s7">$name</span><span class="s1">): </span><span class="s3">Reference</span>
    <span class="s1">{</span>
        <span class="s2">// Configuration prevents $version and $jsonManifestPath from being set</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$version</span><span class="s1">) {</span>
            <span class="s7">$def </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s8">'assets.static_version_strategy'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$def</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$version</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$format</span><span class="s1">)</span>
            <span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'assets._version_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, </span><span class="s7">$def</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'assets._version_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$jsonManifestPath</span><span class="s1">) {</span>
            <span class="s7">$def </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s8">'assets.json_manifest_version_strategy'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$def</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$jsonManifestPath</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'assets._version_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, </span><span class="s7">$def</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'assets._version_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">return new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'assets.empty_version_strategy'</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerTranslatorConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">LoaderInterface </span><span class="s7">$loader</span><span class="s0">, </span><span class="s3">string </span><span class="s7">$defaultLocale</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.translation_debug'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.translation_update'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'translation.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s2">// Use the &quot;real&quot; translator instead of the identity default</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'translator'</span><span class="s0">, </span><span class="s8">'translator.default'</span><span class="s1">)-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'translator.formatter'</span><span class="s0">, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'formatter'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s7">$translator </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">'translator.default'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$translator</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'setFallbackLocales'</span><span class="s0">, </span><span class="s1">[</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'fallbacks'</span><span class="s1">] ?: [</span><span class="s7">$defaultLocale</span><span class="s1">]])</span><span class="s0">;</span>

        <span class="s7">$defaultOptions </span><span class="s1">= </span><span class="s7">$translator</span><span class="s1">-&gt;</span><span class="s3">getArgument</span><span class="s1">(</span><span class="s9">4</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$defaultOptions</span><span class="s1">[</span><span class="s8">'cache_dir'</span><span class="s1">] = </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'cache_dir'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s7">$translator</span><span class="s1">-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">4</span><span class="s0">, </span><span class="s7">$defaultOptions</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'translator.logging'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'logging'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'translator.default_path'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_path'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s2">// Discover translation directories</span>
        <span class="s7">$dirs </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s7">$transPaths </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s7">$nonExistingDirs </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Validator\Validation'</span><span class="s1">)) {</span>
            <span class="s7">$r </span><span class="s1">= </span><span class="s0">new </span><span class="s1">\</span><span class="s3">ReflectionClass</span><span class="s1">(</span><span class="s8">'Symfony\Component\Validator\Validation'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$dirs</span><span class="s1">[] = </span><span class="s7">$transPaths</span><span class="s1">[] = \</span><span class="s3">dirname</span><span class="s1">(</span><span class="s7">$r</span><span class="s1">-&gt;</span><span class="s3">getFileName</span><span class="s1">()).</span><span class="s8">'/Resources/translations'</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Form\Form'</span><span class="s1">)) {</span>
            <span class="s7">$r </span><span class="s1">= </span><span class="s0">new </span><span class="s1">\</span><span class="s3">ReflectionClass</span><span class="s1">(</span><span class="s8">'Symfony\Component\Form\Form'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$dirs</span><span class="s1">[] = </span><span class="s7">$transPaths</span><span class="s1">[] = \</span><span class="s3">dirname</span><span class="s1">(</span><span class="s7">$r</span><span class="s1">-&gt;</span><span class="s3">getFileName</span><span class="s1">()).</span><span class="s8">'/Resources/translations'</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Security\Core\Exception\AuthenticationException'</span><span class="s1">)) {</span>
            <span class="s7">$r </span><span class="s1">= </span><span class="s0">new </span><span class="s1">\</span><span class="s3">ReflectionClass</span><span class="s1">(</span><span class="s8">'Symfony\Component\Security\Core\Exception\AuthenticationException'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$dirs</span><span class="s1">[] = </span><span class="s7">$transPaths</span><span class="s1">[] = \</span><span class="s3">dirname</span><span class="s1">(</span><span class="s7">$r</span><span class="s1">-&gt;</span><span class="s3">getFileName</span><span class="s1">()</span><span class="s0">, </span><span class="s9">2</span><span class="s1">).</span><span class="s8">'/Resources/translations'</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s7">$defaultDir </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameterBag</span><span class="s1">()-&gt;</span><span class="s3">resolveValue</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_path'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.bundles_metadata'</span><span class="s1">) </span><span class="s0">as </span><span class="s7">$name </span><span class="s1">=&gt; </span><span class="s7">$bundle</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$dir </span><span class="s1">= </span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/Resources/translations'</span><span class="s1">) || </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$dir </span><span class="s1">= </span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/translations'</span><span class="s1">)) {</span>
                <span class="s7">$dirs</span><span class="s1">[] = </span><span class="s7">$dir</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$nonExistingDirs</span><span class="s1">[] = </span><span class="s7">$dir</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'paths'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$dir</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$dir</span><span class="s1">)) {</span>
                <span class="s7">$dirs</span><span class="s1">[] = </span><span class="s7">$transPaths</span><span class="s1">[] = </span><span class="s7">$dir</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s0">throw new </span><span class="s1">\</span><span class="s3">UnexpectedValueException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'&quot;%s&quot; defined in translator.paths does not exist or is not a directory.'</span><span class="s0">, </span><span class="s7">$dir</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">'console.command.translation_debug'</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'console.command.translation_debug'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">5</span><span class="s0">, </span><span class="s7">$transPaths</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">'console.command.translation_update'</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'console.command.translation_update'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">6</span><span class="s0">, </span><span class="s7">$transPaths</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$defaultDir</span><span class="s1">)) {</span>
            <span class="s7">$dirs</span><span class="s1">[] = </span><span class="s7">$defaultDir</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$nonExistingDirs</span><span class="s1">[] = </span><span class="s7">$defaultDir</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s2">// Register translation resources</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$dirs</span><span class="s1">) {</span>
            <span class="s7">$files </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s7">$finder </span><span class="s1">= </span><span class="s3">Finder</span><span class="s1">::</span><span class="s3">create</span><span class="s1">()</span>
                <span class="s1">-&gt;</span><span class="s3">followLinks</span><span class="s1">()</span>
                <span class="s1">-&gt;</span><span class="s3">files</span><span class="s1">()</span>
                <span class="s1">-&gt;</span><span class="s3">filter</span><span class="s1">(</span><span class="s0">function </span><span class="s1">(\</span><span class="s3">SplFileInfo </span><span class="s7">$file</span><span class="s1">) {</span>
                    <span class="s0">return </span><span class="s9">2 </span><span class="s1">&lt;= </span><span class="s3">substr_count</span><span class="s1">(</span><span class="s7">$file</span><span class="s1">-&gt;</span><span class="s3">getBasename</span><span class="s1">()</span><span class="s0">, </span><span class="s8">'.'</span><span class="s1">) &amp;&amp; </span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'/\.\w+$/'</span><span class="s0">, </span><span class="s7">$file</span><span class="s1">-&gt;</span><span class="s3">getBasename</span><span class="s1">())</span><span class="s0">;</span>
                <span class="s1">})</span>
                <span class="s1">-&gt;</span><span class="s3">in</span><span class="s1">(</span><span class="s7">$dirs</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">sortByName</span><span class="s1">()</span>
            <span class="s0">;</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$finder </span><span class="s0">as </span><span class="s7">$file</span><span class="s1">) {</span>
                <span class="s7">$fileNameParts </span><span class="s1">= </span><span class="s3">explode</span><span class="s1">(</span><span class="s8">'.'</span><span class="s0">, </span><span class="s3">basename</span><span class="s1">(</span><span class="s7">$file</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s7">$locale </span><span class="s1">= </span><span class="s7">$fileNameParts</span><span class="s1">[\</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$fileNameParts</span><span class="s1">) - </span><span class="s9">2</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$files</span><span class="s1">[</span><span class="s7">$locale</span><span class="s1">])) {</span>
                    <span class="s7">$files</span><span class="s1">[</span><span class="s7">$locale</span><span class="s1">] = []</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s7">$files</span><span class="s1">[</span><span class="s7">$locale</span><span class="s1">][] = (string) </span><span class="s7">$file</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$projectDir </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.project_dir'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$options </span><span class="s1">= </span><span class="s3">array_merge</span><span class="s1">(</span>
                <span class="s7">$translator</span><span class="s1">-&gt;</span><span class="s3">getArgument</span><span class="s1">(</span><span class="s9">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">[</span>
                    <span class="s8">'resource_files' </span><span class="s1">=&gt; </span><span class="s7">$files</span><span class="s0">,</span>
                    <span class="s8">'scanned_directories' </span><span class="s1">=&gt; </span><span class="s7">$scannedDirectories </span><span class="s1">= </span><span class="s3">array_merge</span><span class="s1">(</span><span class="s7">$dirs</span><span class="s0">, </span><span class="s7">$nonExistingDirs</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s8">'cache_vary' </span><span class="s1">=&gt; [</span>
                        <span class="s8">'scanned_directories' </span><span class="s1">=&gt; </span><span class="s3">array_map</span><span class="s1">(</span><span class="s0">static function </span><span class="s1">(</span><span class="s3">string </span><span class="s7">$dir</span><span class="s1">) </span><span class="s0">use </span><span class="s1">(</span><span class="s7">$projectDir</span><span class="s1">): </span><span class="s3">string </span><span class="s1">{</span>
                            <span class="s0">return </span><span class="s9">0 </span><span class="s1">=== </span><span class="s3">strpos</span><span class="s1">(</span><span class="s7">$dir</span><span class="s0">, </span><span class="s7">$projectDir</span><span class="s1">.</span><span class="s8">'/'</span><span class="s1">) ? </span><span class="s3">substr</span><span class="s1">(</span><span class="s7">$dir</span><span class="s0">, </span><span class="s9">1 </span><span class="s1">+ \</span><span class="s3">strlen</span><span class="s1">(</span><span class="s7">$projectDir</span><span class="s1">)) : </span><span class="s7">$dir</span><span class="s0">;</span>
                        <span class="s1">}</span><span class="s0">, </span><span class="s7">$scannedDirectories</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span>
            <span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$translator</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">4</span><span class="s0">, </span><span class="s7">$options</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerValidationConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s0">, </span><span class="s3">bool </span><span class="s7">$propertyInfoEnabled</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">validatorConfigEnabled </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Validator\Validation'</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Validation support cannot be enabled as the Validator component is not installed. Try running &quot;composer require symfony/validator&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'email_validation_mode'</span><span class="s1">])) {</span>
            <span class="s7">$config</span><span class="s1">[</span><span class="s8">'email_validation_mode'</span><span class="s1">] = </span><span class="s8">'loose'</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'validator.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$validatorBuilder </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'validator.builder'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'validator.translation_domain'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'translation_domain'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s7">$files </span><span class="s1">= [</span><span class="s8">'xml' </span><span class="s1">=&gt; []</span><span class="s0">, </span><span class="s8">'yml' </span><span class="s1">=&gt; []]</span><span class="s0">;</span>
        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerValidatorMapping</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s0">, </span><span class="s7">$files</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s0">empty</span><span class="s1">(</span><span class="s7">$files</span><span class="s1">[</span><span class="s8">'xml'</span><span class="s1">])) {</span>
            <span class="s7">$validatorBuilder</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'addXmlMappings'</span><span class="s0">, </span><span class="s1">[</span><span class="s7">$files</span><span class="s1">[</span><span class="s8">'xml'</span><span class="s1">]])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s0">empty</span><span class="s1">(</span><span class="s7">$files</span><span class="s1">[</span><span class="s8">'yml'</span><span class="s1">])) {</span>
            <span class="s7">$validatorBuilder</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'addYamlMappings'</span><span class="s0">, </span><span class="s1">[</span><span class="s7">$files</span><span class="s1">[</span><span class="s8">'yml'</span><span class="s1">]])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$definition </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">'validator.email'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'email_validation_mode'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(\</span><span class="s3">array_key_exists</span><span class="s1">(</span><span class="s8">'enable_annotations'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">) &amp;&amp; </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'enable_annotations'</span><span class="s1">]) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">annotationsConfigEnabled</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s1">\</span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'&quot;enable_annotations&quot; on the validator cannot be set as Annotations support is disabled.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$validatorBuilder</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'enableAnnotationMapping'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'annotation_reader'</span><span class="s1">)])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(\</span><span class="s3">array_key_exists</span><span class="s1">(</span><span class="s8">'static_method'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">) &amp;&amp; </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'static_method'</span><span class="s1">]) {</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'static_method'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$methodName</span><span class="s1">) {</span>
                <span class="s7">$validatorBuilder</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'addMethodMapping'</span><span class="s0">, </span><span class="s1">[</span><span class="s7">$methodName</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">)) {</span>
            <span class="s7">$validatorBuilder</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'setMappingCache'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'validator.mapping.cache.adapter'</span><span class="s1">)])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'validator.auto_mapping'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'auto_mapping'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$propertyInfoEnabled </span><span class="s1">|| !</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">PropertyInfoLoader</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'validator.property_info_loader'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span>
            <span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'validator.not_compromised_password'</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'not_compromised_password'</span><span class="s1">][</span><span class="s8">'enabled'</span><span class="s1">])</span>
            <span class="s1">-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">3</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'not_compromised_password'</span><span class="s1">][</span><span class="s8">'endpoint'</span><span class="s1">])</span>
        <span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerValidatorMapping</span><span class="s1">(</span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, array </span><span class="s7">$config</span><span class="s0">, array </span><span class="s1">&amp;</span><span class="s7">$files</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$fileRecorder </span><span class="s1">= </span><span class="s0">function </span><span class="s1">(</span><span class="s7">$extension</span><span class="s0">, </span><span class="s7">$path</span><span class="s1">) </span><span class="s0">use </span><span class="s1">(&amp;</span><span class="s7">$files</span><span class="s1">) {</span>
            <span class="s7">$files</span><span class="s1">[</span><span class="s8">'yaml' </span><span class="s1">=== </span><span class="s7">$extension </span><span class="s1">? </span><span class="s8">'yml' </span><span class="s1">: </span><span class="s7">$extension</span><span class="s1">][] = </span><span class="s7">$path</span><span class="s0">;</span>
        <span class="s1">}</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Form\FormInterface'</span><span class="s1">)) {</span>
            <span class="s7">$reflClass </span><span class="s1">= </span><span class="s0">new </span><span class="s1">\</span><span class="s3">ReflectionClass</span><span class="s1">(</span><span class="s8">'Symfony\Component\Form\FormInterface'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$fileRecorder</span><span class="s1">(</span><span class="s8">'xml'</span><span class="s0">, </span><span class="s1">\</span><span class="s3">dirname</span><span class="s1">(</span><span class="s7">$reflClass</span><span class="s1">-&gt;</span><span class="s3">getFileName</span><span class="s1">()).</span><span class="s8">'/Resources/config/validation.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.bundles_metadata'</span><span class="s1">) </span><span class="s0">as </span><span class="s7">$bundle</span><span class="s1">) {</span>
            <span class="s7">$configDir </span><span class="s1">= </span><span class="s3">is_dir</span><span class="s1">(</span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/Resources/config'</span><span class="s1">) ? </span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/Resources/config' </span><span class="s1">: </span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/config'</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$file </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/validation.yaml'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">) ||</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$file </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/validation.yml'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)</span>
            <span class="s1">) {</span>
                <span class="s7">$fileRecorder</span><span class="s1">(</span><span class="s8">'yml'</span><span class="s0">, </span><span class="s7">$file</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$file </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/validation.xml'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                <span class="s7">$fileRecorder</span><span class="s1">(</span><span class="s8">'xml'</span><span class="s0">, </span><span class="s7">$file</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$dir </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/validation'</span><span class="s0">, </span><span class="s8">'/^$/'</span><span class="s1">)) {</span>
                <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMappingFilesFromDir</span><span class="s1">(</span><span class="s7">$dir</span><span class="s0">, </span><span class="s7">$fileRecorder</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s7">$projectDir </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.project_dir'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$dir </span><span class="s1">= </span><span class="s7">$projectDir</span><span class="s1">.</span><span class="s8">'/config/validator'</span><span class="s0">, </span><span class="s8">'/^$/'</span><span class="s1">)) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMappingFilesFromDir</span><span class="s1">(</span><span class="s7">$dir</span><span class="s0">, </span><span class="s7">$fileRecorder</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMappingFilesFromConfig</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s0">, </span><span class="s7">$fileRecorder</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerMappingFilesFromDir</span><span class="s1">(</span><span class="s3">string </span><span class="s7">$dir</span><span class="s0">, callable </span><span class="s7">$fileRecorder</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s3">Finder</span><span class="s1">::</span><span class="s3">create</span><span class="s1">()-&gt;</span><span class="s3">followLinks</span><span class="s1">()-&gt;</span><span class="s3">files</span><span class="s1">()-&gt;</span><span class="s3">in</span><span class="s1">(</span><span class="s7">$dir</span><span class="s1">)-&gt;</span><span class="s3">name</span><span class="s1">(</span><span class="s8">'/\.(xml|ya?ml)$/'</span><span class="s1">)-&gt;</span><span class="s3">sortByName</span><span class="s1">() </span><span class="s0">as </span><span class="s7">$file</span><span class="s1">) {</span>
            <span class="s7">$fileRecorder</span><span class="s1">(</span><span class="s7">$file</span><span class="s1">-&gt;</span><span class="s3">getExtension</span><span class="s1">()</span><span class="s0">, </span><span class="s7">$file</span><span class="s1">-&gt;</span><span class="s3">getRealPath</span><span class="s1">())</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerMappingFilesFromConfig</span><span class="s1">(</span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, array </span><span class="s7">$config</span><span class="s0">, callable </span><span class="s7">$fileRecorder</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'mapping'</span><span class="s1">][</span><span class="s8">'paths'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$path</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s3">is_dir</span><span class="s1">(</span><span class="s7">$path</span><span class="s1">)) {</span>
                <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMappingFilesFromDir</span><span class="s1">(</span><span class="s7">$path</span><span class="s0">, </span><span class="s7">$fileRecorder</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">addResource</span><span class="s1">(</span><span class="s0">new </span><span class="s3">DirectoryResource</span><span class="s1">(</span><span class="s7">$path</span><span class="s0">, </span><span class="s8">'/^$/'</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$path</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'/\.(xml|ya?ml)$/'</span><span class="s0">, </span><span class="s7">$path</span><span class="s0">, </span><span class="s7">$matches</span><span class="s1">)) {</span>
                    <span class="s0">throw new </span><span class="s1">\</span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Unsupported mapping type in &quot;%s&quot;, supported types are XML &amp; Yaml.'</span><span class="s0">, </span><span class="s7">$path</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s7">$fileRecorder</span><span class="s1">(</span><span class="s7">$matches</span><span class="s1">[</span><span class="s9">1</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$path</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s0">throw new </span><span class="s1">\</span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Could not open file or directory &quot;%s&quot;.'</span><span class="s0">, </span><span class="s7">$path</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerAnnotationsConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">LoaderInterface </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">annotationsConfigEnabled</span><span class="s1">) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Doctrine\Common\Annotations\Annotation'</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Annotations cannot be enabled as the Doctrine Annotation library is not installed.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'annotations.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">method_exists</span><span class="s1">(</span><span class="s3">AnnotationRegistry</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">'registerUniqueLoader'</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'annotations.dummy_registry'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">setMethodCalls</span><span class="s1">([[</span><span class="s8">'registerLoader'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'class_exists'</span><span class="s1">]]])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s8">'none' </span><span class="s1">!== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'cache'</span><span class="s1">]) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Doctrine\Common\Cache\CacheProvider'</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Annotations cannot be enabled as the Doctrine Cache library is not installed.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$cacheService </span><span class="s1">= </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'cache'</span><span class="s1">]</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s8">'php_array' </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'cache'</span><span class="s1">]) {</span>
                <span class="s7">$cacheService </span><span class="s1">= </span><span class="s8">'annotations.cache'</span><span class="s0">;</span>

                <span class="s2">// Enable warmer only if PHP array is used for cache</span>
                <span class="s7">$definition </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">findDefinition</span><span class="s1">(</span><span class="s8">'annotations.cache_warmer'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.cache_warmer'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(</span><span class="s8">'file' </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'cache'</span><span class="s1">]) {</span>
                <span class="s7">$cacheDir </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameterBag</span><span class="s1">()-&gt;</span><span class="s3">resolveValue</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'file_cache_dir'</span><span class="s1">])</span><span class="s0">;</span>

                <span class="s0">if </span><span class="s1">(!</span><span class="s3">is_dir</span><span class="s1">(</span><span class="s7">$cacheDir</span><span class="s1">) &amp;&amp; </span><span class="s3">false </span><span class="s1">=== @</span><span class="s3">mkdir</span><span class="s1">(</span><span class="s7">$cacheDir</span><span class="s0">, </span><span class="s9">0777</span><span class="s0">, </span><span class="s3">true</span><span class="s1">) &amp;&amp; !</span><span class="s3">is_dir</span><span class="s1">(</span><span class="s7">$cacheDir</span><span class="s1">)) {</span>
                    <span class="s0">throw new </span><span class="s1">\</span><span class="s3">RuntimeException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Could not create cache directory &quot;%s&quot;.'</span><span class="s0">, </span><span class="s7">$cacheDir</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s7">$container</span>
                    <span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'annotations.filesystem_cache'</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$cacheDir</span><span class="s1">)</span>
                <span class="s0">;</span>

                <span class="s7">$cacheService </span><span class="s1">= </span><span class="s8">'annotations.filesystem_cache'</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$container</span>
                <span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'annotations.cached_reader'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'debug'</span><span class="s1">])</span>
                <span class="s2">// temporary property to lazy-reference the cache provider without using it until AddAnnotationsCachedReaderPass runs</span>
                <span class="s1">-&gt;</span><span class="s3">setProperty</span><span class="s1">(</span><span class="s8">'cacheProviderBackup'</span><span class="s0">, new </span><span class="s3">ServiceClosureArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$cacheService</span><span class="s1">)))</span>
                <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'annotations.cached_reader'</span><span class="s1">)</span>
            <span class="s0">;</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'annotation_reader'</span><span class="s0">, </span><span class="s8">'annotations.cached_reader'</span><span class="s1">)-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s3">Reader</span><span class="s1">::</span><span class="s0">class, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'annotations.cached_reader'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'annotations.cached_reader'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerPropertyAccessConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\PropertyAccess\PropertyAccessor'</span><span class="s1">)) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'property_access.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$container</span>
            <span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'property_accessor'</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'magic_call'</span><span class="s1">])</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'throw_exception_on_invalid_index'</span><span class="s1">])</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">3</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'throw_exception_on_invalid_property_path'</span><span class="s1">])</span>
        <span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerSecretsConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.secrets_set'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.secrets_list'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.secrets_remove'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.secrets_generate_key'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.secrets_decrypt_to_local'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.secrets_encrypt_from_local'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'secrets.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'secrets.vault'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'vault_directory'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'local_dotenv_file'</span><span class="s1">]) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'secrets.local_vault'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'local_dotenv_file'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'secrets.local_vault'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'decryption_env_var'</span><span class="s1">]) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">preg_match</span><span class="s1">(</span><span class="s8">'/^(?:\w*+:)*+\w++$/'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'decryption_env_var'</span><span class="s1">])) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Invalid value &quot;%s&quot; set as &quot;decryption_env_var&quot;: only &quot;word&quot; characters are allowed.'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'decryption_env_var'</span><span class="s1">]))</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'secrets.vault'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s8">&quot;%env(</span><span class="s1">{</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'decryption_env_var'</span><span class="s1">]}</span><span class="s8">)%&quot;</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'secrets.vault'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerSecurityCsrfConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">)) {</span>
            <span class="s0">return;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\Security\Csrf\CsrfToken'</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'CSRF support cannot be enabled as the Security CSRF component is not installed. Try running &quot;composer require symfony/security-csrf&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">sessionConfigEnabled</span><span class="s1">) {</span>
            <span class="s0">throw new </span><span class="s1">\</span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'CSRF protection needs sessions to be enabled.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s2">// Enable services for CSRF protection (even without forms)</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'security_csrf.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">CsrfExtension</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'twig.extension.security_csrf'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerSerializerConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'serializer.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$chainLoader </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.mapping.chain_loader'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s8">'Symfony\Component\PropertyAccess\PropertyAccessor'</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeAlias</span><span class="s1">(</span><span class="s8">'serializer.property_accessor'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'serializer.normalizer.object'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Yaml</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'serializer.encoder.yaml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$serializerLoaders </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'enable_annotations'</span><span class="s1">]) &amp;&amp; </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'enable_annotations'</span><span class="s1">]) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">annotationsConfigEnabled</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s1">\</span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'&quot;enable_annotations&quot; on the serializer cannot be set as Annotations support is disabled.'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$annotationLoader </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span>
                <span class="s8">'Symfony\Component\Serializer\Mapping\Loader\AnnotationLoader'</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'annotation_reader'</span><span class="s1">)]</span>
            <span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$annotationLoader</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s7">$serializerLoaders</span><span class="s1">[] = </span><span class="s7">$annotationLoader</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$fileRecorder </span><span class="s1">= </span><span class="s0">function </span><span class="s1">(</span><span class="s7">$extension</span><span class="s0">, </span><span class="s7">$path</span><span class="s1">) </span><span class="s0">use </span><span class="s1">(&amp;</span><span class="s7">$serializerLoaders</span><span class="s1">) {</span>
            <span class="s7">$definition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s7">$extension</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'yaml'</span><span class="s0">, </span><span class="s8">'yml'</span><span class="s1">]) ? </span><span class="s8">'Symfony\Component\Serializer\Mapping\Loader\YamlFileLoader' </span><span class="s1">: </span><span class="s8">'Symfony\Component\Serializer\Mapping\Loader\XmlFileLoader'</span><span class="s0">, </span><span class="s1">[</span><span class="s7">$path</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$serializerLoaders</span><span class="s1">[] = </span><span class="s7">$definition</span><span class="s0">;</span>
        <span class="s1">}</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.bundles_metadata'</span><span class="s1">) </span><span class="s0">as </span><span class="s7">$bundle</span><span class="s1">) {</span>
            <span class="s7">$configDir </span><span class="s1">= </span><span class="s3">is_dir</span><span class="s1">(</span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/Resources/config'</span><span class="s1">) ? </span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/Resources/config' </span><span class="s1">: </span><span class="s7">$bundle</span><span class="s1">[</span><span class="s8">'path'</span><span class="s1">].</span><span class="s8">'/config'</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$file </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/serialization.xml'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                <span class="s7">$fileRecorder</span><span class="s1">(</span><span class="s8">'xml'</span><span class="s0">, </span><span class="s7">$file</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$file </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/serialization.yaml'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">) ||</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$file </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/serialization.yml'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)</span>
            <span class="s1">) {</span>
                <span class="s7">$fileRecorder</span><span class="s1">(</span><span class="s8">'yml'</span><span class="s0">, </span><span class="s7">$file</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$dir </span><span class="s1">= </span><span class="s7">$configDir</span><span class="s1">.</span><span class="s8">'/serialization'</span><span class="s0">, </span><span class="s8">'/^$/'</span><span class="s1">)) {</span>
                <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMappingFilesFromDir</span><span class="s1">(</span><span class="s7">$dir</span><span class="s0">, </span><span class="s7">$fileRecorder</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s7">$projectDir </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.project_dir'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">fileExists</span><span class="s1">(</span><span class="s7">$dir </span><span class="s1">= </span><span class="s7">$projectDir</span><span class="s1">.</span><span class="s8">'/config/serializer'</span><span class="s0">, </span><span class="s8">'/^$/'</span><span class="s1">)) {</span>
            <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMappingFilesFromDir</span><span class="s1">(</span><span class="s7">$dir</span><span class="s0">, </span><span class="s7">$fileRecorder</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">registerMappingFilesFromConfig</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s0">, </span><span class="s7">$fileRecorder</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$chainLoader</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$serializerLoaders</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.mapping.cache_warmer'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$serializerLoaders</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'serializer.mapping.cache_class_metadata_factory'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'name_converter'</span><span class="s1">]) &amp;&amp; </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'name_converter'</span><span class="s1">]) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.name_converter.metadata_aware'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'name_converter'</span><span class="s1">]))</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'circular_reference_handler'</span><span class="s1">]) &amp;&amp; </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'circular_reference_handler'</span><span class="s1">]) {</span>
            <span class="s7">$arguments </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.normalizer.object'</span><span class="s1">)-&gt;</span><span class="s3">getArguments</span><span class="s1">()</span><span class="s0">;</span>
            <span class="s7">$context </span><span class="s1">= (</span><span class="s7">$arguments</span><span class="s1">[</span><span class="s9">6</span><span class="s1">] ?? []) + [</span><span class="s8">'circular_reference_handler' </span><span class="s1">=&gt; </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'circular_reference_handler'</span><span class="s1">])]</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.normalizer.object'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">5</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.normalizer.object'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">6</span><span class="s0">, </span><span class="s7">$context</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'max_depth_handler'</span><span class="s1">] ?? </span><span class="s3">false</span><span class="s1">) {</span>
            <span class="s7">$defaultContext </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.normalizer.object'</span><span class="s1">)-&gt;</span><span class="s3">getArgument</span><span class="s1">(</span><span class="s9">6</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$defaultContext </span><span class="s1">+= [</span><span class="s8">'max_depth_handler' </span><span class="s1">=&gt; </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'max_depth_handler'</span><span class="s1">])]</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'serializer.normalizer.object'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">6</span><span class="s0">, </span><span class="s7">$defaultContext</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerPropertyInfoConfiguration</span><span class="s1">(</span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">PropertyInfoExtractorInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'PropertyInfo support cannot be enabled as the PropertyInfo component is not installed. Try running &quot;composer require symfony/property-info&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'property_info.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s8">'phpDocumentor\Reflection\DocBlockFactoryInterface'</span><span class="s1">)) {</span>
            <span class="s7">$definition </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'property_info.php_doc_extractor'</span><span class="s0">, </span><span class="s8">'Symfony\Component\PropertyInfo\Extractor\PhpDocExtractor'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">setPrivate</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'property_info.description_extractor'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'priority' </span><span class="s1">=&gt; -</span><span class="s9">1000</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'property_info.type_extractor'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'priority' </span><span class="s1">=&gt; -</span><span class="s9">1001</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'property_info.cache'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerLockConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'lock.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'resources'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$resourceName </span><span class="s1">=&gt; </span><span class="s7">$resourceStores</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s9">0 </span><span class="s1">=== \</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$resourceStores</span><span class="s1">)) {</span>
                <span class="s0">continue;</span>
            <span class="s1">}</span>

            <span class="s2">// Generate stores</span>
            <span class="s7">$storeDefinitions </span><span class="s1">= []</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$resourceStores </span><span class="s0">as </span><span class="s7">$storeDsn</span><span class="s1">) {</span>
                <span class="s7">$storeDsn </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s7">$storeDsn</span><span class="s0">, </span><span class="s3">null</span><span class="s0">, </span><span class="s7">$usedEnvs</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$storeDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">StoreInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">) ? </span><span class="s3">StoreInterface</span><span class="s1">::</span><span class="s0">class </span><span class="s1">: </span><span class="s3">PersistingStoreInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$storeDefinition</span><span class="s1">-&gt;</span><span class="s3">setFactory</span><span class="s1">([</span><span class="s3">StoreFactory</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">'createStore'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$storeDefinition</span><span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s7">$storeDsn</span><span class="s1">])</span><span class="s0">;</span>

                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$storeDefinitionId </span><span class="s1">= </span><span class="s8">'.lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.store.'</span><span class="s1">.</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hash</span><span class="s1">(</span><span class="s7">$storeDsn</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$storeDefinition</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s7">$storeDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$storeDefinitionId</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s7">$storeDefinitions</span><span class="s1">[] = </span><span class="s7">$storeDefinition</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// Wrap array of stores with CombinedStore</span>
            <span class="s0">if </span><span class="s1">(\</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$storeDefinitions</span><span class="s1">) &gt; </span><span class="s9">1</span><span class="s1">) {</span>
                <span class="s7">$combinedDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s8">'lock.store.combined.abstract'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$combinedDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$storeDefinitions</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.store'</span><span class="s0">, </span><span class="s7">$combinedDefinition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.store'</span><span class="s0">, new </span><span class="s3">Alias</span><span class="s1">((string) </span><span class="s7">$storeDefinitions</span><span class="s1">[</span><span class="s9">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// Generate factories for each resource</span>
            <span class="s7">$factoryDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s8">'lock.factory.abstract'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$factoryDefinition</span><span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.store'</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.factory'</span><span class="s0">, </span><span class="s7">$factoryDefinition</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s2">// Generate services for lock instances</span>
            <span class="s7">$lockDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">Lock</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$lockDefinition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$lockDefinition</span><span class="s1">-&gt;</span><span class="s3">setFactory</span><span class="s1">([</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.factory'</span><span class="s1">)</span><span class="s0">, </span><span class="s8">'createLock'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$lockDefinition</span><span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s7">$resourceName</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s0">, </span><span class="s7">$lockDefinition</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s2">// provide alias for default resource</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'default' </span><span class="s1">=== </span><span class="s7">$resourceName</span><span class="s1">) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'lock.store'</span><span class="s0">, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.store'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'lock.factory'</span><span class="s0">, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.factory'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'lock'</span><span class="s0">, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s3">PersistingStoreInterface</span><span class="s1">::</span><span class="s0">class, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'lock.store'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s3">LockFactory</span><span class="s1">::</span><span class="s0">class, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'lock.factory'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s3">LockInterface</span><span class="s1">::</span><span class="s0">class, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s8">'lock'</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.store'</span><span class="s0">, </span><span class="s3">PersistingStoreInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.lock.store'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.factory'</span><span class="s0">, </span><span class="s3">LockFactory</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.lock.factory'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s8">'lock.'</span><span class="s1">.</span><span class="s7">$resourceName</span><span class="s0">, </span><span class="s3">LockInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$resourceName</span><span class="s1">.</span><span class="s8">'.lock'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerMessengerConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s0">, array </span><span class="s7">$validationConfig</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">MessageBusInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Messenger support cannot be enabled as the Messenger component is not installed. Try running &quot;composer require symfony/messenger&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'messenger.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">AmqpTransportFactory</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.amqp.factory'</span><span class="s1">)-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.transport_factory'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">RedisTransportFactory</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.redis.factory'</span><span class="s1">)-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.transport_factory'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_bus'</span><span class="s1">] &amp;&amp; </span><span class="s9">1 </span><span class="s1">=== \</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'buses'</span><span class="s1">])) {</span>
            <span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_bus'</span><span class="s1">] = </span><span class="s3">key</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'buses'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$defaultMiddleware </span><span class="s1">= [</span>
            <span class="s8">'before' </span><span class="s1">=&gt; [</span>
                <span class="s1">[</span><span class="s8">'id' </span><span class="s1">=&gt; </span><span class="s8">'add_bus_name_stamp_middleware'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s8">'id' </span><span class="s1">=&gt; </span><span class="s8">'reject_redelivered_message_middleware'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s8">'id' </span><span class="s1">=&gt; </span><span class="s8">'dispatch_after_current_bus'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s8">'id' </span><span class="s1">=&gt; </span><span class="s8">'failed_message_processing_middleware'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s8">'after' </span><span class="s1">=&gt; [</span>
                <span class="s1">[</span><span class="s8">'id' </span><span class="s1">=&gt; </span><span class="s8">'send_message'</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s8">'id' </span><span class="s1">=&gt; </span><span class="s8">'handle_message'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'buses'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$busId </span><span class="s1">=&gt; </span><span class="s7">$bus</span><span class="s1">) {</span>
            <span class="s7">$middleware </span><span class="s1">= </span><span class="s7">$bus</span><span class="s1">[</span><span class="s8">'middleware'</span><span class="s1">]</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$bus</span><span class="s1">[</span><span class="s8">'default_middleware'</span><span class="s1">]) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s8">'allow_no_handlers' </span><span class="s1">=== </span><span class="s7">$bus</span><span class="s1">[</span><span class="s8">'default_middleware'</span><span class="s1">]) {</span>
                    <span class="s7">$defaultMiddleware</span><span class="s1">[</span><span class="s8">'after'</span><span class="s1">][</span><span class="s9">1</span><span class="s1">][</span><span class="s8">'arguments'</span><span class="s1">] = [</span><span class="s3">true</span><span class="s1">]</span><span class="s0">;</span>
                <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                    <span class="s0">unset</span><span class="s1">(</span><span class="s7">$defaultMiddleware</span><span class="s1">[</span><span class="s8">'after'</span><span class="s1">][</span><span class="s9">1</span><span class="s1">][</span><span class="s8">'arguments'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s1">}</span>

                <span class="s2">// argument to add_bus_name_stamp_middleware</span>
                <span class="s7">$defaultMiddleware</span><span class="s1">[</span><span class="s8">'before'</span><span class="s1">][</span><span class="s9">0</span><span class="s1">][</span><span class="s8">'arguments'</span><span class="s1">] = [</span><span class="s7">$busId</span><span class="s1">]</span><span class="s0">;</span>

                <span class="s7">$middleware </span><span class="s1">= </span><span class="s3">array_merge</span><span class="s1">(</span><span class="s7">$defaultMiddleware</span><span class="s1">[</span><span class="s8">'before'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$middleware</span><span class="s0">, </span><span class="s7">$defaultMiddleware</span><span class="s1">[</span><span class="s8">'after'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$middleware </span><span class="s0">as </span><span class="s7">$middlewareItem</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s7">$validationConfig</span><span class="s1">[</span><span class="s8">'enabled'</span><span class="s1">] &amp;&amp; \</span><span class="s3">in_array</span><span class="s1">(</span><span class="s7">$middlewareItem</span><span class="s1">[</span><span class="s8">'id'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'validation'</span><span class="s0">, </span><span class="s8">'messenger.middleware.validation'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
                    <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'The Validation middleware is only available when the Validator component is installed and enabled. Try running &quot;composer require symfony/validator&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">) &amp;&amp; </span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Stopwatch</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
                <span class="s3">array_unshift</span><span class="s1">(</span><span class="s7">$middleware</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'id' </span><span class="s1">=&gt; </span><span class="s8">'traceable'</span><span class="s0">, </span><span class="s8">'arguments' </span><span class="s1">=&gt; [</span><span class="s7">$busId</span><span class="s1">]])</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s7">$busId</span><span class="s1">.</span><span class="s8">'.middleware'</span><span class="s0">, </span><span class="s7">$middleware</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s7">$busId</span><span class="s0">, </span><span class="s3">MessageBus</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)-&gt;</span><span class="s3">addArgument</span><span class="s1">([])-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.bus'</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$busId </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_bus'</span><span class="s1">]) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'messenger.default_bus'</span><span class="s0">, </span><span class="s7">$busId</span><span class="s1">)-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">true</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s3">MessageBusInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$busId</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$busId</span><span class="s0">, </span><span class="s3">MessageBusInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">empty</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'transports'</span><span class="s1">])) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.symfony_serializer'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.amqp.factory'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.redis.factory'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.transport.symfony_serializer'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'serializer'</span><span class="s1">][</span><span class="s8">'symfony_serializer'</span><span class="s1">][</span><span class="s8">'format'</span><span class="s1">])</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'serializer'</span><span class="s1">][</span><span class="s8">'symfony_serializer'</span><span class="s1">][</span><span class="s8">'context'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'messenger.default_serializer'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'serializer'</span><span class="s1">][</span><span class="s8">'default_serializer'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$senderAliases </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s7">$transportRetryReferences </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'transports'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$name </span><span class="s1">=&gt; </span><span class="s7">$transport</span><span class="s1">) {</span>
            <span class="s7">$serializerId </span><span class="s1">= </span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'serializer'</span><span class="s1">] ?? </span><span class="s8">'messenger.default_serializer'</span><span class="s0">;</span>

            <span class="s7">$transportDefinition </span><span class="s1">= (</span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">TransportInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">))</span>
                <span class="s1">-&gt;</span><span class="s3">setFactory</span><span class="s1">([</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'messenger.transport_factory'</span><span class="s1">)</span><span class="s0">, </span><span class="s8">'createTransport'</span><span class="s1">])</span>
                <span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'dsn'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'options'</span><span class="s1">] + [</span><span class="s8">'transport_name' </span><span class="s1">=&gt; </span><span class="s7">$name</span><span class="s1">]</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$serializerId</span><span class="s1">)])</span>
                <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'messenger.receiver'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'alias' </span><span class="s1">=&gt; </span><span class="s7">$name</span><span class="s1">])</span>
            <span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$transportId </span><span class="s1">= </span><span class="s8">'messenger.transport.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, </span><span class="s7">$transportDefinition</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$senderAliases</span><span class="s1">[</span><span class="s7">$name</span><span class="s1">] = </span><span class="s7">$transportId</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">!== </span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'retry_strategy'</span><span class="s1">][</span><span class="s8">'service'</span><span class="s1">]) {</span>
                <span class="s7">$transportRetryReferences</span><span class="s1">[</span><span class="s7">$name</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'retry_strategy'</span><span class="s1">][</span><span class="s8">'service'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$retryServiceId </span><span class="s1">= </span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'messenger.retry.multiplier_retry_strategy.%s'</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$retryDefinition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s8">'messenger.retry.abstract_multiplier_retry_strategy'</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$retryDefinition</span>
                    <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'retry_strategy'</span><span class="s1">][</span><span class="s8">'max_retries'</span><span class="s1">])</span>
                    <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'retry_strategy'</span><span class="s1">][</span><span class="s8">'delay'</span><span class="s1">])</span>
                    <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'retry_strategy'</span><span class="s1">][</span><span class="s8">'multiplier'</span><span class="s1">])</span>
                    <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">3</span><span class="s0">, </span><span class="s7">$transport</span><span class="s1">[</span><span class="s8">'retry_strategy'</span><span class="s1">][</span><span class="s8">'max_delay'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$retryServiceId</span><span class="s0">, </span><span class="s7">$retryDefinition</span><span class="s1">)</span><span class="s0">;</span>

                <span class="s7">$transportRetryReferences</span><span class="s1">[</span><span class="s7">$name</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$retryServiceId</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s7">$senderReferences </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s2">// alias =&gt; service_id</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$senderAliases </span><span class="s0">as </span><span class="s7">$alias </span><span class="s1">=&gt; </span><span class="s7">$serviceId</span><span class="s1">) {</span>
            <span class="s7">$senderReferences</span><span class="s1">[</span><span class="s7">$alias</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$serviceId</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s2">// service_id =&gt; service_id</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$senderAliases </span><span class="s0">as </span><span class="s7">$serviceId</span><span class="s1">) {</span>
            <span class="s7">$senderReferences</span><span class="s1">[</span><span class="s7">$serviceId</span><span class="s1">] = </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$serviceId</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$messageToSendersMapping </span><span class="s1">= []</span><span class="s0">;</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'routing'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$message </span><span class="s1">=&gt; </span><span class="s7">$messageConfiguration</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'*' </span><span class="s1">!== </span><span class="s7">$message </span><span class="s1">&amp;&amp; !</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s7">$message</span><span class="s1">) &amp;&amp; !</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s7">$message</span><span class="s0">, </span><span class="s3">false</span><span class="s1">)) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Invalid Messenger routing configuration: class or interface &quot;%s&quot; not found.'</span><span class="s0">, </span><span class="s7">$message</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// make sure senderAliases contains all senders</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$messageConfiguration</span><span class="s1">[</span><span class="s8">'senders'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$sender</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$senderReferences</span><span class="s1">[</span><span class="s7">$sender</span><span class="s1">])) {</span>
                    <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Invalid Messenger routing configuration: the &quot;%s&quot; class is being routed to a sender called &quot;%s&quot;. This is not a valid transport or service id.'</span><span class="s0">, </span><span class="s7">$message</span><span class="s0">, </span><span class="s7">$sender</span><span class="s1">))</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s7">$messageToSendersMapping</span><span class="s1">[</span><span class="s7">$message</span><span class="s1">] = </span><span class="s7">$messageConfiguration</span><span class="s1">[</span><span class="s8">'senders'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$sendersServiceLocator </span><span class="s1">= </span><span class="s3">ServiceLocatorTagPass</span><span class="s1">::</span><span class="s3">register</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$senderReferences</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.senders_locator'</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$messageToSendersMapping</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$sendersServiceLocator</span><span class="s1">)</span>
        <span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.retry.send_failed_message_for_retry_listener'</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$sendersServiceLocator</span><span class="s1">)</span>
        <span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.retry_strategy_locator'</span><span class="s1">)</span>
            <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$transportRetryReferences</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'failure_transport'</span><span class="s1">]) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$senderReferences</span><span class="s1">[</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'failure_transport'</span><span class="s1">]])) {</span>
                <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Invalid Messenger configuration: the failure transport &quot;%s&quot; is not a valid transport or service id.'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'failure_transport'</span><span class="s1">]))</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'messenger.failure.send_failed_message_to_failure_transport_listener'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$senderReferences</span><span class="s1">[</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'failure_transport'</span><span class="s1">]])</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_retry'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'failure_transport'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_show'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'failure_transport'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_remove'</span><span class="s1">)</span>
                <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'failure_transport'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'messenger.failure.send_failed_message_to_failure_transport_listener'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_retry'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_show'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'console.command.messenger_failed_messages_remove'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerCacheConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">DefaultMarshaller</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'cache.default_marshaller'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$version </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Parameter</span><span class="s1">(</span><span class="s8">'container.build_id'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'cache.adapter.apcu'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$version</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'cache.adapter.system'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$version</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'cache.adapter.filesystem'</span><span class="s1">)-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'directory'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'prefix_seed'</span><span class="s1">])) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'cache.prefix.seed'</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'prefix_seed'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasParameter</span><span class="s1">(</span><span class="s8">'cache.prefix.seed'</span><span class="s1">)) {</span>
            <span class="s2">// Inline any env vars referenced in the parameter</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setParameter</span><span class="s1">(</span><span class="s8">'cache.prefix.seed'</span><span class="s0">, </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">resolveEnvPlaceholders</span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'cache.prefix.seed'</span><span class="s1">)</span><span class="s0">, </span><span class="s3">true</span><span class="s1">))</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">foreach </span><span class="s1">([</span><span class="s8">'doctrine'</span><span class="s0">, </span><span class="s8">'psr6'</span><span class="s0">, </span><span class="s8">'redis'</span><span class="s0">, </span><span class="s8">'memcached'</span><span class="s0">, </span><span class="s8">'pdo'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$name</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s7">$name </span><span class="s1">= </span><span class="s8">'default_'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">.</span><span class="s8">'_provider'</span><span class="s1">])) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setAlias</span><span class="s1">(</span><span class="s8">'cache.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, new </span><span class="s3">Alias</span><span class="s1">(</span><span class="s3">CachePoolPass</span><span class="s1">::</span><span class="s3">getServiceProvider</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s7">$name</span><span class="s1">])</span><span class="s0">, </span><span class="s3">false</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">foreach </span><span class="s1">([</span><span class="s8">'app'</span><span class="s0">, </span><span class="s8">'system'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$name</span><span class="s1">) {</span>
            <span class="s7">$config</span><span class="s1">[</span><span class="s8">'pools'</span><span class="s1">][</span><span class="s8">'cache.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">] = [</span>
                <span class="s8">'adapters' </span><span class="s1">=&gt; [</span><span class="s7">$config</span><span class="s1">[</span><span class="s7">$name</span><span class="s1">]]</span><span class="s0">,</span>
                <span class="s8">'public' </span><span class="s1">=&gt; </span><span class="s3">true</span><span class="s0">,</span>
                <span class="s8">'tags' </span><span class="s1">=&gt; </span><span class="s3">false</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'pools'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$name </span><span class="s1">=&gt; </span><span class="s7">$pool</span><span class="s1">) {</span>
            <span class="s7">$pool</span><span class="s1">[</span><span class="s8">'adapters'</span><span class="s1">] = </span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'adapters'</span><span class="s1">] ?: [</span><span class="s8">'cache.app'</span><span class="s1">]</span><span class="s0">;</span>

            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'adapters'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$provider </span><span class="s1">=&gt; </span><span class="s7">$adapter</span><span class="s1">) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'pools'</span><span class="s1">][</span><span class="s7">$adapter</span><span class="s1">][</span><span class="s8">'tags'</span><span class="s1">] ?? </span><span class="s3">false</span><span class="s1">) {</span>
                    <span class="s7">$pool</span><span class="s1">[</span><span class="s8">'adapters'</span><span class="s1">][</span><span class="s7">$provider</span><span class="s1">] = </span><span class="s7">$adapter </span><span class="s1">= </span><span class="s8">'.'</span><span class="s1">.</span><span class="s7">$adapter</span><span class="s1">.</span><span class="s8">'.inner'</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s9">1 </span><span class="s1">=== \</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'adapters'</span><span class="s1">])) {</span>
                <span class="s0">if </span><span class="s1">(!</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'provider'</span><span class="s1">]) &amp;&amp; !\</span><span class="s3">is_int</span><span class="s1">(</span><span class="s7">$provider</span><span class="s1">)) {</span>
                    <span class="s7">$pool</span><span class="s1">[</span><span class="s8">'provider'</span><span class="s1">] = </span><span class="s7">$provider</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s7">$definition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s7">$adapter</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$definition </span><span class="s1">= </span><span class="s0">new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">ChainAdapter</span><span class="s1">::</span><span class="s0">class, </span><span class="s1">[</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'adapters'</span><span class="s1">]</span><span class="s0">, </span><span class="s9">0</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$pool</span><span class="s1">[</span><span class="s8">'reset'</span><span class="s1">] = </span><span class="s8">'reset'</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">]) {</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s3">true </span><span class="s1">!== </span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">] &amp;&amp; (</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'pools'</span><span class="s1">][</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">]][</span><span class="s8">'tags'</span><span class="s1">] ?? </span><span class="s3">false</span><span class="s1">)) {</span>
                    <span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">] = </span><span class="s8">'.'</span><span class="s1">.</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">].</span><span class="s8">'.inner'</span><span class="s0">;</span>
                <span class="s1">}</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">TagAwareAdapter</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">.</span><span class="s8">'.inner'</span><span class="s1">))</span>
                    <span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s3">true </span><span class="s1">!== </span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">] ? </span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">]) : </span><span class="s3">null</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'public'</span><span class="s1">])</span>
                <span class="s0">;</span>

                <span class="s7">$pool</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">] = </span><span class="s7">$name</span><span class="s0">;</span>
                <span class="s7">$pool</span><span class="s1">[</span><span class="s8">'public'</span><span class="s1">] = </span><span class="s3">false</span><span class="s0">;</span>
                <span class="s7">$name </span><span class="s1">= </span><span class="s8">'.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">.</span><span class="s8">'.inner'</span><span class="s0">;</span>

                <span class="s0">if </span><span class="s1">(!\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'cache.app'</span><span class="s0">, </span><span class="s8">'cache.system'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
                    <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">TagAwareCacheInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                    <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">CacheInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">])</span><span class="s0">;</span>
                    <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">CacheItemPoolInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'name'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s0">elseif </span><span class="s1">(!\</span><span class="s3">in_array</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'cache.app'</span><span class="s0">, </span><span class="s8">'cache.system'</span><span class="s1">]</span><span class="s0">, </span><span class="s3">true</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">.</span><span class="s8">'.taggable'</span><span class="s0">, </span><span class="s3">TagAwareAdapter</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">addArgument</span><span class="s1">(</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$name</span><span class="s1">))</span>
                <span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s8">'.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s1">.</span><span class="s8">'.taggable'</span><span class="s0">, </span><span class="s3">TagAwareCacheInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">CacheInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">CacheItemPoolInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'public'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s0">unset</span><span class="s1">(</span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'adapters'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'public'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$pool</span><span class="s1">[</span><span class="s8">'tags'</span><span class="s1">])</span><span class="s0">;</span>

            <span class="s7">$definition</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'cache.pool'</span><span class="s0">, </span><span class="s7">$pool</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s7">$definition</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s3">method_exists</span><span class="s1">(</span><span class="s3">PropertyAccessor</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">'createCache'</span><span class="s1">)) {</span>
            <span class="s7">$propertyAccessDefinition </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s8">'cache.property_access'</span><span class="s0">, </span><span class="s3">AdapterInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$propertyAccessDefinition</span><span class="s1">-&gt;</span><span class="s3">setPublic</span><span class="s1">(</span><span class="s3">false</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(!</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getParameter</span><span class="s1">(</span><span class="s8">'kernel.debug'</span><span class="s1">)) {</span>
                <span class="s7">$propertyAccessDefinition</span><span class="s1">-&gt;</span><span class="s3">setFactory</span><span class="s1">([</span><span class="s3">PropertyAccessor</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">'createCache'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$propertyAccessDefinition</span><span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s3">null</span><span class="s0">, </span><span class="s9">0</span><span class="s0">, </span><span class="s7">$version</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s8">'logger'</span><span class="s0">, </span><span class="s3">ContainerInterface</span><span class="s1">::</span><span class="s3">IGNORE_ON_INVALID_REFERENCE</span><span class="s1">)])</span><span class="s0">;</span>
                <span class="s7">$propertyAccessDefinition</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'cache.pool'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'clearer' </span><span class="s1">=&gt; </span><span class="s8">'cache.system_clearer'</span><span class="s1">])</span><span class="s0">;</span>
                <span class="s7">$propertyAccessDefinition</span><span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'monolog.logger'</span><span class="s0">, </span><span class="s1">[</span><span class="s8">'channel' </span><span class="s1">=&gt; </span><span class="s8">'cache'</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$propertyAccessDefinition</span><span class="s1">-&gt;</span><span class="s3">setClass</span><span class="s1">(</span><span class="s3">ArrayAdapter</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
                <span class="s7">$propertyAccessDefinition</span><span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s9">0</span><span class="s0">, </span><span class="s3">false</span><span class="s1">])</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerHttpClientConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s0">, array </span><span class="s7">$profilerConfig</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'http_client.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'http_client'</span><span class="s1">)-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'default_options'</span><span class="s1">] ?? []</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'max_host_connections'</span><span class="s1">] ?? </span><span class="s9">6</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s7">$hasPsr18 </span><span class="s1">= </span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">ClientInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'psr18.http_client'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeAlias</span><span class="s1">(</span><span class="s3">ClientInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(!</span><span class="s3">interface_exists</span><span class="s1">(</span><span class="s3">HttpClient</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s3">HttpClient</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$httpClientId </span><span class="s1">= </span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">isConfigEnabled</span><span class="s1">(</span><span class="s7">$container</span><span class="s0">, </span><span class="s7">$profilerConfig</span><span class="s1">) ? </span><span class="s8">'.debug.http_client.inner' </span><span class="s1">: </span><span class="s8">'http_client'</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'scoped_clients'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$name </span><span class="s1">=&gt; </span><span class="s7">$scopeConfig</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s8">'http_client' </span><span class="s1">=== </span><span class="s7">$name</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s3">InvalidArgumentException</span><span class="s1">(</span><span class="s3">sprintf</span><span class="s1">(</span><span class="s8">'Invalid scope name: &quot;%s&quot; is reserved.'</span><span class="s0">, </span><span class="s7">$name</span><span class="s1">))</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$scope </span><span class="s1">= </span><span class="s7">$scopeConfig</span><span class="s1">[</span><span class="s8">'scope'</span><span class="s1">] ?? </span><span class="s3">null</span><span class="s0">;</span>
            <span class="s0">unset</span><span class="s1">(</span><span class="s7">$scopeConfig</span><span class="s1">[</span><span class="s8">'scope'</span><span class="s1">])</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$scope</span><span class="s1">) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">ScopingHttpClient</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">setFactory</span><span class="s1">([</span><span class="s3">ScopingHttpClient</span><span class="s1">::</span><span class="s0">class, </span><span class="s8">'forBaseUri'</span><span class="s1">])</span>
                    <span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$httpClientId</span><span class="s1">)</span><span class="s0">, </span><span class="s7">$scopeConfig</span><span class="s1">[</span><span class="s8">'base_uri'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$scopeConfig</span><span class="s1">])</span>
                    <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'http_client.client'</span><span class="s1">)</span>
                <span class="s0">;</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">register</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">ScopingHttpClient</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span>
                    <span class="s1">-&gt;</span><span class="s3">setArguments</span><span class="s1">([</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$httpClientId</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s7">$scope </span><span class="s1">=&gt; </span><span class="s7">$scopeConfig</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$scope</span><span class="s1">])</span>
                    <span class="s1">-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'http_client.client'</span><span class="s1">)</span>
                <span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">HttpClientInterface</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)</span><span class="s0">;</span>

            <span class="s0">if </span><span class="s1">(</span><span class="s7">$hasPsr18</span><span class="s1">) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s8">'psr18.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, new </span><span class="s3">ChildDefinition</span><span class="s1">(</span><span class="s8">'psr18.http_client'</span><span class="s1">))</span>
                    <span class="s1">-&gt;</span><span class="s3">replaceArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$name</span><span class="s1">))</span><span class="s0">;</span>

                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">registerAliasForArgument</span><span class="s1">(</span><span class="s8">'psr18.'</span><span class="s1">.</span><span class="s7">$name</span><span class="s0">, </span><span class="s3">ClientInterface</span><span class="s1">::</span><span class="s0">class, </span><span class="s7">$name</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerMailerConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Mailer</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Mailer support cannot be enabled as the component is not installed. Try running &quot;composer require symfony/mailer&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'mailer.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'mailer_transports.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s0">if </span><span class="s1">(!\</span><span class="s3">count</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'transports'</span><span class="s1">]) &amp;&amp; </span><span class="s3">null </span><span class="s1">=== </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'dsn'</span><span class="s1">]) {</span>
            <span class="s7">$config</span><span class="s1">[</span><span class="s8">'dsn'</span><span class="s1">] = </span><span class="s8">'smtp://null'</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s7">$transports </span><span class="s1">= </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'dsn'</span><span class="s1">] ? [</span><span class="s8">'main' </span><span class="s1">=&gt; </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'dsn'</span><span class="s1">]] : </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'transports'</span><span class="s1">]</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'mailer.transports'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$transports</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'mailer.default_transport'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s3">current</span><span class="s1">(</span><span class="s7">$transports</span><span class="s1">))</span><span class="s0">;</span>

        <span class="s7">$classToServices </span><span class="s1">= [</span>
            <span class="s3">SesTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'mailer.transport_factory.amazon'</span><span class="s0">,</span>
            <span class="s3">GmailTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'mailer.transport_factory.gmail'</span><span class="s0">,</span>
            <span class="s3">MandrillTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'mailer.transport_factory.mailchimp'</span><span class="s0">,</span>
            <span class="s3">MailgunTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'mailer.transport_factory.mailgun'</span><span class="s0">,</span>
            <span class="s3">PostmarkTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'mailer.transport_factory.postmark'</span><span class="s0">,</span>
            <span class="s3">SendgridTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'mailer.transport_factory.sendgrid'</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$classToServices </span><span class="s0">as </span><span class="s7">$class </span><span class="s1">=&gt; </span><span class="s7">$service</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s7">$class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s7">$service</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s7">$recipients </span><span class="s1">= </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'envelope'</span><span class="s1">][</span><span class="s8">'recipients'</span><span class="s1">] ?? </span><span class="s3">null</span><span class="s0">;</span>
        <span class="s7">$sender </span><span class="s1">= </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'envelope'</span><span class="s1">][</span><span class="s8">'sender'</span><span class="s1">] ?? </span><span class="s3">null</span><span class="s0">;</span>

        <span class="s7">$envelopeListener </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'mailer.envelope_listener'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$envelopeListener</span><span class="s1">-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$sender</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$envelopeListener</span><span class="s1">-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">1</span><span class="s0">, </span><span class="s7">$recipients</span><span class="s1">)</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">private function </span><span class="s3">registerNotifierConfiguration</span><span class="s1">(</span><span class="s0">array </span><span class="s7">$config</span><span class="s0">, </span><span class="s3">ContainerBuilder </span><span class="s7">$container</span><span class="s0">, </span><span class="s3">XmlFileLoader </span><span class="s7">$loader</span><span class="s1">)</span>
    <span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s3">Notifier</span><span class="s1">::</span><span class="s0">class</span><span class="s1">)) {</span>
            <span class="s0">throw new </span><span class="s3">LogicException</span><span class="s1">(</span><span class="s8">'Notifier support cannot be enabled as the component is not installed. Try running &quot;composer require symfony/notifier&quot;.'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'notifier.xml'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s7">$loader</span><span class="s1">-&gt;</span><span class="s3">load</span><span class="s1">(</span><span class="s8">'notifier_transports.xml'</span><span class="s1">)</span><span class="s0">;</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'chatter_transports'</span><span class="s1">]) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'chatter.transports'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'chatter_transports'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'chatter'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'texter_transports'</span><span class="s1">]) {</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'texter.transports'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'texter_transports'</span><span class="s1">])</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'texter'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">mailerConfigEnabled</span><span class="s1">) {</span>
            <span class="s7">$sender </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'mailer.envelope_listener'</span><span class="s1">)-&gt;</span><span class="s3">getArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'notifier.channel.email'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">2</span><span class="s0">, </span><span class="s7">$sender</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s8">'notifier.channel.email'</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s7">$this</span><span class="s1">-&gt;</span><span class="s3">messengerConfigEnabled</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'notification_on_failed_messages'</span><span class="s1">]) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'notifier.failed_message_listener'</span><span class="s1">)-&gt;</span><span class="s3">addTag</span><span class="s1">(</span><span class="s8">'kernel.event_subscriber'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>

            <span class="s2">// as we have a bus, the channels don't need the transports</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'notifier.channel.chat'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">hasDefinition</span><span class="s1">(</span><span class="s8">'notifier.channel.email'</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'notifier.channel.email'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
            <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'notifier.channel.sms'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s3">null</span><span class="s1">)</span><span class="s0">;</span>
        <span class="s1">}</span>

        <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'notifier.channel_policy'</span><span class="s1">)-&gt;</span><span class="s3">setArgument</span><span class="s1">(</span><span class="s9">0</span><span class="s0">, </span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'channel_policy'</span><span class="s1">])</span><span class="s0">;</span>

        <span class="s7">$classToServices </span><span class="s1">= [</span>
            <span class="s3">SlackTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'notifier.transport_factory.slack'</span><span class="s0">,</span>
            <span class="s3">TelegramTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'notifier.transport_factory.telegram'</span><span class="s0">,</span>
            <span class="s3">NexmoTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'notifier.transport_factory.nexmo'</span><span class="s0">,</span>
            <span class="s3">TwilioTransportFactory</span><span class="s1">::</span><span class="s0">class </span><span class="s1">=&gt; </span><span class="s8">'notifier.transport_factory.twilio'</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">;</span>

        <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$classToServices </span><span class="s0">as </span><span class="s7">$class </span><span class="s1">=&gt; </span><span class="s7">$service</span><span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(!</span><span class="s3">class_exists</span><span class="s1">(</span><span class="s7">$class</span><span class="s1">)) {</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">removeDefinition</span><span class="s1">(</span><span class="s7">$service</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">isset</span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'admin_recipients'</span><span class="s1">])) {</span>
            <span class="s7">$notifier </span><span class="s1">= </span><span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">getDefinition</span><span class="s1">(</span><span class="s8">'notifier'</span><span class="s1">)</span><span class="s0">;</span>
            <span class="s0">foreach </span><span class="s1">(</span><span class="s7">$config</span><span class="s1">[</span><span class="s8">'admin_recipients'</span><span class="s1">] </span><span class="s0">as </span><span class="s7">$i </span><span class="s1">=&gt; </span><span class="s7">$recipient</span><span class="s1">) {</span>
                <span class="s7">$id </span><span class="s1">= </span><span class="s8">'notifier.admin_recipient.'</span><span class="s1">.</span><span class="s7">$i</span><span class="s0">;</span>
                <span class="s7">$container</span><span class="s1">-&gt;</span><span class="s3">setDefinition</span><span class="s1">(</span><span class="s7">$id</span><span class="s0">, new </span><span class="s3">Definition</span><span class="s1">(</span><span class="s3">AdminRecipient</span><span class="s1">::</span><span class="s0">class, </span><span class="s1">[</span><span class="s7">$recipient</span><span class="s1">[</span><span class="s8">'email'</span><span class="s1">]</span><span class="s0">, </span><span class="s7">$recipient</span><span class="s1">[</span><span class="s8">'phone'</span><span class="s1">]]))</span><span class="s0">;</span>
                <span class="s7">$notifier</span><span class="s1">-&gt;</span><span class="s3">addMethodCall</span><span class="s1">(</span><span class="s8">'addAdminRecipient'</span><span class="s0">, </span><span class="s1">[</span><span class="s0">new </span><span class="s3">Reference</span><span class="s1">(</span><span class="s7">$id</span><span class="s1">)])</span><span class="s0">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">/**</span>
     <span class="s4">* {</span><span class="s5">@inheritdoc</span><span class="s4">}</span>
     <span class="s4">*/</span>
    <span class="s0">public function </span><span class="s3">getXsdValidationBasePath</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s1">\</span><span class="s3">dirname</span><span class="s1">(</span><span class="s3">__DIR__</span><span class="s1">).</span><span class="s8">'/Resources/config/schema'</span><span class="s0">;</span>
    <span class="s1">}</span>

    <span class="s0">public function </span><span class="s3">getNamespace</span><span class="s1">()</span>
    <span class="s1">{</span>
        <span class="s0">return </span><span class="s8">'http://symfony.com/schema/dic/symfony'</span><span class="s0">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>